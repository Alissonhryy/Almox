<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Controle de Estoque - Cear√° Sem Fome (Melhorado)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <!-- Firebase SDK v10 (ES Modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getDatabase, ref, onValue, set, push, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyAgbHvbj5zewZWFmfDQ2U-K-yRUO_J7WqE",
      authDomain: "almox-72903.firebaseapp.com",
      projectId: "almox-72903",
      storageBucket: "almox-72903.firebasestorage.app",
      messagingSenderId: "570221299350",
      appId: "1:570221299350:web:7d3b216beb1c23a57764b7",
      measurementId: "G-XTZ90FT9GG",
      databaseURL: "https://almox-72903-default-rtdb.firebaseio.com/"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    
    // üîê Auth
    window.auth = getAuth(app);

    // ‚òÅÔ∏è Firestore
    window.db = getFirestore(app);
    
    // üîÑ Realtime Database
    window.rtdb = getDatabase(app);
    window.rtdbRefs = { ref, onValue, set, push, update, remove };
    
    // üìä Analytics (apenas se n√£o estiver em localhost)
    try {
      if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
        window.analytics = getAnalytics(app);
        console.log('‚úÖ Firebase Analytics inicializado');
      } else {
        console.log('‚ÑπÔ∏è Analytics desabilitado em localhost');
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è Erro ao inicializar Analytics:', error);
    }
    window.firestoreStatus = { connected: false, error: null, lastCheck: null };
    
    // Fun√ß√£o para verificar status do Firestore
    window.checkFirestoreStatus = async function() {
      try {
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        // Tentar ler um documento de teste
        const testRef = doc(window.db, "_test", "connection");
        await getDoc(testRef);
        window.firestoreStatus.connected = true;
        window.firestoreStatus.error = null;
        window.firestoreStatus.lastCheck = new Date().toISOString();
        console.log('‚úÖ Firestore est√° conectado e funcionando!');
        return true;
      } catch (error) {
        window.firestoreStatus.connected = false;
        window.firestoreStatus.error = error.message || error.code || 'Erro desconhecido';
        window.firestoreStatus.lastCheck = new Date().toISOString();
        console.warn('‚ö†Ô∏è Firestore n√£o est√° dispon√≠vel:', error);
        return false;
      }
    };
    
    // Vari√°vel para armazenar o unsubscribe do snapshot
    let inventoryUnsubscribe = null;
    
    // Fun√ß√£o para iniciar sincroniza√ß√£o do Firestore (ap√≥s autentica√ß√£o)
    window.startFirestoreSync = function() {
      // Se j√° existe um snapshot ativo, n√£o criar outro
      if (inventoryUnsubscribe) {
        console.log('Firestore sync j√° est√° ativo');
        return;
      }
      
      try {
        const inventoryRef = collection(window.db, "inventory");
        
        inventoryUnsubscribe = onSnapshot(inventoryRef, 
          (snapshot) => {
            // Sucesso - Firestore est√° funcionando
            window.firestoreStatus.connected = true;
            window.firestoreStatus.error = null;
            
            const updatedInventory = snapshot.docs.map(doc => ({
              id: parseInt(doc.id) || doc.id,
              ...doc.data()
            }));
            
            // Atualizar vari√°vel local e window
            if (window.inventory !== undefined) {
              window.inventory.length = 0;
              window.inventory.push(...updatedInventory);
            }
            
            // Atualizar vari√°vel local inventory tamb√©m
            if (window.setInventory) {
              window.setInventory(updatedInventory);
            }
            
            if (window.renderInventory) {
              window.renderInventory();
            }
            
          },
          (error) => {
            // Erro na conex√£o
            window.firestoreStatus.connected = false;
            window.firestoreStatus.error = error.message || error.code || 'Erro desconhecido';
            console.error('‚ùå Erro no Firestore:', error);
            
          // Se for erro de permiss√£o, mostrar mensagem espec√≠fica
            if (error.code === 'permission-denied' || error.message?.includes('permission')) {
              if (window.showToast) {
                window.showToast('Erro de permiss√£o. Verifique as regras de seguran√ßa do Firestore.', 'error');
              }
            }
            // Se for erro de "database does not exist", mostrar mensagem
            else if (error.code === 'not-found' || error.message?.includes('does not exist')) {
              if (window.showToast) {
                window.showToast('Firestore n√£o foi criado ainda. O sistema est√° usando armazenamento local.', 'warning');
              }
            }
          }
        );
        
        console.log('‚úÖ Sincroniza√ß√£o do Firestore iniciada');
      } catch (error) {
        console.error('‚ùå Erro ao configurar Firestore:', error);
        window.firestoreStatus.connected = false;
        window.firestoreStatus.error = error.message || 'Erro ao inicializar';
      }
    };
    
    // Fun√ß√£o para parar sincroniza√ß√£o do Firestore
    window.stopFirestoreSync = function() {
      if (inventoryUnsubscribe) {
        inventoryUnsubscribe();
        inventoryUnsubscribe = null;
        console.log('Sincroniza√ß√£o do Firestore parada');
      }
    };
    
    // Observar estado de autentica√ß√£o
    onAuthStateChanged(window.auth, (user) => {
      if (user) {
        // Usu√°rio autenticado - iniciar sincroniza√ß√£o
        if (window.setCurrentUser && window.showMainContent && window.updateUserInfo) {
          const userData = {
            uid: user.uid,
            email: user.email,
            name: user.email.split('@')[0],
            role: 'admin' // Por padr√£o, todos s√£o admin (pode ajustar depois)
          };
          window.setCurrentUser(userData);
          window.updateUserInfo();
          window.showMainContent();
          
          // Iniciar sincroniza√ß√£o do Firestore ap√≥s login
          setTimeout(() => {
            if (window.startFirestoreSync) {
              window.startFirestoreSync();
            }
            if (window.startWithdrawalsSync) {
              window.startWithdrawalsSync();
            }
            if (window.startCoursesSync) {
              window.startCoursesSync();
            }
          }, 500);
        }
      } else {
        // Usu√°rio n√£o autenticado - parar sincroniza√ß√£o
        if (window.stopFirestoreSync) {
          window.stopFirestoreSync();
        }
        
        // Parar sincroniza√ß√£o de withdrawals
        if (withdrawalsUnsubscribe) {
          withdrawalsUnsubscribe();
          withdrawalsUnsubscribe = null;
        }
        
        // Parar sincroniza√ß√£o de cursos
        if (window.stopCoursesSync) {
          window.stopCoursesSync();
        }
        
        if (window.setCurrentUser && window.showLogin) {
          window.setCurrentUser(null);
          window.showLogin();
        }
      }
    });
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* Cores principais */
      --gov-blue: #4A90E2;
      --gov-green: #7CB342;
      --gov-yellow: #FDD835;
      --gov-red: #E53935;
      --gov-gray: #424242;
      --gov-light: #F5F5F5;
      --bg-white: #FFFFFF;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
      --shadow-lg: 0 4px 16px rgba(0,0,0,0.15);
      
      /* Tema claro (padr√£o) */
      --bg-primary: #FFFFFF;
      --bg-secondary: #F5F5F5;
      --bg-tertiary: #FAFAFA;
      --text-primary: #1D1D1F;
      --text-secondary: #86868B;
      --border-color: #E5E5E7;
      --card-bg: #FFFFFF;
      --card-shadow: 0 2px 16px rgba(0,0,0,0.08);
    }

    [data-theme="dark"] {
      /* Tema escuro */
      --bg-primary: #000000;
      --bg-secondary: #1C1C1E;
      --bg-tertiary: #2C2C2E;
      --text-primary: #F5F5F7;
      --text-secondary: #86868B;
      --border-color: #38383A;
      --card-bg: #1C1C1E;
      --card-shadow: 0 2px 16px rgba(0,0,0,0.3);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'SF Pro Display', 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      min-height: 100vh;
      color: var(--text-primary);
      transition: background 0.3s, color 0.3s;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Sistema de Login */
    #login-page {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-container {
      background: var(--card-bg);
      padding: 40px;
      border-radius: 20px;
      box-shadow: var(--card-shadow);
      max-width: 400px;
      width: 100%;
      border: 1px solid var(--border-color);
      position: relative;
    }

    .login-checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      margin-bottom: 8px;
    }

    .login-checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .login-checkbox-group label {
      font-size: 14px;
      color: var(--text-secondary);
      cursor: pointer;
      user-select: none;
    }

    .login-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 30px;
      text-align: center;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      left: -280px;
      top: 0;
      width: 280px;
      height: 100vh;
      background: var(--card-bg);
      box-shadow: var(--card-shadow);
      z-index: 1000;
      transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow-y: auto;
      border-right: 1px solid var(--border-color);
    }

    .sidebar.active {
      left: 0;
    }

    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }

    .sidebar-overlay.active {
      display: block;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-header h3 {
      color: var(--text-primary);
      font-weight: 600;
    }

    .sidebar-user {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .sidebar-menu {
      padding: 20px 0;
    }

    .sidebar-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      cursor: pointer;
      transition: background 0.2s;
      color: var(--gov-gray);
      text-decoration: none;
    }

    .sidebar-item:hover {
      background: var(--gov-light);
    }

    .sidebar-item.active {
      background: rgba(74, 144, 226, 0.1);
      color: var(--gov-blue);
      font-weight: 600;
    }

    .header {
      background: var(--card-bg);
      padding: 12px 20px;
      box-shadow: var(--card-shadow);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-color);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      height: 50px;
    }

    .logo-svg {
      width: 60px;
      height: 60px;
      display: inline-block;
    }

    .logo-svg-small {
      width: 40px;
      height: 40px;
      display: inline-block;
    }

    .logo-svg svg {
      width: 100%;
      height: 100%;
    }

    .logo-svg svg {
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    [data-theme="dark"] .logo-svg svg {
      filter: drop-shadow(0 2px 4px rgba(255, 255, 255, 0.1));
    }

    .login-logo {
      text-align: center;
      margin-bottom: 24px;
    }

    .login-logo .logo-svg {
      width: 80px;
      height: 80px;
    }

    .menu-btn {
      background: transparent;
      color: var(--text-primary);
      border: none;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      width: 40px;
      height: 40px;
    }

    .menu-btn:hover {
      background: var(--bg-secondary);
    }

    .menu-btn .material-icons {
      font-size: 24px;
    }

    .theme-toggle {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .theme-toggle:hover {
      background: var(--bg-tertiary);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .search-bar {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      margin-bottom: 24px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      border: 1px solid var(--border-color);
    }

    .filter-info {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-radius: 12px;
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .filter-info strong {
      color: var(--text-primary);
      font-weight: 600;
    }

    .search-input {
      flex: 1;
      min-width: 200px;
      padding: 14px 18px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      font-size: 16px;
      font-family: inherit;
      background: var(--bg-secondary);
      color: var(--text-primary);
      transition: all 0.2s;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--gov-blue);
      background: var(--card-bg);
      box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1);
    }

    .search-input::placeholder {
      color: var(--text-secondary);
    }

    .filter-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 10px 18px;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      border-radius: 12px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      color: var(--text-primary);
    }

    .filter-btn:hover {
      border-color: var(--gov-blue);
      color: var(--gov-blue);
      background: var(--card-bg);
    }

    .filter-btn.active {
      background: transparent;
      color: var(--gov-blue);
      border-color: var(--gov-blue);
      box-shadow: none;
    }

    .inventory-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 100px;
    }

    .item-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 24px;
      box-shadow: var(--card-shadow);
      display: flex;
      flex-direction: column;
      gap: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      border: 1px solid var(--border-color);
    }

    .item-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    .item-card.updated {
      animation: highlight 0.6s ease-out;
    }

    .item-card.updated-add {
      animation: highlightGreen 0.6s ease-out;
    }

    .item-card.updated-remove {
      animation: highlightRed 0.6s ease-out;
    }

    @keyframes highlight {
      from { box-shadow: 0 0 0 6px rgba(74,144,226,0.3); }
      to { box-shadow: var(--card-shadow); }
    }

    @keyframes highlightGreen {
      0% { box-shadow: 0 0 0 6px rgba(124,179,66,0.4); background-color: rgba(124,179,66,0.1); }
      50% { box-shadow: 0 0 0 4px rgba(124,179,66,0.3); }
      100% { box-shadow: var(--card-shadow); background-color: var(--card-bg); }
    }

    @keyframes highlightRed {
      0% { box-shadow: 0 0 0 6px rgba(229,57,53,0.4); background-color: rgba(229,57,53,0.1); }
      50% { box-shadow: 0 0 0 4px rgba(229,57,53,0.3); }
      100% { box-shadow: var(--card-shadow); background-color: var(--card-bg); }
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .item-code {
      font-size: 11px;
      color: var(--text-secondary);
      background: var(--bg-secondary);
      padding: 4px 8px;
      border-radius: 8px;
      font-weight: 500;
    }

    .item-status {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      flex-shrink: 0;
      margin-left: auto;
      box-shadow: 0 0 0 3px rgba(0,0,0,0.05);
    }

    .item-status.ok {
      background: var(--gov-green);
    }

    .item-status.warning {
      background: var(--gov-yellow);
    }

    .item-status.critical {
      background: var(--gov-red);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .item-name {
      font-weight: 700;
      text-align: left;
      font-size: 22px;
      color: var(--text-primary);
      margin-bottom: 12px;
      line-height: 1.3;
      letter-spacing: -0.02em;
    }

    .item-category {
      font-size: 13px;
      color: var(--text-secondary);
      text-align: left;
    }

    .item-quantity {
      font-size: 40px;
      font-weight: 800;
      text-align: left;
      line-height: 1;
      margin: 12px 0;
      letter-spacing: -0.03em;
    }

    .item-quantity.ok {
      color: var(--gov-green);
    }

    .item-quantity.warning {
      color: var(--gov-yellow);
    }

    .item-quantity.critical {
      color: var(--gov-red);
    }

    .item-info {
      font-size: 12px;
      color: var(--text-secondary);
      text-align: left;
      margin-top: 4px;
      opacity: 0.7;
    }

    .badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 8px;
      background: rgba(74, 144, 226, 0.1);
      color: var(--gov-blue);
      font-weight: 500;
      display: inline-block;
      margin: 2px 0;
    }

    .badge.location {
      background: rgba(124, 179, 66, 0.1);
      color: var(--gov-green);
    }

    .badge.project {
      background: rgba(74, 144, 226, 0.1);
      color: var(--gov-blue);
    }

    .item-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
    }


    .item-actions {
      display: flex;
      gap: 8px;
      width: 100%;
    }

    .action-btn {
      flex: 1;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--card-bg);
      color: var(--text-primary);
    }

    .btn-add {
      border-color: var(--gov-green);
      color: var(--gov-green);
    }

    .btn-add:hover {
      background: rgba(124, 179, 66, 0.1);
      border-color: var(--gov-green);
    }

    .btn-remove {
      border-color: var(--gov-red);
      color: var(--gov-red);
      position: relative;
    }

    .btn-remove:hover {
      background: rgba(229, 57, 53, 0.1);
      border-color: var(--gov-red);
    }

    .btn-remove.dangerous {
      background: rgba(229, 57, 53, 0.15);
      border-color: var(--gov-red);
    }

    .action-btn:hover {
      transform: none;
    }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Bot√£o Flutuante */
    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--card-bg);
      color: var(--gov-blue);
      border: 1px solid var(--border-color);
      box-shadow: var(--card-shadow);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      z-index: 999;
      transition: all 0.2s;
    }

    .fab:hover {
      background: var(--bg-secondary);
      border-color: var(--gov-blue);
      transform: none;
      box-shadow: var(--card-shadow);
    }

    .fab:active {
      transform: scale(0.95);
    }

    /* Bot√µes de a√ß√£o no card */
    .item-card-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 12px;
    }

    .item-edit-btn {
      width: 28px;
      height: 28px;
      padding: 0;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      color: var(--text-secondary);
      opacity: 0.6;
    }

    .item-edit-btn:hover {
      background: var(--bg-secondary);
      color: var(--gov-blue);
      opacity: 1;
    }

    .item-edit-btn .material-icons {
      font-size: 18px;
    }

    /* Loading de login */
    .login-loading {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 20px;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 10;
    }

    .login-loading.active {
      display: flex;
    }

    .login-success {
      display: none;
      color: var(--gov-green);
      font-size: 14px;
      margin-top: 8px;
      align-items: center;
      gap: 6px;
    }

    .login-success.active {
      display: flex;
    }

    /* P√°gina de withdrawals */
    .withdrawals-filters {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      margin-bottom: 24px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      border: 1px solid var(--border-color);
    }

    .withdrawal-card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-color);
      margin-bottom: 16px;
    }

    .withdrawal-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    .withdrawal-status.in_use {
      background: rgba(74, 144, 226, 0.1);
      color: var(--gov-blue);
    }

    .withdrawal-status.overdue {
      background: rgba(229, 57, 53, 0.1);
      color: var(--gov-red);
    }

    .withdrawal-status.returned {
      background: rgba(124, 179, 66, 0.1);
      color: var(--gov-green);
    }

    .withdrawals-group {
      margin-bottom: 32px;
    }

    .withdrawals-group-header {
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border-color);
    }

    .withdrawals-group-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .withdrawals-group-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    /* Grid de prateleira para withdrawals */
    .withdrawals-shelf-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .withdrawal-shelf-item {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      box-shadow: var(--card-shadow);
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
    }

    .withdrawal-shelf-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .withdrawal-shelf-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .withdrawal-shelf-item-name {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .withdrawal-shelf-item-details {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .withdrawal-shelf-item-details strong {
      color: var(--text-primary);
    }

    /* Lista de projetos */
    .project-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .project-item-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .project-item-actions {
      display: flex;
      gap: 8px;
    }

    .project-action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .project-action-btn.edit {
      background: var(--gov-blue);
      color: white;
    }

    .project-action-btn.delete {
      background: var(--gov-red);
      color: white;
    }

    .project-action-btn:hover {
      opacity: 0.8;
      transform: scale(1.05);
    }

    @media (max-width: 1200px) {
      .withdrawals-shelf-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 768px) {
      .withdrawals-shelf-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .withdrawals-shelf-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Toasts */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast {
      background: var(--card-bg);
      padding: 16px 20px;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      max-width: 400px;
      animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid var(--border-color);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success {
      border-left: 4px solid var(--gov-green);
    }

    .toast.error {
      border-left: 4px solid var(--gov-red);
    }

    .toast.warning {
      border-left: 4px solid var(--gov-yellow);
    }

    .toast.info {
      border-left: 4px solid var(--gov-blue);
    }

    .toast-icon {
      font-size: 24px;
    }

    .toast.success .toast-icon {
      color: var(--gov-green);
    }

    .toast.error .toast-icon {
      color: var(--gov-red);
    }

    .toast.warning .toast-icon {
      color: var(--gov-yellow);
    }

    .toast.info .toast-icon {
      color: var(--gov-blue);
    }

    .toast-message {
      flex: 1;
    }

    .toast-close {
      background: none;
      border: none;
      cursor: pointer;
      color: #999;
      padding: 4px;
    }


    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      padding: 20px;
      animation: fadeIn 0.2s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 24px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid var(--border-color);
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .close-btn:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      font-family: inherit;
      background: var(--bg-secondary);
      color: var(--text-primary);
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--gov-blue);
      background: var(--card-bg);
      box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .quantity-selector {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }

    .quantity-input {
      padding: 12px;
      border: 2px solid #E0E0E0;
      border-radius: 8px;
      font-size: 24px;
      text-align: center;
      font-weight: 700;
    }

    .quick-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .quick-btn {
      padding: 8px;
      border: 1px solid var(--border-color);
      background: transparent;
      color: var(--text-primary);
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-btn:hover {
      background: var(--bg-secondary);
      border-color: var(--gov-blue);
      color: var(--gov-blue);
    }

    .submit-btn {
      width: 100%;
      padding: 12px 16px;
      background: transparent;
      color: var(--gov-blue);
      border: 1px solid var(--gov-blue);
      border-radius: 8px;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      margin-top: 12px;
      transition: all 0.2s;
    }

    .submit-btn:hover {
      background: rgba(74, 144, 226, 0.1);
    }

    .submit-btn:active {
      transform: none;
    }

    .btn-minimalist {
      padding: 8px 12px;
      background: transparent;
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-minimalist:hover {
      background: var(--bg-secondary);
      border-color: var(--gov-blue);
      color: var(--gov-blue);
    }

    .btn-minimalist .material-icons {
      font-size: 18px;
    }

    .submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-danger {
      background: transparent;
      border-color: var(--gov-red);
      color: var(--gov-red);
    }

    .btn-danger:hover {
      background: rgba(229, 57, 53, 0.1);
    }

    .btn-secondary {
      background: transparent;
      border-color: var(--text-secondary);
      color: var(--text-secondary);
    }

    .btn-secondary:hover {
      background: var(--bg-secondary);
    }

    .btn-success {
      background: transparent;
      border-color: var(--gov-green);
      color: var(--gov-green);
    }

    .btn-success:hover {
      background: rgba(124, 179, 66, 0.1);
    }


    .notes-input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      font-family: inherit;
      resize: vertical;
      min-height: 80px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      transition: all 0.2s;
    }

    .notes-input:focus {
      outline: none;
      border-color: var(--gov-blue);
      background: var(--card-bg);
      box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1);
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .page-content {
      display: none;
    }

    .page-content.active {
      display: block;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text-primary);
    }

    .stat-card {
      background: var(--card-bg);
      padding: 24px;
      border-radius: 20px;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-color);
    }

    .stat-title {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--gov-blue);
      line-height: 1;
    }

    .chart-container {
      background: var(--card-bg);
      padding: 24px;
      border-radius: 20px;
      box-shadow: var(--card-shadow);
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }

    .chart-wrapper {
      position: relative;
      height: 300px;
      width: 100%;
    }

    .chart-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .history-item {
      background: var(--card-bg);
      padding: 16px;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-color);
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .history-time {
      color: var(--text-secondary);
      font-size: 12px;
    }

    .history-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 8px;
    }

    .history-action {
      font-size: 14px;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(74, 144, 226, 0.3);
      border-radius: 50%;
      border-top-color: var(--gov-blue);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      background: #333;
      color: white;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
      margin-bottom: 5px;
    }

    /* Mobile */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        left: -100%;
      }

      .inventory-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 12px;
      }

      .item-card {
        padding: 20px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .search-bar {
        flex-direction: column;
        padding: 16px;
      }

      .filter-buttons {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }

      .filter-btn {
        flex: 1;
        padding: 10px;
        font-size: 14px;
      }

      .container {
        padding: 16px;
      }
    }

    /* Gavetas (Drawers) */
    .drawers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 100px;
    }

    .drawer-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 24px;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-color);
      transition: all 0.3s;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .drawer-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gov-blue);
      transform: scaleX(0);
      transition: transform 0.3s;
    }

    .drawer-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }

    .drawer-card:hover::before {
      transform: scaleX(1);
    }

    .drawer-card.active {
      border-color: var(--gov-blue);
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }

    .drawer-card.active::before {
      transform: scaleX(1);
    }

    .drawer-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .drawer-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .drawer-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .drawer-badge.active {
      background: rgba(74, 144, 226, 0.1);
      color: var(--gov-blue);
    }

    .drawer-badge.ended {
      background: rgba(124, 179, 66, 0.1);
      color: var(--gov-green);
    }

    .drawer-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .drawer-info-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .drawer-stats {
      display: flex;
      gap: 16px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
    }

    .drawer-stat {
      flex: 1;
      text-align: center;
    }

    .drawer-stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--gov-blue);
    }

    .drawer-stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .drawer-alert {
      margin-top: 12px;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .drawer-alert.warning {
      background: rgba(255, 193, 7, 0.1);
      color: #F57C00;
      border-left: 3px solid var(--gov-yellow);
    }

    .drawer-alert.danger {
      background: rgba(229, 57, 53, 0.1);
      color: var(--gov-red);
      border-left: 3px solid var(--gov-red);
    }

    /* Timeline */
    .timeline-container {
      position: relative;
      padding: 20px 0;
    }

    .timeline-item {
      position: relative;
      padding-left: 40px;
      margin-bottom: 24px;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 8px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--gov-blue);
      border: 3px solid var(--card-bg);
      z-index: 2;
    }

    .timeline-item::after {
      content: '';
      position: absolute;
      left: 13px;
      top: 20px;
      width: 2px;
      height: calc(100% + 4px);
      background: var(--border-color);
    }

    .timeline-item:last-child::after {
      display: none;
    }

    .timeline-content {
      background: var(--card-bg);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .timeline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .timeline-action {
      font-weight: 600;
      color: var(--text-primary);
    }

    .timeline-action.create { color: var(--gov-blue); }
    .timeline-action.add { color: var(--gov-green); }
    .timeline-action.remove { color: var(--gov-yellow); }
    .timeline-action.returned { color: var(--gov-green); }
    .timeline-action.partial { color: var(--gov-yellow); }
    .timeline-action.edit { color: var(--gov-blue); }
    .timeline-action.delete { color: var(--gov-red); }

    .timeline-time {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .timeline-details {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 8px;
    }

    .timeline-user {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 8px;
      font-style: italic;
    }

    /* Checklist */
    .checklist-item {
      background: var(--card-bg);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      margin-bottom: 12px;
    }

    /* Sele√ß√£o de Itens para Curso */
    .course-items-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .course-item-option {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .course-item-option:hover {
      background: var(--bg-secondary);
      border-color: var(--gov-blue);
    }

    .course-item-option.selected {
      background: rgba(74, 144, 226, 0.1);
      border-color: var(--gov-blue);
    }

    .course-item-info {
      flex: 1;
    }

    .course-item-name {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .course-item-details {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .course-item-qty-input {
      width: 80px;
      padding: 6px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      text-align: center;
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .course-selected-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .course-selected-item-info {
      flex: 1;
    }

    .course-selected-item-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .course-selected-item-qty {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .course-step {
      animation: fadeIn 0.3s;
    }

    .checklist-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .checklist-item-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .checklist-item-qty {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .checklist-item-fields {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    @media (max-width: 768px) {
      .checklist-item-fields {
        grid-template-columns: 1fr;
      }
    }

    /* Alertas de Prazo */
    .alert-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
    }

    .alert-badge.warning {
      background: rgba(255, 193, 7, 0.15);
      color: #F57C00;
    }

    .alert-badge.danger {
      background: rgba(229, 57, 53, 0.15);
      color: var(--gov-red);
      animation: pulse 2s infinite;
    }

    .alert-badge.info {
      background: rgba(74, 144, 226, 0.15);
      color: var(--gov-blue);
    }

    /* Mobile - Melhorias espec√≠ficas */
    @media (max-width: 480px) {
      /* Cards compact√°veis - esconder item-meta por padr√£o */
      .item-meta {
        display: none;
      }

      .item-card.expanded .item-meta {
        display: flex;
      }

      /* Bot√µes de a√ß√£o maiores (thumb friendly) */
      .action-btn {
        padding: 14px;
        font-size: 18px;
      }

      /* Filtros colaps√°veis */
      .filter-buttons {
        display: none;
        margin-top: 12px;
      }

      .filter-buttons.active {
        display: grid;
      }

      #mobile-filters-btn {
        display: flex;
      }

      /* Header mobile - esconder texto do theme toggle */
      #theme-text {
        display: none;
      }

      /* Modais estilo bottom-sheet */
      .modal-content {
        border-radius: 20px 20px 0 0;
        max-height: 90vh;
        margin-top: auto;
        margin-bottom: 0;
        padding-bottom: max(24px, env(safe-area-inset-bottom));
      }

      .modal {
        align-items: flex-end;
        padding: 0;
      }

      /* Feedback visual de toque */
      .action-btn:active,
      .filter-btn:active,
      .fab:active,
      .submit-btn:active,
      .item-edit-btn:active,
      .btn-minimalist:active,
      .quick-btn:active,
      .project-action-btn:active {
        transform: scale(0.96);
      }
    }
  </style>
</head>
<body>
  <!-- Sistema de Login -->
  <div id="login-page" style="display: none;">
    <div class="login-container">
      <h2 class="login-title">Controle de Estoque</h2>
      <form id="login-form">
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="login-username" placeholder="seu@email.com" required autocomplete="email">
        </div>
        <div class="form-group">
          <label class="form-label">Senha</label>
          <input type="password" class="form-input" id="login-password" required autocomplete="current-password" oninput="validateLoginPassword()">
          <div class="login-success" id="login-success">
            <span class="material-icons" style="font-size: 18px;">check_circle</span>
            <span>Senha v√°lida</span>
          </div>
        </div>
        <div class="login-checkbox-group">
          <input type="checkbox" id="remember-password">
          <label for="remember-password">Salvar senha</label>
        </div>
        <button type="submit" class="submit-btn" id="login-submit-btn">
          <span id="login-btn-text">Entrar</span>
          <span id="login-btn-loading" class="loading" style="display: none; margin-left: 8px;"></span>
        </button>
      </form>
      <div class="login-loading" id="login-loading">
        <div class="loading" style="width: 40px; height: 40px; margin-bottom: 16px;"></div>
        <p style="color: var(--text-primary); font-weight: 500;">Entrando...</p>
      </div>
    </div>
  </div>

  <!-- Conte√∫do Principal -->
  <div id="main-content" style="display: none;">
    <!-- Sidebar -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h3>Menu</h3>
        <button class="close-btn" onclick="toggleSidebar()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="sidebar-user">
        <div style="font-weight: 600;" id="sidebar-username">Usu√°rio</div>
        <div style="font-size: 12px; color: var(--text-secondary);" id="sidebar-userrole">Operador</div>
      </div>
      <div class="sidebar-menu">
        <a class="sidebar-item active" onclick="navigateTo('inventory', this)">
          <span class="material-icons">inventory</span>
          <span>Estoque</span>
        </a>
        <a class="sidebar-item" onclick="navigateTo('dashboard', this)">
          <span class="material-icons">dashboard</span>
          <span>Dashboard</span>
        </a>
        <a class="sidebar-item" onclick="navigateTo('drawers', this)">
          <span class="material-icons">folder</span>
          <span>Material em Uso</span>
        </a>
        <a class="sidebar-item" onclick="navigateTo('history', this)">
          <span class="material-icons">history</span>
          <span>Hist√≥rico</span>
        </a>
        <a class="sidebar-item" onclick="navigateTo('settings', this)">
          <span class="material-icons">settings</span>
          <span>Configura√ß√µes</span>
        </a>
        <a class="sidebar-item" onclick="logout()">
          <span class="material-icons">logout</span>
          <span>Sair</span>
        </a>
      </div>
    </div>

    <!-- Header -->
    <div class="header">
      <div class="header-content">
        <div style="display: flex; align-items: center; gap: 16px;">
          <button class="menu-btn" onclick="toggleSidebar()" title="Menu">
            <span class="material-icons">menu</span>
          </button>
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
          <button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle">
            <span class="material-icons" id="theme-icon">dark_mode</span>
            <span id="theme-text">Escuro</span>
          </button>
          <div class="user-info">
            <span id="header-username">Usu√°rio</span>
            <span class="material-icons">account_circle</span>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- P√°gina de Estoque -->
      <div id="inventory-page" class="page-content active">
        <div class="search-bar">
          <div style="display: flex; gap: 8px; width: 100%;">
            <input type="text" class="search-input" placeholder="üîç Buscar itens..." id="search-input" oninput="filterItems(this.value)" style="flex: 1;">
            <button class="btn-minimalist" id="mobile-filters-btn" onclick="toggleFilters()" style="display: none;">
              <span class="material-icons">filter_list</span>
              <span>Filtros</span>
            </button>
          </div>
          <div class="filter-buttons" id="filter-buttons">
            <button class="filter-btn active" onclick="setLocationFilter('all', this)">Todos</button>
            <button class="filter-btn" onclick="setLocationFilter('ADM', this)">ADM</button>
            <button class="filter-btn" onclick="setLocationFilter('IAC-SOCIAL', this)">IAC-SOCIAL</button>
          </div>
        </div>
        <div class="filter-info" id="filter-info" style="display: none;">
          <span class="material-icons" style="font-size: 18px;">filter_list</span>
          <span>Mostrando <strong id="filtered-count">0</strong> de <strong id="total-count">0</strong> itens</span>
        </div>
        <div id="inventory-grid" class="inventory-grid"></div>
      </div>

      <!-- P√°gina de Dashboard -->
      <div id="dashboard-page" class="page-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0;">Dashboard</h2>
          <button class="btn-minimalist" onclick="openChartsModal()" style="white-space: nowrap;">
            <span class="material-icons">bar_chart</span>
          </button>
        </div>
        <div class="dashboard-grid" id="dashboard-content"></div>
      </div>

      <!-- P√°gina de Material em Uso -->
      <div id="drawers-page" class="page-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0;">Material em Uso</h2>
          <button class="btn-minimalist" onclick="openCreateCourseModal()">
            <span class="material-icons">add</span>
            <span>Novo Curso/Projeto</span>
          </button>
        </div>
        
        <!-- Se√ß√£o: Itens Retirados Isoladamente -->
        <div id="isolated-withdrawals-section" style="margin-bottom: 32px;">
          <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
            <span class="material-icons" style="font-size: 24px;">inventory_2</span>
            Itens Retirados Isoladamente
          </h3>
          <div id="isolated-withdrawals-content" class="withdrawals-shelf-grid"></div>
        </div>
        
        <!-- Se√ß√£o: Cursos/Projetos -->
        <div id="courses-section">
          <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
            <span class="material-icons" style="font-size: 24px;">folder</span>
            Cursos/Projetos
          </h3>
          <div id="drawers-grid" class="drawers-grid"></div>
        </div>
      </div>

      <!-- P√°gina de Hist√≥rico -->
      <div id="history-page" class="page-content">
        <h2 style="margin-bottom: 20px;">Hist√≥rico de Altera√ß√µes</h2>
        <div class="withdrawals-filters" style="margin-bottom: 20px;">
          <div class="form-group" style="flex: 1; min-width: 200px;">
            <label class="form-label">Filtrar por Tipo</label>
            <select class="form-input" id="history-filter-type" onchange="renderHistory()">
              <option value="all">Todos</option>
              <option value="create">Cria√ß√£o</option>
              <option value="edit">Edi√ß√£o</option>
              <option value="delete">Exclus√£o</option>
              <option value="add">Adi√ß√£o</option>
              <option value="remove">Retirada</option>
              <option value="returned">Devolu√ß√µes</option>
            </select>
          </div>
          <div class="form-group" style="flex: 1; min-width: 200px;">
            <label class="form-label">Buscar</label>
            <input type="text" class="form-input" id="history-search" placeholder="Buscar por item, usu√°rio..." oninput="renderHistory()">
          </div>
        </div>
        <div id="history-list" class="history-list"></div>
      </div>

      <!-- P√°gina de Configura√ß√µes -->
      <div id="settings-page" class="page-content">
        <h2 style="margin-bottom: 24px; font-size: 24px; font-weight: 600;">Configura√ß√µes</h2>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px;">
          <!-- Se√ß√£o Perfil do Usu√°rio -->
          <div style="background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color);">
            <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 600;">Perfil</h3>
            <div class="form-group" style="margin-bottom: 16px;">
              <label class="form-label">Nome</label>
              <input type="text" class="form-input" id="user-name-input" placeholder="Seu nome" style="margin-bottom: 8px;">
              <button class="submit-btn" onclick="openChangeNameModal()" style="width: 100%; padding: 10px;">Alterar Nome</button>
            </div>
            <div class="form-group" style="margin-bottom: 16px;">
              <label class="form-label">Email</label>
              <input type="text" class="form-input" id="user-email-display" readonly style="background: var(--input-bg-disabled); cursor: not-allowed;">
            </div>
            <div class="form-group">
              <button class="submit-btn" onclick="openChangePasswordModal()" style="width: 100%; padding: 10px;">Alterar Senha</button>
            </div>
          </div>

          <!-- Se√ß√£o Importa√ß√£o -->
          <div style="background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color);">
            <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 600;">Importar Dados</h3>
            <div class="form-group">
              <label class="form-label">Planilha (Excel/CSV)</label>
              <input type="file" class="form-input" id="import-file" accept=".xlsx,.xls,.csv" onchange="handleFileSelect(event)">
              <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px; line-height: 1.4;">
                Formatos: Excel (.xlsx, .xls) e CSV
              </p>
            </div>
          </div>

        <!-- Se√ß√£o Gerenciamento de Projetos e Categorias -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 24px;">
          <!-- Gerenciamento de Projetos -->
          <div style="background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color);">
            <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 600;">Projetos</h3>
            <div class="form-group" style="margin-bottom: 16px;">
              <div style="display: flex; gap: 8px;">
                <input type="text" class="form-input" id="new-project-name" placeholder="Nome do projeto">
                <button class="submit-btn" onclick="addProject()" style="white-space: nowrap; padding: 10px 16px;">Adicionar</button>
              </div>
            </div>
            <div id="projects-list" style="display: flex; flex-direction: column; gap: 6px;">
              <!-- Lista de projetos ser√° preenchida dinamicamente -->
            </div>
          </div>

          <!-- Gerenciamento de Categorias -->
          <div style="background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color);">
            <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 600;">Categorias</h3>
            <div class="form-group" style="margin-bottom: 16px;">
              <div style="display: flex; gap: 8px;">
                <input type="text" class="form-input" id="new-category-name" placeholder="Nome da categoria">
                <button class="submit-btn" onclick="addCategory()" style="white-space: nowrap; padding: 10px 16px;">Adicionar</button>
              </div>
            </div>
            <div id="categories-list" style="display: flex; flex-direction: column; gap: 6px;">
              <!-- Lista de categorias ser√° preenchida dinamicamente -->
            </div>
          </div>
        </div>

          <!-- Se√ß√£o Exporta√ß√£o e Backup -->
          <div style="background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color);">
            <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 600;">Exporta√ß√£o e Backup</h3>
            <div class="form-group" style="margin-bottom: 12px;">
              <button class="submit-btn" onclick="exportToCSV()" style="width: 100%; padding: 10px;">Exportar CSV</button>
            </div>
            <div class="form-group" style="margin-bottom: 12px;">
              <button class="submit-btn" onclick="exportToPDF()" style="width: 100%; padding: 10px;">Exportar PDF</button>
            </div>
            <div class="form-group" style="margin-bottom: 12px;">
              <button class="submit-btn" onclick="backupData()" style="width: 100%; padding: 10px;">Fazer Backup</button>
            </div>
            <div class="form-group">
              <label class="form-label">Restaurar Backup</label>
              <input type="file" class="form-input" id="restore-file" accept=".json" style="margin-bottom: 8px;">
              <button class="submit-btn btn-danger" onclick="restoreData()" style="width: 100%; padding: 10px;">Restaurar</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Modal de A√ß√£o -->
    <div class="modal" id="action-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="modal-title">Adicionar</h3>
          <button class="close-btn" onclick="closeModal('action-modal')">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div id="current-quantity-info" style="display: none; background: var(--bg-secondary); padding: 16px; border-radius: 12px; margin-bottom: 16px; text-align: center;">
          <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px;">Quantidade Atual</div>
          <div id="current-quantity-display" style="font-size: 32px; font-weight: 700; color: var(--gov-blue);"></div>
          <div id="new-quantity-preview" style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;"></div>
        </div>
        <div id="remove-dates" style="display: none;">
            <div class="form-group">
            <label class="form-label">Data/Prazo de Devolu√ß√£o</label>
            <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 8px;">
              <input type="date" class="form-input" id="return-date" style="flex: 1;">
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; white-space: nowrap;">
                <input type="checkbox" id="no-return-date" onchange="toggleReturnDate()" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-size: 14px;">Sem prazo</span>
              </label>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Motivo da Retirada <span style="color: var(--gov-red);">*</span></label>
            <textarea class="form-input" id="withdrawal-reason" rows="3" placeholder="Informe o motivo da retirada do material..." required></textarea>
          </div>
        </div>
        <div class="quantity-selector">
          <input type="number" class="quantity-input" id="quantity-input" value="1" min="1" oninput="updateQuantityPreview()">
          <div class="quick-buttons">
            <button type="button" class="quick-btn" onclick="setQuantity(1)">1</button>
            <button type="button" class="quick-btn" onclick="setQuantity(5)">5</button>
            <button type="button" class="quick-btn" onclick="setQuantity(10)">10</button>
            <button type="button" class="quick-btn" onclick="setQuantity(20)">20</button>
          </div>
        </div>
        <button class="submit-btn" onclick="confirmAction()">Confirmar</button>
      </div>
    </div>

    <!-- Modal de Alterar Senha -->
    <div class="modal" id="change-password-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Alterar Senha</h3>
          <button class="close-btn" onclick="closeModal('change-password-modal')">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="form-group">
          <label class="form-label">Senha Atual</label>
          <input type="password" class="form-input" id="current-password" required>
        </div>
        <div class="form-group">
          <label class="form-label">Nova Senha</label>
          <input type="password" class="form-input" id="new-password" required minlength="6">
          <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">M√≠nimo de 6 caracteres</p>
        </div>
        <div class="form-group">
          <label class="form-label">Confirmar Nova Senha</label>
          <input type="password" class="form-input" id="confirm-password" required minlength="6">
        </div>
        <button class="submit-btn" onclick="changePassword()">Alterar Senha</button>
      </div>
    </div>

    <!-- Modal de Alterar Nome -->
    <div class="modal" id="change-name-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Alterar Nome</h3>
          <button class="close-btn" onclick="closeModal('change-name-modal')">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="form-group">
          <label class="form-label">Novo Nome</label>
          <input type="text" class="form-input" id="new-name-input" required>
        </div>
        <button type="button" class="submit-btn" id="save-name-btn">Salvar Nome</button>
      </div>
    </div>

    <!-- Modal de Mapeamento de Colunas -->
    <div class="modal" id="column-mapping-modal">
      <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
          <h3 class="modal-title">Mapear Colunas da Planilha</h3>
          <button class="close-btn" onclick="closeModal('column-mapping-modal')">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="form-group">
          <p style="margin-bottom: 16px; color: var(--text-secondary);">
            Selecione qual coluna da planilha corresponde a cada campo do sistema:
          </p>
          <div id="column-mapping-form"></div>
        </div>
        <button class="submit-btn" onclick="processColumnMapping()">Processar Importa√ß√£o</button>
      </div>
    </div>

    <!-- Modal de Erros da Importa√ß√£o -->
    <div class="modal" id="import-errors-modal">
      <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
        <div class="modal-header">
          <h3 class="modal-title">Erros Encontrados na Planilha</h3>
          <button class="close-btn" onclick="closeModal('import-errors-modal')">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="form-group">
          <p style="margin-bottom: 16px; color: var(--text-secondary);">
            Foram encontrados <strong id="errors-count">0</strong> erros. Corrija-os abaixo ou pule para importar apenas os itens v√°lidos.
          </p>
          <div id="import-errors-list" style="margin-bottom: 16px;"></div>
          <div style="display: flex; gap: 8px;">
            <button type="button" class="submit-btn" onclick="applyErrorCorrections()">Aplicar Corre√ß√µes</button>
            <button type="button" class="submit-btn btn-secondary" onclick="skipErrorsAndImport()">Ignorar Erros e Importar V√°lidos</button>
            <button type="button" class="submit-btn btn-danger" onclick="closeModal('import-errors-modal')">Cancelar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Criar Item -->
    <div class="modal" id="create-item-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Criar Novo Item</h3>
          <button class="close-btn" onclick="closeModal('create-item-modal')">
            <span class="material-icons">close</span>
          </button>
        </div>
        <form id="create-item-form" onsubmit="createItem(event)">
          <div class="form-group">
            <label class="form-label">Nome do Item <span style="color: var(--gov-red);">*</span></label>
            <input type="text" class="form-input" id="item-name" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Categoria</label>
              <select class="form-input" id="item-category" required>
                <option value="">Selecione...</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Unidade</label>
              <select class="form-input" id="item-unit" required>
                <option value="UN">UN</option>
                <option value="KG">KG</option>
                <option value="L">L</option>
                <option value="CX">CX</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Quantidade Inicial</label>
              <input type="number" class="form-input" id="item-quantity" value="0" min="0" required>
            </div>
            <div class="form-group">
              <label class="form-label">Quantidade M√≠nima</label>
              <input type="number" class="form-input" id="item-min-quantity" value="10" min="0" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Localiza√ß√£o</label>
              <select class="form-input" id="item-location" required>
                <option value="ADM">ADM</option>
                <option value="IAC-SOCIAL">IAC-SOCIAL</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Projeto</label>
              <select class="form-input" id="item-project">
                <option value="">Selecione o projeto...</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Data de Validade (opcional)</label>
            <input type="date" class="form-input" id="item-expiry">
          </div>
          <button type="submit" class="submit-btn">Criar Item</button>
        </form>
      </div>
    </div>

    <!-- Modal de Edi√ß√£o de Item -->
    <div class="modal" id="edit-item-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Editar Item</h3>
          <button class="close-btn" onclick="closeModal('edit-item-modal')">
            <span class="material-icons">close</span>
          </button>
        </div>
        <form id="edit-item-form" onsubmit="saveItemEdit(event)">
          <div class="form-group">
            <label class="form-label">Nome do Item <span style="color: var(--gov-red);">*</span></label>
            <input type="text" class="form-input" id="edit-item-name" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Categoria</label>
              <select class="form-input" id="edit-item-category" required>
                <option value="">Selecione...</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Unidade</label>
              <select class="form-input" id="edit-item-unit" required>
                <option value="UN">UN</option>
                <option value="KG">KG</option>
                <option value="L">L</option>
                <option value="CX">CX</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Quantidade</label>
              <input type="number" class="form-input" id="edit-item-quantity" min="0" required>
            </div>
            <div class="form-group">
              <label class="form-label">Quantidade M√≠nima</label>
              <input type="number" class="form-input" id="edit-item-min-quantity" min="0" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Localiza√ß√£o</label>
              <select class="form-input" id="edit-item-location" required>
                <option value="ADM">ADM</option>
                <option value="IAC-SOCIAL">IAC-SOCIAL</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Projeto</label>
              <select class="form-input" id="edit-item-project">
                <option value="">Selecione o projeto...</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Data de Validade (opcional)</label>
            <input type="date" class="form-input" id="edit-item-expiry">
          </div>
          <div style="display: flex; gap: 8px;">
            <button type="submit" class="submit-btn" style="flex: 1;">Salvar Altera√ß√µes</button>
            <button type="button" class="submit-btn btn-danger" onclick="deleteItem()" style="flex: 1;">Excluir Item</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal de Gr√°ficos -->
    <div class="modal" id="charts-modal">
      <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
          <h3 class="modal-title">Gr√°ficos do Estoque</h3>
          <button class="close-btn" onclick="closeModal('charts-modal')">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div style="display: flex; flex-direction: column; gap: 24px;">
          <div class="chart-container">
            <div class="chart-title">Distribui√ß√£o por Localiza√ß√£o</div>
            <div class="chart-wrapper">
              <canvas id="modal-location-chart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <div class="chart-title">Status do Estoque</div>
            <div class="chart-wrapper">
              <canvas id="modal-status-chart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <div class="chart-title">Distribui√ß√£o por Projeto</div>
            <div class="chart-wrapper">
              <canvas id="modal-project-chart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Resultados da Importa√ß√£o -->
    <div class="modal" id="import-results-modal">
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
          <h3 class="modal-title">Resultado da Importa√ß√£o</h3>
          <button class="close-btn" onclick="closeModal('import-results-modal')">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="form-group" style="text-align: center;">
          <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
          <h3 id="import-success-count" style="color: var(--gov-green); font-size: 32px; margin-bottom: 8px;">0</h3>
          <p style="margin-bottom: 24px; color: var(--text-secondary);">Itens importados com sucesso</p>
          <div id="import-failed-count" style="display: none;">
            <h3 style="color: var(--gov-red); font-size: 24px; margin-bottom: 8px;">0</h3>
            <p style="margin-bottom: 24px; color: var(--text-secondary);">Itens n√£o importados</p>
          </div>
          <button class="submit-btn" onclick="closeModal('import-results-modal'); document.getElementById('import-file').value = '';">Fechar</button>
        </div>
      </div>
    </div>

    <!-- Modal de Criar/Editar Curso/Projeto -->
    <div class="modal" id="course-modal">
      <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
          <h3 class="modal-title" id="course-modal-title">Novo Curso/Projeto</h3>
          <button class="close-btn" onclick="closeModal('course-modal')">
            <span class="material-icons">close</span>
          </button>
        </div>
        
        <!-- Etapa 1: Informa√ß√µes B√°sicas -->
        <div id="course-step-1" class="course-step">
          <form id="course-form" onsubmit="event.preventDefault(); goToCourseStep2();">
            <div class="form-group">
              <label class="form-label">Nome do Curso/Projeto <span style="color: var(--gov-red);">*</span></label>
              <input type="text" class="form-input" id="course-name" required placeholder="Ex: Curso de Inform√°tica B√°sica">
            </div>
            <div class="form-group">
              <label class="form-label">Data Prov√°vel de Retorno <span style="color: var(--gov-red);">*</span></label>
              <input type="date" class="form-input" id="course-return-date" required>
            </div>
            <div style="display: flex; gap: 8px; margin-top: 20px;">
              <button type="submit" class="submit-btn" style="flex: 1;">Pr√≥ximo: Selecionar Itens</button>
              <button type="button" class="submit-btn btn-secondary" onclick="closeModal('course-modal')" style="flex: 1;">Cancelar</button>
            </div>
          </form>
        </div>
        
        <!-- Etapa 2: Sele√ß√£o de Itens -->
        <div id="course-step-2" class="course-step" style="display: none;">
          <div class="form-group">
            <label class="form-label">Buscar Item</label>
            <input type="text" class="form-input" id="course-item-search" placeholder="üîç Buscar por nome..." oninput="filterCourseItems(this.value)">
          </div>
          <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 12px; padding: 12px; margin-bottom: 16px;">
            <div id="course-items-list" class="course-items-list"></div>
          </div>
          <div id="course-selected-items" style="margin-bottom: 16px;"></div>
          <div style="display: flex; gap: 8px;">
            <button type="button" class="submit-btn" onclick="goToCourseStep1()" style="flex: 1;">Voltar</button>
            <button type="button" class="submit-btn" onclick="confirmCourseWithItems()" style="flex: 1;" id="confirm-course-btn" disabled>Confirmar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Devolu√ß√£o -->
    <div class="modal" id="partial-return-modal">
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
          <h3 class="modal-title" id="partial-return-title">Devolu√ß√£o</h3>
          <button class="close-btn" onclick="closeModal('partial-return-modal')">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div id="partial-return-content">
          <div class="form-group">
            <label class="form-label">Item</label>
            <input type="text" class="form-input" id="partial-return-item-name" readonly>
          </div>
          <div class="form-group">
            <label class="form-label">Quantidade Retirada</label>
            <input type="text" class="form-input" id="partial-return-total-qty" readonly>
          </div>
          <div class="form-group">
            <label class="form-label">Quantidade a Devolver <span style="color: var(--gov-red);">*</span></label>
            <input type="number" class="form-input" id="partial-return-qty" min="1" required oninput="updatePartialReturnPreview()">
            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;" id="partial-return-preview"></p>
          </div>
          <div class="form-group">
            <label class="form-label">Observa√ß√£o (opcional)</label>
            <textarea class="form-input" id="partial-return-notes" rows="3" placeholder="Observa√ß√µes sobre a devolu√ß√£o..."></textarea>
          </div>
          <div style="display: flex; gap: 8px;">
            <button type="button" class="submit-btn" onclick="confirmPartialReturn()" style="flex: 1;">Confirmar Devolu√ß√£o</button>
            <button type="button" class="submit-btn btn-secondary" onclick="closeModal('partial-return-modal')" style="flex: 1;">Cancelar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Checklist de Devolu√ß√£o por Curso -->
    <div class="modal" id="course-checklist-modal">
      <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
          <h3 class="modal-title" id="checklist-course-name">Checklist de Devolu√ß√£o</h3>
          <button class="close-btn" onclick="closeModal('course-checklist-modal')">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div id="checklist-content">
          <div class="form-group">
            <p style="color: var(--text-secondary); margin-bottom: 16px;">
              Verifique todos os itens retirados para este curso e marque o status de cada um.
            </p>
            <div id="checklist-items-list"></div>
          </div>
          <div class="form-group">
            <label class="form-label">Observa√ß√µes Finais</label>
            <textarea class="form-input" id="checklist-final-notes" rows="3" placeholder="Observa√ß√µes gerais sobre a devolu√ß√£o..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Respons√°vel pelo Encerramento</label>
            <input type="text" class="form-input" id="checklist-closing-responsible" placeholder="Nome do respons√°vel">
          </div>
          <div style="display: flex; gap: 8px; margin-top: 20px;">
            <button type="button" class="submit-btn btn-success" onclick="finalizeCourseChecklist()" style="flex: 1;">Finalizar Curso</button>
            <button type="button" class="submit-btn btn-secondary" onclick="closeModal('course-checklist-modal')" style="flex: 1;">Cancelar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Hist√≥rico Detalhado por Item -->
    <div class="modal" id="item-timeline-modal">
      <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
          <h3 class="modal-title" id="timeline-item-name">Linha do Tempo do Item</h3>
          <button class="close-btn" onclick="closeModal('item-timeline-modal')">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div id="item-timeline-content" class="timeline-container"></div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; justify-content: center; align-items: center; flex-direction: column; color: white;">
      <div style="width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px;"></div>
      <p id="loading-text" style="font-size: 18px; font-weight: 500;">Processando...</p>
    </div>

    <!-- Bot√£o Flutuante para Criar Item -->
    <button class="fab" id="fab-button" title="Criar Novo Item">
      <span class="material-icons" id="fab-icon">add</span>
    </button>

    <style>
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      #firestore-status-icon {
        transition: color 0.3s ease;
      }
    </style>

  </div>

  <script>
    // Estado da aplica√ß√£o
    let inventory = [];
    let history = [];
    let activityLogs = [];
    let users = [];
    let currentUser = null;
    let currentItem = null;
    let currentAction = null;
    let currentLocationFilter = 'all';
    let charts = {};
    let withdrawals = [];
    let withdrawalsUnsubscribe = null;
    let projects = [];
    let categories = [];
    let courses = []; // Cursos/Projetos expandidos com datas, local, etc.
    let currentCourse = null;
    let currentWithdrawal = null;
    let coursesUnsubscribe = null;
    let courseSelectedItems = [];
    // Flags para evitar recurs√£o - inicializar no window tamb√©m para garantir disponibilidade
    let isSyncingProjects = false;
    let isUpdatingSelects = false;
    window.isSyncingProjects = false;
    window.isUpdatingSelects = false;
    
    // Expor para m√≥dulos ES6 do Firebase (ser√° atualizado depois das defini√ß√µes)
    window.inventory = inventory;

    // Sistema de Tema
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      const themeIcon = document.getElementById('theme-icon');
      const themeText = document.getElementById('theme-text');
      
      if (themeIcon) {
        themeIcon.textContent = newTheme === 'dark' ? 'light_mode' : 'dark_mode';
      }
      if (themeText) {
        themeText.textContent = newTheme === 'dark' ? 'Claro' : 'Escuro';
      }
    }

    function loadTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      
      const themeIcon = document.getElementById('theme-icon');
      const themeText = document.getElementById('theme-text');
      
      if (themeIcon) {
        themeIcon.textContent = savedTheme === 'dark' ? 'light_mode' : 'dark_mode';
      }
      if (themeText) {
        themeText.textContent = savedTheme === 'dark' ? 'Claro' : 'Escuro';
      }
    }

    // Expor fun√ß√µes para m√≥dulos ES6 do Firebase (ser√° atualizado depois das defini√ß√µes)

    function init() {
      loadTheme();
      loadSavedCredentials();
      loadProjects();
      loadCategories();
      // loadUsers(); // Removido - usando Firebase Auth
      // checkAuth(); // Removido - usando onAuthStateChanged
      initWithdrawalsSync();
      
      // Inicializar sincroniza√ß√£o do Realtime Database
      initRealtimeSync();
    }
    
    // ============================================
    // üîÑ SINCRONIZA√á√ÉO REALTIME DATABASE
    // ============================================
    
    let rtdbUnsubscribes = {
      inventory: null,
      withdrawals: null,
      courses: null,
      history: null,
      activityLogs: null
    };
    
    function initRealtimeSync() {
      if (!window.rtdb || !window.rtdbRefs) {
        console.log('Realtime Database n√£o dispon√≠vel, usando apenas localStorage');
        return;
      }
      
      const { ref, onValue } = window.rtdbRefs;
      
      // Sincronizar Inventory
      const inventoryRef = ref(window.rtdb, 'inventory');
      rtdbUnsubscribes.inventory = onValue(inventoryRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          // Marcar que est√° sincronizando do Realtime Database
          isSyncingFromRTDB.inventory = true;
          
          // Converter objeto em array
          const inventoryArray = Object.keys(data).map(key => ({
            id: key,
            ...data[key]
          }));
          
          // Atualizar apenas se os dados forem diferentes (evitar loops)
          const currentIds = inventory.map(i => String(i.id)).sort().join(',');
          const newIds = inventoryArray.map(i => String(i.id)).sort().join(',');
          
          if (currentIds !== newIds || JSON.stringify(inventory) !== JSON.stringify(inventoryArray)) {
            inventory = inventoryArray;
            localStorage.setItem('inventory', JSON.stringify(inventory));
            
            // Atualizar renderiza√ß√µes
            if (window.renderInventory) {
              renderInventory();
            }
            if (window.updateDashboard) {
              updateDashboard();
            }
            
            console.log('‚úÖ Inventory sincronizado do Realtime Database:', inventory.length, 'itens');
          }
          
          // Resetar flag ap√≥s um delay
          setTimeout(() => {
            isSyncingFromRTDB.inventory = false;
          }, 500);
        }
      }, (error) => {
        console.warn('Erro ao sincronizar inventory do Realtime Database:', error);
        isSyncingFromRTDB.inventory = false;
      });
      
      // Sincronizar Withdrawals
      const withdrawalsRef = ref(window.rtdb, 'withdrawals');
      rtdbUnsubscribes.withdrawals = onValue(withdrawalsRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          isSyncingFromRTDB.withdrawals = true;
          
          const withdrawalsArray = Object.keys(data).map(key => ({
            id: key,
            ...data[key]
          }));
          
          const currentIds = withdrawals.map(w => String(w.id)).sort().join(',');
          const newIds = withdrawalsArray.map(w => String(w.id)).sort().join(',');
          
          if (currentIds !== newIds || JSON.stringify(withdrawals) !== JSON.stringify(withdrawalsArray)) {
            withdrawals = withdrawalsArray;
            localStorage.setItem('withdrawals', JSON.stringify(withdrawals));
            
            // Atualizar renderiza√ß√µes
            if (window.renderWithdrawals) {
              renderWithdrawals();
            }
            if (window.renderDrawers) {
              renderDrawers();
            }
            if (window.renderIsolatedWithdrawals) {
              renderIsolatedWithdrawals();
            }
            if (window.updateDashboard) {
              updateDashboard();
            }
            
            console.log('‚úÖ Withdrawals sincronizado do Realtime Database:', withdrawals.length, 'retiradas');
          }
          
          setTimeout(() => {
            isSyncingFromRTDB.withdrawals = false;
          }, 500);
        }
      }, (error) => {
        console.warn('Erro ao sincronizar withdrawals do Realtime Database:', error);
        isSyncingFromRTDB.withdrawals = false;
      });
      
      // Sincronizar Courses
      const coursesRef = ref(window.rtdb, 'courses');
      rtdbUnsubscribes.courses = onValue(coursesRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          isSyncingFromRTDB.courses = true;
          
          const coursesArray = Object.keys(data).map(key => ({
            id: key,
            ...data[key]
          }));
          
          const currentIds = courses.map(c => String(c.id)).sort().join(',');
          const newIds = coursesArray.map(c => String(c.id)).sort().join(',');
          
          if (currentIds !== newIds || JSON.stringify(courses) !== JSON.stringify(coursesArray)) {
            courses = coursesArray;
            localStorage.setItem('courses', JSON.stringify(courses));
            
            // Sincronizar com projetos
            syncCoursesWithProjects();
            
            // Atualizar renderiza√ß√µes
            if (window.renderDrawers) {
              renderDrawers();
            }
            
            console.log('‚úÖ Courses sincronizado do Realtime Database:', courses.length, 'cursos');
          }
          
          setTimeout(() => {
            isSyncingFromRTDB.courses = false;
          }, 500);
        }
      }, (error) => {
        console.warn('Erro ao sincronizar courses do Realtime Database:', error);
        isSyncingFromRTDB.courses = false;
      });
      
      // Sincronizar History
      const historyRef = ref(window.rtdb, 'history');
      rtdbUnsubscribes.history = onValue(historyRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          isSyncingFromRTDB.history = true;
          
          const historyArray = Object.keys(data).map(key => ({
            id: key,
            ...data[key]
          }));
          
          const currentIds = history.map(h => String(h.id)).sort().join(',');
          const newIds = historyArray.map(h => String(h.id)).sort().join(',');
          
          if (currentIds !== newIds) {
            history = historyArray;
            localStorage.setItem('history', JSON.stringify(history));
            
            // Atualizar renderiza√ß√µes
            if (window.renderHistory) {
              renderHistory();
            }
            
            console.log('‚úÖ History sincronizado do Realtime Database:', history.length, 'entradas');
          }
          
          setTimeout(() => {
            isSyncingFromRTDB.history = false;
          }, 500);
        }
      }, (error) => {
        console.warn('Erro ao sincronizar history do Realtime Database:', error);
        isSyncingFromRTDB.history = false;
      });
      
      // Sincronizar Activity Logs
      const activityLogsRef = ref(window.rtdb, 'activityLogs');
      rtdbUnsubscribes.activityLogs = onValue(activityLogsRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          isSyncingFromRTDB.activityLogs = true;
          
          const activityLogsArray = Object.keys(data).map(key => ({
            id: key,
            ...data[key]
          }));
          
          const currentIds = activityLogs.map(a => String(a.id)).sort().join(',');
          const newIds = activityLogsArray.map(a => String(a.id)).sort().join(',');
          
          if (currentIds !== newIds) {
            activityLogs = activityLogsArray;
            localStorage.setItem('activityLogs', JSON.stringify(activityLogs));
            
            console.log('‚úÖ Activity Logs sincronizado do Realtime Database:', activityLogs.length, 'logs');
          }
          
          setTimeout(() => {
            isSyncingFromRTDB.activityLogs = false;
          }, 500);
        }
      }, (error) => {
        console.warn('Erro ao sincronizar activityLogs do Realtime Database:', error);
        isSyncingFromRTDB.activityLogs = false;
      });
      
      console.log('‚úÖ Sincroniza√ß√£o Realtime Database iniciada');
    }
    
    // Fun√ß√£o para salvar dados no Realtime Database
    function saveToRealtimeDB(path, data) {
      if (!window.rtdb || !window.rtdbRefs) {
        return Promise.resolve();
      }
      
      const { ref, set } = window.rtdbRefs;
      const dbRef = ref(window.rtdb, path);
      
      return set(dbRef, data).catch(error => {
        console.warn(`Erro ao salvar em ${path} no Realtime Database:`, error);
        // Continuar mesmo se falhar
        return Promise.resolve();
      });
    }
    
    // Fun√ß√£o para atualizar dados no Realtime Database
    function updateRealtimeDB(path, updates) {
      if (!window.rtdb || !window.rtdbRefs) {
        return Promise.resolve();
      }
      
      const { ref, update } = window.rtdbRefs;
      const dbRef = ref(window.rtdb, path);
      
      return update(dbRef, updates).catch(error => {
        console.warn(`Erro ao atualizar ${path} no Realtime Database:`, error);
        return Promise.resolve();
      });
    }
    
    // Fun√ß√£o para remover dados do Realtime Database
    function removeFromRealtimeDB(path) {
      if (!window.rtdb || !window.rtdbRefs) {
        return Promise.resolve();
      }
      
      const { ref, remove } = window.rtdbRefs;
      const dbRef = ref(window.rtdb, path);
      
      return remove(dbRef).catch(error => {
        console.warn(`Erro ao remover ${path} do Realtime Database:`, error);
        return Promise.resolve();
      });
    }
    
    // Fun√ß√£o para sincronizar array completo no Realtime Database
    // Converte array em objeto onde a chave √© o ID
    function syncArrayToRealtimeDB(path, array) {
      if (!window.rtdb || !window.rtdbRefs || !array) {
        return Promise.resolve();
      }
      
      const { ref, set } = window.rtdbRefs;
      const dbRef = ref(window.rtdb, path);
      
      // Converter array em objeto
      const objectData = {};
      array.forEach(item => {
        if (item && item.id) {
          objectData[String(item.id)] = item;
        }
      });
      
      return set(dbRef, objectData).catch(error => {
        console.warn(`Erro ao sincronizar ${path} no Realtime Database:`, error);
        return Promise.resolve();
      });
    }
    
    // Fun√ß√£o para sincronizar automaticamente ap√≥s mudan√ßas
    // Evita loops infinitos verificando se a mudan√ßa veio do Realtime Database
    let isSyncingFromRTDB = {
      inventory: false,
      withdrawals: false,
      courses: false,
      history: false,
      activityLogs: false
    };
    
    async function autoSyncToRealtimeDB(dataType, data) {
      // Se a mudan√ßa veio do Realtime Database, n√£o sincronizar de volta
      if (isSyncingFromRTDB[dataType]) {
        return;
      }
      
      // Sincronizar ap√≥s um pequeno delay para evitar m√∫ltiplas sincroniza√ß√µes
      setTimeout(async () => {
        if (!isSyncingFromRTDB[dataType]) {
          await syncArrayToRealtimeDB(dataType, data);
        }
      }, 100);
    }
    
    // Fun√ß√£o wrapper para salvar e sincronizar automaticamente
    function saveAndSync(dataType, data) {
      // Salvar no localStorage
      try {
        localStorage.setItem(dataType, JSON.stringify(data));
      } catch (error) {
        console.warn(`Erro ao salvar ${dataType} no localStorage:`, error);
      }
      
      // Sincronizar no Realtime Database
      autoSyncToRealtimeDB(dataType, data);
    }

    // Sistema de Projetos
    function loadProjects() {
      try {
        const saved = localStorage.getItem('projects');
        if (saved) {
          projects = JSON.parse(saved);
        } else {
          // Projetos padr√£o
          projects = [
            { id: '1', name: 'PMQ - CSF' },
            { id: '2', name: 'IAC-SOCIAL' }
          ];
          saveProjects();
        }
        // N√£o chamar updateProjectSelects aqui para evitar recurs√£o na inicializa√ß√£o
        // updateProjectSelects ser√° chamado quando necess√°rio (ao abrir modais, etc)
        renderProjectsList();
      } catch (error) {
        console.error('Erro ao carregar projetos:', error);
        projects = [{ id: '1', name: 'PMQ - CSF' }];
        saveProjects();
      }
    }

    function saveProjects() {
      localStorage.setItem('projects', JSON.stringify(projects));
      // N√£o chamar updateProjectSelects aqui para evitar recurs√£o
      // updateProjectSelects ser√° chamado quando necess√°rio (ao abrir modais, etc)
      renderProjectsList();
    }

    function updateProjectSelects() {
      // Evitar recurs√£o - usar window para garantir que a flag esteja dispon√≠vel
      if (window.isUpdatingSelects) return;
      window.isUpdatingSelects = true;
      isUpdatingSelects = true;
      
      try {
      const selects = [
        document.getElementById('item-project'),
        document.getElementById('edit-item-project')
      ];
        
        // Se n√£o houver projetos, sincronizar com cursos (sem chamar loadProjects para evitar recurs√£o)
        if (!projects || projects.length === 0) {
          console.log('Array de projetos vazio, sincronizando com cursos...');
          if (!window.isSyncingProjects) {
            syncCoursesWithProjects();
          }
        } else if (!window.isSyncingProjects) {
          // Garantir que os projetos estejam sincronizados com cursos (apenas se n√£o estiver sincronizando)
          syncCoursesWithProjects();
        }
      
      selects.forEach(select => {
        if (!select) return;
        const currentValue = select.value;
        select.innerHTML = '<option value="">Selecione o projeto...</option>';
          
          if (projects && projects.length > 0) {
        projects.forEach(project => {
              if (project && project.name) {
          const option = document.createElement('option');
          option.value = project.name;
          option.textContent = project.name;
          select.appendChild(option);
              }
        });
          } else {
            console.warn('Nenhum projeto dispon√≠vel para adicionar ao select');
          }
          
          // Restaurar valor anterior se existir
        if (currentValue) {
          select.value = currentValue;
        }
      });
        
        console.log('Projetos atualizados nos selects:', projects.length, projects.map(p => p.name));
      } finally {
        window.isUpdatingSelects = false;
        isUpdatingSelects = false;
      }
    }

    function renderProjectsList() {
      const list = document.getElementById('projects-list');
      if (!list) return;
      
      if (projects.length === 0) {
        list.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center; color: var(--text-secondary);">Nenhum projeto cadastrado</div>';
        return;
      }
      
      list.innerHTML = projects.map(project => `
        <div class="project-item">
          <span class="project-item-name">${project.name}</span>
          <div class="project-item-actions">
            <button class="project-action-btn edit" onclick="openEditProjectModal('${project.id}')">Editar</button>
            <button class="project-action-btn delete" onclick="deleteProject('${project.id}')">Remover</button>
          </div>
        </div>
      `).join('');
    }

    function addProject() {
      const input = document.getElementById('new-project-name');
      const name = input?.value.trim();
      
      if (!name) {
        showToast('Digite o nome do projeto!', 'warning');
        return;
      }
      
      if (projects.find(p => p.name.toLowerCase() === name.toLowerCase())) {
        showToast('Este projeto j√° existe!', 'error');
        return;
      }
      
      const newProject = {
        id: Date.now().toString(),
        name: name
      };
      
      projects.push(newProject);
      saveProjects();
      input.value = '';
      showToast('Projeto adicionado com sucesso!', 'success');
    }

    function openEditProjectModal(projectId) {
      const project = projects.find(p => p.id === projectId);
      if (!project) {
        showToast('Projeto n√£o encontrado', 'error');
        return;
      }
      
      const newName = prompt('Digite o novo nome do projeto:', project.name);
      if (!newName || newName.trim() === '') {
        return;
      }
      
      const trimmedName = newName.trim();
      if (projects.find(p => p.id !== projectId && p.name.toLowerCase() === trimmedName.toLowerCase())) {
        showToast('Este nome j√° est√° em uso!', 'error');
        return;
      }
      
      project.name = trimmedName;
      saveProjects();
      showToast('Projeto editado com sucesso!', 'success');
    }

    function deleteProject(projectId) {
      const project = projects.find(p => p.id === projectId);
      if (!project) {
        showToast('Projeto n√£o encontrado', 'error');
        return;
      }
      
      // Verificar se h√° itens usando este projeto
      const itemsUsingProject = inventory.filter(i => i.project === project.name);
      if (itemsUsingProject.length > 0) {
        if (!confirm(`Este projeto est√° sendo usado por ${itemsUsingProject.length} item(ns). Deseja realmente remov√™-lo?\n\nOs itens n√£o perder√£o o projeto, mas voc√™ precisar√° atualiz√°-los manualmente.`)) {
          return;
        }
      }
      
      projects = projects.filter(p => p.id !== projectId);
      saveProjects();
      showToast('Projeto removido com sucesso!', 'success');
    }

    // Sistema de Categorias
    function loadCategories() {
      try {
        const saved = localStorage.getItem('categories');
        if (saved) {
          categories = JSON.parse(saved);
        } else {
          // Categorias padr√£o
          categories = [
            { id: '1', name: 'Permanente' },
            { id: '2', name: 'De Kit' },
            { id: '3', name: 'Insumo' },
            { id: '4', name: 'Outro' }
          ];
          saveCategories();
        }
        updateCategorySelects();
        renderCategoriesList();
      } catch (error) {
        console.error('Erro ao carregar categorias:', error);
        categories = [
          { id: '1', name: 'Permanente' },
          { id: '2', name: 'De Kit' },
          { id: '3', name: 'Insumo' },
          { id: '4', name: 'Outro' }
        ];
        saveCategories();
      }
    }

    function saveCategories() {
      localStorage.setItem('categories', JSON.stringify(categories));
      updateCategorySelects();
      renderCategoriesList();
    }

    function updateCategorySelects() {
      const selects = [
        document.getElementById('item-category'),
        document.getElementById('edit-item-category')
      ];
      
      selects.forEach(select => {
        if (!select) return;
        const currentValue = select.value;
        select.innerHTML = '<option value="">Selecione...</option>';
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category.name;
          option.textContent = category.name;
          select.appendChild(option);
        });
        if (currentValue) {
          select.value = currentValue;
        }
      });
    }

    function renderCategoriesList() {
      const list = document.getElementById('categories-list');
      if (!list) return;
      
      if (categories.length === 0) {
        list.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 14px;">Nenhuma categoria cadastrada</div>';
        return;
      }
      
      list.innerHTML = categories.map(category => `
        <div class="project-item">
          <span class="project-item-name">${category.name}</span>
          <div class="project-item-actions">
            <button class="project-action-btn edit" onclick="openEditCategoryModal('${category.id}')">Editar</button>
            <button class="project-action-btn delete" onclick="deleteCategory('${category.id}')">Remover</button>
          </div>
        </div>
      `).join('');
    }

    function addCategory() {
      const input = document.getElementById('new-category-name');
      const name = input?.value.trim();
      
      if (!name) {
        showToast('Digite o nome da categoria!', 'warning');
        return;
      }
      
      if (categories.find(c => c.name.toLowerCase() === name.toLowerCase())) {
        showToast('Esta categoria j√° existe!', 'error');
        return;
      }
      
      const newCategory = {
        id: Date.now().toString(),
        name: name
      };
      
      categories.push(newCategory);
      saveCategories();
      input.value = '';
      showToast('Categoria adicionada com sucesso!', 'success');
    }

    function openEditCategoryModal(categoryId) {
      const category = categories.find(c => c.id === categoryId);
      if (!category) {
        showToast('Categoria n√£o encontrada', 'error');
        return;
      }
      
      const newName = prompt('Digite o novo nome da categoria:', category.name);
      if (!newName || newName.trim() === '') {
        return;
      }
      
      const trimmedName = newName.trim();
      if (categories.find(c => c.id !== categoryId && c.name.toLowerCase() === trimmedName.toLowerCase())) {
        showToast('Este nome j√° est√° em uso!', 'error');
        return;
      }
      
      category.name = trimmedName;
      saveCategories();
      showToast('Categoria editada com sucesso!', 'success');
    }

    function deleteCategory(categoryId) {
      const category = categories.find(c => c.id === categoryId);
      if (!category) {
        showToast('Categoria n√£o encontrada', 'error');
        return;
      }
      
      // Verificar se h√° itens usando esta categoria
      const itemsUsingCategory = inventory.filter(i => i.category === category.name);
      if (itemsUsingCategory.length > 0) {
        if (!confirm(`Esta categoria est√° sendo usada por ${itemsUsingCategory.length} item(ns). Deseja realmente remov√™-la?\n\nOs itens n√£o perder√£o a categoria, mas voc√™ precisar√° atualiz√°-los manualmente.`)) {
          return;
        }
      }
      
      categories = categories.filter(c => c.id !== categoryId);
      saveCategories();
      showToast('Categoria removida com sucesso!', 'success');
    }

    // Sistema de Login/Usu√°rios
    function loadUsers() {
      const savedUsers = localStorage.getItem('users');
      if (savedUsers) {
        users = JSON.parse(savedUsers);
      } else {
        // Usu√°rio padr√£o
        users = [{
          id: 1,
          username: 'admin',
          password: 'admin',
          name: 'Administrador',
          role: 'admin'
        }];
        saveUsers();
      }
    }

    function saveUsers() {
      localStorage.setItem('users', JSON.stringify(users));
    }

    function checkAuth() {
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showMainContent();
      } else {
        showLogin();
      }
    }

    function showLogin() {
      document.getElementById('login-page').style.display = 'flex';
      document.getElementById('main-content').style.display = 'none';
    }

    function showMainContent() {
      document.getElementById('login-page').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
      updateUserInfo();
      renderInventory(); // loadData() removido - sincroniza√ß√£o em tempo real com Firebase
      updateFAB('inventory'); // Inicializar FAB na p√°gina de estoque
    }

    // Carregar credenciais salvas
    function loadSavedCredentials() {
      try {
        const savedEmail = localStorage.getItem('savedEmail');
        const rememberPassword = localStorage.getItem('rememberPassword') === 'true';
        
        if (savedEmail) {
          document.getElementById('login-username').value = savedEmail;
        }
        
        if (rememberPassword) {
          document.getElementById('remember-password').checked = true;
          const savedPassword = localStorage.getItem('savedPassword');
          if (savedPassword) {
            // Descriptografar (b√°sico - apenas para conveni√™ncia, n√£o seguro)
            try {
              document.getElementById('login-password').value = atob(savedPassword);
            } catch (e) {
              // Ignorar se n√£o conseguir descriptografar
            }
          }
        }
      } catch (error) {
        console.warn('Erro ao carregar credenciais salvas:', error);
      }
    }

    // Validar senha durante digita√ß√£o
    function validateLoginPassword() {
      const password = document.getElementById('login-password').value;
      const successEl = document.getElementById('login-success');
      
      if (successEl) {
        if (password.length >= 6) {
          successEl.classList.add('active');
        } else {
          successEl.classList.remove('active');
        }
      }
    }

    // Login com Firebase Auth
    document.getElementById('login-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const email = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      const rememberPassword = document.getElementById('remember-password').checked;
      
      if (!email || !password) {
        showToast('Por favor, preencha email e senha.', 'warning');
        return;
      }
      
      // Mostrar loading
      const loginLoading = document.getElementById('login-loading');
      const loginBtn = document.getElementById('login-submit-btn');
      const loginBtnText = document.getElementById('login-btn-text');
      const loginBtnLoading = document.getElementById('login-btn-loading');
      
      if (loginLoading) loginLoading.classList.add('active');
      if (loginBtn) loginBtn.disabled = true;
      if (loginBtnText) loginBtnText.textContent = 'Entrando...';
      if (loginBtnLoading) loginBtnLoading.style.display = 'inline-block';
      
      try {
        const { signInWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
        await signInWithEmailAndPassword(window.auth, email, password);
        
        // Salvar credenciais se solicitado
        if (rememberPassword) {
          localStorage.setItem('savedEmail', email);
          localStorage.setItem('savedPassword', btoa(password)); // Base64 (n√£o seguro, apenas conveni√™ncia)
          localStorage.setItem('rememberPassword', 'true');
        } else {
          localStorage.removeItem('savedEmail');
          localStorage.removeItem('savedPassword');
          localStorage.removeItem('rememberPassword');
        }
        
        showToast('Login realizado com sucesso!', 'success');
      } catch (error) {
        console.error('Erro no login:', error);
        let errorMessage = 'Erro no login. Verifique email e senha.';
        if (error.code === 'auth/invalid-email') {
          errorMessage = 'Email inv√°lido. Use um formato v√°lido (ex: usuario@email.com)';
        } else if (error.code === 'auth/user-not-found') {
          errorMessage = 'Usu√°rio n√£o encontrado. Verifique o email.';
        } else if (error.code === 'auth/wrong-password') {
          errorMessage = 'Senha incorreta.';
        } else if (error.code === 'auth/invalid-credential') {
          errorMessage = 'Credenciais inv√°lidas. Verifique email e senha.';
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = 'Erro de conex√£o. Verifique sua internet.';
        }
        showToast(errorMessage, 'error');
      } finally {
        if (loginLoading) loginLoading.classList.remove('active');
        if (loginBtn) loginBtn.disabled = false;
        if (loginBtnText) loginBtnText.textContent = 'Entrar';
        if (loginBtnLoading) loginBtnLoading.style.display = 'none';
      }
    });

    // Carregar credenciais ao iniciar
    loadSavedCredentials();

    async function logout() {
      if (confirm('Deseja sair do sistema?')) {
        try {
          const { signOut } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
          await signOut(window.auth);
          currentUser = null;
          showLogin();
        } catch (error) {
          console.error('Erro ao fazer logout:', error);
          currentUser = null;
          showLogin();
        }
      }
    }

    function updateUserInfo() {
      if (currentUser) {
        const usernameEl = document.getElementById('sidebar-username');
        const userroleEl = document.getElementById('sidebar-userrole');
        const headerUsernameEl = document.getElementById('header-username');
        const userNameInput = document.getElementById('user-name-input');
        const userEmailDisplay = document.getElementById('user-email-display');
        
        if (usernameEl) usernameEl.textContent = currentUser.name || currentUser.email || 'Usu√°rio';
        if (userroleEl) userroleEl.textContent = (currentUser.role === 'admin' ? 'Administrador' : 'Operador');
        if (headerUsernameEl) headerUsernameEl.textContent = currentUser.name || currentUser.email || 'Usu√°rio';
        if (userNameInput) userNameInput.value = currentUser.name || '';
        if (userEmailDisplay) userEmailDisplay.value = currentUser.email || '';
      }
    }

    // Fun√ß√µes de Alterar Senha e Nome
    function openChangePasswordModal() {
      document.getElementById('change-password-modal').classList.add('active');
      document.getElementById('current-password').value = '';
      document.getElementById('new-password').value = '';
      document.getElementById('confirm-password').value = '';
    }

    async function changePassword() {
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;

      if (!currentPassword || !newPassword || !confirmPassword) {
        showToast('Preencha todos os campos!', 'warning');
        return;
      }

      if (newPassword.length < 6) {
        showToast('A senha deve ter no m√≠nimo 6 caracteres!', 'warning');
        return;
      }

      if (newPassword !== confirmPassword) {
        showToast('As senhas n√£o coincidem!', 'error');
        return;
      }

      try {
        const { signInWithEmailAndPassword, updatePassword, reauthenticateWithCredential, EmailAuthProvider } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
        
        // Reautenticar para alterar senha
        const user = window.auth.currentUser;
        if (!user || !user.email) {
          showToast('Usu√°rio n√£o autenticado!', 'error');
          return;
        }

        const credential = EmailAuthProvider.credential(user.email, currentPassword);
        await reauthenticateWithCredential(user, credential);
        await updatePassword(user, newPassword);
        
        showToast('Senha alterada com sucesso!', 'success');
        closeModal('change-password-modal');
      } catch (error) {
        console.error('Erro ao alterar senha:', error);
        let errorMessage = 'Erro ao alterar senha.';
        if (error.code === 'auth/wrong-password') {
          errorMessage = 'Senha atual incorreta!';
        } else if (error.code === 'auth/weak-password') {
          errorMessage = 'A senha √© muito fraca!';
        }
        showToast(errorMessage, 'error');
      }
    }

    function openChangeNameModal() {
      const nameInput = document.getElementById('user-name-input');
      const newNameInput = document.getElementById('new-name-input');
      const modal = document.getElementById('change-name-modal');
      
      if (nameInput && newNameInput) {
        newNameInput.value = nameInput.value || '';
      }
      
      if (modal) {
        modal.classList.add('active');
      }
    }

    async function changeUserName() {
      // Prevenir m√∫ltiplas chamadas
      if (changeUserName.processing) {
        console.log('changeUserName j√° est√° processando, ignorando...');
        return;
      }
      changeUserName.processing = true;
      
      try {
        const newNameInput = document.getElementById('new-name-input');
        if (!newNameInput) {
          console.error('Campo new-name-input n√£o encontrado');
          showToast('Erro: campo n√£o encontrado', 'error');
          return;
        }

        const newName = newNameInput.value.trim();

        if (!newName) {
          showToast('Digite um nome!', 'warning');
          return;
        }

        const user = window.auth?.currentUser;
        if (!user || !user.uid) {
          showToast('Usu√°rio n√£o autenticado!', 'error');
          return;
        }

        // Tentar salvar no Firestore, mas se n√£o estiver dispon√≠vel, salvar localmente
        try {
          if (window.db) {
            const { doc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const userRef = doc(window.db, 'users', user.uid);
            await setDoc(userRef, { 
              name: newName,
              email: user.email,
              uid: user.uid,
              updatedAt: new Date().toISOString()
            }, { merge: true });
            console.log('Nome salvo no Firestore');
          } else {
            throw new Error('Firestore n√£o dispon√≠vel');
          }
        } catch (firestoreError) {
          console.warn('Erro ao salvar no Firestore, salvando localmente:', firestoreError);
          // Salvar localmente como fallback
          const userData = {
            name: newName,
            email: user.email,
            uid: user.uid,
            updatedAt: new Date().toISOString()
          };
          localStorage.setItem(`user_${user.uid}`, JSON.stringify(userData));
          showToast('Nome salvo localmente (Firestore n√£o dispon√≠vel). Crie o Firestore para sincroniza√ß√£o.', 'warning');
        }

        // Atualizar localmente
        if (currentUser) {
          currentUser.name = newName;
          updateUserInfo();
        }

        showToast('Nome alterado com sucesso!', 'success');
        closeModal('change-name-modal');
      } catch (error) {
        console.error('Erro ao alterar nome:', error);
        showToast(`Erro ao alterar nome: ${error.message || 'Erro desconhecido'}`, 'error');
      } finally {
        changeUserName.processing = false;
      }
    }
    
    // Expor fun√ß√µes para m√≥dulos ES6 do Firebase (ap√≥s defini√ß√µes)
    window.renderInventory = renderInventory;
    window.toggleCardExpand = function(card) {
      // S√≥ funciona no mobile
      if (window.innerWidth > 480) return;
      
      // Remover expanded de outros cards
      document.querySelectorAll('.item-card.expanded').forEach(c => {
        if (c !== card) c.classList.remove('expanded');
      });
      
      // Toggle do card clicado
      card.classList.toggle('expanded');
    };
    window.toggleFilters = toggleFilters;
    window.showMainContent = showMainContent;
    window.showLogin = showLogin;
    window.updateUserInfo = updateUserInfo;
    window.setCurrentUser = (user) => { currentUser = user; };
    window.setInventory = (items) => { inventory.length = 0; inventory.push(...items); };
    window.changeUserName = changeUserName;
    window.openChangeNameModal = openChangeNameModal;
    window.changePassword = changePassword;
    window.openChangePasswordModal = openChangePasswordModal;
    
    // Inicializar
    init();

    // Sistema de Toasts
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: 'check_circle',
        error: 'error',
        warning: 'warning',
        info: 'info'
      };
      
      toast.innerHTML = `
        <span class="material-icons toast-icon">${icons[type]}</span>
        <span class="toast-message">${message}</span>
        <button class="toast-close" onclick="this.parentElement.remove()">
          <span class="material-icons">close</span>
        </button>
      `;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 5000);
    }

    // Sidebar
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    document.getElementById('sidebar-overlay').addEventListener('click', toggleSidebar);

    // Event listener para bot√£o de salvar nome (ap√≥s DOM estar pronto)
    function setupSaveNameButton() {
      const saveNameBtn = document.getElementById('save-name-btn');
      if (saveNameBtn && !saveNameBtn.hasAttribute('data-listener-added')) {
        saveNameBtn.setAttribute('data-listener-added', 'true');
        saveNameBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          if (typeof changeUserName === 'function') {
            changeUserName();
          }
        });
      }
    }

    // Tentar configurar o bot√£o ap√≥s o DOM carregar
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupSaveNameButton);
    } else {
      setupSaveNameButton();
    }

    // Tamb√©m tentar quando o modal abrir
    const originalOpenChangeNameModal = openChangeNameModal;
    openChangeNameModal = function() {
      originalOpenChangeNameModal();
      setTimeout(setupSaveNameButton, 100);
    };

    // Sistema de Log
    function logActivity(action, description, type) {
      const log = {
        id: Date.now(),
        timestamp: new Date().toLocaleString('pt-BR'),
        user: currentUser ? currentUser.name : 'Sistema',
        userId: currentUser ? currentUser.id : null,
        action: action,
        description: description,
        type: type
      };
      
      activityLogs.unshift(log);
      if (activityLogs.length > 1000) activityLogs.pop();
      localStorage.setItem('activityLogs', JSON.stringify(activityLogs));
    }

    // Carregar dados
    function loadData() {
      const savedInventory = localStorage.getItem('inventory');
      const savedHistory = localStorage.getItem('history');
      const savedLogs = localStorage.getItem('activityLogs');
      
      if (savedInventory) inventory = JSON.parse(savedInventory);
      if (savedHistory) history = JSON.parse(savedHistory);
      if (savedLogs) activityLogs = JSON.parse(savedLogs);
    }

    function saveData() {
      // inventory removido - sincroniza√ß√£o em tempo real com Firestore
      localStorage.setItem('history', JSON.stringify(history));
      localStorage.setItem('activityLogs', JSON.stringify(activityLogs));
    }

    // Renderizar invent√°rio
    function renderInventory(filter = '') {
      const grid = document.getElementById('inventory-grid');
      let filtered = inventory.filter(item => {
        const matchFilter = !filter || item.name.toLowerCase().includes(filter.toLowerCase());
        const matchLocation = currentLocationFilter === 'all' || item.location === currentLocationFilter;
        return matchFilter && matchLocation;
      });

      // Atualizar contador de filtros
      updateFilterCounter(filtered.length, inventory.length, filter, currentLocationFilter);

      if (filtered.length === 0) {
        grid.innerHTML = '<div class="empty-state">Nenhum item encontrado</div>';
        return;
      }

      grid.innerHTML = filtered.map(item => {
        const status = getItemStatus(item);
        const statusClass = status === 'ok' ? 'ok' : status === 'warning' ? 'warning' : 'critical';
        const statusColors = {
          ok: '#7CB342',
          warning: '#FDD835',
          critical: '#E53935'
        };
        const statusLabels = {
          ok: 'OK',
          warning: 'Aten√ß√£o',
          critical: 'Cr√≠tico'
        };
        
        return `
          <div class="item-card" onclick="toggleCardExpand(this)" style="cursor: pointer;">
            <div style="display: flex; align-items: flex-start; justify-content: flex-end; margin-bottom: 12px;">
              <div style="display: flex; align-items: center; gap: 6px;">
                <div class="item-status ${statusClass}" style="background: ${statusColors[status]};"></div>
                <span style="font-size: 11px; color: var(--text-secondary); font-weight: 500;">${statusLabels[status]}</span>
              </div>
            </div>
            
            <div class="item-name">${item.name}</div>
            
            <div class="item-quantity ${statusClass}" style="color: ${statusColors[status]};">
              ${item.quantity} <span style="font-size: 20px; font-weight: 500; color: var(--text-secondary);">${item.unit || 'UN'}</span>
            </div>
            
            <div class="item-meta">
              ${item.category ? `<div class="item-info"><span style="font-weight: 500;">Categoria:</span> ${item.category}</div>` : ''}
              <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
                <span class="badge location">üìç ${item.location}</span>
                ${item.project ? `<span class="badge project">üéØ ${item.project}</span>` : ''}
              </div>
              ${item.expiryDate ? `<div class="item-info" style="color: ${isExpiringSoon(item.expiryDate) ? '#E53935' : 'var(--text-secondary)'}; margin-top: 8px;">
                <span style="font-weight: 500;">Validade:</span> ${formatDate(item.expiryDate)}
              </div>` : ''}
            </div>
            
            <div class="item-actions" onclick="event.stopPropagation()">
              <button class="action-btn btn-add" onclick="openActionModal('${String(item.id)}', 'add')" title="Adicionar">
                <span class="material-icons">add</span>
              </button>
              <button class="action-btn btn-remove ${status === 'critical' ? 'dangerous' : ''}" onclick="openActionModal('${String(item.id)}', 'remove')" 
                      ${item.quantity === 0 ? 'disabled' : ''} title="Retirar">
                <span class="material-icons">remove</span>
              </button>
            </div>
            <div class="item-card-actions" onclick="event.stopPropagation()">
              <button class="item-edit-btn" onclick="openItemTimeline('${String(item.id)}')" title="Ver Hist√≥rico">
                <span class="material-icons">history</span>
              </button>
              <button class="item-edit-btn" onclick="openEditItemModal('${String(item.id)}')" title="Editar">
                <span class="material-icons">edit</span>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function updateFilterCounter(filteredCount, totalCount, searchFilter, locationFilter) {
      const filterInfo = document.getElementById('filter-info');
      const filteredCountEl = document.getElementById('filtered-count');
      const totalCountEl = document.getElementById('total-count');
      
      if (filteredCountEl) filteredCountEl.textContent = filteredCount;
      if (totalCountEl) totalCountEl.textContent = totalCount;
      
      if (filterInfo) {
        if (searchFilter || locationFilter !== 'all') {
          filterInfo.style.display = 'flex';
        } else {
          filterInfo.style.display = 'none';
        }
      }
    }

    function getItemStatus(item) {
      const minQty = item.minQuantity || 10;
      if (item.quantity === 0) return 'critical';
      if (item.quantity < minQty) return 'critical';
      if (item.quantity < minQty * 1.5) return 'warning';
      return 'ok';
    }

    function isExpiringSoon(date) {
      const expiry = new Date(date);
      const today = new Date();
      const daysUntilExpiry = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
      return daysUntilExpiry <= 7 && daysUntilExpiry >= 0;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr + 'T00:00:00');
      return date.toLocaleDateString('pt-BR');
    }


    function setLocationFilter(location, button) {
      currentLocationFilter = location;
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      if (button) button.classList.add('active');
      const searchValue = document.getElementById('search-input')?.value || '';
      renderInventory(searchValue);
    }

    function filterItems(query) {
      renderInventory(query);
    }

    function openActionModal(itemId, action) {
      // Converter para string para compara√ß√£o correta (IDs podem ser string ou number)
      const itemIdStr = String(itemId);
      const item = inventory.find(i => String(i.id) === itemIdStr);
      
      if (!item) {
        console.error('Item n√£o encontrado:', itemId, inventory);
        showToast('Erro: Item n√£o encontrado', 'error');
        return;
      }
      
      currentItem = item;
      currentAction = action;
      
      document.getElementById('modal-title').textContent = action === 'add' ? 'Adicionar' : 'Retirar';
      document.getElementById('quantity-input').value = 1;
      document.getElementById('quantity-input').max = action === 'remove' ? item.quantity : '';
      
      // Mostrar quantidade atual
      const currentQuantityEl = document.getElementById('current-quantity-display');
      const currentQuantityInfo = document.getElementById('current-quantity-info');
      const newQuantityPreview = document.getElementById('new-quantity-preview');
      
      if (currentQuantityEl) {
        currentQuantityEl.textContent = `${item.quantity} ${item.unit || 'UN'}`;
        currentQuantityInfo.style.display = 'block';
        updateQuantityPreview();
      }
      
      // Mostrar campos de data apenas para retirada
      if (action === 'remove') {
        document.getElementById('remove-dates').style.display = 'block';
        const today = new Date().toISOString().split('T')[0];
        const returnDate = new Date();
        returnDate.setDate(returnDate.getDate() + 7);
        document.getElementById('return-date').value = returnDate.toISOString().split('T')[0];
        document.getElementById('return-date').min = today;
        document.getElementById('no-return-date').checked = false;
        document.getElementById('withdrawal-reason').value = '';
      } else {
        document.getElementById('remove-dates').style.display = 'none';
      }
      
      document.getElementById('action-modal').classList.add('active');
    }

    function updateQuantityPreview() {
      if (!currentItem || !currentAction) return;
      
      const quantityInput = document.getElementById('quantity-input');
      const newQuantityPreview = document.getElementById('new-quantity-preview');
      
      if (!quantityInput || !newQuantityPreview) return;
      
      const quantity = parseInt(quantityInput.value) || 0;
      let newQuantity = currentItem.quantity;
      
      if (currentAction === 'add') {
        newQuantity = currentItem.quantity + quantity;
        newQuantityPreview.textContent = `Nova quantidade: ${newQuantity} ${currentItem.unit || 'UN'}`;
        newQuantityPreview.style.color = 'var(--gov-green)';
      } else if (currentAction === 'remove') {
        newQuantity = Math.max(0, currentItem.quantity - quantity);
        newQuantityPreview.textContent = `Nova quantidade: ${newQuantity} ${currentItem.unit || 'UN'}`;
        if (newQuantity < (currentItem.minQuantity || 10)) {
          newQuantityPreview.style.color = 'var(--gov-red)';
        } else if (newQuantity < (currentItem.minQuantity || 10) * 1.5) {
          newQuantityPreview.style.color = 'var(--gov-yellow)';
        } else {
          newQuantityPreview.style.color = 'var(--gov-green)';
        }
      }
    }

    function setQuantity(value) {
      document.getElementById('quantity-input').value = value;
      updateQuantityPreview();
    }

    function toggleReturnDate() {
      const noReturnDateCheckbox = document.getElementById('no-return-date');
      const returnDateInput = document.getElementById('return-date');
      
      if (noReturnDateCheckbox.checked) {
        returnDateInput.disabled = true;
        returnDateInput.value = '';
      } else {
        returnDateInput.disabled = false;
        // Se estava vazio, definir data padr√£o (7 dias)
        if (!returnDateInput.value) {
          const returnDate = new Date();
          returnDate.setDate(returnDate.getDate() + 7);
          returnDateInput.value = returnDate.toISOString().split('T')[0];
        }
      }
    }

    async function confirmAction() {
      const quantity = parseInt(document.getElementById('quantity-input').value);
      
      if (currentAction === 'remove' && quantity > currentItem.quantity) {
        showToast('Quantidade solicitada maior que o estoque dispon√≠vel!', 'error');
        return;
      }
      
      // Para retirada: usar data atual como withdrawalDate
      const today = new Date().toISOString().split('T')[0];
      const withdrawalDate = currentAction === 'remove' ? today : null;
      
      // Verificar se "sem prazo" est√° marcado
      const noReturnDate = currentAction === 'remove' ? document.getElementById('no-return-date').checked : false;
      const returnDate = currentAction === 'remove' && !noReturnDate ? document.getElementById('return-date').value : null;
      const withdrawalReason = currentAction === 'remove' ? document.getElementById('withdrawal-reason').value.trim() : null;
      
      if (currentAction === 'remove' && (!withdrawalReason || withdrawalReason === '')) {
        showToast('Por favor, informe o motivo da retirada!', 'warning');
        return;
      }
      
      if (currentAction === 'remove' && !noReturnDate && !returnDate) {
        showToast('Por favor, selecione uma data de devolu√ß√£o ou marque "Sem prazo"!', 'warning');
        return;
      }
      
      // Confirma√ß√£o extra para retiradas perigosas
      if (currentAction === 'remove') {
        const newQuantity = currentItem.quantity - quantity;
        const minQty = currentItem.minQuantity || 10;
        
        // Se a retirada deixar o estoque abaixo do m√≠nimo, pedir confirma√ß√£o extra
        if (newQuantity < minQty) {
          const confirmMessage = `‚ö†Ô∏è ATEN√á√ÉO: Esta retirada deixar√° o estoque em ${newQuantity} unidades, abaixo do m√≠nimo de ${minQty}.\n\nO estoque ficar√° CR√çTICO. Deseja continuar?`;
          
          if (!confirm(confirmMessage)) {
            return;
          }
        }
        
        // Se a retirada deixar o estoque zerado, confirma√ß√£o ainda mais expl√≠cita
        if (newQuantity === 0) {
          const criticalConfirm = `üö® ALERTA CR√çTICO: Esta retirada esgotar√° completamente o estoque de "${currentItem.name}".\n\nO estoque ficar√° ZERADO. Tem certeza absoluta?`;
          
          if (!confirm(criticalConfirm)) {
            return;
          }
        }
      }
      
      // Aplicar mudan√ßa diretamente ao invent√°rio no Firestore
      const timestamp = new Date().toLocaleString('pt-BR');
      const newQuantity = currentAction === 'add' 
        ? currentItem.quantity + quantity 
        : Math.max(0, currentItem.quantity - quantity);
      
      try {
        const { updateDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const itemDocId = String(currentItem.id);
        try {
        await updateDoc(doc(window.db, 'inventory', itemDocId), {
          quantity: newQuantity
        });
        } catch (firestoreError) {
          console.warn('Erro ao atualizar no Firestore, usando fallback local:', firestoreError);
          // Continuar com fallback local
        }
        
        if (currentAction === 'add') {
          logActivity('Adi√ß√£o', `Adicionou ${quantity} ${currentItem.unit || 'unidades'} de ${currentItem.name} (${currentItem.location})`, 'add');
          showToast(`Adicionado ${quantity} ${currentItem.unit || 'unidades'} de ${currentItem.name}`, 'success');
        } else {
          // Registrar withdrawal no Firestore
          try {
            const withdrawalData = {
              itemId: String(currentItem.id),
              itemName: currentItem.name,
              quantity: quantity,
              unit: currentItem.unit || 'UN',
              course: null, // Retirada isolada, n√£o vinculada a curso
              courseName: null,
              location: currentItem.location,
              withdrawalDate: withdrawalDate,
              expectedReturnDate: returnDate,
              returnedDate: null,
              status: 'in_use',
              userId: currentUser ? currentUser.uid : null,
              userName: currentUser ? (currentUser.name || currentUser.email) : 'Sistema',
              withdrawalReason: withdrawalReason
            };
            
            if (window.db) {
              const { collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
              const withdrawalRef = await addDoc(collection(window.db, 'withdrawals'), {
                ...withdrawalData,
                createdAt: serverTimestamp()
              });
              
              // Adicionar ao array local tamb√©m para exibi√ß√£o imediata
              withdrawalData.id = withdrawalRef.id;
              withdrawalData.createdAt = new Date();
              withdrawals.unshift(withdrawalData);
              
              // Atualizar refer√™ncia global
              window.withdrawals = withdrawals;
              
              // Salvar no localStorage tamb√©m
              try {
                localStorage.setItem('withdrawals', JSON.stringify(withdrawals));
                console.log('Withdrawal salvo no localStorage. Total:', withdrawals.length);
              } catch (error) {
                console.warn('Erro ao salvar withdrawals no localStorage:', error);
              }
              
              console.log('Withdrawal registrado no Firestore e adicionado localmente. ID:', withdrawalRef.id);
              console.log('Total de withdrawals agora:', withdrawals.length);
            } else {
              // Fallback local
              withdrawalData.id = Date.now().toString();
              withdrawalData.createdAt = new Date();
              withdrawals.unshift(withdrawalData);
              
              // Atualizar refer√™ncia global
              window.withdrawals = withdrawals;
              
              localStorage.setItem('withdrawals', JSON.stringify(withdrawals));
              console.log('Withdrawal salvo localmente. Total:', withdrawals.length);
            }
            
            // Atualizar interface
              if (window.renderWithdrawals) {
                renderWithdrawals();
              }
            // Se estiver na p√°gina drawers, atualizar tamb√©m
            if (document.getElementById('drawers-page')?.classList.contains('active')) {
              if (window.renderIsolatedWithdrawals) {
                renderIsolatedWithdrawals();
              }
              if (window.renderDrawers) {
                renderDrawers();
              }
            }
          } catch (error) {
            console.error('Erro ao registrar withdrawal:', error);
            // Tentar salvar localmente como fallback
            try {
              const withdrawalData = {
                id: Date.now().toString(),
                itemId: String(currentItem.id),
                itemName: currentItem.name,
                quantity: quantity,
                unit: currentItem.unit || 'UN',
                course: null,
                courseName: null,
                location: currentItem.location,
                withdrawalDate: withdrawalDate,
                expectedReturnDate: returnDate,
                returnedDate: null,
                status: 'in_use',
                userId: currentUser ? currentUser.uid : null,
                userName: currentUser ? (currentUser.name || currentUser.email) : 'Sistema',
                withdrawalReason: withdrawalReason,
                createdAt: new Date()
              };
              withdrawals.unshift(withdrawalData);
              
              // Atualizar refer√™ncia global
              window.withdrawals = withdrawals;
              
              localStorage.setItem('withdrawals', JSON.stringify(withdrawals));
              console.log('Withdrawal salvo localmente (fallback). Total:', withdrawals.length);
              
              if (window.renderWithdrawals) {
                renderWithdrawals();
              }
              showToast('Movimenta√ß√£o salva localmente (Firestore n√£o dispon√≠vel)', 'warning');
            } catch (localError) {
              console.error('Erro ao salvar withdrawal localmente:', localError);
            }
          }
          
          const returnDateText = noReturnDate ? 'Sem prazo' : formatDate(returnDate);
          logActivity('Retirada', `Retirou ${quantity} ${currentItem.unit || 'unidades'} de ${currentItem.name} (${currentItem.location}) - Retorno: ${returnDateText}`, 'remove');
          showToast(`Retirado ${quantity} ${currentItem.unit || 'unidades'} de ${currentItem.name} - Retorno: ${returnDateText}`, 'info');
          
          // Verificar estoque cr√≠tico
          const updatedItem = { ...currentItem, quantity: newQuantity };
          if (getItemStatus(updatedItem) === 'critical') {
            showToast(`‚ö†Ô∏è Estoque cr√≠tico: ${currentItem.name}`, 'warning');
          }
        }
        
        // Adicionar ao hist√≥rico
        history.unshift({
          id: Date.now(),
          timestamp: timestamp,
          user: currentUser ? currentUser.name : 'Sistema',
          actions: [{
            itemId: currentItem.id,
            itemName: currentItem.name,
            action: currentAction,
            quantity: quantity,
            withdrawalDate: withdrawalDate,
            returnDate: returnDate,
            withdrawalReason: withdrawalReason
          }],
          notes: ''
        });
        
        saveData(); // Apenas para history e activityLogs
        closeModal('action-modal');
        // renderInventory() n√£o √© necess√°rio - sincroniza√ß√£o em tempo real atualiza automaticamente
      } catch (error) {
        console.error('Erro ao atualizar item:', error);
        showToast('Erro ao atualizar item. Tente novamente.', 'error');
      }
    }


    function openCreateItemModal() {
      console.log('openCreateItemModal chamada');
      try {
      // Limpar formul√°rio
      const form = document.getElementById('create-item-form');
      if (form) {
        form.reset();
        document.getElementById('item-quantity').value = '0';
        document.getElementById('item-min-quantity').value = '10';
      }
      updateProjectSelects();
      updateCategorySelects();
        const modal = document.getElementById('create-item-modal');
        if (modal) {
          modal.classList.add('active');
          console.log('Modal de criar item aberto');
        } else {
          console.error('Modal create-item-modal n√£o encontrado');
        }
      } catch (error) {
        console.error('Erro ao abrir modal de criar item:', error);
      }
    }

    async function createItem(e) {
      e.preventDefault();
      
      const name = document.getElementById('item-name').value.trim();
      const category = document.getElementById('item-category').value;
      const unit = document.getElementById('item-unit').value;
      const quantity = parseInt(document.getElementById('item-quantity').value);
      const minQuantity = parseInt(document.getElementById('item-min-quantity').value);
      const location = document.getElementById('item-location').value;
      const project = document.getElementById('item-project').value;
      const expiryDate = document.getElementById('item-expiry').value;

      if (!name) {
        showToast('Informe o nome do item!', 'warning');
        return;
      }

      // Projeto √© opcional, n√£o precisa validar

      // Gerar ID √∫nico automaticamente
      const itemId = Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9);
      
      // Verificar se j√° existe item com mesmo nome (opcional - pode remover se quiser permitir duplicatas)
      if (inventory.find(i => i.name.toLowerCase() === name.toLowerCase() && i.location === location)) {
        if (!confirm('J√° existe um item com este nome nesta localiza√ß√£o. Deseja criar mesmo assim?')) {
        return;
        }
      }

      const newItem = {
        id: itemId,
        name: name,
        category: category,
        unit: unit,
        quantity: quantity,
        minQuantity: minQuantity,
        location: location,
        project: project,
        expiryDate: expiryDate || null
      };

      try {
        if (window.db) {
          try {
          const { setDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
          await setDoc(doc(window.db, 'inventory', newItem.id.toString()), newItem);
          } catch (firestoreError) {
            console.warn('Erro ao salvar no Firestore, usando fallback local:', firestoreError);
            // Continuar com fallback local
          }
        }
        
        // Sempre salvar localmente tamb√©m
          inventory.push(newItem);
          localStorage.setItem('inventory', JSON.stringify(inventory));
          
          // Sincronizar automaticamente no Realtime Database
          await autoSyncToRealtimeDB('inventory', inventory);
        
        logActivity('Cria√ß√£o', `Criou o item ${name}`, 'create');
        e.target.reset();
        document.getElementById('item-quantity').value = '0';
        document.getElementById('item-min-quantity').value = '10';
        showToast('Item criado com sucesso!', 'success');
        closeModal('create-item-modal');
        
        // Atualizar interface
        if (window.renderInventory) {
          renderInventory();
        }
      } catch (error) {
        console.error('Erro ao criar item:', error);
        showToast('Erro ao criar item. Tente novamente.', 'error');
      }
    }

    function renderDashboard() {
      const admItems = inventory.filter(i => i.location === 'ADM');
      const iacItems = inventory.filter(i => i.location === 'IAC-SOCIAL');
      
      const admTotal = admItems.reduce((sum, i) => sum + i.quantity, 0);
      const iacTotal = iacItems.reduce((sum, i) => sum + i.quantity, 0);
      
      const criticalItems = inventory.filter(i => getItemStatus(i) === 'critical').length;
      const warningItems = inventory.filter(i => getItemStatus(i) === 'warning').length;
      const okItems = inventory.filter(i => getItemStatus(i) === 'ok').length;
      
      // Itens em uso (withdrawals n√£o devolvidos)
      const itemsInUse = withdrawals.filter(w => 
        !w.returnedDate && !w.returned_date && w.status !== 'returned'
      );
      const totalInUse = itemsInUse.reduce((sum, w) => sum + (w.quantity || 0), 0);
      
      // Agrupar por projeto
      const itemsByProject = {};
      inventory.forEach(item => {
        const project = item.project || 'Sem Projeto';
        if (!itemsByProject[project]) {
          itemsByProject[project] = {
            count: 0,
            quantity: 0,
            items: []
          };
        }
        itemsByProject[project].count++;
        itemsByProject[project].quantity += item.quantity || 0;
        itemsByProject[project].items.push(item);
      });
      
      // Criar HTML dos projetos
      const projectsHTML = Object.keys(itemsByProject).map(project => {
        const projectData = itemsByProject[project];
        return `
          <div class="stat-card" style="grid-column: span 1;">
            <div class="stat-title">${project}</div>
            <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
              <div style="font-size: 14px; color: var(--text-secondary);">
                Itens: <strong style="color: var(--text-primary);">${projectData.count}</strong>
              </div>
              <div style="font-size: 14px; color: var(--text-secondary);">
                Quantidade: <strong style="color: var(--text-primary);">${projectData.quantity}</strong>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('dashboard-content').innerHTML = `
        <div class="stat-card" style="grid-column: span 2;">
          <div class="stat-title">Total de Itens no Estoque</div>
          <div class="stat-value">${inventory.length}</div>
          <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">
            Quantidade Total: <strong style="color: var(--text-primary);">${admTotal + iacTotal}</strong> unidades
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Itens em ADM</div>
          <div class="stat-value">${admTotal}</div>
          <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
            ${admItems.length} tipos diferentes
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Itens em IAC-SOCIAL</div>
          <div class="stat-value">${iacTotal}</div>
          <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
            ${iacItems.length} tipos diferentes
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Itens em Uso</div>
          <div class="stat-value" style="color: var(--gov-blue);">${totalInUse}</div>
          <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
            ${itemsInUse.length} movimenta√ß√µes ativas
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Estoque OK</div>
          <div class="stat-value" style="color: var(--gov-green);">${okItems}</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Estoque em Aten√ß√£o</div>
          <div class="stat-value" style="color: var(--gov-yellow);">${warningItems}</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Estoque Cr√≠tico</div>
          <div class="stat-value" style="color: var(--gov-red);">${criticalItems}</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Total de Movimenta√ß√µes</div>
          <div class="stat-value">${history.length}</div>
        </div>
        ${projectsHTML}
      `;
    }

    function openChartsModal() {
      document.getElementById('charts-modal').classList.add('active');
      
      // Aguardar um pouco para garantir que o modal est√° vis√≠vel
      setTimeout(() => {
        renderCharts();
      }, 100);
    }

    function renderCharts() {
      const admItems = inventory.filter(i => i.location === 'ADM');
      const iacItems = inventory.filter(i => i.location === 'IAC-SOCIAL');
      
      const admTotal = admItems.reduce((sum, i) => sum + i.quantity, 0);
      const iacTotal = iacItems.reduce((sum, i) => sum + i.quantity, 0);
      
      const criticalItems = inventory.filter(i => getItemStatus(i) === 'critical').length;
      const warningItems = inventory.filter(i => getItemStatus(i) === 'warning').length;
      const okItems = inventory.filter(i => getItemStatus(i) === 'ok').length;
      
      // Agrupar por projeto
      const itemsByProject = {};
      inventory.forEach(item => {
        const project = item.project || 'Sem Projeto';
        if (!itemsByProject[project]) {
          itemsByProject[project] = 0;
        }
        itemsByProject[project] += item.quantity || 0;
      });
      
      const projectLabels = Object.keys(itemsByProject);
      const projectData = Object.values(itemsByProject);
      
      // Gr√°fico de localiza√ß√£o
      const locationCtx = document.getElementById('modal-location-chart');
      if (locationCtx) {
        if (charts.location) charts.location.destroy();
        charts.location = new Chart(locationCtx, {
          type: 'pie',
          data: {
            labels: ['ADM', 'IAC-SOCIAL'],
            datasets: [{
              data: [admTotal, iacTotal],
              backgroundColor: ['#4A90E2', '#7CB342']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }
      
      // Gr√°fico de status
      const statusCtx = document.getElementById('modal-status-chart');
      if (statusCtx) {
        if (charts.status) charts.status.destroy();
        charts.status = new Chart(statusCtx, {
          type: 'bar',
          data: {
            labels: ['OK', 'Aten√ß√£o', 'Cr√≠tico'],
            datasets: [{
              label: 'Itens',
              data: [okItems, warningItems, criticalItems],
              backgroundColor: ['#7CB342', '#FDD835', '#E53935']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            scales: {
              y: {
                beginAtZero: true
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
      }
      
      // Gr√°fico por projeto
      const projectCtx = document.getElementById('modal-project-chart');
      if (projectCtx && projectLabels.length > 0) {
        if (charts.project) charts.project.destroy();
        
        // Gerar cores para os projetos
        const projectColors = projectLabels.map((_, index) => {
          const hue = (index * 360 / projectLabels.length) % 360;
          return `hsl(${hue}, 70%, 60%)`;
        });
        
        charts.project = new Chart(projectCtx, {
          type: 'doughnut',
          data: {
            labels: projectLabels,
            datasets: [{
              data: projectData,
              backgroundColor: projectColors
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }
    }

    function renderHistory() {
      const list = document.getElementById('history-list');
      if (!list) return;
      
      const filterType = document.getElementById('history-filter-type')?.value || 'all';
      const searchTerm = (document.getElementById('history-search')?.value || '').toLowerCase();
      
      // Combinar hist√≥rico e withdrawals devolvidos
      let allHistoryItems = [];
      
      // Adicionar hist√≥rico existente
      history.forEach(h => {
        if (h.actions && h.actions.length > 0) {
          h.actions.forEach(action => {
            allHistoryItems.push({
              id: `history_${h.id}_${action.itemId || ''}`,
              type: action.action === 'add' ? 'add' : 'remove',
              timestamp: h.timestamp,
              user: h.user || 'Sistema',
              itemId: action.itemId,
              itemName: action.itemName,
              quantity: action.quantity,
              location: action.location || '',
              withdrawalDate: action.withdrawalDate,
              returnDate: action.returnDate,
              withdrawalReason: action.withdrawalReason,
              notes: h.notes
            });
          });
        } else {
          // Hist√≥rico sem a√ß√µes (cria√ß√£o, edi√ß√£o, exclus√£o)
          const activityLog = activityLogs.find(log => 
            log.description && log.description.includes(h.user || '') && 
            log.timestamp === h.timestamp
          );
          
          let historyType = 'create';
          if (activityLog) {
            if (activityLog.action === 'Cria√ß√£o') historyType = 'create';
            else if (activityLog.action === 'Edi√ß√£o') historyType = 'edit';
            else if (activityLog.action === 'Exclus√£o') historyType = 'delete';
          }
          
          allHistoryItems.push({
            id: `history_${h.id}`,
            type: historyType,
            timestamp: h.timestamp,
            user: h.user || 'Sistema',
            description: activityLog?.description || h.notes || '',
            notes: h.notes
          });
        }
      });
      
      // Adicionar atividades do log (apenas as que n√£o s√£o a√ß√µes de hist√≥rico j√° inclu√≠das)
      if (activityLogs && Array.isArray(activityLogs)) {
        activityLogs.forEach(log => {
          // Verificar se j√° foi adicionado como a√ß√£o de hist√≥rico
          const alreadyAdded = allHistoryItems.some(item => {
            // Verificar se √© a mesma a√ß√£o baseado em timestamp e descri√ß√£o
            if (item.timestamp === log.timestamp && item.description === log.description) {
              return true;
            }
            // Verificar se a descri√ß√£o est√° relacionada a uma a√ß√£o j√° inclu√≠da
            if (log.description) {
              const descriptionLower = log.description.toLowerCase();
              return allHistoryItems.some(h => {
                if (h.itemName && descriptionLower.includes(h.itemName.toLowerCase())) {
                  return true;
                }
                return false;
              });
            }
            return false;
          });
          
          if (!alreadyAdded) {
            let logType = 'create';
            if (log.action === 'Cria√ß√£o') logType = 'create';
            else if (log.action === 'Edi√ß√£o') logType = 'edit';
            else if (log.action === 'Exclus√£o') logType = 'delete';
            else if (log.action === 'Adi√ß√£o') logType = 'add';
            else if (log.action === 'Retirada') logType = 'remove';
            else if (log.action === 'Devolu√ß√£o') logType = 'returned';
            
            // Tentar extrair informa√ß√µes do item da descri√ß√£o
            const description = log.description || '';
            const itemNameMatch = description.match(/(?:de|do|da)\s+([^(\n]+)/);
            const quantityMatch = description.match(/(\d+)\s+(unidades|unidade|UN|KG|L|CX)/i);
            
            allHistoryItems.push({
              id: `activity_${log.id}`,
              type: logType,
              timestamp: log.timestamp,
              user: log.user || 'Sistema',
              description: description,
              itemName: itemNameMatch ? itemNameMatch[1].trim() : null,
              quantity: quantityMatch ? parseInt(quantityMatch[1]) : null
            });
          }
        });
      }
      
      // Adicionar withdrawals devolvidos
      withdrawals.forEach(w => {
        if (w.returnedDate || w.returned_date || w.status === 'returned') {
          allHistoryItems.push({
            id: `returned_${w.id}`,
            type: 'returned',
            timestamp: w.returnedDate ? new Date(w.returnedDate + 'T12:00:00').toLocaleString('pt-BR') : 
                      (w.returned_date ? new Date(w.returned_date + 'T12:00:00').toLocaleString('pt-BR') : 
                      new Date().toLocaleString('pt-BR')),
            user: w.userName || w.user_name || 'Sistema',
            itemId: w.itemId,
            itemName: w.itemName || w.item_name || 'Item',
            quantity: w.quantity || 0,
            course: w.course || w.courseName || '',
            withdrawalDate: w.withdrawalDate || w.withdrawal_date,
            expectedReturnDate: w.expectedReturnDate || w.expected_return_date,
            returnedDate: w.returnedDate || w.returned_date,
            withdrawalReason: w.withdrawalReason || w.reason || ''
          });
        }
      });
      
      // Filtrar por tipo
      if (filterType !== 'all') {
        allHistoryItems = allHistoryItems.filter(item => item.type === filterType);
      }
      
      // Filtrar por busca
      if (searchTerm) {
        allHistoryItems = allHistoryItems.filter(item => 
          (item.itemName && item.itemName.toLowerCase().includes(searchTerm)) ||
          (item.user && item.user.toLowerCase().includes(searchTerm)) ||
          (item.description && item.description.toLowerCase().includes(searchTerm)) ||
          (item.course && item.course.toLowerCase().includes(searchTerm))
        );
      }
      
      // Ordenar por timestamp (mais recente primeiro)
      allHistoryItems.sort((a, b) => {
        const dateA = new Date(a.timestamp);
        const dateB = new Date(b.timestamp);
        return dateB - dateA;
      });
      
      if (allHistoryItems.length === 0) {
        list.innerHTML = '<div class="empty-state">Nenhuma altera√ß√£o encontrada com os filtros aplicados</div>';
        return;
      }
      
      // Agrupar itens de cursos/projetos
      const groupedByCourse = {};
      const isolatedItems = [];
      
      allHistoryItems.forEach(item => {
        const courseName = item.course || item.courseName;
        if (courseName && (item.type === 'remove' || item.type === 'returned')) {
          // Agrupar por curso e data de retirada
          const key = `${courseName}_${item.withdrawalDate || item.withdrawal_date || 'no_date'}`;
          if (!groupedByCourse[key]) {
            groupedByCourse[key] = {
              course: courseName,
              withdrawalDate: item.withdrawalDate || item.withdrawal_date,
              timestamp: item.timestamp,
              user: item.user,
              items: []
            };
          }
          groupedByCourse[key].items.push(item);
        } else {
          isolatedItems.push(item);
        }
      });
      
      // Renderizar itens isolados primeiro
      let html = isolatedItems.map(item => {
        const typeIcons = {
          create: { icon: 'üìù', label: 'Cria√ß√£o', color: '#4A90E2' },
          edit: { icon: '‚úèÔ∏è', label: 'Edi√ß√£o', color: '#7CB342' },
          delete: { icon: 'üóëÔ∏è', label: 'Exclus√£o', color: '#E53935' },
          add: { icon: '‚ûï', label: 'Adi√ß√£o', color: '#4A90E2' },
          remove: { icon: '‚ûñ', label: 'Retirada', color: '#FDD835' },
          returned: { icon: '‚úÖ', label: 'Devolu√ß√£o', color: '#7CB342' }
        };
        
        const typeInfo = typeIcons[item.type] || { icon: 'üìã', label: 'Altera√ß√£o', color: '#86868B' };
        
        return `
          <div class="history-item">
            <div class="history-header">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="font-size: 24px;">${typeInfo.icon}</div>
                <div>
                  <strong style="color: ${typeInfo.color};">${typeInfo.label}</strong>
                  <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                    Por: ${item.user || 'Sistema'}
                  </div>
                </div>
              </div>
              <span class="history-time">${item.timestamp}</span>
            </div>
            
            ${item.itemName ? `
              <div style="margin-top: 12px;">
                <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                  ${item.itemName}
                </div>
                ${item.quantity !== undefined ? `
                  <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px;">
                    Quantidade: <strong style="color: var(--text-primary);">${item.type === 'add' ? '+' : item.type === 'remove' || item.type === 'returned' ? '-' : ''}${item.quantity}</strong>
                    ${item.unit ? item.unit : ''}
                  </div>
                ` : ''}
                ${item.location ? `
                  <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px;">
                    Localiza√ß√£o: <strong>${item.location}</strong>
                  </div>
                ` : ''}
              </div>
            ` : ''}
            
            ${item.description ? `
              <div style="color: var(--text-secondary); font-size: 14px; margin-top: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 8px;">
                ${item.description}
              </div>
            ` : ''}
            
            ${item.withdrawalDate || item.withdrawal_date ? `
              <div style="margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid ${typeInfo.color};">
                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                  <strong style="color: var(--text-primary);">Informa√ß√µes da Retirada:</strong>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; font-size: 13px;">
                  <div>
                    <span style="color: var(--text-secondary);">Data de Sa√≠da:</span>
                    <strong style="color: var(--text-primary); margin-left: 4px;">${formatDate(item.withdrawalDate || item.withdrawal_date)}</strong>
                  </div>
                  ${item.expectedReturnDate || item.expected_return_date ? `
                    <div>
                      <span style="color: var(--text-secondary);">Retorno Previsto:</span>
                      <strong style="color: var(--text-primary); margin-left: 4px;">${formatDate(item.expectedReturnDate || item.expected_return_date)}</strong>
                    </div>
                  ` : ''}
                  ${item.returnedDate ? `
                    <div style="color: var(--gov-green);">
                      <span>‚úÖ Devolvido em:</span>
                      <strong style="margin-left: 4px;">${formatDate(item.returnedDate)}</strong>
                    </div>
                  ` : ''}
                  ${item.course ? `
                    <div>
                      <span style="color: var(--text-secondary);">Curso/Projeto:</span>
                      <strong style="color: var(--text-primary); margin-left: 4px;">${item.course}</strong>
                    </div>
                  ` : ''}
                </div>
                ${item.withdrawalReason ? `
                  <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-color);">
                    <span style="color: var(--text-secondary); font-size: 12px;">Motivo:</span>
                    <div style="color: var(--text-primary); font-size: 13px; margin-top: 4px; font-style: italic;">
                      ${item.withdrawalReason}
                    </div>
                  </div>
                ` : ''}
              </div>
            ` : ''}
            
            ${item.notes ? `
              <div style="color: var(--text-secondary); font-size: 13px; margin-top: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 8px;">
                <strong>Observa√ß√£o:</strong> ${item.notes}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
      
      // Renderizar grupos de cursos/projetos
      if (Object.keys(groupedByCourse).length > 0) {
        html += Object.keys(groupedByCourse).map(key => {
          const group = groupedByCourse[key];
          const totalQuantity = group.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
          const returnedItems = group.items.filter(item => item.type === 'returned');
          const withdrawnItems = group.items.filter(item => item.type === 'remove');
          
          return `
            <div class="history-item" style="border-left: 4px solid var(--gov-blue);">
              <div class="history-header">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="font-size: 24px;">üìÅ</div>
                  <div>
                    <strong style="color: var(--gov-blue);">Curso/Projeto: ${group.course}</strong>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                      Por: ${group.user || 'Sistema'}
                    </div>
                  </div>
                </div>
                <span class="history-time">${group.timestamp}</span>
              </div>
              
              <div style="margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                  <strong style="color: var(--text-primary);">Itens Retirados:</strong>
                </div>
                <div style="display: grid; gap: 8px;">
                  ${group.items.map(item => `
                    <div style="padding: 8px; background: var(--bg-primary); border-radius: 6px; border-left: 3px solid ${item.type === 'returned' ? 'var(--gov-green)' : 'var(--gov-yellow)'};">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <div style="font-weight: 600; color: var(--text-primary);">${item.itemName || 'Item'}</div>
                        <span style="font-size: 12px; color: var(--text-secondary);">${item.type === 'returned' ? '‚úÖ Devolvido' : '‚è≥ Em Uso'}</span>
                      </div>
                      <div style="font-size: 13px; color: var(--text-secondary);">
                        Quantidade: <strong style="color: var(--text-primary);">${item.quantity || 0} ${item.unit || 'UN'}</strong>
                      </div>
                      ${item.returnedDate ? `
                        <div style="font-size: 12px; color: var(--gov-green); margin-top: 4px;">
                          Devolvido em: ${formatDate(item.returnedDate)}
                        </div>
                      ` : ''}
                    </div>
                  `).join('')}
                </div>
                ${group.withdrawalDate ? `
                  <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                    <div style="font-size: 13px; color: var(--text-secondary);">
                      <strong>Data de Retirada:</strong> ${formatDate(group.withdrawalDate)}
                    </div>
                  </div>
                ` : ''}
              </div>
          </div>
        `;
      }).join('');
      }
      
      list.innerHTML = html;
    }

    function navigateTo(page, element) {
      document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
      const pageElement = document.getElementById(page + '-page');
      if (pageElement) {
        pageElement.classList.add('active');
      }
      
      document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
      if (element) {
        element.classList.add('active');
      }
      
      if (page === 'dashboard') {
        renderDashboard();
      }
      if (page === 'history') {
        renderHistory();
      }
      if (page === 'drawers') {
        renderDrawers();
        updateFAB('drawers');
      }
      if (page === 'settings') {
        renderProjectsList();
        renderCategoriesList();
      }
      
      // Fechar sidebar no mobile ao navegar
      if (window.innerWidth <= 768) {
        toggleSidebar();
      }
    }

    function toggleFilters() {
      const filterButtons = document.getElementById('filter-buttons');
      if (filterButtons) {
        filterButtons.classList.toggle('active');
      }
    }

    function updateFAB(page) {
      console.log('updateFAB chamada para p√°gina:', page);
      const fabButton = document.getElementById('fab-button');
      const fabIcon = document.getElementById('fab-icon');
      
      if (!fabButton || !fabIcon) {
        console.warn('FAB button ou icon n√£o encontrado');
        return;
      }
      
      // O bot√£o FAB sempre abre o modal de criar item
      if (page === 'inventory' || page === 'drawers') {
        fabButton.onclick = () => {
          console.log('FAB clicado, abrindo modal de criar item');
          openCreateItemModal();
        };
        fabButton.title = 'Criar Novo Item';
        fabIcon.textContent = 'add';
        fabButton.style.display = 'flex';
        console.log('FAB configurado para criar item');
      } else {
        // Para outras p√°ginas, esconder o FAB
        fabButton.style.display = 'none';
      }
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // Fechar modal ao clicar fora
    function setupModalCloseOnClick() {
      document.querySelectorAll('.modal').forEach(modal => {
        // Remover listeners anteriores para evitar duplica√ß√£o
        const newModal = modal.cloneNode(true);
        modal.parentNode.replaceChild(newModal, modal);
        
        newModal.addEventListener('click', function(e) {
          // Se o clique foi diretamente no modal (overlay), fechar
          if (e.target === newModal) {
            const modalId = newModal.id;
            closeModal(modalId);
          }
        });
      });
    }

    // Configurar ao carregar
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupModalCloseOnClick);
    } else {
      setupModalCloseOnClick();
    }

    // Exporta√ß√£o
    function exportToCSV() {
      const headers = ['C√≥digo', 'Nome', 'Categoria', 'Unidade', 'Quantidade', 'M√≠nimo', 'Localiza√ß√£o', 'Validade'];
      const rows = inventory.map(item => [
        item.code || '',
        item.name || '',
        item.category || '',
        item.unit || '',
        item.quantity || 0,
        item.minQuantity || 0,
        item.location || '',
        item.expiryDate ? formatDate(item.expiryDate) : ''
      ]);
      
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `estoque_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      
      showToast('Exporta√ß√£o CSV realizada com sucesso!', 'success');
    }

    function exportToPDF() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Configura√ß√µes
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 15;
        let yPos = margin;
        
        // Cabe√ßalho
        doc.setFontSize(20);
        doc.setFont(undefined, 'bold');
        doc.text('Controle de Estoque - Cear√° Sem Fome', pageWidth / 2, yPos, { align: 'center' });
        
        yPos += 10;
        doc.setFontSize(12);
        doc.setFont(undefined, 'normal');
        doc.text(`Relat√≥rio gerado em: ${new Date().toLocaleString('pt-BR')}`, pageWidth / 2, yPos, { align: 'center' });
        
        yPos += 15;
        
        // Estat√≠sticas
        const totalItems = inventory.length;
        const totalQuantity = inventory.reduce((sum, item) => sum + (item.quantity || 0), 0);
        const criticalItems = inventory.filter(i => getItemStatus(i) === 'critical').length;
        const warningItems = inventory.filter(i => getItemStatus(i) === 'warning').length;
        const okItems = inventory.filter(i => getItemStatus(i) === 'ok').length;
        
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('Resumo do Estoque', margin, yPos);
        
        yPos += 8;
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`Total de Itens: ${totalItems}`, margin, yPos);
        yPos += 6;
        doc.text(`Quantidade Total: ${totalQuantity} unidades`, margin, yPos);
        yPos += 6;
        doc.setTextColor(76, 175, 80); // Verde
        doc.text(`‚úì Itens OK: ${okItems}`, margin, yPos);
        yPos += 6;
        doc.setTextColor(255, 152, 0); // Laranja
        doc.text(`‚ö† Itens em Aten√ß√£o: ${warningItems}`, margin, yPos);
        yPos += 6;
        doc.setTextColor(244, 67, 54); // Vermelho
        doc.text(`‚úó Itens Cr√≠ticos: ${criticalItems}`, margin, yPos);
        doc.setTextColor(0, 0, 0); // Preto
        yPos += 12;
        
        // Verificar se precisa de nova p√°gina
        if (yPos > pageHeight - 40) {
          doc.addPage();
          yPos = margin;
        }
        
        // Tabela de itens
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('Lista de Itens', margin, yPos);
        yPos += 8;
        
        // Cabe√ßalho da tabela
        doc.setFontSize(8);
        doc.setFont(undefined, 'bold');
        const colWidths = [25, 50, 25, 20, 20, 20, 30]; // Ajuste das larguras
        const headers = ['C√≥digo', 'Nome', 'Categoria', 'Qtd', 'M√≠n', 'Local', 'Status'];
        let xPos = margin;
        
        doc.setFillColor(74, 144, 226); // Azul
        doc.rect(xPos, yPos - 5, pageWidth - 2 * margin, 7, 'F');
        doc.setTextColor(255, 255, 255);
        
        headers.forEach((header, index) => {
          doc.text(header, xPos + 2, yPos, { align: 'left' });
          xPos += colWidths[index];
        });
        
        yPos += 8;
        doc.setTextColor(0, 0, 0);
        doc.setFont(undefined, 'normal');
        
        // Itens agrupados por localiza√ß√£o
        const locations = ['ADM', 'IAC-SOCIAL'];
        
        locations.forEach(location => {
          const locationItems = inventory.filter(i => i.location === location);
          
          if (locationItems.length > 0) {
            // Verificar se precisa de nova p√°gina
            if (yPos > pageHeight - 30) {
              doc.addPage();
              yPos = margin;
            }
            
            // T√≠tulo da localiza√ß√£o
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text(`Localiza√ß√£o: ${location}`, margin, yPos);
            yPos += 6;
            
            locationItems.forEach((item, index) => {
              // Verificar se precisa de nova p√°gina
              if (yPos > pageHeight - 15) {
                doc.addPage();
                yPos = margin;
              }
              
              const status = getItemStatus(item);
              const statusColors = {
                ok: [76, 175, 80],
                warning: [255, 152, 0],
                critical: [244, 67, 54]
              };
              const statusText = {
                ok: 'OK',
                warning: 'ATEN',
                critical: 'CRIT'
              };
              
              // Linha alternada
              if (index % 2 === 0) {
                doc.setFillColor(245, 245, 245);
                doc.rect(margin, yPos - 4, pageWidth - 2 * margin, 5, 'F');
              }
              
              xPos = margin;
              doc.setFontSize(7);
              doc.setFont(undefined, 'normal');
              
              // C√≥digo (truncado se muito longo)
              doc.text((item.code || 'N/A').substring(0, 8), xPos + 1, yPos);
              xPos += colWidths[0];
              
              // Nome (truncado se muito longo)
              doc.text((item.name || 'N/A').substring(0, 20), xPos + 1, yPos);
              xPos += colWidths[1];
              
              // Categoria (truncado)
              doc.text((item.category || 'N/A').substring(0, 10), xPos + 1, yPos);
              xPos += colWidths[2];
              
              // Quantidade
              doc.text(String(item.quantity || 0), xPos + 1, yPos);
              xPos += colWidths[3];
              
              // M√≠nimo
              doc.text(String(item.minQuantity || 0), xPos + 1, yPos);
              xPos += colWidths[4];
              
              // Local (j√° sabemos que √© ADM ou IAC-SOCIAL, mas mostramos mesmo assim)
              doc.text(item.location || 'N/A', xPos + 1, yPos);
              xPos += colWidths[5];
              
              // Status com cor
              doc.setFillColor(...statusColors[status]);
              doc.setTextColor(255, 255, 255);
              doc.setFont(undefined, 'bold');
              doc.roundedRect(xPos, yPos - 3.5, colWidths[6] - 2, 4, 1, 1, 'F');
              doc.text(statusText[status], xPos + (colWidths[6] - 2) / 2, yPos, { align: 'center' });
              doc.setTextColor(0, 0, 0);
              
              yPos += 6;
            });
            
            yPos += 4; // Espa√ßo entre localiza√ß√µes
          }
        });
        
        // Adicionar p√°gina com itens agrupados por projeto (se houver)
        const itemsWithProject = inventory.filter(i => i.project);
        if (itemsWithProject.length > 0) {
          if (yPos > pageHeight - 40) {
            doc.addPage();
            yPos = margin;
          } else {
            yPos += 10;
          }
          
          doc.setFontSize(14);
          doc.setFont(undefined, 'bold');
          doc.text('Itens por Projeto', margin, yPos);
          yPos += 8;
          
          const projects = [...new Set(itemsWithProject.map(i => i.project))];
          
          projects.forEach(project => {
            if (yPos > pageHeight - 30) {
              doc.addPage();
              yPos = margin;
            }
            
            const projectItems = itemsWithProject.filter(i => i.project === project);
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text(`Projeto: ${project}`, margin, yPos);
            yPos += 6;
            
            doc.setFontSize(7);
            doc.setFont(undefined, 'normal');
            
            projectItems.forEach(item => {
              if (yPos > pageHeight - 15) {
                doc.addPage();
                yPos = margin;
              }
              
              doc.text(`‚Ä¢ ${item.name} (${item.quantity || 0} ${item.unit || 'UN'}) - ${item.location}`, margin + 5, yPos);
              yPos += 5;
            });
            
            yPos += 4;
          });
        }
        
        // Rodap√© em todas as p√°ginas
        const totalPages = doc.internal.pages.length - 1;
        for (let i = 1; i <= totalPages; i++) {
          doc.setPage(i);
          doc.setFontSize(8);
          doc.setTextColor(128, 128, 128);
          doc.text(
            `P√°gina ${i} de ${totalPages}`,
            pageWidth / 2,
            pageHeight - 10,
            { align: 'center' }
          );
        }
        
        // Gerar nome do arquivo
        const fileName = `estoque_${new Date().toISOString().split('T')[0]}.pdf`;
        
        // Salvar PDF
        doc.save(fileName);
        
        showToast('PDF gerado com sucesso!', 'success');
      } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        showToast('Erro ao gerar PDF. Verifique o console para mais detalhes.', 'error');
      }
    }

    function backupData() {
      const backup = {
        inventory: inventory,
        history: history,
        activityLogs: activityLogs,
        users: users,
        timestamp: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `backup_estoque_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      showToast('Backup realizado com sucesso!', 'success');
    }

    function restoreData() {
      const fileInput = document.getElementById('restore-file');
      const file = fileInput.files[0];
      
      if (!file) {
        showToast('Selecione um arquivo de backup!', 'warning');
        return;
      }
      
      if (!confirm('Restaurar backup ir√° substituir todos os dados atuais. Deseja continuar?')) {
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const backup = JSON.parse(e.target.result);
          inventory = backup.inventory || [];
          history = backup.history || [];
          activityLogs = backup.activityLogs || [];
          users = backup.users || [];
          
          saveData();
          saveUsers();
          renderInventory();
          
          showToast('Backup restaurado com sucesso!', 'success');
          fileInput.value = '';
        } catch (error) {
          showToast('Erro ao restaurar backup! Arquivo inv√°lido.', 'error');
        }
      };
      reader.readAsText(file);
    }

    // Vari√°veis globais para importa√ß√£o
    let importedData = null;
    let columnMapping = {};
    let importErrors = [];

    // Fun√ß√£o para lidar com sele√ß√£o de arquivo
    async function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      showLoading('Lendo planilha...');

      try {
        const workbook = XLSX.read(await file.arrayBuffer(), { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });

        if (data.length === 0) {
          hideLoading();
          showToast('Planilha vazia!', 'error');
          return;
        }

        importedData = data;
        hideLoading();
        
        // Detectar colunas automaticamente
        detectColumns(data);
      } catch (error) {
        hideLoading();
        console.error('Erro ao ler planilha:', error);
        showToast('Erro ao ler planilha. Verifique o formato do arquivo.', 'error');
      }
    }

    // Fun√ß√£o para detectar colunas automaticamente
    function detectColumns(data) {
      if (!data || data.length === 0) return;

      const headers = data[0].map(h => String(h || '').toLowerCase().trim());
      const mappingForm = document.getElementById('column-mapping-form');
      
      // Mapeamento inteligente baseado em palavras-chave
      const fieldMap = {
        'code': ['c√≥digo', 'codigo', 'id', 'identifica√ß√£o', 'identificacao'],
        'name': ['nome', 'item', 'item nome', 'descri√ß√£o', 'descricao', 'produto'],
        'quantity': ['quantidade', 'qtd', 'qty', 'estoque', 'saldo'],
        'category': ['categoria', 'categoria do item'],
        'unit': ['unidade', 'un', 'medida'],
        'minQuantity': ['m√≠nimo', 'minimo', 'quantidade m√≠nima', 'estoque m√≠nimo'],
        'location': ['local', 'localiza√ß√£o', 'localizacao', 'dep√≥sito', 'deposito'],
        'expiryDate': ['validade', 'data de validade', 'vencimento', 'expira']
      };

      columnMapping = {};

      // Detectar automaticamente
      Object.keys(fieldMap).forEach(field => {
        const keywords = fieldMap[field];
        for (let i = 0; i < headers.length; i++) {
          const header = headers[i];
          if (keywords.some(keyword => header.includes(keyword))) {
            columnMapping[field] = i;
            break;
          }
        }
      });

      // Criar formul√°rio de mapeamento
      const fields = [
        { key: 'code', label: 'C√≥digo', required: true },
        { key: 'name', label: 'Nome do Item', required: true },
        { key: 'quantity', label: 'Quantidade', required: true },
        { key: 'category', label: 'Categoria', required: false },
        { key: 'unit', label: 'Unidade', required: false },
        { key: 'minQuantity', label: 'Quantidade M√≠nima', required: false },
        { key: 'location', label: 'Localiza√ß√£o', required: false },
        { key: 'expiryDate', label: 'Data de Validade', required: false }
      ];

      mappingForm.innerHTML = fields.map(field => `
        <div class="form-group" style="margin-bottom: 16px;">
          <label class="form-label">
            ${field.label} ${field.required ? '<span style="color: var(--gov-red);">*</span>' : ''}
          </label>
          <select class="form-input" id="map-${field.key}" ${field.required ? 'required' : ''}>
            <option value="">-- Selecione --</option>
            ${headers.map((h, i) => `
              <option value="${i}" ${columnMapping[field.key] === i ? 'selected' : ''}>${h || `Coluna ${i + 1}`}</option>
            `).join('')}
          </select>
        </div>
      `).join('');

      document.getElementById('column-mapping-modal').classList.add('active');
    }

    // Processar mapeamento e validar dados
    async function processColumnMapping() {
      const fields = ['code', 'name', 'quantity', 'category', 'unit', 'minQuantity', 'location', 'expiryDate'];
      
      // Atualizar mapeamento
      fields.forEach(field => {
        const select = document.getElementById(`map-${field}`);
        if (select && select.value !== '') {
          columnMapping[field] = parseInt(select.value);
        } else {
          delete columnMapping[field];
        }
      });

      // Validar campos obrigat√≥rios
      if (columnMapping.code === undefined || columnMapping.name === undefined || columnMapping.quantity === undefined) {
        showToast('Mapeie pelo menos: C√≥digo, Nome e Quantidade!', 'warning');
        return;
      }

      closeModal('column-mapping-modal');
      showLoading('Validando dados...');

      // Processar dados
      const validItems = [];
      importErrors = [];

      for (let i = 1; i < importedData.length; i++) {
        const row = importedData[i];
        if (!row || row.length === 0) continue;

        const item = {};
        const errors = [];

        // Mapear campos
        if (columnMapping.code !== undefined) {
          item.code = String(row[columnMapping.code] || '').trim();
          if (!item.code) errors.push({ field: 'code', message: 'C√≥digo √© obrigat√≥rio' });
        }

        if (columnMapping.name !== undefined) {
          item.name = String(row[columnMapping.name] || '').trim();
          if (!item.name) errors.push({ field: 'name', message: 'Nome √© obrigat√≥rio' });
        }

        if (columnMapping.quantity !== undefined) {
          const qty = parseFloat(row[columnMapping.quantity]);
          if (isNaN(qty) || qty < 0) {
            errors.push({ field: 'quantity', message: `Quantidade inv√°lida: "${row[columnMapping.quantity]}"` });
          } else {
            item.quantity = Math.floor(qty);
          }
        }

        if (columnMapping.category !== undefined) {
          item.category = String(row[columnMapping.category] || '').trim() || 'Outros';
        } else {
          item.category = 'Outros';
        }

        if (columnMapping.unit !== undefined) {
          item.unit = String(row[columnMapping.unit] || '').trim().toUpperCase() || 'UN';
        } else {
          item.unit = 'UN';
        }

        if (columnMapping.minQuantity !== undefined) {
          const minQty = parseFloat(row[columnMapping.minQuantity]);
          item.minQuantity = isNaN(minQty) ? 10 : Math.floor(minQty);
        } else {
          item.minQuantity = 10;
        }

        if (columnMapping.location !== undefined) {
          item.location = String(row[columnMapping.location] || '').trim() || 'ADM';
        } else {
          item.location = 'ADM';
        }

        if (columnMapping.expiryDate !== undefined) {
          const dateStr = String(row[columnMapping.expiryDate] || '').trim();
          if (dateStr) {
            // Tentar parsear data em v√°rios formatos
            const date = parseDate(dateStr);
            item.expiryDate = date ? date.toISOString().split('T')[0] : null;
            if (!date && dateStr) {
              errors.push({ field: 'expiryDate', message: `Data inv√°lida: "${dateStr}"` });
            }
          }
        }

        // Verificar duplicatas
        const existingItem = inventory.find(it => it.code === item.code);
        if (existingItem) {
          errors.push({ field: 'code', message: `C√≥digo j√° existe: ${item.code}` });
        }

        if (errors.length > 0) {
          importErrors.push({ row: i + 1, item, errors, rawRow: row });
        } else {
          validItems.push(item);
        }
      }

      hideLoading();

      // Se houver erros, mostrar modal de corre√ß√£o
      if (importErrors.length > 0) {
        showImportErrorsModal();
      } else {
        // Importar direto se n√£o houver erros
        await importItems(validItems);
      }
    }

    // Fun√ß√£o para parsear data em v√°rios formatos
    function parseDate(dateStr) {
      if (!dateStr) return null;
      
      // Tentar formato ISO (YYYY-MM-DD)
      let date = new Date(dateStr);
      if (!isNaN(date.getTime())) return date;

      // Tentar formato brasileiro (DD/MM/YYYY)
      const brMatch = dateStr.match(/(\d{2})\/(\d{2})\/(\d{4})/);
      if (brMatch) {
        date = new Date(`${brMatch[3]}-${brMatch[2]}-${brMatch[1]}`);
        if (!isNaN(date.getTime())) return date;
      }

      // Tentar formato com Excel (n√∫mero serial)
      const excelNum = parseFloat(dateStr);
      if (!isNaN(excelNum) && excelNum > 25569) {
        // Excel epoch starts at 1900-01-01 (25569 days before Unix epoch)
        date = new Date((excelNum - 25569) * 86400 * 1000);
        if (!isNaN(date.getTime())) return date;
      }

      return null;
    }

    // Mostrar modal de erros
    function showImportErrorsModal() {
      const errorsList = document.getElementById('import-errors-list');
      const errorsCount = document.getElementById('errors-count');
      
      errorsCount.textContent = importErrors.length;
      
      errorsList.innerHTML = importErrors.map((error, idx) => `
        <div style="background: var(--input-bg); padding: 16px; border-radius: 8px; margin-bottom: 12px; border: 1px solid var(--border-color);">
          <div style="font-weight: 600; margin-bottom: 8px; color: var(--gov-red);">
            Linha ${error.row}: ${error.item.name || error.item.code || 'Sem nome'}
          </div>
          ${error.errors.map(e => `
            <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 4px;">
              ‚Ä¢ ${e.field}: ${e.message}
            </div>
          `).join('')}
          <div style="margin-top: 8px; display: flex; gap: 8px;">
            ${error.item.code ? `<input type="text" class="form-input" id="error-code-${idx}" value="${error.item.code}" placeholder="C√≥digo" style="flex: 1;">` : ''}
            ${error.item.name ? `<input type="text" class="form-input" id="error-name-${idx}" value="${error.item.name}" placeholder="Nome" style="flex: 2;">` : ''}
            ${error.item.quantity !== undefined ? `<input type="number" class="form-input" id="error-qty-${idx}" value="${error.item.quantity}" placeholder="Quantidade" style="flex: 1;">` : ''}
          </div>
        </div>
      `).join('');

      document.getElementById('import-errors-modal').classList.add('active');
    }

    // Aplicar corre√ß√µes
    async function applyErrorCorrections() {
      try {
        showLoading('Processando corre√ß√µes...');
        
        const correctedItems = [];

        importErrors.forEach((error, idx) => {
          const codeInput = document.getElementById(`error-code-${idx}`);
          const nameInput = document.getElementById(`error-name-${idx}`);
          const qtyInput = document.getElementById(`error-qty-${idx}`);

          const correctedItem = { ...error.item };
          if (codeInput) correctedItem.code = codeInput.value.trim();
          if (nameInput) correctedItem.name = nameInput.value.trim();
          if (qtyInput) {
            const qty = parseInt(qtyInput.value);
            correctedItem.quantity = isNaN(qty) ? 0 : qty;
          }

          // Garantir campos obrigat√≥rios
          if (!correctedItem.code) return;
          if (!correctedItem.name) return;
          if (correctedItem.quantity === undefined || correctedItem.quantity < 0) {
            correctedItem.quantity = 0;
          }

          // Garantir campos opcionais
          if (!correctedItem.category) correctedItem.category = 'Outros';
          if (!correctedItem.unit) correctedItem.unit = 'UN';
          if (!correctedItem.minQuantity) correctedItem.minQuantity = 10;
          if (!correctedItem.location) correctedItem.location = 'ADM';

          correctedItems.push(correctedItem);
        });

        // Adicionar itens v√°lidos originais
        const validItems = [];
        for (let i = 1; i < importedData.length; i++) {
          const row = importedData[i];
          if (!row) continue;

          const item = {};
          if (columnMapping.code !== undefined) item.code = String(row[columnMapping.code] || '').trim();
          if (columnMapping.name !== undefined) item.name = String(row[columnMapping.name] || '').trim();
          if (columnMapping.quantity !== undefined) {
            const qty = parseFloat(row[columnMapping.quantity]);
            item.quantity = isNaN(qty) ? 0 : Math.floor(qty);
          }

          // Verificar se n√£o est√° na lista de erros
          const hasError = importErrors.some(e => e.row === i + 1);
          if (!hasError && item.code && item.name) {
            // Mapear outros campos
            if (columnMapping.category !== undefined) item.category = String(row[columnMapping.category] || '').trim() || 'Outros';
            else item.category = 'Outros';
            if (columnMapping.unit !== undefined) item.unit = String(row[columnMapping.unit] || '').trim().toUpperCase() || 'UN';
            else item.unit = 'UN';
            if (columnMapping.minQuantity !== undefined) {
              const minQty = parseFloat(row[columnMapping.minQuantity]);
              item.minQuantity = isNaN(minQty) ? 10 : Math.floor(minQty);
            } else item.minQuantity = 10;
            if (columnMapping.location !== undefined) item.location = String(row[columnMapping.location] || '').trim() || 'ADM';
            else item.location = 'ADM';
            if (columnMapping.expiryDate !== undefined) {
              const dateStr = String(row[columnMapping.expiryDate] || '').trim();
              if (dateStr) {
                const date = parseDate(dateStr);
                item.expiryDate = date ? date.toISOString().split('T')[0] : null;
              }
            }
            validItems.push(item);
          }
        }

        closeModal('import-errors-modal');
        await importItems([...validItems, ...correctedItems]);
      } catch (error) {
        hideLoading();
        console.error('Erro ao aplicar corre√ß√µes:', error);
        showToast(`Erro ao aplicar corre√ß√µes: ${error.message || 'Erro desconhecido'}`, 'error');
      }
    }

    // Ignorar erros e importar apenas v√°lidos
    async function skipErrorsAndImport() {
      try {
        showLoading('Processando importa√ß√£o...');
        
        const validItems = [];
        const errorRows = importErrors.map(e => e.row);

        for (let i = 1; i < importedData.length; i++) {
          if (errorRows.includes(i + 1)) continue;

          const row = importedData[i];
          if (!row) continue;

          const item = {};
          if (columnMapping.code !== undefined) item.code = String(row[columnMapping.code] || '').trim();
          if (columnMapping.name !== undefined) item.name = String(row[columnMapping.name] || '').trim();
          if (columnMapping.quantity !== undefined) {
            const qty = parseFloat(row[columnMapping.quantity]);
            item.quantity = isNaN(qty) ? 0 : Math.floor(qty);
          }

          if (!item.code || !item.name) continue;

          if (columnMapping.category !== undefined) item.category = String(row[columnMapping.category] || '').trim() || 'Outros';
          else item.category = 'Outros';
          if (columnMapping.unit !== undefined) item.unit = String(row[columnMapping.unit] || '').trim().toUpperCase() || 'UN';
          else item.unit = 'UN';
          if (columnMapping.minQuantity !== undefined) {
            const minQty = parseFloat(row[columnMapping.minQuantity]);
            item.minQuantity = isNaN(minQty) ? 10 : Math.floor(minQty);
          } else item.minQuantity = 10;
          if (columnMapping.location !== undefined) item.location = String(row[columnMapping.location] || '').trim() || 'ADM';
          else item.location = 'ADM';
          if (columnMapping.expiryDate !== undefined) {
            const dateStr = String(row[columnMapping.expiryDate] || '').trim();
            if (dateStr) {
              const date = parseDate(dateStr);
              item.expiryDate = date ? date.toISOString().split('T')[0] : null;
            }
          }

          validItems.push(item);
        }

        closeModal('import-errors-modal');
        await importItems(validItems);
      } catch (error) {
        hideLoading();
        console.error('Erro ao ignorar erros e importar:', error);
        showToast(`Erro ao importar: ${error.message || 'Erro desconhecido'}`, 'error');
      }
    }

    // Importar itens para Firestore (com fallback para localStorage)
    async function importItems(items) {
      if (!items || items.length === 0) {
        hideLoading();
        showToast('Nenhum item v√°lido para importar!', 'warning');
        return;
      }

      try {
        let successCount = 0;
        let failedCount = 0;
        const itemsToSave = [];

        // Preparar itens
        for (const item of items) {
          // Validar item
          if (!item.code || !item.name) {
            failedCount++;
            continue;
          }

          // Gerar ID √∫nico se n√£o existir c√≥digo
          const itemId = item.code || `ITEM_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          
          // Verificar se j√° existe
          const existingItem = inventory.find(it => it.code === item.code);
          if (existingItem) {
            failedCount++;
            continue;
          }

          // Criar item completo - garantir que ID seja string
          const newItem = {
            id: String(itemId), // Garantir que ID seja sempre string
            code: item.code || String(itemId),
            name: item.name,
            quantity: item.quantity || 0,
            category: item.category || 'Outros',
            unit: item.unit || 'UN',
            minQuantity: item.minQuantity || 10,
            location: item.location || 'ADM',
            expiryDate: item.expiryDate || null
          };

          itemsToSave.push(newItem);
        }

        // Tentar salvar no Firestore
        if (window.db) {
          try {
            const { setDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            // Processar em lotes para n√£o sobrecarregar
            const batchSize = 10;
            for (let i = 0; i < itemsToSave.length; i += batchSize) {
              const batch = itemsToSave.slice(i, i + batchSize);
              
              for (const newItem of batch) {
                try {
                  await setDoc(doc(window.db, 'inventory', newItem.id.toString()), newItem);
                  successCount++;
                  showLoading(`Importando ${Math.min(i + batch.length, itemsToSave.length)} de ${itemsToSave.length} itens...`);
                } catch (error) {
                  console.error('Erro ao importar item no Firestore:', newItem, error);
                  failedCount++;
                }
              }
            }
          } catch (firestoreError) {
            console.warn('Erro ao acessar Firestore, salvando localmente:', firestoreError);
            // Fallback: salvar localmente
            for (const newItem of itemsToSave) {
              try {
                // Garantir que o ID seja string
                newItem.id = String(newItem.id || newItem.code);
                inventory.push(newItem);
                successCount++;
              } catch (error) {
                console.error('Erro ao salvar item localmente:', newItem, error);
                failedCount++;
              }
            }
            // Salvar no localStorage
            localStorage.setItem('inventory', JSON.stringify(inventory));
            showToast(`${successCount} itens importados localmente (Firestore n√£o dispon√≠vel). Crie o Firestore para sincroniza√ß√£o.`, 'warning');
          }
        } else {
          // Firestore n√£o dispon√≠vel, salvar localmente
          for (const newItem of itemsToSave) {
            try {
              // Garantir que o ID seja string
              newItem.id = String(newItem.id || newItem.code);
              inventory.push(newItem);
              successCount++;
            } catch (error) {
              console.error('Erro ao salvar item localmente:', newItem, error);
              failedCount++;
            }
          }
          // Salvar no localStorage
          localStorage.setItem('inventory', JSON.stringify(inventory));
          showToast(`${successCount} itens importados localmente (Firestore n√£o dispon√≠vel). Crie o Firestore para sincroniza√ß√£o.`, 'warning');
        }

        hideLoading();

        // Mostrar resultados
        showImportResults(successCount, failedCount);
        
        if (successCount > 0) {
          // Atualizar interface
          if (typeof renderInventory === 'function') {
            renderInventory();
          }
        } else if (failedCount > 0) {
          showToast(`Nenhum item foi importado. ${failedCount} itens falharam.`, 'error');
        }
      } catch (error) {
        hideLoading();
        console.error('Erro ao importar itens:', error);
        showToast(`Erro ao importar itens: ${error.message || 'Erro desconhecido'}`, 'error');
      }
    }

    // Mostrar resultados da importa√ß√£o
    function showImportResults(successCount, failedCount) {
      const successEl = document.getElementById('import-success-count');
      const failedEl = document.getElementById('import-failed-count');
      
      successEl.textContent = successCount;
      
      if (failedCount > 0) {
        failedEl.style.display = 'block';
        failedEl.querySelector('h3').textContent = failedCount;
      } else {
        failedEl.style.display = 'none';
      }

      document.getElementById('import-results-modal').classList.add('active');
    }

    // Fun√ß√µes de loading
    function showLoading(text = 'Processando...') {
      document.getElementById('loading-text').textContent = text;
      document.getElementById('loading-overlay').style.display = 'flex';
    }

    function hideLoading() {
      document.getElementById('loading-overlay').style.display = 'none';
    }

    // Fun√ß√µes de verifica√ß√£o do Firestore
    function updateFirestoreStatus(connected, error = null) {
      const statusEl = document.getElementById('firestore-status');
      const iconEl = document.getElementById('firestore-status-icon');
      const textEl = document.getElementById('firestore-status-text');
      const detailEl = document.getElementById('firestore-status-detail');
      
      if (!statusEl || !iconEl || !textEl || !detailEl) return;
      
      if (connected) {
        statusEl.style.background = 'rgba(124, 179, 66, 0.1)';
        statusEl.style.border = '1px solid rgba(124, 179, 66, 0.3)';
        iconEl.textContent = 'check_circle';
        iconEl.style.color = 'var(--gov-green)';
        textEl.textContent = '‚úÖ Firestore Conectado';
        detailEl.textContent = 'Sincroniza√ß√£o em tempo real ativa. Dados sendo salvos na nuvem.';
      } else {
        statusEl.style.background = 'rgba(229, 57, 53, 0.1)';
        statusEl.style.border = '1px solid rgba(229, 57, 53, 0.3)';
        iconEl.textContent = 'error';
        iconEl.style.color = 'var(--gov-red)';
        textEl.textContent = '‚ùå Firestore N√£o Conectado';
        
        if (error) {
          if (error.includes('does not exist') || error.includes('not-found')) {
            detailEl.textContent = 'Firestore n√£o foi criado ainda. Os dados est√£o sendo salvos localmente.';
          } else {
            detailEl.textContent = `Erro: ${error}`;
          }
        } else {
          detailEl.textContent = 'Os dados est√£o sendo salvos localmente. Crie o Firestore para sincroniza√ß√£o.';
        }
      }
    }

    async function testFirestoreConnection() {
      const statusEl = document.getElementById('firestore-status');
      const iconEl = document.getElementById('firestore-status-icon');
      const textEl = document.getElementById('firestore-status-text');
      const detailEl = document.getElementById('firestore-status-detail');
      
      if (statusEl) {
        statusEl.style.background = 'rgba(74, 144, 226, 0.1)';
        statusEl.style.border = '1px solid rgba(74, 144, 226, 0.3)';
      }
      if (iconEl) {
        iconEl.textContent = 'sync';
        iconEl.style.color = 'var(--gov-blue)';
        iconEl.style.animation = 'spin 1s linear infinite';
      }
      if (textEl) textEl.textContent = 'üîÑ Testando conex√£o...';
      if (detailEl) detailEl.textContent = 'Aguarde...';
      
      try {
        if (window.checkFirestoreStatus) {
          const isConnected = await window.checkFirestoreStatus();
          updateFirestoreStatus(isConnected, window.firestoreStatus?.error || null);
          
          if (isConnected) {
            showToast('‚úÖ Firestore est√° conectado e funcionando!', 'success');
          } else {
            const errorMsg = window.firestoreStatus?.error || 'Firestore n√£o dispon√≠vel';
            showToast(`‚ö†Ô∏è Firestore n√£o est√° conectado: ${errorMsg}`, 'warning');
          }
        } else {
          // Fallback: tentar escrever um documento de teste
          if (window.db) {
            const { doc, setDoc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const testRef = doc(window.db, '_test', 'connection');
            await setDoc(testRef, { timestamp: new Date().toISOString() });
            await deleteDoc(testRef);
            updateFirestoreStatus(true);
            showToast('‚úÖ Firestore est√° conectado e funcionando!', 'success');
          } else {
            updateFirestoreStatus(false, 'Firestore n√£o inicializado');
            showToast('‚ùå Firestore n√£o foi inicializado', 'error');
          }
        }
      } catch (error) {
        console.error('Erro ao testar Firestore:', error);
        const errorMsg = error.message || error.code || 'Erro desconhecido';
        updateFirestoreStatus(false, errorMsg);
        showToast(`‚ùå Erro ao testar Firestore: ${errorMsg}`, 'error');
      } finally {
        if (iconEl) {
          iconEl.style.animation = '';
        }
      }
    }


    // Expor fun√ß√µes de importa√ß√£o globalmente (ap√≥s todas as defini√ß√µes)
    window.applyErrorCorrections = applyErrorCorrections;
    window.skipErrorsAndImport = skipErrorsAndImport;
    window.importItems = importItems;
    window.handleFileSelect = handleFileSelect;
    window.processColumnMapping = processColumnMapping;
    window.showImportResults = showImportResults;
    window.showImportErrorsModal = showImportErrorsModal;
    window.showLoading = showLoading;
    window.hideLoading = hideLoading;
    window.updateFirestoreStatus = updateFirestoreStatus;
    window.testFirestoreConnection = testFirestoreConnection;
    window.updateQuantityPreview = updateQuantityPreview;
    window.validateLoginPassword = validateLoginPassword;

    // Fun√ß√µes de editar/excluir itens
    function openEditItemModal(itemId) {
      console.log('openEditItemModal chamada com itemId:', itemId);
      try {
      const itemIdStr = String(itemId);
        const item = inventory.find(i => String(i.id) === itemIdStr);
      
      if (!item) {
          console.error('Item n√£o encontrado:', itemId);
        showToast('Item n√£o encontrado', 'error');
        return;
      }
      
      currentItem = item;
      
        // Garantir que os projetos estejam sincronizados antes de abrir o modal
        syncCoursesWithProjects();
        
      document.getElementById('edit-item-name').value = item.name || '';
      document.getElementById('edit-item-category').value = item.category || 'Outros';
      document.getElementById('edit-item-unit').value = item.unit || 'UN';
      document.getElementById('edit-item-quantity').value = item.quantity || 0;
      document.getElementById('edit-item-min-quantity').value = item.minQuantity || 10;
      document.getElementById('edit-item-location').value = item.location || 'ADM';
      document.getElementById('edit-item-expiry').value = item.expiryDate || '';
      
        // Atualizar selects de projetos
      updateProjectSelects();
        
        // Aguardar um pouco para garantir que o select foi atualizado antes de definir o valor
      setTimeout(() => {
          const projectSelect = document.getElementById('edit-item-project');
          if (projectSelect) {
            projectSelect.value = item.project || '';
            console.log('Valor do projeto definido:', item.project);
            // Se o valor n√£o foi definido, verificar se o projeto existe
            if (item.project && projectSelect.value !== item.project) {
              console.warn('Projeto n√£o encontrado no select:', item.project);
              console.log('Projetos dispon√≠veis:', projects.map(p => p.name));
            }
          } else {
            console.error('Select edit-item-project n√£o encontrado');
          }
        }, 100);
        
        const modal = document.getElementById('edit-item-modal');
        if (modal) {
          modal.classList.add('active');
          console.log('Modal de editar item aberto');
        } else {
          console.error('Modal edit-item-modal n√£o encontrado');
        }
      } catch (error) {
        console.error('Erro ao abrir modal de editar item:', error);
        showToast('Erro ao abrir modal de editar item', 'error');
      }
    }

    async function saveItemEdit(e) {
      e.preventDefault();
      
      if (!currentItem) {
        showToast('Erro: Item n√£o selecionado', 'error');
        return;
      }
      
      const project = document.getElementById('edit-item-project').value;
      // Projeto √© opcional, n√£o precisa validar

      const updatedItem = {
        ...currentItem,
        name: document.getElementById('edit-item-name').value.trim(),
        category: document.getElementById('edit-item-category').value,
        unit: document.getElementById('edit-item-unit').value,
        quantity: parseInt(document.getElementById('edit-item-quantity').value) || 0,
        minQuantity: parseInt(document.getElementById('edit-item-min-quantity').value) || 10,
        location: document.getElementById('edit-item-location').value,
        project: project,
        expiryDate: document.getElementById('edit-item-expiry').value || null
      };
      
      try {
        if (window.db) {
          try {
          const { updateDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const itemDocId = String(currentItem.id);
          await updateDoc(doc(window.db, 'inventory', itemDocId), updatedItem);
          } catch (firestoreError) {
            console.warn('Erro ao atualizar no Firestore, usando fallback local:', firestoreError);
            // Continuar com fallback local
          }
        }
        
        // Sempre atualizar localmente tamb√©m
        const index = inventory.findIndex(i => String(i.id) === String(currentItem.id));
          if (index !== -1) {
            inventory[index] = { ...inventory[index], ...updatedItem };
            localStorage.setItem('inventory', JSON.stringify(inventory));
        }
        
        logActivity('Edi√ß√£o', `Editou o item ${updatedItem.name}`, 'edit');
        showToast('Item editado com sucesso!', 'success');
        closeModal('edit-item-modal');
        renderInventory();
      } catch (error) {
        console.error('Erro ao editar item:', error);
        showToast('Erro ao editar item. Tente novamente.', 'error');
      }
    }

    function confirmDeleteItem(itemId) {
      const itemIdStr = String(itemId);
      const item = inventory.find(i => String(i.id) === itemIdStr);
      
      if (!item) {
        showToast('Item n√£o encontrado', 'error');
        return;
      }
      
      if (!confirm(`Tem certeza que deseja excluir o item "${item.name}"?\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
        return;
      }
      
      deleteItem(itemId);
    }

    async function deleteItem() {
      if (!currentItem) {
        showToast('Item n√£o encontrado', 'error');
        return;
      }
      
      if (!confirm(`Tem certeza que deseja excluir o item "${currentItem.name}"? Esta a√ß√£o n√£o pode ser desfeita.`)) {
        return;
      }
      
      try {
        if (window.db) {
          try {
          const { deleteDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const itemDocId = String(currentItem.id);
          await deleteDoc(doc(window.db, 'inventory', itemDocId));
          } catch (firestoreError) {
            console.warn('Erro ao excluir no Firestore, usando fallback local:', firestoreError);
            // Continuar com fallback local
          }
        }
        
        // Sempre remover localmente tamb√©m
        inventory = inventory.filter(i => String(i.id) !== String(currentItem.id));
        localStorage.setItem('inventory', JSON.stringify(inventory));
        
        logActivity('Exclus√£o', `Excluiu o item ${currentItem.name}`, 'delete');
        showToast('Item exclu√≠do com sucesso!', 'success');
        closeModal('edit-item-modal');
        renderInventory();
      } catch (error) {
        console.error('Erro ao excluir item:', error);
        showToast('Erro ao excluir item. Tente novamente.', 'error');
      }
    }

    // Sistema de withdrawals/movimenta√ß√µes
    function initWithdrawalsSync() {
      // Carregar withdrawals do localStorage na inicializa√ß√£o
      // A sincroniza√ß√£o com Firestore ser√° iniciada ap√≥s autentica√ß√£o
      loadWithdrawalsLocal();
    }

    window.startWithdrawalsSync = function() {
      if (withdrawalsUnsubscribe) {
        return;
      }
      
      try {
        if (window.db) {
          // Importar dinamicamente
          import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js').then(async ({ collection, onSnapshot, query, orderBy }) => {
            try {
              const withdrawalsRef = collection(window.db, 'withdrawals');
              
              // Tentar com orderBy primeiro, se falhar tenta sem
              let q;
              try {
                q = query(withdrawalsRef, orderBy('createdAt', 'desc'));
              } catch (e) {
                // Se n√£o tiver √≠ndice para orderBy, usar sem ordena√ß√£o
                console.warn('Usando query sem orderBy:', e);
                q = withdrawalsRef;
              }
              
              withdrawalsUnsubscribe = onSnapshot(q, 
                (snapshot) => {
                  // Mapear withdrawals do Firestore
                  const firestoreWithdrawals = snapshot.docs.map(doc => {
                    const data = doc.data();
                    // Verificar se tem curso (n√£o converter null/undefined para string)
                    const courseValue = data.course || data.courseName;
                    const hasCourse = courseValue && courseValue.toString().trim() !== '' && courseValue.toString().trim() !== 'null';
                    
                    const withdrawalData = {
                      id: doc.id,
                      ...data,
                      // Garantir que campos essenciais existam
                      withdrawalDate: data.withdrawalDate || data.withdrawal_date || '',
                      expectedReturnDate: data.expectedReturnDate || data.expected_return_date || data.returnDate || '',
                      course: hasCourse ? (data.course || data.courseName) : null,
                      courseName: hasCourse ? (data.courseName || data.course) : null, // Compatibilidade
                      itemName: data.itemName || data.item_name || 'Item sem nome',
                      quantity: data.quantity || 0,
                      unit: data.unit || 'UN',
                      location: data.location || 'N/A',
                      userName: data.userName || data.user_name || 'Sistema',
                      withdrawalReason: data.withdrawalReason || data.reason || '',
                      returnedDate: data.returnedDate || data.returned_date || null
                    };
                    withdrawalData.status = getWithdrawalStatus(withdrawalData);
                    return withdrawalData;
                  });
                  
                  // Carregar withdrawals do localStorage para mesclar
                  let localWithdrawals = [];
                  try {
                    const saved = localStorage.getItem('withdrawals');
                    if (saved) {
                      localWithdrawals = JSON.parse(saved);
                      // Normalizar campos course e courseName
                      localWithdrawals.forEach(w => {
                        const courseValue = w.course || w.courseName;
                        const hasCourse = courseValue && courseValue.toString().trim() !== '' && courseValue.toString().trim() !== 'null';
                        w.course = hasCourse ? (w.course || w.courseName) : null;
                        w.courseName = hasCourse ? (w.courseName || w.course) : null;
                        w.status = getWithdrawalStatus(w);
                      });
                    }
                  } catch (error) {
                    console.warn('Erro ao carregar withdrawals do localStorage para mesclar:', error);
                  }
                  
                  // Mesclar: usar Firestore como fonte principal, mas adicionar locais que n√£o est√£o no Firestore
                  const firestoreIds = new Set(firestoreWithdrawals.map(w => w.id));
                  const localOnly = localWithdrawals.filter(w => w.id && !firestoreIds.has(w.id));
                  
                  withdrawals = [...firestoreWithdrawals, ...localOnly];
                  
                  console.log('Withdrawals sincronizados do Firestore:', firestoreWithdrawals.length);
                  console.log('Withdrawals locais adicionais:', localOnly.length);
                  console.log('Total de withdrawals ap√≥s mesclagem:', withdrawals.length);
                  console.log('Cursos encontrados:', [...new Set(withdrawals.map(w => w.course || w.courseName))]);
                  
                  // Ordenar por data de cria√ß√£o (mais recente primeiro)
                  withdrawals.sort((a, b) => {
                    const dateA = a.createdAt?.toDate?.() || new Date(a.withdrawalDate || 0);
                    const dateB = b.createdAt?.toDate?.() || new Date(b.withdrawalDate || 0);
                    return dateB - dateA;
                  });
                  
                  // Atualizar refer√™ncia global
                  window.withdrawals = withdrawals;
                  
                  // Salvar no localStorage ap√≥s mesclagem
                  try {
                    localStorage.setItem('withdrawals', JSON.stringify(withdrawals));
                  } catch (error) {
                    console.warn('Erro ao salvar withdrawals mesclados no localStorage:', error);
                  }
                  
                  console.log('Withdrawals atualizados:', withdrawals.length);
                  
                  if (window.renderWithdrawals) {
                    renderWithdrawals();
                  }
                  
                  // Atualizar gavetas tamb√©m se estiver na p√°gina
                  if (window.renderDrawers && document.getElementById('drawers-page')?.classList.contains('active')) {
                    renderDrawers();
                  }
                },
                (error) => {
                  // Se for erro de permiss√£o, apenas usar fallback local sem mostrar erro
                  if (error.code === 'permission-denied' || error.message?.includes('permissions')) {
                    console.log('Permiss√µes do Firestore n√£o dispon√≠veis, usando dados locais');
                  } else {
                  console.error('Erro ao sincronizar withdrawals:', error);
                  }
                  // Tentar carregar localmente se Firestore falhar
                  loadWithdrawalsLocal();
                }
              );
              
              console.log('‚úÖ Sincroniza√ß√£o de withdrawals iniciada');
            } catch (error) {
              console.error('Erro ao configurar query de withdrawals:', error);
              loadWithdrawalsLocal();
            }
          }).catch(error => {
            console.error('Erro ao importar Firestore:', error);
            loadWithdrawalsLocal();
          });
        } else {
          loadWithdrawalsLocal();
        }
      } catch (error) {
        console.error('Erro ao configurar sincroniza√ß√£o de withdrawals:', error);
        loadWithdrawalsLocal();
      }
    };

    // Carregar withdrawals localmente como fallback
    function loadWithdrawalsLocal() {
      try {
        const saved = localStorage.getItem('withdrawals');
        if (saved) {
          const loadedWithdrawals = JSON.parse(saved);
          console.log('Withdrawals carregados do localStorage:', loadedWithdrawals.length);
          
          // Normalizar campos course e courseName
          loadedWithdrawals.forEach(w => {
            // Normalizar campos course e courseName (garantir que null/undefined n√£o sejam strings)
            const courseValue = w.course || w.courseName;
            const hasCourse = courseValue && courseValue.toString().trim() !== '' && courseValue.toString().trim() !== 'null';
            w.course = hasCourse ? (w.course || w.courseName) : null;
            w.courseName = hasCourse ? (w.courseName || w.course) : null;
            w.status = getWithdrawalStatus(w);
          });
          
          // Mesclar com withdrawals existentes (evitar duplicatas)
          const existingIds = new Set(withdrawals.map(w => w.id));
          const newWithdrawals = loadedWithdrawals.filter(w => w.id && !existingIds.has(w.id));
          
          if (newWithdrawals.length > 0) {
            console.log('Adicionando', newWithdrawals.length, 'novos withdrawals do localStorage');
            withdrawals.push(...newWithdrawals);
          }
          
          // Se n√£o havia withdrawals, usar os carregados
          if (withdrawals.length === 0 && loadedWithdrawals.length > 0) {
            withdrawals = loadedWithdrawals;
            console.log('Usando withdrawals do localStorage:', withdrawals.length);
          }
          
          // Atualizar refer√™ncia global
          window.withdrawals = withdrawals;
          
          if (window.renderWithdrawals) {
            renderWithdrawals();
          }
        } else {
          console.log('Nenhum withdrawal encontrado no localStorage');
        }
      } catch (error) {
        console.error('Erro ao carregar withdrawals localmente:', error);
      }
    }

    function getWithdrawalStatus(withdrawal) {
      if (!withdrawal) return 'in_use';
      
      // Verificar se j√° foi devolvido
      if (withdrawal.returnedDate || withdrawal.returned_date) {
        return 'returned';
      }
      
      // Verificar se est√° atrasado
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const returnDateStr = withdrawal.expectedReturnDate || withdrawal.expected_return_date || withdrawal.returnDate;
      if (returnDateStr) {
        const returnDate = new Date(returnDateStr);
        returnDate.setHours(0, 0, 0, 0);
        
        if (today > returnDate) {
          return 'overdue';
        }
      }
      
      return 'in_use';
    }

    function renderWithdrawals() {
      const content = document.getElementById('withdrawals-content');
      // Se o elemento n√£o existir, pode ser que estejamos na p√°gina drawers
      // Nesse caso, usar renderIsolatedWithdrawals
      if (!content) {
        // Se estiver na p√°gina drawers, renderizar l√°
        if (document.getElementById('drawers-page')?.classList.contains('active')) {
          if (window.renderIsolatedWithdrawals) {
            renderIsolatedWithdrawals();
          }
        }
        return;
      }
      
      // Se o array estiver vazio, tentar carregar do localStorage
      if (!withdrawals || withdrawals.length === 0) {
        console.log('Array withdrawals vazio, tentando carregar do localStorage...');
        loadWithdrawalsLocal();
      }
      
      console.log('Renderizando withdrawals. Total:', withdrawals.length);
      
      if (!withdrawals || withdrawals.length === 0) {
        content.innerHTML = '<div class="empty-state">Nenhum item retirado encontrado. Quando voc√™ retirar um item do estoque, ele aparecer√° aqui.</div>';
        return;
      }
      
      // Separar itens isolados de itens de cursos/projetos (mostrar TODOS, incluindo devolvidos)
      const isolatedWithdrawals = withdrawals.filter(w => {
        if (!w) return false;
        // Verificar se tem curso (considerando null, undefined, string vazia)
        const course = w.course || w.courseName;
        const hasCourse = course && course.toString().trim() !== '' && course.toString().trim() !== 'null';
        return !hasCourse; // Mostrar todos os itens isolados, independente do status
      });
      
      const courseWithdrawals = withdrawals.filter(w => {
        if (!w) return false;
        // Verificar se tem curso (considerando null, undefined, string vazia)
        const course = w.course || w.courseName;
        const hasCourse = course && course.toString().trim() !== '' && course.toString().trim() !== 'null';
        return hasCourse; // Mostrar todos os itens de cursos/projetos, independente do status
      });
      
      console.log('Itens isolados encontrados:', isolatedWithdrawals.length);
      console.log('Itens de cursos encontrados:', courseWithdrawals.length);
      console.log('Total de withdrawals processados:', withdrawals.length);
      
      // Debug: mostrar alguns exemplos
      if (isolatedWithdrawals.length > 0) {
        console.log('Exemplo de withdrawal isolado:', {
          id: isolatedWithdrawals[0].id,
          itemName: isolatedWithdrawals[0].itemName,
          course: isolatedWithdrawals[0].course,
          courseName: isolatedWithdrawals[0].courseName,
          hasCourse: !!(isolatedWithdrawals[0].course || isolatedWithdrawals[0].courseName)
        });
      }
      if (courseWithdrawals.length > 0) {
        console.log('Exemplo de withdrawal de curso:', {
          id: courseWithdrawals[0].id,
          itemName: courseWithdrawals[0].itemName,
          course: courseWithdrawals[0].course,
          courseName: courseWithdrawals[0].courseName
        });
      }
      
      // Debug: mostrar todos os withdrawals e seus campos course
      console.log('Todos os withdrawals e seus cursos:', withdrawals.map(w => ({
        id: w.id,
        itemName: w.itemName,
        course: w.course,
        courseName: w.courseName,
        courseType: typeof w.course,
        courseNameType: typeof w.courseName
      })));
      
      // Agrupar por curso/projeto
      const groupedByCourse = {};
      courseWithdrawals.forEach(w => {
        const courseName = w.course || w.courseName || 'Sem curso/projeto';
        if (!groupedByCourse[courseName]) {
          groupedByCourse[courseName] = [];
        }
        groupedByCourse[courseName].push(w);
      });
      
      let html = '';
      
      // Se√ß√£o: Itens Retirados Isoladamente
      if (isolatedWithdrawals.length > 0) {
        html += `
          <div class="withdrawals-section">
            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
              <span class="material-icons" style="font-size: 24px;">inventory_2</span>
              Itens Retirados Isoladamente
            </h3>
            <div class="withdrawals-shelf-grid">
              ${isolatedWithdrawals.map(w => {
                const status = getWithdrawalStatus(w);
                const statusLabels = {
                  in_use: 'Em Uso',
                  overdue: 'Atrasado',
                  returned: 'Devolvido'
                };
                const returnDate = w.expectedReturnDate || w.expected_return_date || null;
                const returnDateText = returnDate ? formatDate(returnDate) : 'Sem prazo';
                
                return `
                  <div class="withdrawal-shelf-item">
                    <div class="withdrawal-shelf-item-header">
                      <span class="withdrawal-status ${status}">${statusLabels[status]}</span>
                    </div>
                    <div class="withdrawal-shelf-item-name">${w.itemName || w.item_name || 'Item sem nome'}</div>
                    <div class="withdrawal-shelf-item-details">
                      <strong>Quantidade:</strong> ${w.quantity || 0} ${w.unit || 'UN'}
                    </div>
                    <div class="withdrawal-shelf-item-details">
                      <strong>Data de Retirada:</strong> ${formatDate(w.withdrawalDate || w.withdrawal_date || '')}
                    </div>
                    <div class="withdrawal-shelf-item-details" style="color: ${status === 'overdue' ? 'var(--gov-red)' : status === 'returned' ? 'var(--gov-green)' : 'var(--text-secondary)'};">
                      <strong>Data/Prazo de Devolu√ß√£o:</strong> ${returnDateText}
                    </div>
                    ${(w.returnedDate || w.returned_date) ? `
                      <div class="withdrawal-shelf-item-details" style="color: var(--gov-green); margin-top: 4px;">
                        <strong>‚úÖ Devolvido em:</strong> ${formatDate(w.returnedDate || w.returned_date)}
                      </div>
                    ` : ''}
                    ${(w.withdrawalReason || w.reason) ? `
                      <div class="withdrawal-shelf-item-details" style="margin-top: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 6px; font-size: 12px;">
                        <strong>Motivo:</strong> ${w.withdrawalReason || w.reason}
                      </div>
                    ` : ''}
                    ${status !== 'returned' ? `
                      <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 12px;">
                        <button class="submit-btn btn-success" style="padding: 8px; font-size: 14px;" onclick="markAsReturned('${w.id}')">
                          <span class="material-icons" style="font-size: 18px; vertical-align: middle;">check_circle</span>
                          Devolver Tudo
                        </button>
                        <button class="submit-btn" style="padding: 8px; font-size: 14px; background: transparent; border-color: var(--gov-yellow); color: var(--gov-yellow);" onclick="openPartialReturnModal('${w.id}')">
                          <span class="material-icons" style="font-size: 18px; vertical-align: middle;">partial</span>
                          Devolu√ß√£o Parcial
                        </button>
                      </div>
                    ` : ''}
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }
      
      // Se√ß√£o: Itens Retirados para Cursos/Projetos
      if (Object.keys(groupedByCourse).length > 0) {
        html += `
          <div class="withdrawals-section" style="margin-top: ${isolatedWithdrawals.length > 0 ? '32px' : '0'};">
            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
              <span class="material-icons" style="font-size: 24px;">folder</span>
              Itens Retirados para Cursos/Projetos
            </h3>
            ${Object.keys(groupedByCourse).map(courseName => {
              const courseItems = groupedByCourse[courseName];
              const totalQuantity = courseItems.reduce((sum, w) => sum + (w.quantity || 0), 0);
        const overdueItems = courseItems.filter(w => getWithdrawalStatus(w) === 'overdue');
        
        // Encontrar data de retorno mais pr√≥xima
        let nearestReturnDate = null;
              courseItems.forEach(w => {
                const returnDate = w.expectedReturnDate || w.expected_return_date;
          if (returnDate) {
            if (!nearestReturnDate || new Date(returnDate) < new Date(nearestReturnDate)) {
              nearestReturnDate = returnDate;
            }
          }
        });
        
        return `
                <div class="withdrawals-group" style="margin-bottom: 24px;">
          <div class="withdrawals-group-header">
                    <div class="withdrawals-group-title">${courseName}</div>
            <div class="withdrawals-group-summary">
              <span class="badge">üì¶ ${totalQuantity} itens</span>
              ${overdueItems.length > 0 ? `<span class="badge" style="background: rgba(229, 57, 53, 0.1); color: var(--gov-red);">‚ö†Ô∏è ${overdueItems.length} atrasado${overdueItems.length > 1 ? 's' : ''}</span>` : ''}
              ${nearestReturnDate ? `<span class="badge" style="background: rgba(255, 193, 7, 0.1); color: var(--gov-yellow);">üìÖ Retorno: ${formatDate(nearestReturnDate)}</span>` : ''}
            </div>
          </div>
          <div class="withdrawals-shelf-grid">
                    ${courseItems.map(w => {
              const status = getWithdrawalStatus(w);
              const statusLabels = {
                in_use: 'Em Uso',
                overdue: 'Atrasado',
                returned: 'Devolvido'
              };
                      const returnDate = w.expectedReturnDate || w.expected_return_date || null;
                      const returnDateText = returnDate ? formatDate(returnDate) : 'Sem prazo';
              
              return `
                <div class="withdrawal-shelf-item">
                  <div class="withdrawal-shelf-item-header">
                            <span class="withdrawal-status ${status}">${statusLabels[status]}</span>
                  </div>
                  <div class="withdrawal-shelf-item-name">${w.itemName || w.item_name || 'Item sem nome'}</div>
                  <div class="withdrawal-shelf-item-details">
                    <strong>Quantidade:</strong> ${w.quantity || 0} ${w.unit || 'UN'}
                  </div>
                  <div class="withdrawal-shelf-item-details">
                            <strong>Data de Retirada:</strong> ${formatDate(w.withdrawalDate || w.withdrawal_date || '')}
                  </div>
                  <div class="withdrawal-shelf-item-details" style="color: ${status === 'overdue' ? 'var(--gov-red)' : status === 'returned' ? 'var(--gov-green)' : 'var(--text-secondary)'};">
                            <strong>Data/Prazo de Devolu√ß√£o:</strong> ${returnDateText}
                  </div>
                  ${(w.returnedDate || w.returned_date) ? `
                            <div class="withdrawal-shelf-item-details" style="color: var(--gov-green); margin-top: 4px;">
                              <strong>‚úÖ Devolvido em:</strong> ${formatDate(w.returnedDate || w.returned_date)}
                    </div>
                  ` : ''}
                  ${status !== 'returned' ? `
                            <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 12px;">
                              <button class="submit-btn btn-success" style="padding: 8px; font-size: 14px;" onclick="markAsReturned('${w.id}')">
                                <span class="material-icons" style="font-size: 18px; vertical-align: middle;">check_circle</span>
                                Devolver Tudo
                    </button>
                              <button class="submit-btn" style="padding: 8px; font-size: 14px; background: transparent; border-color: var(--gov-yellow); color: var(--gov-yellow);" onclick="openPartialReturnModal('${w.id}')">
                                <span class="material-icons" style="font-size: 18px; vertical-align: middle;">partial</span>
                                Devolu√ß√£o Parcial
                              </button>
                            </div>
                  ` : ''}
                </div>
              `;
            }).join('')}
          </div>
        </div>
        `;
            }).join('')}
          </div>
        `;
      }
      
      if (html === '') {
        content.innerHTML = '<div class="empty-state">Nenhum item em uso encontrado.</div>';
      } else {
        content.innerHTML = html;
      }
    }

    function filterWithdrawals() {
      renderWithdrawals();
    }

    async function markAsReturned(withdrawalId) {
      try {
        // Encontrar o withdrawal
        const withdrawal = withdrawals.find(w => w.id === withdrawalId);
        if (!withdrawal) {
          showToast('Movimenta√ß√£o n√£o encontrada!', 'error');
          return;
        }

        // Verificar se j√° foi devolvido
        if (withdrawal.returnedDate || withdrawal.returned_date || withdrawal.status === 'returned') {
          showToast('Este item j√° foi marcado como devolvido!', 'warning');
          return;
        }

        const returnedDate = new Date().toISOString().split('T')[0];
        
        // Atualizar no Firestore se dispon√≠vel
        if (window.db) {
          try {
            const { updateDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            await updateDoc(doc(window.db, 'withdrawals', withdrawalId), {
              returnedDate: returnedDate,
              returned_date: returnedDate, // Compatibilidade
              status: 'returned'
            });
            console.log('Withdrawal atualizado no Firestore');
          } catch (firestoreError) {
            console.error('Erro ao atualizar no Firestore:', firestoreError);
            // Continuar com fallback local
          }
        }
        
        // Atualizar localmente
        const withdrawalIndex = withdrawals.findIndex(w => w.id === withdrawalId);
        if (withdrawalIndex !== -1) {
          withdrawals[withdrawalIndex].returnedDate = returnedDate;
          withdrawals[withdrawalIndex].returned_date = returnedDate;
          withdrawals[withdrawalIndex].status = 'returned';
          
          // Salvar localmente
          try {
            localStorage.setItem('withdrawals', JSON.stringify(withdrawals));
          } catch (localError) {
            console.warn('Erro ao salvar localmente:', localError);
          }
        }
        
        // Adicionar quantidade de volta ao estoque
        if (withdrawal.itemId) {
          const item = inventory.find(i => String(i.id) === String(withdrawal.itemId));
          
          if (item) {
            const quantityToAdd = withdrawal.quantity || 0;
            const newQuantity = (item.quantity || 0) + quantityToAdd;
            
            // Atualizar no Firestore se dispon√≠vel
            if (window.db) {
              try {
                const { updateDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const itemDocId = String(item.id);
                await updateDoc(doc(window.db, 'inventory', itemDocId), {
                  quantity: newQuantity
                });
                console.log('Estoque atualizado no Firestore');
              } catch (firestoreError) {
                console.error('Erro ao atualizar estoque no Firestore:', firestoreError);
                // Continuar com fallback local
              }
            }
            
            // Atualizar localmente
            const itemIndex = inventory.findIndex(i => String(i.id) === String(item.id));
            if (itemIndex !== -1) {
              inventory[itemIndex].quantity = newQuantity;
              try {
                localStorage.setItem('inventory', JSON.stringify(inventory));
              } catch (localError) {
                console.warn('Erro ao salvar estoque localmente:', localError);
              }
            }
          } else {
            console.warn('Item n√£o encontrado no estoque para devolu√ß√£o:', withdrawal.itemId);
          }
        }
        
        // Registrar devolu√ß√£o no hist√≥rico
        logActivity('Devolu√ß√£o', `Devolveu ${withdrawal.quantity || 0} ${withdrawal.unit || 'unidades'} de ${withdrawal.itemName || 'item'} - Devolvido em: ${returnedDate}`, 'returned');
        
        // Adicionar ao hist√≥rico
        history.unshift({
          id: Date.now(),
          timestamp: new Date().toLocaleString('pt-BR'),
          user: currentUser ? currentUser.name : (withdrawal.userName || 'Sistema'),
          actions: [{
            itemId: withdrawal.itemId,
            itemName: withdrawal.itemName || 'Item',
            action: 'returned',
            quantity: withdrawal.quantity || 0,
            withdrawalDate: withdrawal.withdrawalDate || withdrawal.withdrawal_date,
            returnDate: withdrawal.expectedReturnDate || withdrawal.expected_return_date,
            returnedDate: returnedDate,
            withdrawalReason: withdrawal.withdrawalReason || withdrawal.reason || ''
          }],
          notes: `Item devolvido em ${returnedDate}`
        });
        
        saveData();
        
        // Registrar devolu√ß√£o no hist√≥rico e log de atividades
        const returnedTimestamp = new Date().toLocaleString('pt-BR');
        
        logActivity('Devolu√ß√£o', `Devolveu ${withdrawal.quantity || 0} ${withdrawal.unit || 'unidades'} de ${withdrawal.itemName || withdrawal.item_name || 'item'} - Devolvido em: ${returnedDate}`, 'returned');
        
        // Adicionar ao hist√≥rico
        history.unshift({
          id: Date.now(),
          timestamp: returnedTimestamp,
          user: currentUser ? (currentUser.name || currentUser.email) : (withdrawal.userName || withdrawal.user_name || 'Sistema'),
          actions: [{
            itemId: withdrawal.itemId,
            itemName: withdrawal.itemName || withdrawal.item_name || 'Item',
            action: 'returned',
            quantity: withdrawal.quantity || 0,
            unit: withdrawal.unit || 'UN',
            location: withdrawal.location || '',
            withdrawalDate: withdrawal.withdrawalDate || withdrawal.withdrawal_date,
            returnDate: withdrawal.expectedReturnDate || withdrawal.expected_return_date,
            returnedDate: returnedDate,
            course: withdrawal.course || withdrawal.courseName || '',
            withdrawalReason: withdrawal.withdrawalReason || withdrawal.reason || ''
          }],
          notes: `Item devolvido em ${returnedDate}. Quantidade adicionada de volta ao estoque.`
        });
        
        saveData();
        
        // Atualizar renderiza√ß√£o com pequeno delay para garantir processamento
        setTimeout(() => {
        if (window.renderInventory) {
          renderInventory();
        }
          if (window.renderDrawers) {
            renderDrawers();
          }
          if (window.renderIsolatedWithdrawals) {
            renderIsolatedWithdrawals();
          }
          if (window.renderWithdrawals) {
            renderWithdrawals();
          }
        }, 100);
        
        showToast('Item marcado como devolvido e quantidade adicionada ao estoque!', 'success');
      } catch (error) {
        console.error('Erro ao marcar como devolvido:', error);
        showToast(`Erro ao marcar como devolvido: ${error.message || 'Erro desconhecido'}`, 'error');
      }
    }

    window.openEditItemModal = openEditItemModal;
    window.confirmDeleteItem = confirmDeleteItem;
    window.deleteItem = deleteItem;
    window.saveItemEdit = saveItemEdit;
    window.openCreateItemModal = openCreateItemModal;
    window.createItem = createItem;
    window.renderWithdrawals = renderWithdrawals;
    window.filterWithdrawals = filterWithdrawals;
    window.markAsReturned = markAsReturned;
    window.getWithdrawalStatus = getWithdrawalStatus;
    window.navigateTo = navigateTo;
    window.updateFAB = updateFAB;
    window.addProject = addProject;
    window.openEditProjectModal = openEditProjectModal;
    window.deleteProject = deleteProject;
    window.loadProjects = loadProjects;
    window.renderProjectsList = renderProjectsList;
    window.addCategory = addCategory;
    window.openEditCategoryModal = openEditCategoryModal;
    window.deleteCategory = deleteCategory;
    window.loadCategories = loadCategories;
    window.renderCategoriesList = renderCategoriesList;
    window.openChartsModal = openChartsModal;
    window.renderCharts = renderCharts;

    // ==================== SISTEMA DE CURSOS/PROJETOS EXPANDIDO ====================
    
    // Carregar cursos
    function loadCourses() {
      try {
        // Primeiro, tentar carregar do localStorage como fallback
        const saved = localStorage.getItem('courses');
        if (saved) {
          const localCourses = JSON.parse(saved);
          // Usar apenas se n√£o houver sincroniza√ß√£o ativa
          if (!coursesUnsubscribe) {
            courses = localCourses;
          }
        }
        
        // Migrar projetos antigos para cursos (apenas se n√£o houver cursos)
        if (courses.length === 0 && projects && projects.length > 0) {
          courses = projects.map(p => ({
            id: p.id,
            name: p.name,
            startDate: null,
            endDate: null,
            location: 'ADM',
            maxDays: 30,
            description: '',
            status: 'active',
            createdAt: new Date().toISOString()
          }));
          saveCourses();
        }
        
        syncCoursesWithProjects();
      } catch (error) {
        console.error('Erro ao carregar cursos:', error);
        courses = [];
      }
    }

    // Salvar cursos (Firestore + localStorage)
    async function saveCourses() {
      // Sempre salvar no localStorage como backup
      try {
        localStorage.setItem('courses', JSON.stringify(courses));
      } catch (error) {
        console.warn('Erro ao salvar cursos no localStorage:', error);
      }
      
      // Salvar no Firestore se dispon√≠vel
      if (window.db) {
        try {
          const { setDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
          
          // Salvar cada curso no Firestore
          for (const course of courses) {
            try {
              await setDoc(doc(window.db, 'courses', String(course.id)), course);
            } catch (error) {
              // Se for erro de permiss√£o, apenas usar fallback local sem mostrar erro
              if (error.code === 'permission-denied' || error.message?.includes('permissions')) {
                // Silenciar erro de permiss√£o, j√° est√° usando fallback local
              } else {
                console.warn(`Erro ao salvar curso ${course.id} no Firestore:`, error);
              }
              // Continuar com os outros cursos
            }
          }
        } catch (error) {
          // Se for erro de permiss√£o, apenas usar fallback local sem mostrar erro
          if (error.code === 'permission-denied' || error.message?.includes('permissions')) {
            // Silenciar erro de permiss√£o, j√° est√° usando fallback local
          } else {
            console.warn('Erro ao salvar cursos no Firestore:', error);
          }
          // Continuar normalmente, dados j√° est√£o no localStorage
        }
      }
      
      syncCoursesWithProjects();
    }

    // Sincronizar cursos em tempo real com Firestore
    window.startCoursesSync = function() {
      if (coursesUnsubscribe) {
        return; // J√° est√° sincronizando
      }
      
      try {
        if (window.db) {
          import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js').then(async ({ collection, onSnapshot, query, orderBy }) => {
            try {
              const coursesRef = collection(window.db, 'courses');
              
              // Tentar com orderBy primeiro, se falhar tenta sem
              let q;
              try {
                q = query(coursesRef, orderBy('createdAt', 'desc'));
              } catch (e) {
                console.warn('Usando query sem orderBy para cursos:', e);
                q = coursesRef;
              }
              
              coursesUnsubscribe = onSnapshot(q, 
                (snapshot) => {
                  courses = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                      id: doc.id,
                      ...data,
                      // Garantir que campos essenciais existam
                      name: data.name || 'Curso sem nome',
                      returnDate: data.returnDate || data.return_date || '',
                      startDate: data.startDate || data.start_date || new Date().toISOString(),
                      status: data.status || 'active',
                      createdAt: data.createdAt?.toDate?.()?.toISOString() || data.createdAt || new Date().toISOString()
                    };
                  });
                  
                  console.log('Cursos sincronizados do Firestore:', courses.length);
                  
                  // Salvar no localStorage como backup
                  try {
                    localStorage.setItem('courses', JSON.stringify(courses));
                  } catch (error) {
                    console.warn('Erro ao salvar cursos no localStorage:', error);
                  }
                  
                  syncCoursesWithProjects();
                  
                  // Atualizar interface se estiver na p√°gina de gavetas
                  if (window.renderDrawers && document.getElementById('drawers-page')?.classList.contains('active')) {
                    renderDrawers();
                  }
                },
                (error) => {
                  // Se for erro de permiss√£o, apenas usar fallback local sem mostrar erro
                  if (error.code === 'permission-denied' || error.message?.includes('permissions')) {
                    console.log('Permiss√µes do Firestore n√£o dispon√≠veis para cursos, usando dados locais');
                  } else {
                    console.error('Erro ao sincronizar cursos:', error);
                  }
                  // Tentar carregar localmente se Firestore falhar
                  loadCourses();
                }
              );
              
              console.log('‚úÖ Sincroniza√ß√£o de cursos iniciada');
            } catch (error) {
              console.error('Erro ao configurar query de cursos:', error);
              loadCourses();
            }
          }).catch(error => {
            console.error('Erro ao importar Firestore para cursos:', error);
            loadCourses();
          });
        } else {
          loadCourses();
        }
      } catch (error) {
        console.error('Erro ao configurar sincroniza√ß√£o de cursos:', error);
        loadCourses();
      }
    };

    // Parar sincroniza√ß√£o de cursos
    window.stopCoursesSync = function() {
      if (coursesUnsubscribe) {
        coursesUnsubscribe();
        coursesUnsubscribe = null;
        console.log('Sincroniza√ß√£o de cursos parada');
      }
    };

    // Sincronizar cursos com projetos (para compatibilidade)
    function syncCoursesWithProjects() {
      // Usar window para garantir que a flag esteja dispon√≠vel
      if (window.isSyncingProjects) return; // Evitar recurs√£o
      window.isSyncingProjects = true;
      isSyncingProjects = true;
      
      try {
        if (courses && courses.length > 0) {
          projects = courses.map(c => ({
            id: c.id,
            name: c.name
          }));
        } else {
          // Se n√£o houver cursos, manter projetos existentes ou usar padr√£o
          if (projects.length === 0) {
            // Tentar carregar do localStorage sem chamar updateProjectSelects
            try {
              const saved = localStorage.getItem('projects');
              if (saved) {
                projects = JSON.parse(saved);
              } else {
                // Projetos padr√£o
                projects = [
                  { id: '1', name: 'PMQ - CSF' },
                  { id: '2', name: 'IAC-SOCIAL' }
                ];
              }
            } catch (error) {
              console.error('Erro ao carregar projetos em syncCoursesWithProjects:', error);
              projects = [{ id: '1', name: 'PMQ - CSF' }];
            }
          }
        }
        saveProjects();
        
        // N√£o chamar updateProjectSelects aqui para evitar recurs√£o
        // updateProjectSelects ser√° chamado quando necess√°rio (ao abrir modais, etc)
      } finally {
        window.isSyncingProjects = false;
        isSyncingProjects = false;
      }
    }

    // Abrir modal de criar/editar curso
    function openCreateCourseModal(courseId = null) {
      const modal = document.getElementById('course-modal');
      const title = document.getElementById('course-modal-title');
      
      if (courseId) {
        // Edi√ß√£o - manter funcionalidade antiga por enquanto
        const course = courses.find(c => c.id === courseId);
        if (course) {
          currentCourse = course;
          title.textContent = 'Editar Curso/Projeto';
          // Para edi√ß√£o, usar modal antigo (pode melhorar depois)
          showToast('Funcionalidade de edi√ß√£o em desenvolvimento', 'info');
          return;
        }
      } else {
        // Novo curso - fluxo simplificado
        currentCourse = null;
        courseSelectedItems = [];
        title.textContent = 'Novo Curso/Projeto';
        document.getElementById('course-form').reset();
        document.getElementById('course-item-search').value = '';
        goToCourseStep1();
        renderCourseItemsList();
        updateCourseSelectedItems();
      }
      
      modal.classList.add('active');
    }
    
    function goToCourseStep1() {
      document.getElementById('course-step-1').style.display = 'block';
      document.getElementById('course-step-2').style.display = 'none';
    }
    
    function goToCourseStep2() {
      const name = document.getElementById('course-name').value.trim();
      const returnDate = document.getElementById('course-return-date').value;
      
      if (!name || !returnDate) {
        showToast('Preencha o nome e a data de retorno!', 'warning');
        return;
      }
      
      document.getElementById('course-step-1').style.display = 'none';
      document.getElementById('course-step-2').style.display = 'block';
      renderCourseItemsList();
      updateCourseSelectedItems();
    }
    
    function renderCourseItemsList(searchTerm = '') {
      const list = document.getElementById('course-items-list');
      if (!list) return;
      
      let filtered = inventory;
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        filtered = inventory.filter(item => 
          item.name.toLowerCase().includes(term) ||
          (item.code && item.code.toLowerCase().includes(term))
        );
      }
      
      if (filtered.length === 0) {
        list.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center;">Nenhum item encontrado</div>';
        return;
      }
      
      list.innerHTML = filtered.map(item => {
        const isSelected = courseSelectedItems.find(si => si.itemId === String(item.id || item.code));
        const selectedQty = isSelected ? isSelected.quantity : 0;
        const availableQty = item.quantity || 0;
        
        return `
          <div class="course-item-option ${isSelected ? 'selected' : ''}" 
               onclick="toggleCourseItem('${String(item.id || item.code)}', '${item.name.replace(/'/g, "\\'")}', ${availableQty})">
            <div class="course-item-info">
              <div class="course-item-name">${item.name}</div>
              <div class="course-item-details">
                C√≥digo: ${item.code || 'N/A'} | Dispon√≠vel: ${availableQty} ${item.unit || 'UN'} | ${item.location || 'N/A'}
              </div>
            </div>
            ${isSelected ? `
              <input type="number" 
                     class="course-item-qty-input" 
                     value="${selectedQty}" 
                     min="1" 
                     max="${availableQty}"
                     onclick="event.stopPropagation()"
                     onchange="updateCourseItemQty('${String(item.id || item.code)}', this.value, ${availableQty})">
            ` : `
              <button class="btn-minimalist" onclick="event.stopPropagation(); toggleCourseItem('${String(item.id || item.code)}', '${item.name.replace(/'/g, "\\'")}', ${availableQty})" style="white-space: nowrap;">
                <span class="material-icons" style="font-size: 18px;">add</span>
                Adicionar
              </button>
            `}
          </div>
        `;
      }).join('');
    }
    
    function filterCourseItems(searchTerm) {
      renderCourseItemsList(searchTerm);
    }
    
    function toggleCourseItem(itemId, itemName, availableQty) {
      const index = courseSelectedItems.findIndex(si => si.itemId === itemId);
      
      if (index !== -1) {
        // Remover
        courseSelectedItems.splice(index, 1);
      } else {
        // Adicionar com quantidade padr√£o 1
        courseSelectedItems.push({
          itemId: itemId,
          itemName: itemName,
          quantity: 1,
          availableQty: availableQty
        });
      }
      
      renderCourseItemsList(document.getElementById('course-item-search').value);
      updateCourseSelectedItems();
    }
    
    function updateCourseItemQty(itemId, qty, maxQty) {
      const qtyNum = parseInt(qty) || 1;
      const qtyFinal = Math.min(Math.max(1, qtyNum), maxQty);
      
      const item = courseSelectedItems.find(si => si.itemId === itemId);
      if (item) {
        item.quantity = qtyFinal;
        updateCourseSelectedItems();
      }
    }
    
    function updateCourseSelectedItems() {
      const container = document.getElementById('course-selected-items');
      const confirmBtn = document.getElementById('confirm-course-btn');
      
      if (!container) return;
      
      if (courseSelectedItems.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Nenhum item selecionado</p>';
        if (confirmBtn) confirmBtn.disabled = true;
        return;
      }
      
      container.innerHTML = `
        <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
          <div style="font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">
            Itens Selecionados (${courseSelectedItems.length})
          </div>
          ${courseSelectedItems.map((si, idx) => {
            const item = inventory.find(i => String(i.id || i.code) === si.itemId);
            return `
              <div class="course-selected-item">
                <div class="course-selected-item-info">
                  <div class="course-selected-item-name">${si.itemName}</div>
                  <div class="course-selected-item-qty">Quantidade: ${si.quantity} ${item?.unit || 'UN'}</div>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <input type="number" 
                         class="course-item-qty-input" 
                         value="${si.quantity}" 
                         min="1" 
                         max="${si.availableQty}"
                         onchange="updateCourseItemQty('${si.itemId}', this.value, ${si.availableQty})">
                  <button class="item-edit-btn" onclick="toggleCourseItem('${si.itemId}', '${si.itemName.replace(/'/g, "\\'")}', ${si.availableQty})" title="Remover">
                    <span class="material-icons">close</span>
                  </button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
      
      if (confirmBtn) confirmBtn.disabled = false;
    }

    // Confirmar curso com itens selecionados
    async function confirmCourseWithItems() {
      if (courseSelectedItems.length === 0) {
        showToast('Selecione pelo menos um item!', 'warning');
        return;
      }
      
      const name = document.getElementById('course-name').value.trim();
      const returnDate = document.getElementById('course-return-date').value;
      
      if (!name || !returnDate) {
        showToast('Preencha o nome e a data de retorno!', 'warning');
        return;
      }
      
      try {
        const isEditing = currentCourse && currentCourse.id;
        const loadingMessage = isEditing ? 'Adicionando itens ao curso...' : 'Criando curso e processando retiradas...';
        showLoading(loadingMessage);
        
        const today = new Date().toISOString().split('T')[0];
        let courseId;
        let courseToSave;
        
        if (isEditing) {
          // Atualizar curso existente
          courseId = currentCourse.id;
          courseToSave = {
            ...currentCourse,
            name: name,
            returnDate: returnDate
          };
          
          // Atualizar no array local
          const courseIndex = courses.findIndex(c => String(c.id) === String(courseId));
          if (courseIndex !== -1) {
            courses[courseIndex] = courseToSave;
          }
        } else {
          // Criar novo curso
          courseId = Date.now().toString();
          courseToSave = {
            id: courseId,
            name: name,
            returnDate: returnDate,
            startDate: today,
            status: 'active',
            createdAt: new Date().toISOString()
          };
          
          // Adicionar ao array local
          courses.push(courseToSave);
        }
        
        // Salvar curso no Firestore se dispon√≠vel
        if (window.db) {
          try {
            const { setDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            await setDoc(doc(window.db, 'courses', String(courseId)), courseToSave);
            console.log(isEditing ? 'Curso atualizado no Firestore:' : 'Curso criado no Firestore:', courseToSave);
          } catch (firestoreError) {
            // Se for erro de permiss√£o, apenas usar fallback local sem mostrar erro
            if (firestoreError.code === 'permission-denied' || firestoreError.message?.includes('permissions')) {
              // Silenciar erro de permiss√£o, j√° est√° usando fallback local
            } else {
              console.warn('Erro ao salvar curso no Firestore, usando fallback local:', firestoreError);
            }
            // Continuar com fallback local
          }
        }
        
        // Salvar no localStorage tamb√©m
        try {
          localStorage.setItem('courses', JSON.stringify(courses));
        } catch (error) {
          console.warn('Erro ao salvar cursos no localStorage:', error);
        }
        
        // Criar withdrawals para cada item selecionado
        const createdWithdrawals = [];
        
        for (const selectedItem of courseSelectedItems) {
          const item = inventory.find(i => String(i.id || i.code) === selectedItem.itemId);
          if (!item) continue;
          
          // Verificar se h√° estoque suficiente
          if (item.quantity < selectedItem.quantity) {
            showToast(`Estoque insuficiente para ${item.name}. Dispon√≠vel: ${item.quantity}`, 'error');
            continue;
          }
          
          // Atualizar quantidade no estoque
          const newQuantity = item.quantity - selectedItem.quantity;
          
          // Preparar dados do withdrawal
          const withdrawalDataBase = {
            itemId: selectedItem.itemId,
            itemName: selectedItem.itemName,
            quantity: selectedItem.quantity,
            unit: item.unit || 'UN',
            course: name,
            courseName: name, // Compatibilidade
            location: item.location || 'ADM',
            withdrawalDate: today,
            expectedReturnDate: returnDate,
            returnedDate: null,
            status: 'in_use',
            userId: currentUser ? currentUser.uid : null,
            userName: currentUser ? (currentUser.name || currentUser.email) : 'Sistema',
            withdrawalReason: `Retirada para curso/projeto: ${name}`
          };
          
          let withdrawalData = null;
          let useLocalFallback = false;
          
          // Tentar atualizar no Firestore primeiro
          if (window.db) {
            try {
              const { updateDoc, doc, addDoc, collection, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
              const itemDocId = String(item.id);
              
              // Atualizar estoque
              try {
                await updateDoc(doc(window.db, 'inventory', itemDocId), {
                  quantity: newQuantity
                });
              } catch (inventoryError) {
                console.warn('Erro ao atualizar estoque no Firestore, usando fallback local:', inventoryError);
                useLocalFallback = true;
              }
              
              if (!useLocalFallback) {
                // Criar withdrawal
                const withdrawalDataForFirestore = {
                  ...withdrawalDataBase,
                  createdAt: serverTimestamp()
                };
                
                try {
                  const withdrawalRef = await addDoc(collection(window.db, 'withdrawals'), withdrawalDataForFirestore);
                  withdrawalData = {
                    ...withdrawalDataBase,
                    id: withdrawalRef.id,
                    createdAt: new Date()
                  };
                  console.log('Withdrawal criado no Firestore:', withdrawalData);
                } catch (withdrawalError) {
                  console.warn('Erro ao criar withdrawal no Firestore, usando fallback local:', withdrawalError);
                  useLocalFallback = true;
                }
              }
            } catch (error) {
              console.warn('Erro geral no Firestore, usando fallback local:', error);
              useLocalFallback = true;
            }
          } else {
            useLocalFallback = true;
          }
          
          // Usar fallback local se necess√°rio
          if (useLocalFallback || !withdrawalData) {
            // Fallback local
            withdrawalData = {
              ...withdrawalDataBase,
              id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
              createdAt: new Date()
            };
            
            console.log('Withdrawal criado (local):', withdrawalData);
          }
          
          // Adicionar ao array local sempre (tanto Firestore quanto local)
          withdrawals.push(withdrawalData);
          createdWithdrawals.push(withdrawalData);
          
          // Atualizar estoque local sempre
          const itemIndex = inventory.findIndex(i => String(i.id) === selectedItem.itemId);
          if (itemIndex !== -1) {
            inventory[itemIndex].quantity = newQuantity;
            console.log(`Estoque atualizado: ${item.name} - Nova quantidade: ${newQuantity}`);
          }
          
          // Se usou fallback local, mostrar aviso
          if (useLocalFallback) {
            console.warn('Dados salvos localmente devido a erro de permiss√£o no Firestore');
          }
          
          // Registrar no hist√≥rico
          logActivity('Retirada', 
            `Retirou ${selectedItem.quantity} ${item.unit || 'unidades'} de ${selectedItem.itemName} para curso ${name}`,
            'remove'
          );
        }
        
        // Salvar dados
        await saveCourses();
        saveData();
        
        // Sempre salvar withdrawals no localStorage (mesmo com Firestore, para fallback)
        try {
          localStorage.setItem('withdrawals', JSON.stringify(withdrawals));
          console.log('Withdrawals salvos:', withdrawals.length);
        } catch (error) {
          console.error('Erro ao salvar withdrawals no localStorage:', error);
        }
        
        // Atualizar estoque no localStorage tamb√©m
        try {
          localStorage.setItem('inventory', JSON.stringify(inventory));
        } catch (error) {
          console.error('Erro ao salvar inventory no localStorage:', error);
        }
        
        hideLoading();
        closeModal('course-modal');
        
        // Atualizar interface - for√ßar renderiza√ß√£o
        setTimeout(() => {
          if (window.renderDrawers) {
            renderDrawers();
            console.log('Gavetas renderizadas');
          }
          if (window.renderInventory) {
            renderInventory();
            console.log('Estoque renderizado');
          }
          if (window.renderWithdrawals) {
            renderWithdrawals();
            console.log('Withdrawals renderizados');
          }
        }, 300);
        
        // Limpar curso atual ap√≥s salvar
        currentCourse = null;
        courseSelectedItems = [];
        
        const successMessage = isEditing 
          ? `${createdWithdrawals.length} item(ns) adicionado(s) ao curso com sucesso!`
          : `Curso criado com sucesso! ${createdWithdrawals.length} item(ns) retirado(s).`;
        showToast(successMessage, 'success');
      } catch (error) {
        hideLoading();
        console.error('Erro ao criar curso:', error);
        showToast('Erro ao criar curso. Tente novamente.', 'error');
      }
    }
    
    // Gerar PDF de termo de retirada do curso
    function generateCourseWithdrawalPDF(courseName, withdrawalDate, withdrawals) {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 15;
        let yPos = margin;
        
        // Cabe√ßalho
        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text('TERMO DE RETIRADA DE MATERIAL', pageWidth / 2, yPos, { align: 'center' });
        yPos += 10;
        
        doc.setFontSize(12);
        doc.setFont(undefined, 'normal');
        doc.text('Cear√° Sem Fome - Controle de Estoque', pageWidth / 2, yPos, { align: 'center' });
        yPos += 15;
        
        // Linha separadora
        doc.setLineWidth(0.5);
        doc.line(margin, yPos, pageWidth - margin, yPos);
        yPos += 10;
        
        // Dados do curso
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('DADOS DA RETIRADA', margin, yPos);
        yPos += 8;
        
        doc.setFont(undefined, 'normal');
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text('Curso/Projeto:', margin, yPos);
        doc.setFont(undefined, 'normal');
        doc.text(courseName, margin + 50, yPos);
        yPos += 7;
        
        doc.setFont(undefined, 'bold');
        doc.text('Data da Retirada:', margin, yPos);
        doc.setFont(undefined, 'normal');
        doc.text(formatDate(withdrawalDate), margin + 50, yPos);
        yPos += 10;
        
        // Tabela de itens
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('MATERIAIS RETIRADOS', margin, yPos);
        yPos += 8;
        
        // Cabe√ßalho da tabela
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        doc.setFillColor(74, 144, 226);
        doc.rect(margin, yPos - 5, pageWidth - 2 * margin, 7, 'F');
        doc.setTextColor(255, 255, 255);
        doc.text('Item', margin + 2, yPos);
        doc.text('Quantidade', pageWidth - margin - 50, yPos, { align: 'right' });
        yPos += 8;
        
        doc.setTextColor(0, 0, 0);
        doc.setFont(undefined, 'normal');
        
        // Itens
        withdrawals.forEach((w, index) => {
          if (yPos > pageWidth * 2.834 - 40) {
            doc.addPage();
            yPos = margin;
          }
          
          // Linha alternada
          if (index % 2 === 0) {
            doc.setFillColor(245, 245, 245);
            doc.rect(margin, yPos - 4, pageWidth - 2 * margin, 5, 'F');
          }
          
          doc.setFontSize(9);
          doc.text(w.itemName || 'Item', margin + 2, yPos);
          doc.text(`${w.quantity} ${w.unit || 'UN'}`, pageWidth - margin - 2, yPos, { align: 'right' });
          yPos += 6;
        });
        
        yPos += 10;
        
        // Espa√ßo para assinatura
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('ASSINATURA', margin, yPos);
        yPos += 15;
        
        doc.setLineWidth(0.5);
        doc.line(margin, yPos, pageWidth - margin, yPos);
        yPos += 5;
        
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(128, 128, 128);
        doc.text('Retirante', margin + (pageWidth - 2 * margin) / 2, yPos, { align: 'center' });
        
        // Rodap√©
        yPos = pageWidth * 2.834 - 15;
        doc.setFontSize(8);
        doc.setTextColor(128, 128, 128);
        doc.text(`Documento gerado em ${new Date().toLocaleString('pt-BR')}`, pageWidth / 2, yPos, { align: 'center' });
        
        // Salvar
        const fileName = `termo_retirada_${courseName.replace(/\s+/g, '_')}_${withdrawalDate}.pdf`;
        doc.save(fileName);
        
        showToast('Termo PDF gerado com sucesso!', 'success');
      } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        showToast('Erro ao gerar PDF. Verifique o console.', 'error');
      }
    }

    // Gerar PDF de termo de retirada a partir do card do curso
    function generateCourseWithdrawalPDFFromCard(courseId) {
      const course = courses.find(c => String(c.id) === String(courseId));
      if (!course) {
        showToast('Curso n√£o encontrado!', 'error');
        return;
      }
      
      // Buscar todos os withdrawals deste curso
      const courseWithdrawals = withdrawals.filter(w => {
        const courseMatch = (w.course && w.course.trim() === course.name.trim()) || 
                           (w.courseName && w.courseName.trim() === course.name.trim());
        return courseMatch;
      });
      
      if (courseWithdrawals.length === 0) {
        showToast('Nenhum item retirado para este curso!', 'warning');
        return;
      }
      
      // Usar a data de retirada mais antiga ou data atual
      const withdrawalDate = courseWithdrawals[0]?.withdrawalDate || 
                             courseWithdrawals[0]?.withdrawal_date || 
                             new Date().toISOString().split('T')[0];
      
      generateCourseWithdrawalPDF(course.name, withdrawalDate, courseWithdrawals);
    }

    // Abrir modal para editar/adicionar itens ao curso
    function openEditCourseModal(courseId) {
      const course = courses.find(c => String(c.id) === String(courseId));
      if (!course) {
        showToast('Curso n√£o encontrado!', 'error');
        return;
      }
      
      currentCourse = course;
      courseSelectedItems = [];
      
      // Preencher campos do modal
      document.getElementById('course-name').value = course.name;
      document.getElementById('course-return-date').value = course.returnDate || '';
      
      // Atualizar t√≠tulo do modal
      const modalTitle = document.getElementById('course-modal-title');
      if (modalTitle) {
        modalTitle.textContent = `Adicionar Itens - ${course.name}`;
      }
      
      // Ir para o passo 2 (sele√ß√£o de itens)
      goToCourseStep2();
      
      // Renderizar lista de itens
      renderCourseItemsList();
      updateCourseSelectedItems();
      
      // Abrir modal
      document.getElementById('course-modal').classList.add('active');
    }

    // Confirmar exclus√£o de curso/projeto
    async function confirmDeleteCourse(courseId) {
      const course = courses.find(c => String(c.id) === String(courseId));
      if (!course) {
        showToast('Curso n√£o encontrado!', 'error');
        return;
      }
      
      // Verificar se h√° itens em uso
      const courseWithdrawals = withdrawals.filter(w => {
        const courseMatch = (w.course && w.course.trim() === course.name.trim()) || 
                           (w.courseName && w.courseName.trim() === course.name.trim());
        return courseMatch && (w.status !== 'returned' && !w.returnedDate && !w.returned_date);
      });
      
      if (courseWithdrawals.length > 0) {
        showToast(`N√£o √© poss√≠vel excluir o curso. Existem ${courseWithdrawals.length} item(ns) ainda em uso.`, 'warning');
        return;
      }
      
      if (!confirm(`Tem certeza que deseja excluir o curso/projeto "${course.name}"?\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
        return;
      }
      
      try {
        // Excluir do Firestore
        if (window.db) {
          try {
            const { deleteDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            await deleteDoc(doc(window.db, 'courses', String(courseId)));
            console.log('Curso exclu√≠do do Firestore');
          } catch (firestoreError) {
            console.warn('Erro ao excluir curso do Firestore:', firestoreError);
            // Continuar com exclus√£o local
          }
        }
        
        // Excluir do array local
        courses = courses.filter(c => String(c.id) !== String(courseId));
        
        // Salvar no localStorage
        try {
          localStorage.setItem('courses', JSON.stringify(courses));
        } catch (error) {
          console.warn('Erro ao salvar cursos no localStorage:', error);
        }
        
        syncCoursesWithProjects();
        
        // Atualizar interface
        if (window.renderDrawers) {
          renderDrawers();
        }
        
        showToast('Curso/projeto exclu√≠do com sucesso!', 'success');
      } catch (error) {
        console.error('Erro ao excluir curso:', error);
        showToast('Erro ao excluir curso. Tente novamente.', 'error');
      }
    }

    // Devolver todos os itens de um curso/projeto
    async function returnAllCourseItems(courseId) {
      const course = courses.find(c => String(c.id) === String(courseId));
      if (!course) {
        showToast('Curso n√£o encontrado!', 'error');
        return;
      }
      
      // Buscar todos os withdrawals ativos deste curso
      const activeWithdrawals = withdrawals.filter(w => {
        const courseMatch = (w.course && w.course.trim() === course.name.trim()) || 
                           (w.courseName && w.courseName.trim() === course.name.trim());
        const isReturned = w.returnedDate || w.returned_date || w.status === 'returned';
        return courseMatch && !isReturned;
      });
      
      if (activeWithdrawals.length === 0) {
        showToast('N√£o h√° itens em uso para devolver neste curso!', 'warning');
        return;
      }
      
      if (!confirm(`Tem certeza que deseja devolver TODOS os ${activeWithdrawals.length} item(ns) do curso "${course.name}"?`)) {
        return;
      }
      
      try {
        showLoading('Devolvendo itens...');
        const returnedDate = new Date().toISOString().split('T')[0];
        let successCount = 0;
        let errorCount = 0;
        
        for (const withdrawal of activeWithdrawals) {
          try {
            // Atualizar no Firestore se dispon√≠vel
            if (window.db) {
              try {
                const { updateDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                await updateDoc(doc(window.db, 'withdrawals', withdrawal.id), {
                  returnedDate: returnedDate,
                  returned_date: returnedDate,
                  status: 'returned'
                });
              } catch (firestoreError) {
                console.warn('Erro ao atualizar withdrawal no Firestore, usando fallback local:', firestoreError);
                // Continuar com fallback local
              }
            }
            
            // Atualizar localmente
            const withdrawalIndex = withdrawals.findIndex(w => w.id === withdrawal.id);
            if (withdrawalIndex !== -1) {
              withdrawals[withdrawalIndex].returnedDate = returnedDate;
              withdrawals[withdrawalIndex].returned_date = returnedDate;
              withdrawals[withdrawalIndex].status = 'returned';
            }
            
            // Adicionar quantidade de volta ao estoque
            if (withdrawal.itemId) {
              const item = inventory.find(i => String(i.id) === String(withdrawal.itemId));
              if (item) {
                const quantityToAdd = withdrawal.quantity || 0;
                const newQuantity = (item.quantity || 0) + quantityToAdd;
                
                // Atualizar no Firestore se dispon√≠vel
                if (window.db) {
                  try {
                    const { updateDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                    const itemDocId = String(item.id);
                    await updateDoc(doc(window.db, 'inventory', itemDocId), {
                      quantity: newQuantity
                    });
                  } catch (firestoreError) {
                    console.warn('Erro ao atualizar estoque no Firestore:', firestoreError);
                    // Continuar com fallback local
                  }
                }
                
                // Atualizar localmente
                const itemIndex = inventory.findIndex(i => String(i.id) === String(item.id));
                if (itemIndex !== -1) {
                  inventory[itemIndex].quantity = newQuantity;
                }
              }
            }
            
            successCount++;
          } catch (error) {
            console.error('Erro ao devolver item:', error);
            errorCount++;
          }
        }
        
        // Salvar no localStorage
        try {
          localStorage.setItem('withdrawals', JSON.stringify(withdrawals));
          localStorage.setItem('inventory', JSON.stringify(inventory));
        } catch (error) {
          console.warn('Erro ao salvar no localStorage:', error);
        }
        
        hideLoading();
        
        // Atualizar interface
        setTimeout(() => {
          if (window.renderDrawers) {
            renderDrawers();
          }
          if (window.renderInventory) {
            renderInventory();
          }
          if (window.renderIsolatedWithdrawals) {
            renderIsolatedWithdrawals();
          }
        }, 100);
        
        if (errorCount > 0) {
          showToast(`${successCount} item(ns) devolvido(s) com sucesso. ${errorCount} erro(s).`, 'warning');
        } else {
          showToast(`Todos os ${successCount} item(ns) foram devolvidos com sucesso!`, 'success');
        }
      } catch (error) {
        hideLoading();
        console.error('Erro ao devolver itens do curso:', error);
        showToast('Erro ao devolver itens. Tente novamente.', 'error');
      }
    }

    // Renderizar withdrawals isolados
    function renderIsolatedWithdrawals() {
      const content = document.getElementById('isolated-withdrawals-content');
      if (!content) {
        console.warn('Elemento isolated-withdrawals-content n√£o encontrado');
        return;
      }
      
      // Se o array estiver vazio, tentar carregar do localStorage
      if (!withdrawals || withdrawals.length === 0) {
        loadWithdrawalsLocal();
      }
      
      // Filtrar withdrawals isolados (sem curso) e apenas os que est√£o em uso (n√£o devolvidos)
      const isolatedWithdrawals = withdrawals.filter(w => {
        if (!w) return false;
        const course = w.course || w.courseName;
        const hasCourse = course && course.toString().trim() !== '' && course.toString().trim() !== 'null';
        // Verificar se foi devolvido
        const isReturned = w.returnedDate || w.returned_date || w.status === 'returned';
        return !hasCourse && !isReturned; // Apenas itens isolados e em uso
      });
      
      console.log('Renderizando withdrawals isolados. Total:', isolatedWithdrawals.length);
      
      if (isolatedWithdrawals.length === 0) {
        content.innerHTML = '<div class="empty-state">Nenhum item retirado isoladamente.</div>';
        return;
      }
      
      content.innerHTML = isolatedWithdrawals.map(w => {
        const status = getWithdrawalStatus(w);
        const statusLabels = {
          in_use: 'Em Uso',
          overdue: 'Atrasado',
          returned: 'Devolvido'
        };
        const returnDate = w.expectedReturnDate || w.expected_return_date || null;
        const returnDateText = returnDate ? formatDate(returnDate) : 'Sem prazo';
        
        return `
          <div class="withdrawal-shelf-item">
            <div class="withdrawal-shelf-item-header">
              <span class="withdrawal-status ${status}">${statusLabels[status]}</span>
            </div>
            <div class="withdrawal-shelf-item-name">${w.itemName || w.item_name || 'Item sem nome'}</div>
            <div class="withdrawal-shelf-item-details">
              <strong>Quantidade:</strong> ${w.quantity || 0} ${w.unit || 'UN'}
            </div>
            <div class="withdrawal-shelf-item-details">
              <strong>Data de Retirada:</strong> ${formatDate(w.withdrawalDate || w.withdrawal_date || '')}
            </div>
            <div class="withdrawal-shelf-item-details" style="color: ${status === 'overdue' ? 'var(--gov-red)' : status === 'returned' ? 'var(--gov-green)' : 'var(--text-secondary)'};">
              <strong>Data/Prazo de Devolu√ß√£o:</strong> ${returnDateText}
            </div>
            ${(w.returnedDate || w.returned_date) ? `
              <div class="withdrawal-shelf-item-details" style="color: var(--gov-green); margin-top: 4px;">
                <strong>‚úÖ Devolvido em:</strong> ${formatDate(w.returnedDate || w.returned_date)}
              </div>
            ` : ''}
            ${(w.withdrawalReason || w.reason) ? `
              <div class="withdrawal-shelf-item-details" style="margin-top: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 6px; font-size: 12px;">
                <strong>Motivo:</strong> ${w.withdrawalReason || w.reason}
              </div>
            ` : ''}
            ${status !== 'returned' ? `
              <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 12px;">
                <button class="submit-btn btn-success" style="padding: 8px; font-size: 14px;" onclick="markAsReturned('${w.id}')">
                  <span class="material-icons" style="font-size: 18px; vertical-align: middle;">check_circle</span>
                  Devolver Tudo
                </button>
                <button class="submit-btn" style="padding: 8px; font-size: 14px; background: transparent; border-color: var(--gov-yellow); color: var(--gov-yellow);" onclick="openPartialReturnModal('${w.id}')">
                  <span class="material-icons" style="font-size: 18px; vertical-align: middle;">partial</span>
                  Devolu√ß√£o Parcial
                </button>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    // Renderizar gavetas (drawers)
    function renderDrawers() {
      // Renderizar withdrawals isolados primeiro
      renderIsolatedWithdrawals();
      
      const grid = document.getElementById('drawers-grid');
      if (!grid) return;
      
      // Buscar todos os withdrawals em uso (n√£o devolvidos)
      const allActiveWithdrawals = withdrawals.filter(w => {
        if (!w) return false;
        const isReturned = w.returnedDate || w.returned_date || w.status === 'returned';
        return !isReturned;
      });
      
      console.log('Total de withdrawals ativos:', allActiveWithdrawals.length);
      console.log('Total de cursos:', courses.length);
      
      // Verificar withdrawals vinculados a cursos que n√£o existem mais
      const orphanedWithdrawals = allActiveWithdrawals.filter(w => {
        const course = w.course || w.courseName;
        if (!course || course.toString().trim() === '' || course.toString().trim() === 'null') {
          return false; // N√£o √© orphaned, √© isolado
        }
        const courseExists = courses.find(c => 
          c.name && c.name.trim() === course.toString().trim()
        );
        return !courseExists; // √â orphaned se n√£o encontrar o curso
      });
      
      if (orphanedWithdrawals.length > 0) {
        console.warn('Encontrados withdrawals vinculados a cursos inexistentes:', orphanedWithdrawals.length);
        console.log('Orphaned withdrawals:', orphanedWithdrawals.map(w => ({
          id: w.id,
          course: w.course || w.courseName,
          itemName: w.itemName
        })));
      }
      
      if (courses.length === 0) {
        // Se n√£o h√° cursos mas h√° withdrawals orphaned, mostrar eles
        if (orphanedWithdrawals.length > 0) {
          grid.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1;">
              <p>Nenhum curso/projeto cadastrado.</p>
              <p style="margin-top: 8px; color: var(--gov-yellow);">
                ‚ö†Ô∏è Existem ${orphanedWithdrawals.length} item(ns) em uso vinculados a cursos que n√£o existem mais.
              </p>
              <button class="submit-btn" onclick="openCreateCourseModal()" style="margin-top: 16px;">
                Criar Primeiro Curso/Projeto
              </button>
            </div>
          `;
        } else {
          grid.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1;">
              <p>Nenhum curso/projeto cadastrado.</p>
              <button class="submit-btn" onclick="openCreateCourseModal()" style="margin-top: 16px;">
                Criar Primeiro Curso/Projeto
              </button>
            </div>
          `;
        }
        return;
      }
      
      // Renderizar cursos existentes
      const coursesHTML = courses.map(course => {
        // Buscar todos os withdrawals deste curso
        const allCourseWithdrawals = withdrawals.filter(w => {
          const courseMatch = (w.course && w.course.trim() === course.name.trim()) || 
                             (w.courseName && w.courseName.trim() === course.name.trim());
          return courseMatch;
        });
        
        // Debug apenas se necess√°rio
        if (allCourseWithdrawals.length === 0 && withdrawals.length > 0) {
          console.log(`Curso "${course.name}" n√£o encontrou withdrawals. Total de withdrawals:`, withdrawals.length);
        }
        
        const activeWithdrawals = allCourseWithdrawals.filter(w => 
          !w.returnedDate && !w.returned_date && w.status !== 'returned'
        );
        
        const returnedWithdrawals = allCourseWithdrawals.filter(w => 
          w.returnedDate || w.returned_date || w.status === 'returned'
        );
        
        // Agrupar por item
        const itemsMap = {};
        allCourseWithdrawals.forEach(w => {
          const key = w.itemId || w.itemName;
          if (!itemsMap[key]) {
            itemsMap[key] = {
              itemName: w.itemName || w.item_name || 'Item',
              itemId: w.itemId,
              unit: w.unit || 'UN',
              totalQty: 0,
              returnedQty: 0,
              inUseQty: 0,
              withdrawals: []
            };
          }
          itemsMap[key].totalQty += (w.quantity || 0);
          itemsMap[key].withdrawals.push(w);
          
          if (w.returnedDate || w.returned_date || w.status === 'returned') {
            itemsMap[key].returnedQty += (w.quantity || 0);
          } else {
            itemsMap[key].inUseQty += (w.quantity || 0);
          }
        });
        
        // Filtrar apenas itens que ainda t√™m quantidade em uso (n√£o totalmente devolvidos)
        const itemsList = Object.values(itemsMap).filter(item => item.inUseQty > 0);
        const totalItems = itemsList.length;
        const totalInUse = activeWithdrawals.reduce((sum, w) => sum + (w.quantity || 0), 0);
        const totalReturned = returnedWithdrawals.reduce((sum, w) => sum + (w.quantity || 0), 0);
        
        // Calcular alertas
        const alerts = getCourseAlerts(course, activeWithdrawals);
        
        // Status do curso
        const isEnded = course.returnDate && new Date(course.returnDate) < new Date();
        const isActive = course.status === 'active' && !isEnded;
        
        return `
          <div class="drawer-card ${isActive ? 'active' : ''}">
            <div class="drawer-header" style="display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                <h3 class="drawer-title">${course.name}</h3>
                <span class="drawer-badge ${isActive ? 'active' : 'ended'}">
                  ${isActive ? 'Ativo' : 'Encerrado'}
                </span>
              </div>
              <button class="item-edit-btn" 
                      onclick="confirmDeleteCourse('${course.id}')" 
                      title="Excluir Curso/Projeto"
                      style="padding: 6px; color: var(--gov-red);">
                <span class="material-icons" style="font-size: 20px;">delete</span>
              </button>
            </div>
            <div class="drawer-info">
              <div class="drawer-info-item">
                <span class="material-icons" style="font-size: 18px;">event</span>
                <span>Retorno: ${formatDate(course.returnDate || course.startDate)}</span>
              </div>
            </div>
            ${alerts.length > 0 ? alerts.map(alert => `
              <div class="drawer-alert ${alert.type}">
                <span class="material-icons" style="font-size: 18px;">${alert.icon}</span>
                <span>${alert.message}</span>
              </div>
            `).join('') : ''}
            <div class="drawer-stats">
              <div class="drawer-stat">
                <div class="drawer-stat-value">${totalItems}</div>
                <div class="drawer-stat-label">Itens</div>
              </div>
              <div class="drawer-stat">
                <div class="drawer-stat-value" style="color: var(--gov-yellow);">${totalInUse}</div>
                <div class="drawer-stat-label">Em Uso</div>
              </div>
              <div class="drawer-stat">
                <div class="drawer-stat-value" style="color: var(--gov-green);">${totalReturned}</div>
                <div class="drawer-stat-label">Devolvidos</div>
              </div>
            </div>
            
            <!-- Lista de Itens -->
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
              <div style="font-weight: 600; margin-bottom: 12px; color: var(--text-primary); font-size: 14px;">
                Materiais Retirados
              </div>
              ${itemsList.length === 0 ? `
                <div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 14px;">
                  Nenhum material retirado
                </div>
              ` : itemsList.map(item => {
                const isFullyReturned = item.inUseQty === 0 && item.returnedQty > 0;
                const isPartiallyReturned = item.inUseQty > 0 && item.returnedQty > 0;
                const isInUse = item.inUseQty > 0;
                
                return `
                  <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid ${isFullyReturned ? 'var(--gov-green)' : isInUse ? 'var(--gov-yellow)' : 'var(--border-color)'};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                      <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">${item.itemName}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                          Total: ${item.totalQty} ${item.unit}
                          ${isPartiallyReturned ? ` | Devolvido: ${item.returnedQty} ${item.unit}` : ''}
                          ${isInUse ? ` | Em uso: ${item.inUseQty} ${item.unit}` : ''}
                        </div>
                        <div style="margin-top: 4px;">
                          ${isFullyReturned ? `
                            <span class="alert-badge info" style="background: rgba(124, 179, 66, 0.15); color: var(--gov-green);">
                              ‚úÖ Devolvido
                            </span>
                          ` : isInUse ? `
                            <span class="alert-badge warning">
                              ‚è≥ Em Uso
                            </span>
                          ` : ''}
                        </div>
                      </div>
                    </div>
                    ${isInUse ? `
                      <div style="display: flex; gap: 6px; margin-top: 8px;">
                        <button class="btn-minimalist" 
                                onclick="openPartialReturnModal('${item.withdrawals.find(w => !w.returnedDate && !w.returned_date && w.status !== 'returned')?.id || ''}')" 
                                style="flex: 1; padding: 6px; font-size: 12px;">
                          <span class="material-icons" style="font-size: 16px;">partial</span>
                          Devolver
                        </button>
                      </div>
                    ` : ''}
                  </div>
                `;
              }).join('')}
            </div>
            
            <!-- Bot√µes de A√ß√£o -->
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color); display: flex; gap: 8px; flex-wrap: wrap;">
              <button class="btn-minimalist" 
                      onclick="openEditCourseModal('${course.id}')" 
                      style="flex: 1; min-width: 120px; padding: 10px; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 6px;">
                <span class="material-icons" style="font-size: 18px;">add</span>
                Adicionar Itens
              </button>
              ${activeWithdrawals.length > 0 ? `
                <button class="btn-minimalist" 
                        onclick="returnAllCourseItems('${course.id}')" 
                        style="flex: 1; min-width: 120px; padding: 10px; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 6px; background: var(--gov-green); color: white;">
                  <span class="material-icons" style="font-size: 18px;">check_circle</span>
                  Devolver Todos
                </button>
              ` : ''}
              ${allCourseWithdrawals.length > 0 ? `
                <button class="btn-minimalist" 
                        onclick="generateCourseWithdrawalPDFFromCard('${course.id}')" 
                        style="flex: 1; min-width: 120px; padding: 10px; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 6px; background: var(--gov-blue); color: white;">
                  <span class="material-icons" style="font-size: 18px;">description</span>
                  Termo de Retirada
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
      
      // Adicionar se√ß√£o para withdrawals orphaned (vinculados a cursos que n√£o existem mais)
      let orphanedHTML = '';
      if (orphanedWithdrawals.length > 0) {
        // Agrupar por nome do curso
        const orphanedByCourse = {};
        orphanedWithdrawals.forEach(w => {
          const courseName = (w.course || w.courseName || 'Curso Desconhecido').toString().trim();
          if (!orphanedByCourse[courseName]) {
            orphanedByCourse[courseName] = [];
          }
          orphanedByCourse[courseName].push(w);
        });
        
        orphanedHTML = `
          <div style="grid-column: 1 / -1; margin-top: 24px; padding-top: 24px; border-top: 2px solid var(--border-color);">
            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--gov-yellow); display: flex; align-items: center; gap: 8px;">
              <span class="material-icons" style="font-size: 20px;">warning</span>
              Itens Vinculados a Cursos Inexistentes (${orphanedWithdrawals.length})
            </h3>
            ${Object.keys(orphanedByCourse).map(courseName => {
              const courseWithdrawals = orphanedByCourse[courseName];
              const activeWithdrawals = courseWithdrawals.filter(w => 
                !w.returnedDate && !w.returned_date && w.status !== 'returned'
              );
              
              if (activeWithdrawals.length === 0) return '';
              
              // Agrupar por item
              const itemsMap = {};
              activeWithdrawals.forEach(w => {
                const key = w.itemId || w.itemName;
                if (!itemsMap[key]) {
                  itemsMap[key] = {
                    itemName: w.itemName || w.item_name || 'Item',
                    itemId: w.itemId,
                    unit: w.unit || 'UN',
                    totalQty: 0,
                    withdrawals: []
                  };
                }
                itemsMap[key].totalQty += (w.quantity || 0);
                itemsMap[key].withdrawals.push(w);
              });
              
              const itemsList = Object.values(itemsMap);
              const totalInUse = activeWithdrawals.reduce((sum, w) => sum + (w.quantity || 0), 0);
              
              return `
                <div class="drawer-card" style="opacity: 0.8; border-left: 4px solid var(--gov-yellow);">
                  <div class="drawer-header">
                    <h3 class="drawer-title">${courseName} <span style="color: var(--gov-yellow); font-size: 12px;">(Curso n√£o encontrado)</span></h3>
                  </div>
                  <div class="drawer-stats">
                    <div class="drawer-stat">
                      <div class="drawer-stat-value">${itemsList.length}</div>
                      <div class="drawer-stat-label">Itens</div>
                    </div>
                    <div class="drawer-stat">
                      <div class="drawer-stat-value" style="color: var(--gov-yellow);">${totalInUse}</div>
                      <div class="drawer-stat-label">Em Uso</div>
                    </div>
                  </div>
                  <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                    <div style="font-weight: 600; margin-bottom: 12px; color: var(--text-primary); font-size: 14px;">
                      Materiais Retirados
                    </div>
                    ${itemsList.map(item => `
                      <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px;">
                        <div style="font-weight: 600; margin-bottom: 4px;">${item.itemName}</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">
                          Quantidade: ${item.totalQty} ${item.unit}
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              `;
            }).filter(html => html !== '').join('')}
          </div>
        `;
      }
      
      // Atualizar grid com cursos e withdrawals orphaned
      grid.innerHTML = coursesHTML + orphanedHTML;
      
      console.log('Cursos renderizados:', courses.length);
      console.log('Withdrawals orphaned renderizados:', orphanedWithdrawals.length);
    }

    // Calcular alertas do curso
    function getCourseAlerts(course, withdrawals) {
      const alerts = [];
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      withdrawals.forEach(w => {
        const returnDate = w.expectedReturnDate || w.expected_return_date;
        if (returnDate) {
          const returnDateObj = new Date(returnDate);
          returnDateObj.setHours(0, 0, 0, 0);
          const daysDiff = Math.ceil((returnDateObj - today) / (1000 * 60 * 60 * 24));
          
          if (daysDiff < 0) {
            alerts.push({
              type: 'danger',
              icon: 'error',
              message: `Item "${w.itemName}" atrasado h√° ${Math.abs(daysDiff)} dia(s)`
            });
          } else if (daysDiff <= 3) {
            alerts.push({
              type: 'warning',
              icon: 'warning',
              message: `Item "${w.itemName}" vence em ${daysDiff} dia(s)`
            });
          }
        }
      });
      
      return alerts;
    }

    // Abrir detalhes da gaveta
    function openDrawerDetails(courseId) {
      const course = courses.find(c => c.id === courseId);
      if (!course) return;
      
      // Filtrar estoque por este projeto
      currentLocationFilter = 'all';
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        searchInput.value = '';
      }
      
      // Navegar para estoque com filtro de projeto
      navigateTo('inventory', document.querySelector('.sidebar-item[onclick*="inventory"]'));
      
      // Filtrar por projeto (precisa implementar filtro por projeto no estoque)
      setTimeout(() => {
        const projectItems = inventory.filter(i => i.project === course.name);
        renderInventory();
        showToast(`Mostrando ${projectItems.length} itens do projeto ${course.name}`, 'info');
      }, 100);
    }

    // Abrir checklist de devolu√ß√£o do curso
    function openCourseChecklist(courseId) {
      const course = courses.find(c => c.id === courseId);
      if (!course) {
        showToast('Curso n√£o encontrado', 'error');
        return;
      }
      
      currentCourse = course;
      const modal = document.getElementById('course-checklist-modal');
      const title = document.getElementById('checklist-course-name');
      const list = document.getElementById('checklist-items-list');
      
      title.textContent = `Checklist de Devolu√ß√£o - ${course.name}`;
      
      // Buscar todos os withdrawals ativos deste curso
      const courseWithdrawals = withdrawals.filter(w => 
        (w.course === course.name || w.courseName === course.name) &&
        !w.returnedDate && !w.returned_date && w.status !== 'returned'
      );
      
      if (courseWithdrawals.length === 0) {
        list.innerHTML = '<div class="empty-state">Nenhum item em uso para este curso.</div>';
      } else {
        list.innerHTML = courseWithdrawals.map((w, index) => `
          <div class="checklist-item" data-withdrawal-id="${w.id}">
            <div class="checklist-item-header">
              <div>
                <div class="checklist-item-name">${w.itemName || w.item_name || 'Item sem nome'}</div>
                <div class="checklist-item-qty">Quantidade retirada: ${w.quantity || 0} ${w.unit || 'UN'}</div>
              </div>
            </div>
            <div class="checklist-item-fields">
              <div class="form-group">
                <label class="form-label">Quantidade a Devolver</label>
                <input type="number" class="form-input checklist-return-qty" 
                       data-withdrawal-id="${w.id}" 
                       value="${w.quantity || 0}" 
                       min="0" 
                       max="${w.quantity || 0}">
              </div>
              <div class="form-group">
                <label class="form-label">Status</label>
                <select class="form-input checklist-status" data-withdrawal-id="${w.id}">
                  <option value="returned">Devolvido (Integro)</option>
                  <option value="damaged">Danificado</option>
                  <option value="lost">Perdido</option>
                  <option value="consumed">Consumido</option>
                </select>
              </div>
            </div>
            <div class="form-group" style="margin-top: 12px;">
              <label class="form-label">Observa√ß√£o</label>
              <textarea class="form-input checklist-notes" 
                        data-withdrawal-id="${w.id}" 
                        rows="2" 
                        placeholder="Observa√ß√µes sobre este item..."></textarea>
            </div>
          </div>
        `).join('');
      }
      
      modal.classList.add('active');
    }

    // Finalizar checklist do curso
    async function finalizeCourseChecklist() {
      if (!currentCourse) return;
      
      const checklistItems = document.querySelectorAll('.checklist-item');
      const finalNotes = document.getElementById('checklist-final-notes').value.trim();
      const responsible = document.getElementById('checklist-closing-responsible').value.trim();
      
      if (!responsible) {
        showToast('Informe o respons√°vel pelo encerramento!', 'warning');
        return;
      }
      
      try {
        showLoading('Processando devolu√ß√µes...');
        
        const returns = [];
        for (const item of checklistItems) {
          const withdrawalId = item.dataset.withdrawalId;
          const withdrawal = withdrawals.find(w => w.id === withdrawalId);
          if (!withdrawal) continue;
          
          const returnQty = parseInt(item.querySelector('.checklist-return-qty').value) || 0;
          const status = item.querySelector('.checklist-status').value;
          const notes = item.querySelector('.checklist-notes').value.trim();
          
          if (returnQty > 0) {
            returns.push({
              withdrawal,
              returnQty,
              status,
              notes
            });
          }
        }
        
        // Processar cada devolu√ß√£o
        for (const ret of returns) {
          await processPartialReturn(ret.withdrawal, ret.returnQty, ret.status, ret.notes, responsible);
        }
        
        // Marcar curso como encerrado se todos os itens foram devolvidos
        const remainingWithdrawals = withdrawals.filter(w => 
          (w.course === currentCourse.name || w.courseName === currentCourse.name) &&
          !w.returnedDate && !w.returned_date && w.status !== 'returned'
        );
        
        if (remainingWithdrawals.length === 0) {
          const courseIndex = courses.findIndex(c => c.id === currentCourse.id);
          if (courseIndex !== -1) {
            courses[courseIndex].status = 'ended';
            courses[courseIndex].endedAt = new Date().toISOString();
            saveCourses();
          }
        }
        
        hideLoading();
        closeModal('course-checklist-modal');
        showToast('Checklist finalizado com sucesso!', 'success');
        
        if (window.renderWithdrawals) renderWithdrawals();
        if (window.renderDrawers) renderDrawers();
        if (window.renderInventory) renderInventory();
      } catch (error) {
        hideLoading();
        console.error('Erro ao finalizar checklist:', error);
        showToast('Erro ao finalizar checklist. Tente novamente.', 'error');
      }
    }

    // Abrir modal de devolu√ß√£o parcial
    function openPartialReturnModal(withdrawalId) {
      const withdrawal = withdrawals.find(w => w.id === withdrawalId);
      if (!withdrawal) {
        showToast('Movimenta√ß√£o n√£o encontrada!', 'error');
        return;
      }
      
      currentWithdrawal = withdrawal;
      
      const totalQty = withdrawal.quantity || 0;
      const title = document.getElementById('partial-return-title');
      const itemName = withdrawal.itemName || withdrawal.item_name || 'Item';
      const unit = withdrawal.unit || 'UN';
      
      if (title) {
        title.textContent = 'Devolu√ß√£o';
      }
      
      document.getElementById('partial-return-item-name').value = itemName;
      document.getElementById('partial-return-total-qty').value = `${totalQty} ${unit}`;
      document.getElementById('partial-return-qty').value = totalQty;
      document.getElementById('partial-return-qty').max = totalQty;
      document.getElementById('partial-return-notes').value = '';
      
      updatePartialReturnPreview();
      
      document.getElementById('partial-return-modal').classList.add('active');
    }
    
    function updatePartialReturnPreview() {
      if (!currentWithdrawal) return;
      
      const returnQty = parseInt(document.getElementById('partial-return-qty').value) || 0;
      const totalQty = currentWithdrawal.quantity || 0;
      const unit = currentWithdrawal.unit || 'UN';
      const preview = document.getElementById('partial-return-preview');
      
      if (!preview) return;
      
      if (returnQty === totalQty) {
        preview.textContent = `Devolu√ß√£o total: ${returnQty} ${unit}`;
        preview.style.color = 'var(--gov-green)';
      } else if (returnQty > 0) {
        const remaining = totalQty - returnQty;
        preview.textContent = `Devolu√ß√£o parcial: ${returnQty} ${unit} | Restante: ${remaining} ${unit}`;
        preview.style.color = 'var(--gov-yellow)';
      } else {
        preview.textContent = '';
      }
    }

    // Confirmar devolu√ß√£o
    async function confirmPartialReturn() {
      if (!currentWithdrawal) return;
      
      const returnQty = parseInt(document.getElementById('partial-return-qty').value);
      const notes = document.getElementById('partial-return-notes').value.trim();
      
      if (!returnQty || returnQty <= 0) {
        showToast('Informe a quantidade a devolver!', 'warning');
        return;
      }
      
      if (returnQty > currentWithdrawal.quantity) {
        showToast('Quantidade a devolver n√£o pode ser maior que a retirada!', 'error');
        return;
      }
      
      try {
        // Se devolver tudo, usar status 'returned', sen√£o √© parcial
        const isFullReturn = returnQty === currentWithdrawal.quantity;
        await processPartialReturn(currentWithdrawal, returnQty, 'returned', notes || '', '');
        closeModal('partial-return-modal');
      } catch (error) {
        console.error('Erro ao processar devolu√ß√£o:', error);
        showToast('Erro ao processar devolu√ß√£o. Tente novamente.', 'error');
      }
    }

    // Processar devolu√ß√£o parcial
    async function processPartialReturn(withdrawal, returnQty, status, notes, responsible) {
      const returnedDate = new Date().toISOString().split('T')[0];
      const remainingQty = withdrawal.quantity - returnQty;
      const isFullReturn = remainingQty === 0;
      
      // Se devolveu tudo, marcar como devolvido completamente
      if (isFullReturn) {
        // Atualizar withdrawal no Firestore
        if (window.db) {
          try {
            const { updateDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            await updateDoc(doc(window.db, 'withdrawals', withdrawal.id), {
              returnedDate: returnedDate,
              returned_date: returnedDate,
              status: 'returned',
              returnNotes: notes || ''
            });
          } catch (error) {
            console.error('Erro ao atualizar no Firestore:', error);
          }
        }
        
        // Atualizar localmente
        const withdrawalIndex = withdrawals.findIndex(w => w.id === withdrawal.id);
        if (withdrawalIndex !== -1) {
          withdrawals[withdrawalIndex].returnedDate = returnedDate;
          withdrawals[withdrawalIndex].returned_date = returnedDate;
          withdrawals[withdrawalIndex].status = 'returned';
          withdrawals[withdrawalIndex].returnNotes = notes || '';
          localStorage.setItem('withdrawals', JSON.stringify(withdrawals));
        }
      } else {
        // Devolu√ß√£o parcial - criar novo withdrawal com quantidade restante
        const newWithdrawal = {
          ...withdrawal,
          id: `${withdrawal.id}_partial_${Date.now()}`,
          quantity: remainingQty,
          partialReturn: {
            originalQty: withdrawal.quantity,
            returnedQty: returnQty,
            returnedDate: returnedDate,
            notes: notes || ''
          }
        };
        
        // Atualizar withdrawal original
        if (window.db) {
          try {
            const { updateDoc, doc, addDoc, collection } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            await updateDoc(doc(window.db, 'withdrawals', withdrawal.id), {
              quantity: returnQty,
              returnedDate: returnedDate,
              returned_date: returnedDate,
              status: 'returned',
              returnNotes: notes || '',
              isPartial: true
            });
            
            // Adicionar novo withdrawal para quantidade restante
            await addDoc(collection(window.db, 'withdrawals'), {
              ...newWithdrawal,
              createdAt: new Date()
            });
          } catch (error) {
            console.error('Erro ao atualizar no Firestore:', error);
          }
        }
        
        // Atualizar localmente
        const withdrawalIndex = withdrawals.findIndex(w => w.id === withdrawal.id);
        if (withdrawalIndex !== -1) {
          withdrawals[withdrawalIndex].quantity = returnQty;
          withdrawals[withdrawalIndex].returnedDate = returnedDate;
          withdrawals[withdrawalIndex].returned_date = returnedDate;
          withdrawals[withdrawalIndex].status = 'returned';
          withdrawals[withdrawalIndex].returnNotes = notes || '';
          withdrawals[withdrawalIndex].isPartial = true;
          
          withdrawals.push(newWithdrawal);
          localStorage.setItem('withdrawals', JSON.stringify(withdrawals));
        }
      }
      
      // Adicionar quantidade de volta ao estoque
      if (returnQty > 0) {
        const item = inventory.find(i => String(i.id) === String(withdrawal.itemId));
        
        if (item) {
          const newQuantity = (item.quantity || 0) + returnQty;
          
          if (window.db) {
            try {
              const { updateDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
              const itemDocId = String(item.id);
              await updateDoc(doc(window.db, 'inventory', itemDocId), {
                quantity: newQuantity
              });
            } catch (error) {
              console.error('Erro ao atualizar estoque no Firestore:', error);
            }
          }
          
          const itemIndex = inventory.findIndex(i => String(i.id) === String(item.id));
          if (itemIndex !== -1) {
            inventory[itemIndex].quantity = newQuantity;
            localStorage.setItem('inventory', JSON.stringify(inventory));
          }
        }
      }
      
      // Registrar no hist√≥rico
      const returnType = isFullReturn ? 'Devolu√ß√£o Total' : 'Devolu√ß√£o Parcial';
      logActivity(returnType, 
        `Devolveu ${returnQty} ${withdrawal.unit || 'unidades'} de ${withdrawal.itemName || 'item'}. ${isFullReturn ? 'Devolu√ß√£o completa.' : `Restante: ${remainingQty} ${withdrawal.unit || 'unidades'}.`}`,
        'returned'
      );
      
      history.unshift({
        id: Date.now(),
        timestamp: new Date().toLocaleString('pt-BR'),
        user: currentUser ? currentUser.name : 'Sistema',
        actions: [{
          itemId: withdrawal.itemId,
          itemName: withdrawal.itemName || 'Item',
          action: isFullReturn ? 'returned' : 'partial_return',
          quantity: returnQty,
          notes: notes || '',
          remainingQty: remainingQty
        }],
        notes: notes || ''
      });
      
      saveData();
      
      // Atualizar renderiza√ß√£o
      setTimeout(() => {
        if (window.renderInventory) {
          renderInventory();
        }
        if (window.renderDrawers) {
          renderDrawers();
        }
        if (window.renderIsolatedWithdrawals) {
          renderIsolatedWithdrawals();
        }
        if (window.renderWithdrawals) {
          renderWithdrawals();
        }
      }, 100);
      
      const message = isFullReturn 
        ? `Devolu√ß√£o total: ${returnQty} ${withdrawal.unit || 'unidades'} devolvidas`
        : `Devolu√ß√£o parcial: ${returnQty} ${withdrawal.unit || 'unidades'} devolvidas. Restante: ${remainingQty} ${withdrawal.unit || 'unidades'}`;
      showToast(message, 'success');
    }

    // Abrir timeline de item
    function openItemTimeline(itemId) {
      const item = inventory.find(i => 
        String(i.id) === String(itemId) || 
        String(i.code) === String(itemId)
      );
      
      if (!item) {
        showToast('Item n√£o encontrado', 'error');
        return;
      }
      
      const modal = document.getElementById('item-timeline-modal');
      const title = document.getElementById('timeline-item-name');
      const content = document.getElementById('item-timeline-content');
      
      title.textContent = `Linha do Tempo - ${item.name}`;
      
      // Buscar todas as a√ß√µes relacionadas a este item
      const itemHistory = [];
      
      // Hist√≥rico de a√ß√µes
      history.forEach(h => {
        if (h.actions) {
          h.actions.forEach(action => {
            if (String(action.itemId) === String(item.id) || String(action.itemId) === String(item.code)) {
              itemHistory.push({
                type: action.action,
                timestamp: h.timestamp,
                user: h.user,
                description: action,
                notes: h.notes
              });
            }
          });
        }
      });
      
      // Activity logs
      activityLogs.forEach(log => {
        if (log.description && (
          log.description.includes(item.name) || 
          log.description.includes(item.code)
        )) {
          let logType = 'create';
          if (log.action === 'Cria√ß√£o') logType = 'create';
          else if (log.action === 'Edi√ß√£o') logType = 'edit';
          else if (log.action === 'Exclus√£o') logType = 'delete';
          else if (log.action === 'Adi√ß√£o') logType = 'add';
          else if (log.action === 'Retirada') logType = 'remove';
          else if (log.action === 'Devolu√ß√£o') logType = 'returned';
          
          itemHistory.push({
            type: logType,
            timestamp: log.timestamp,
            user: log.user,
            description: log.description,
            notes: ''
          });
        }
      });
      
      // Withdrawals relacionados
      withdrawals.forEach(w => {
        if (String(w.itemId) === String(item.id) || String(w.itemId) === String(item.code)) {
          itemHistory.push({
            type: 'remove',
            timestamp: w.withdrawalDate ? new Date(w.withdrawalDate + 'T12:00:00').toLocaleString('pt-BR') : new Date().toLocaleString('pt-BR'),
            user: w.userName || w.user_name || 'Sistema',
            description: `Retirado para ${w.course || w.courseName || 'curso'}`,
            notes: w.withdrawalReason || ''
          });
          
          if (w.returnedDate || w.returned_date) {
            itemHistory.push({
              type: w.isPartial ? 'partial' : 'returned',
              timestamp: w.returnedDate ? new Date(w.returnedDate + 'T12:00:00').toLocaleString('pt-BR') : new Date().toLocaleString('pt-BR'),
              user: w.returnResponsible || w.userName || 'Sistema',
              description: w.isPartial ? `Devolu√ß√£o parcial: ${w.partialReturn?.returnedQty || 0} ${w.unit || 'UN'}` : 'Devolvido',
              notes: w.returnNotes || ''
            });
          }
        }
      });
      
      // Ordenar por timestamp
      itemHistory.sort((a, b) => {
        const dateA = new Date(a.timestamp);
        const dateB = new Date(b.timestamp);
        return dateB - dateA;
      });
      
      if (itemHistory.length === 0) {
        content.innerHTML = '<div class="empty-state">Nenhum hist√≥rico encontrado para este item.</div>';
      } else {
        content.innerHTML = itemHistory.map(h => {
          const actionLabels = {
            create: 'Criado',
            edit: 'Editado',
            delete: 'Exclu√≠do',
            add: 'Adicionado',
            remove: 'Retirado',
            returned: 'Devolvido',
            partial: 'Devolu√ß√£o Parcial'
          };
          
          return `
            <div class="timeline-item">
              <div class="timeline-content">
                <div class="timeline-header">
                  <span class="timeline-action ${h.type}">${actionLabels[h.type] || 'A√ß√£o'}</span>
                  <span class="timeline-time">${h.timestamp}</span>
                </div>
                <div class="timeline-details">${h.description}</div>
                ${h.notes ? `<div class="timeline-details" style="margin-top: 8px; font-style: italic;">${h.notes}</div>` : ''}
                <div class="timeline-user">Por: ${h.user || 'Sistema'}</div>
              </div>
            </div>
          `;
        }).join('');
      }
      
      modal.classList.add('active');
    }

    // Gerar termo PDF de retirada
    function generateWithdrawalPDF(withdrawalId) {
      const withdrawal = withdrawals.find(w => w.id === withdrawalId);
      if (!withdrawal) {
        showToast('Movimenta√ß√£o n√£o encontrada!', 'error');
        return;
      }
      
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 15;
        let yPos = margin;
        
        // Cabe√ßalho
        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text('TERMO DE RETIRADA DE MATERIAL', pageWidth / 2, yPos, { align: 'center' });
        yPos += 10;
        
        doc.setFontSize(12);
        doc.setFont(undefined, 'normal');
        doc.text('Cear√° Sem Fome - Controle de Estoque', pageWidth / 2, yPos, { align: 'center' });
        yPos += 15;
        
        // Linha separadora
        doc.setLineWidth(0.5);
        doc.line(margin, yPos, pageWidth - margin, yPos);
        yPos += 10;
        
        // Dados do termo
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('DADOS DA RETIRADA', margin, yPos);
        yPos += 8;
        
        doc.setFont(undefined, 'normal');
        doc.setFontSize(10);
        
        const data = [
          ['Item:', withdrawal.itemName || withdrawal.item_name || 'N/A'],
          ['Quantidade:', `${withdrawal.quantity || 0} ${withdrawal.unit || 'UN'}`],
          ['Curso/Projeto:', withdrawal.course || withdrawal.courseName || 'N/A'],
          ['Data de Sa√≠da:', formatDate(withdrawal.withdrawalDate || withdrawal.withdrawal_date)],
          ['Data Prevista de Retorno:', formatDate(withdrawal.expectedReturnDate || withdrawal.expected_return_date)],
          ['Localiza√ß√£o:', withdrawal.location || 'N/A'],
          ['Motivo:', withdrawal.withdrawalReason || withdrawal.reason || 'N/A'],
          ['Retirado por:', withdrawal.userName || withdrawal.user_name || 'N/A']
        ];
        
        data.forEach(([label, value]) => {
          doc.setFont(undefined, 'bold');
          doc.text(label, margin, yPos);
          doc.setFont(undefined, 'normal');
          doc.text(value, margin + 50, yPos);
          yPos += 7;
        });
        
        yPos += 10;
        
        // Espa√ßo para assinaturas
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('ASSINATURAS', margin, yPos);
        yPos += 15;
        
        // Retirante
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text('Retirante:', margin, yPos);
        yPos += 20;
        doc.line(margin, yPos, pageWidth / 2 - 10, yPos);
        doc.setFontSize(9);
        doc.text(withdrawal.userName || withdrawal.user_name || '_________________', margin + (pageWidth / 2 - margin - 10) / 2, yPos + 5, { align: 'center' });
        
        // Autorizador
        yPos -= 20;
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text('Autorizador:', pageWidth / 2 + 10, yPos);
        yPos += 20;
        doc.line(pageWidth / 2 + 10, yPos, pageWidth - margin, yPos);
        doc.setFontSize(9);
        doc.text('_________________', pageWidth / 2 + 10 + (pageWidth / 2 - margin - 10) / 2, yPos + 5, { align: 'center' });
        
        yPos += 15;
        
        // Rodap√©
        doc.setFontSize(8);
        doc.setTextColor(128, 128, 128);
        doc.text(`Documento gerado em ${new Date().toLocaleString('pt-BR')}`, pageWidth / 2, pageWidth * 2.834 - 10, { align: 'center' });
        
        // Salvar
        const fileName = `termo_retirada_${withdrawal.itemName?.replace(/\s+/g, '_') || 'item'}_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(fileName);
        
        showToast('Termo PDF gerado com sucesso!', 'success');
      } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        showToast('Erro ao gerar PDF. Verifique o console.', 'error');
      }
    }


    // Carregar cursos na inicializa√ß√£o
    const originalInit = init;
    init = function() {
      originalInit();
      loadCourses();
    };

    // Expor fun√ß√µes globalmente
    window.renderDrawers = renderDrawers;
    window.renderIsolatedWithdrawals = renderIsolatedWithdrawals;
    window.openCreateCourseModal = openCreateCourseModal;
    window.goToCourseStep1 = goToCourseStep1;
    window.goToCourseStep2 = goToCourseStep2;
    window.renderCourseItemsList = renderCourseItemsList;
    window.filterCourseItems = filterCourseItems;
    window.toggleCourseItem = toggleCourseItem;
    window.updateCourseItemQty = updateCourseItemQty;
    window.updateCourseSelectedItems = updateCourseSelectedItems;
    window.confirmCourseWithItems = confirmCourseWithItems;
    window.generateCourseWithdrawalPDF = generateCourseWithdrawalPDF;
    window.generateCourseWithdrawalPDFFromCard = generateCourseWithdrawalPDFFromCard;
    window.openEditCourseModal = openEditCourseModal;
    window.confirmDeleteCourse = confirmDeleteCourse;
    window.returnAllCourseItems = returnAllCourseItems;
    window.toggleReturnDate = toggleReturnDate;
    window.openDrawerDetails = openDrawerDetails;
    window.openCourseChecklist = openCourseChecklist;
    window.finalizeCourseChecklist = finalizeCourseChecklist;
    window.openPartialReturnModal = openPartialReturnModal;
    window.confirmPartialReturn = confirmPartialReturn;
    window.updatePartialReturnPreview = updatePartialReturnPreview;
    window.openItemTimeline = openItemTimeline;
    window.generateWithdrawalPDF = generateWithdrawalPDF;
    window.loadCourses = loadCourses;
    window.startCoursesSync = startCoursesSync;
    window.stopCoursesSync = stopCoursesSync;
    window.saveCourses = saveCourses;
    window.withdrawals = withdrawals; // Expor para debug
    window.loadWithdrawalsLocal = loadWithdrawalsLocal;
  </script>
</body>
</html>

