<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Controle de Estoque - Cear√° Sem Fome (Melhorado)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <!-- Firebase SDK v10 (ES Modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyAgbHvbj5zewZWFmfDQ2U-K-yRUO_J7WqE",
      authDomain: "almox-72903.firebaseapp.com",
      projectId: "almox-72903",
      storageBucket: "almox-72903.firebasestorage.app",
      messagingSenderId: "570221299350",
      appId: "1:570221299350:web:7d3b216beb1c23a57764b7",
      measurementId: "G-XTZ90FT9GG"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    
    // üîê Auth
    window.auth = getAuth(app);

    // ‚òÅÔ∏è Firestore
    window.db = getFirestore(app);
    
    // üìä Analytics (apenas se n√£o estiver em localhost)
    try {
      if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
        window.analytics = getAnalytics(app);
        console.log('‚úÖ Firebase Analytics inicializado');
      } else {
        console.log('‚ÑπÔ∏è Analytics desabilitado em localhost');
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è Erro ao inicializar Analytics:', error);
    }
    window.firestoreStatus = { connected: false, error: null, lastCheck: null };
    
    // Fun√ß√£o para verificar status do Firestore
    window.checkFirestoreStatus = async function() {
      try {
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        // Tentar ler um documento de teste
        const testRef = doc(window.db, "_test", "connection");
        await getDoc(testRef);
        window.firestoreStatus.connected = true;
        window.firestoreStatus.error = null;
        window.firestoreStatus.lastCheck = new Date().toISOString();
        console.log('‚úÖ Firestore est√° conectado e funcionando!');
        return true;
      } catch (error) {
        window.firestoreStatus.connected = false;
        window.firestoreStatus.error = error.message || error.code || 'Erro desconhecido';
        window.firestoreStatus.lastCheck = new Date().toISOString();
        console.warn('‚ö†Ô∏è Firestore n√£o est√° dispon√≠vel:', error);
        return false;
      }
    };
    
    // Vari√°vel para armazenar o unsubscribe do snapshot
    let inventoryUnsubscribe = null;
    
    // Fun√ß√£o para iniciar sincroniza√ß√£o do Firestore (ap√≥s autentica√ß√£o)
    window.startFirestoreSync = function() {
      // Se j√° existe um snapshot ativo, n√£o criar outro
      if (inventoryUnsubscribe) {
        console.log('Firestore sync j√° est√° ativo');
        return;
      }
      
      try {
        const inventoryRef = collection(window.db, "inventory");
        
        inventoryUnsubscribe = onSnapshot(inventoryRef, 
          (snapshot) => {
            // Sucesso - Firestore est√° funcionando
            window.firestoreStatus.connected = true;
            window.firestoreStatus.error = null;
            
            const updatedInventory = snapshot.docs.map(doc => ({
              id: parseInt(doc.id) || doc.id,
              ...doc.data()
            }));
            
            // Atualizar vari√°vel local e window
            if (window.inventory !== undefined) {
              window.inventory.length = 0;
              window.inventory.push(...updatedInventory);
            }
            
            // Atualizar vari√°vel local inventory tamb√©m
            if (window.setInventory) {
              window.setInventory(updatedInventory);
            }
            
            if (window.renderInventory) {
              window.renderInventory();
            }
            
          },
          (error) => {
            // Erro na conex√£o
            window.firestoreStatus.connected = false;
            window.firestoreStatus.error = error.message || error.code || 'Erro desconhecido';
            console.error('‚ùå Erro no Firestore:', error);
            
          // Se for erro de permiss√£o, mostrar mensagem espec√≠fica
            if (error.code === 'permission-denied' || error.message?.includes('permission')) {
              if (window.showToast) {
                window.showToast('Erro de permiss√£o. Verifique as regras de seguran√ßa do Firestore.', 'error');
              }
            }
            // Se for erro de "database does not exist", mostrar mensagem
            else if (error.code === 'not-found' || error.message?.includes('does not exist')) {
              if (window.showToast) {
                window.showToast('Firestore n√£o foi criado ainda. O sistema est√° usando armazenamento local.', 'warning');
              }
            }
          }
        );
        
        console.log('‚úÖ Sincroniza√ß√£o do Firestore iniciada');
      } catch (error) {
        console.error('‚ùå Erro ao configurar Firestore:', error);
        window.firestoreStatus.connected = false;
        window.firestoreStatus.error = error.message || 'Erro ao inicializar';
      }
    };
    
    // Fun√ß√£o para parar sincroniza√ß√£o do Firestore
    window.stopFirestoreSync = function() {
      if (inventoryUnsubscribe) {
        inventoryUnsubscribe();
        inventoryUnsubscribe = null;
        console.log('Sincroniza√ß√£o do Firestore parada');
      }
    };
    
    // Observar estado de autentica√ß√£o
    onAuthStateChanged(window.auth, (user) => {
      if (user) {
        // Usu√°rio autenticado - iniciar sincroniza√ß√£o
        if (window.setCurrentUser && window.showMainContent && window.updateUserInfo) {
          const userData = {
            uid: user.uid,
            email: user.email,
            name: user.email.split('@')[0],
            role: 'admin' // Por padr√£o, todos s√£o admin (pode ajustar depois)
          };
          window.setCurrentUser(userData);
          window.updateUserInfo();
          window.showMainContent();
          
          // Iniciar sincroniza√ß√£o do Firestore ap√≥s login
          setTimeout(() => {
            if (window.startFirestoreSync) {
              window.startFirestoreSync();
            }
            if (window.startWithdrawalsSync) {
              window.startWithdrawalsSync();
            }
          }, 500);
        }
      } else {
        // Usu√°rio n√£o autenticado - parar sincroniza√ß√£o
        if (window.stopFirestoreSync) {
          window.stopFirestoreSync();
        }
        
        // Parar sincroniza√ß√£o de withdrawals
        if (withdrawalsUnsubscribe) {
          withdrawalsUnsubscribe();
          withdrawalsUnsubscribe = null;
        }
        
        if (window.setCurrentUser && window.showLogin) {
          window.setCurrentUser(null);
          window.showLogin();
        }
      }
    });
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* Cores principais */
      --gov-blue: #4A90E2;
      --gov-green: #7CB342;
      --gov-yellow: #FDD835;
      --gov-red: #E53935;
      --gov-gray: #424242;
      --gov-light: #F5F5F5;
      --bg-white: #FFFFFF;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
      --shadow-lg: 0 4px 16px rgba(0,0,0,0.15);
      
      /* Tema claro (padr√£o) */
      --bg-primary: #FFFFFF;
      --bg-secondary: #F5F5F5;
      --bg-tertiary: #FAFAFA;
      --text-primary: #1D1D1F;
      --text-secondary: #86868B;
      --border-color: #E5E5E7;
      --card-bg: #FFFFFF;
      --card-shadow: 0 2px 16px rgba(0,0,0,0.08);
    }

    [data-theme="dark"] {
      /* Tema escuro */
      --bg-primary: #000000;
      --bg-secondary: #1C1C1E;
      --bg-tertiary: #2C2C2E;
      --text-primary: #F5F5F7;
      --text-secondary: #86868B;
      --border-color: #38383A;
      --card-bg: #1C1C1E;
      --card-shadow: 0 2px 16px rgba(0,0,0,0.3);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'SF Pro Display', 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      min-height: 100vh;
      color: var(--text-primary);
      transition: background 0.3s, color 0.3s;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Sistema de Login */
    #login-page {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-container {
      background: var(--card-bg);
      padding: 40px;
      border-radius: 20px;
      box-shadow: var(--card-shadow);
      max-width: 400px;
      width: 100%;
      border: 1px solid var(--border-color);
      position: relative;
    }

    .login-checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      margin-bottom: 8px;
    }

    .login-checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .login-checkbox-group label {
      font-size: 14px;
      color: var(--text-secondary);
      cursor: pointer;
      user-select: none;
    }

    .login-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 30px;
      text-align: center;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      left: -280px;
      top: 0;
      width: 280px;
      height: 100vh;
      background: var(--card-bg);
      box-shadow: var(--card-shadow);
      z-index: 1000;
      transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow-y: auto;
      border-right: 1px solid var(--border-color);
    }

    .sidebar.active {
      left: 0;
    }

    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }

    .sidebar-overlay.active {
      display: block;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-header h3 {
      color: var(--text-primary);
      font-weight: 600;
    }

    .sidebar-user {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .sidebar-menu {
      padding: 20px 0;
    }

    .sidebar-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      cursor: pointer;
      transition: background 0.2s;
      color: var(--gov-gray);
      text-decoration: none;
    }

    .sidebar-item:hover {
      background: var(--gov-light);
    }

    .sidebar-item.active {
      background: rgba(74, 144, 226, 0.1);
      color: var(--gov-blue);
      font-weight: 600;
    }

    .header {
      background: var(--card-bg);
      padding: 12px 20px;
      box-shadow: var(--card-shadow);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-color);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      height: 50px;
    }

    .logo-svg {
      width: 60px;
      height: 60px;
      display: inline-block;
    }

    .logo-svg-small {
      width: 40px;
      height: 40px;
      display: inline-block;
    }

    .logo-svg svg {
      width: 100%;
      height: 100%;
    }

    .logo-svg svg {
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    [data-theme="dark"] .logo-svg svg {
      filter: drop-shadow(0 2px 4px rgba(255, 255, 255, 0.1));
    }

    .login-logo {
      text-align: center;
      margin-bottom: 24px;
    }

    .login-logo .logo-svg {
      width: 80px;
      height: 80px;
    }

    .menu-btn {
      background: transparent;
      color: var(--text-primary);
      border: none;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      width: 40px;
      height: 40px;
    }

    .menu-btn:hover {
      background: var(--bg-secondary);
    }

    .menu-btn .material-icons {
      font-size: 24px;
    }

    .theme-toggle {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .theme-toggle:hover {
      background: var(--bg-tertiary);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .search-bar {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      margin-bottom: 24px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      border: 1px solid var(--border-color);
    }

    .filter-info {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-radius: 12px;
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .filter-info strong {
      color: var(--text-primary);
      font-weight: 600;
    }

    .search-input {
      flex: 1;
      min-width: 200px;
      padding: 14px 18px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      font-size: 16px;
      font-family: inherit;
      background: var(--bg-secondary);
      color: var(--text-primary);
      transition: all 0.2s;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--gov-blue);
      background: var(--card-bg);
      box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1);
    }

    .search-input::placeholder {
      color: var(--text-secondary);
    }

    .filter-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 10px 18px;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      border-radius: 12px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      color: var(--text-primary);
    }

    .filter-btn:hover {
      border-color: var(--gov-blue);
      color: var(--gov-blue);
      background: var(--card-bg);
    }

    .filter-btn.active {
      background: transparent;
      color: var(--gov-blue);
      border-color: var(--gov-blue);
      box-shadow: none;
    }

    .inventory-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 100px;
    }

    .item-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 24px;
      box-shadow: var(--card-shadow);
      display: flex;
      flex-direction: column;
      gap: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      border: 1px solid var(--border-color);
    }

    .item-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    .item-card.updated {
      animation: highlight 0.6s ease-out;
    }

    .item-card.updated-add {
      animation: highlightGreen 0.6s ease-out;
    }

    .item-card.updated-remove {
      animation: highlightRed 0.6s ease-out;
    }

    @keyframes highlight {
      from { box-shadow: 0 0 0 6px rgba(74,144,226,0.3); }
      to { box-shadow: var(--card-shadow); }
    }

    @keyframes highlightGreen {
      0% { box-shadow: 0 0 0 6px rgba(124,179,66,0.4); background-color: rgba(124,179,66,0.1); }
      50% { box-shadow: 0 0 0 4px rgba(124,179,66,0.3); }
      100% { box-shadow: var(--card-shadow); background-color: var(--card-bg); }
    }

    @keyframes highlightRed {
      0% { box-shadow: 0 0 0 6px rgba(229,57,53,0.4); background-color: rgba(229,57,53,0.1); }
      50% { box-shadow: 0 0 0 4px rgba(229,57,53,0.3); }
      100% { box-shadow: var(--card-shadow); background-color: var(--card-bg); }
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .item-code {
      font-size: 11px;
      color: var(--text-secondary);
      background: var(--bg-secondary);
      padding: 4px 8px;
      border-radius: 8px;
      font-weight: 500;
    }

    .item-status {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      flex-shrink: 0;
      margin-left: auto;
      box-shadow: 0 0 0 3px rgba(0,0,0,0.05);
    }

    .item-status.ok {
      background: var(--gov-green);
    }

    .item-status.warning {
      background: var(--gov-yellow);
    }

    .item-status.critical {
      background: var(--gov-red);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .item-name {
      font-weight: 700;
      text-align: left;
      font-size: 22px;
      color: var(--text-primary);
      margin-bottom: 12px;
      line-height: 1.3;
      letter-spacing: -0.02em;
    }

    .item-category {
      font-size: 13px;
      color: var(--text-secondary);
      text-align: left;
    }

    .item-quantity {
      font-size: 40px;
      font-weight: 800;
      text-align: left;
      line-height: 1;
      margin: 12px 0;
      letter-spacing: -0.03em;
    }

    .item-quantity.ok {
      color: var(--gov-green);
    }

    .item-quantity.warning {
      color: var(--gov-yellow);
    }

    .item-quantity.critical {
      color: var(--gov-red);
    }

    .item-info {
      font-size: 12px;
      color: var(--text-secondary);
      text-align: left;
      margin-top: 4px;
      opacity: 0.7;
    }

    .badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 8px;
      background: rgba(74, 144, 226, 0.1);
      color: var(--gov-blue);
      font-weight: 500;
      display: inline-block;
      margin: 2px 0;
    }

    .badge.location {
      background: rgba(124, 179, 66, 0.1);
      color: var(--gov-green);
    }

    .badge.project {
      background: rgba(74, 144, 226, 0.1);
      color: var(--gov-blue);
    }

    .item-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
    }


    .item-actions {
      display: flex;
      gap: 8px;
      width: 100%;
    }

    .action-btn {
      flex: 1;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--card-bg);
      color: var(--text-primary);
    }

    .btn-add {
      border-color: var(--gov-green);
      color: var(--gov-green);
    }

    .btn-add:hover {
      background: rgba(124, 179, 66, 0.1);
      border-color: var(--gov-green);
    }

    .btn-remove {
      border-color: var(--gov-red);
      color: var(--gov-red);
      position: relative;
    }

    .btn-remove:hover {
      background: rgba(229, 57, 53, 0.1);
      border-color: var(--gov-red);
    }

    .btn-remove.dangerous {
      background: rgba(229, 57, 53, 0.15);
      border-color: var(--gov-red);
    }

    .action-btn:hover {
      transform: none;
    }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Bot√£o Flutuante */
    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--card-bg);
      color: var(--gov-blue);
      border: 1px solid var(--border-color);
      box-shadow: var(--card-shadow);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      z-index: 999;
      transition: all 0.2s;
    }

    .fab:hover {
      background: var(--bg-secondary);
      border-color: var(--gov-blue);
      transform: none;
      box-shadow: var(--card-shadow);
    }

    .fab:active {
      transform: scale(0.95);
    }

    /* Bot√µes de a√ß√£o no card */
    .item-card-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 12px;
    }

    .item-edit-btn {
      width: 28px;
      height: 28px;
      padding: 0;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      color: var(--text-secondary);
      opacity: 0.6;
    }

    .item-edit-btn:hover {
      background: var(--bg-secondary);
      color: var(--gov-blue);
      opacity: 1;
    }

    .item-edit-btn .material-icons {
      font-size: 18px;
    }

    /* Loading de login */
    .login-loading {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 20px;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 10;
    }

    .login-loading.active {
      display: flex;
    }

    .login-success {
      display: none;
      color: var(--gov-green);
      font-size: 14px;
      margin-top: 8px;
      align-items: center;
      gap: 6px;
    }

    .login-success.active {
      display: flex;
    }

    /* P√°gina de withdrawals */
    .withdrawals-filters {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      margin-bottom: 24px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      border: 1px solid var(--border-color);
    }

    .withdrawal-card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-color);
      margin-bottom: 16px;
    }

    .withdrawal-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    .withdrawal-status.in_use {
      background: rgba(74, 144, 226, 0.1);
      color: var(--gov-blue);
    }

    .withdrawal-status.overdue {
      background: rgba(229, 57, 53, 0.1);
      color: var(--gov-red);
    }

    .withdrawal-status.returned {
      background: rgba(124, 179, 66, 0.1);
      color: var(--gov-green);
    }

    .withdrawals-group {
      margin-bottom: 32px;
    }

    .withdrawals-group-header {
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border-color);
    }

    .withdrawals-group-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .withdrawals-group-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    /* Grid de prateleira para withdrawals */
    .withdrawals-shelf-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .withdrawal-shelf-item {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      box-shadow: var(--card-shadow);
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
    }

    .withdrawal-shelf-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .withdrawal-shelf-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .withdrawal-shelf-item-name {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .withdrawal-shelf-item-details {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .withdrawal-shelf-item-details strong {
      color: var(--text-primary);
    }

    /* Lista de projetos */
    .project-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .project-item-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .project-item-actions {
      display: flex;
      gap: 8px;
    }

    .project-action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .project-action-btn.edit {
      background: var(--gov-blue);
      color: white;
    }

    .project-action-btn.delete {
      background: var(--gov-red);
      color: white;
    }

    .project-action-btn:hover {
      opacity: 0.8;
      transform: scale(1.05);
    }

    @media (max-width: 1200px) {
      .withdrawals-shelf-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 768px) {
      .withdrawals-shelf-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .withdrawals-shelf-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Toasts */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast {
      background: var(--card-bg);
      padding: 16px 20px;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      max-width: 400px;
      animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid var(--border-color);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success {
      border-left: 4px solid var(--gov-green);
    }

    .toast.error {
      border-left: 4px solid var(--gov-red);
    }

    .toast.warning {
      border-left: 4px solid var(--gov-yellow);
    }

    .toast.info {
      border-left: 4px solid var(--gov-blue);
    }

    .toast-icon {
      font-size: 24px;
    }

    .toast.success .toast-icon {
      color: var(--gov-green);
    }

    .toast.error .toast-icon {
      color: var(--gov-red);
    }

    .toast.warning .toast-icon {
      color: var(--gov-yellow);
    }

    .toast.info .toast-icon {
      color: var(--gov-blue);
    }

    .toast-message {
      flex: 1;
    }

    .toast-close {
      background: none;
      border: none;
      cursor: pointer;
      color: #999;
      padding: 4px;
    }


    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      padding: 20px;
      animation: fadeIn 0.2s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 24px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid var(--border-color);
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .close-btn:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      font-family: inherit;
      background: var(--bg-secondary);
      color: var(--text-primary);
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--gov-blue);
      background: var(--card-bg);
      box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .quantity-selector {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }

    .quantity-input {
      padding: 12px;
      border: 2px solid #E0E0E0;
      border-radius: 8px;
      font-size: 24px;
      text-align: center;
      font-weight: 700;
    }

    .quick-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .quick-btn {
      padding: 8px;
      border: 1px solid var(--border-color);
      background: transparent;
      color: var(--text-primary);
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-btn:hover {
      background: var(--bg-secondary);
      border-color: var(--gov-blue);
      color: var(--gov-blue);
    }

    .submit-btn {
      width: 100%;
      padding: 12px 16px;
      background: transparent;
      color: var(--gov-blue);
      border: 1px solid var(--gov-blue);
      border-radius: 8px;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      margin-top: 12px;
      transition: all 0.2s;
    }

    .submit-btn:hover {
      background: rgba(74, 144, 226, 0.1);
    }

    .submit-btn:active {
      transform: none;
    }

    .btn-minimalist {
      padding: 8px 12px;
      background: transparent;
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-minimalist:hover {
      background: var(--bg-secondary);
      border-color: var(--gov-blue);
      color: var(--gov-blue);
    }

    .btn-minimalist .material-icons {
      font-size: 18px;
    }

    .submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-danger {
      background: transparent;
      border-color: var(--gov-red);
      color: var(--gov-red);
    }

    .btn-danger:hover {
      background: rgba(229, 57, 53, 0.1);
    }

    .btn-secondary {
      background: transparent;
      border-color: var(--text-secondary);
      color: var(--text-secondary);
    }

    .btn-secondary:hover {
      background: var(--bg-secondary);
    }

    .btn-success {
      background: transparent;
      border-color: var(--gov-green);
      color: var(--gov-green);
    }

    .btn-success:hover {
      background: rgba(124, 179, 66, 0.1);
    }


    .notes-input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      font-family: inherit;
      resize: vertical;
      min-height: 80px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      transition: all 0.2s;
    }

    .notes-input:focus {
      outline: none;
      border-color: var(--gov-blue);
      background: var(--card-bg);
      box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1);
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .page-content {
      display: none;
    }

    .page-content.active {
      display: block;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text-primary);
    }

    .stat-card {
      background: var(--card-bg);
      padding: 24px;
      border-radius: 20px;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-color);
    }

    .stat-title {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--gov-blue);
      line-height: 1;
    }

    .chart-container {
      background: var(--card-bg);
      padding: 24px;
      border-radius: 20px;
      box-shadow: var(--card-shadow);
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }

    .chart-wrapper {
      position: relative;
      height: 300px;
      width: 100%;
    }

    .chart-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .history-item {
      background: var(--card-bg);
      padding: 16px;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-color);
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .history-time {
      color: var(--text-secondary);
      font-size: 12px;
    }

    .history-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 8px;
    }

    .history-action {
      font-size: 14px;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(74, 144, 226, 0.3);
      border-radius: 50%;
      border-top-color: var(--gov-blue);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      background: #333;
      color: white;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
      margin-bottom: 5px;
    }

    /* Mobile */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        left: -100%;
      }

      .inventory-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 12px;
      }

      .item-card {
        padding: 20px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .search-bar {
        flex-direction: column;
        padding: 16px;
      }

      .filter-buttons {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }

      .filter-btn {
        flex: 1;
        padding: 10px;
        font-size: 14px;
      }

      .container {
        padding: 16px;
      }
    }

    /* Mobile - Melhorias espec√≠ficas */
    @media (max-width: 480px) {
      /* Cards compact√°veis - esconder item-meta por padr√£o */
      .item-meta {
        display: none;
      }

      .item-card.expanded .item-meta {
        display: flex;
      }

      /* Bot√µes de a√ß√£o maiores (thumb friendly) */
      .action-btn {
        padding: 14px;
        font-size: 18px;
      }

      /* Filtros colaps√°veis */
      .filter-buttons {
        display: none;
        margin-top: 12px;
      }

      .filter-buttons.active {
        display: grid;
      }

      #mobile-filters-btn {
        display: flex;
      }

      /* Header mobile - esconder texto do theme toggle */
      #theme-text {
        display: none;
      }

      /* Modais estilo bottom-sheet */
      .modal-content {
        border-radius: 20px 20px 0 0;
        max-height: 90vh;
        margin-top: auto;
        margin-bottom: 0;
        padding-bottom: max(24px, env(safe-area-inset-bottom));
      }

      .modal {
        align-items: flex-end;
        padding: 0;
      }

      /* Feedback visual de toque */
      .action-btn:active,
      .filter-btn:active,
      .fab:active,
      .submit-btn:active,
      .item-edit-btn:active,
      .btn-minimalist:active,
      .quick-btn:active,
      .project-action-btn:active {
        transform: scale(0.96);
      }
    }
  </style>
</head>
<body>
  <!-- Sistema de Login -->
  <div id="login-page" style="display: none;">
    <div class="login-container">
      <h2 class="login-title">Controle de Estoque</h2>
      <form id="login-form">
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="login-username" placeholder="seu@email.com" required autocomplete="email">
        </div>
        <div class="form-group">
          <label class="form-label">Senha</label>
          <input type="password" class="form-input" id="login-password" required autocomplete="current-password" oninput="validateLoginPassword()">
          <div class="login-success" id="login-success">
            <span class="material-icons" style="font-size: 18px;">check_circle</span>
            <span>Senha v√°lida</span>
          </div>
        </div>
        <div class="login-checkbox-group">
          <input type="checkbox" id="remember-password">
          <label for="remember-password">Salvar senha</label>
        </div>
        <button type="submit" class="submit-btn" id="login-submit-btn">
          <span id="login-btn-text">Entrar</span>
          <span id="login-btn-loading" class="loading" style="display: none; margin-left: 8px;"></span>
        </button>
      </form>
      <div class="login-loading" id="login-loading">
        <div class="loading" style="width: 40px; height: 40px; margin-bottom: 16px;"></div>
        <p style="color: var(--text-primary); font-weight: 500;">Entrando...</p>
      </div>
    </div>
  </div>

  <!-- Conte√∫do Principal -->
  <div id="main-content" style="display: none;">
    <!-- Sidebar -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h3>Menu</h3>
        <button class="close-btn" onclick="toggleSidebar()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="sidebar-user">
        <div style="font-weight: 600;" id="sidebar-username">Usu√°rio</div>
        <div style="font-size: 12px; color: var(--text-secondary);" id="sidebar-userrole">Operador</div>
      </div>
      <div class="sidebar-menu">
        <a class="sidebar-item active" onclick="navigateTo('inventory', this)">
          <span class="material-icons">inventory</span>
          <span>Estoque</span>
        </a>
        <a class="sidebar-item" onclick="navigateTo('dashboard', this)">
          <span class="material-icons">dashboard</span>
          <span>Dashboard</span>
        </a>
        <a class="sidebar-item" onclick="navigateTo('withdrawals', this)">
          <span class="material-icons">inventory_2</span>
          <span>Itens em Uso</span>
        </a>
        <a class="sidebar-item" onclick="navigateTo('history', this)">
          <span class="material-icons">history</span>
          <span>Hist√≥rico</span>
        </a>
        <a class="sidebar-item" onclick="navigateTo('settings', this)">
          <span class="material-icons">settings</span>
          <span>Configura√ß√µes</span>
        </a>
        <a class="sidebar-item" onclick="logout()">
          <span class="material-icons">logout</span>
          <span>Sair</span>
        </a>
      </div>
    </div>

    <!-- Header -->
    <div class="header">
      <div class="header-content">
        <div style="display: flex; align-items: center; gap: 16px;">
          <button class="menu-btn" onclick="toggleSidebar()" title="Menu">
            <span class="material-icons">menu</span>
          </button>
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
          <button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle">
            <span class="material-icons" id="theme-icon">dark_mode</span>
            <span id="theme-text">Escuro</span>
          </button>
          <div class="user-info">
            <span id="header-username">Usu√°rio</span>
            <span class="material-icons">account_circle</span>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- P√°gina de Estoque -->
      <div id="inventory-page" class="page-content active">
        <div class="search-bar">
          <div style="display: flex; gap: 8px; width: 100%;">
            <input type="text" class="search-input" placeholder="üîç Buscar itens..." id="search-input" oninput="filterItems(this.value)" style="flex: 1;">
            <button class="btn-minimalist" id="mobile-filters-btn" onclick="toggleFilters()" style="display: none;">
              <span class="material-icons">filter_list</span>
              <span>Filtros</span>
            </button>
          </div>
          <div class="filter-buttons" id="filter-buttons">
            <button class="filter-btn active" onclick="setLocationFilter('all', this)">Todos</button>
            <button class="filter-btn" onclick="setLocationFilter('ADM', this)">ADM</button>
            <button class="filter-btn" onclick="setLocationFilter('IAC-SOCIAL', this)">IAC-SOCIAL</button>
          </div>
        </div>
        <div class="filter-info" id="filter-info" style="display: none;">
          <span class="material-icons" style="font-size: 18px;">filter_list</span>
          <span>Mostrando <strong id="filtered-count">0</strong> de <strong id="total-count">0</strong> itens</span>
        </div>
        <div id="inventory-grid" class="inventory-grid"></div>
      </div>

      <!-- P√°gina de Dashboard -->
      <div id="dashboard-page" class="page-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0;">Dashboard</h2>
          <button class="btn-minimalist" onclick="openChartsModal()" style="white-space: nowrap;">
            <span class="material-icons">bar_chart</span>
          </button>
        </div>
        <div class="dashboard-grid" id="dashboard-content"></div>
      </div>


      <!-- P√°gina de Hist√≥rico -->
      <div id="history-page" class="page-content">
        <h2 style="margin-bottom: 20px;">Hist√≥rico de Altera√ß√µes</h2>
        <div class="withdrawals-filters" style="margin-bottom: 20px;">
          <div class="form-group" style="flex: 1; min-width: 200px;">
            <label class="form-label">Filtrar por Tipo</label>
            <select class="form-input" id="history-filter-type" onchange="renderHistory()">
              <option value="all">Todos</option>
              <option value="create">Cria√ß√£o</option>
              <option value="edit">Edi√ß√£o</option>
              <option value="delete">Exclus√£o</option>
              <option value="add">Adi√ß√£o</option>
              <option value="remove">Retirada</option>
              <option value="returned">Devolu√ß√µes</option>
            </select>
          </div>
          <div class="form-group" style="flex: 1; min-width: 200px;">
            <label class="form-label">Buscar</label>
            <input type="text" class="form-input" id="history-search" placeholder="Buscar por item, usu√°rio..." oninput="renderHistory()">
          </div>
        </div>
        <div id="history-list" class="history-list"></div>
      </div>

      <!-- P√°gina de Itens em Uso -->
      <div id="withdrawals-page" class="page-content">
        <h2 style="margin-bottom: 20px;">Itens em Uso por Curso/Projeto</h2>
        <div class="withdrawals-filters">
          <div class="form-group" style="flex: 1; min-width: 200px;">
            <label class="form-label">Filtrar por Curso/Projeto</label>
            <input type="text" class="form-input" id="filter-course" placeholder="Digite o nome do curso/projeto..." oninput="filterWithdrawals()">
          </div>
          <div class="form-group" style="flex: 1; min-width: 200px;">
            <label class="form-label">Filtrar por Status</label>
            <select class="form-input" id="filter-status" onchange="filterWithdrawals()">
              <option value="all">Todos</option>
              <option value="in_use">Em Uso</option>
              <option value="overdue">Atrasados</option>
              <option value="returned">Devolvidos</option>
            </select>
          </div>
        </div>
        <div id="withdrawals-content"></div>
      </div>

      <!-- P√°gina de Configura√ß√µes -->
      <div id="settings-page" class="page-content">
        <h2 style="margin-bottom: 24px; font-size: 24px; font-weight: 600;">Configura√ß√µes</h2>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px;">
          <!-- Se√ß√£o Perfil do Usu√°rio -->
          <div style="background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color);">
            <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 600;">Perfil</h3>
            <div class="form-group" style="margin-bottom: 16px;">
              <label class="form-label">Nome</label>
              <input type="text" class="form-input" id="user-name-input" placeholder="Seu nome" style="margin-bottom: 8px;">
              <button class="submit-btn" onclick="openChangeNameModal()" style="width: 100%; padding: 10px;">Alterar Nome</button>
            </div>
            <div class="form-group" style="margin-bottom: 16px;">
              <label class="form-label">Email</label>
              <input type="text" class="form-input" id="user-email-display" readonly style="background: var(--input-bg-disabled); cursor: not-allowed;">
            </div>
            <div class="form-group">
              <button class="submit-btn" onclick="openChangePasswordModal()" style="width: 100%; padding: 10px;">Alterar Senha</button>
            </div>
          </div>

          <!-- Se√ß√£o Importa√ß√£o -->
          <div style="background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color);">
            <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 600;">Importar Dados</h3>
            <div class="form-group">
              <label class="form-label">Planilha (Excel/CSV)</label>
              <input type="file" class="form-input" id="import-file" accept=".xlsx,.xls,.csv" onchange="handleFileSelect(event)">
              <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px; line-height: 1.4;">
                Formatos: Excel (.xlsx, .xls) e CSV
              </p>
            </div>
          </div>

        <!-- Se√ß√£o Gerenciamento de Projetos e Categorias -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 24px;">
          <!-- Gerenciamento de Projetos -->
          <div style="background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color);">
            <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 600;">Projetos</h3>
            <div class="form-group" style="margin-bottom: 16px;">
              <div style="display: flex; gap: 8px;">
                <input type="text" class="form-input" id="new-project-name" placeholder="Nome do projeto">
                <button class="submit-btn" onclick="addProject()" style="white-space: nowrap; padding: 10px 16px;">Adicionar</button>
              </div>
            </div>
            <div id="projects-list" style="display: flex; flex-direction: column; gap: 6px;">
              <!-- Lista de projetos ser√° preenchida dinamicamente -->
            </div>
          </div>

          <!-- Gerenciamento de Categorias -->
          <div style="background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color);">
            <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 600;">Categorias</h3>
            <div class="form-group" style="margin-bottom: 16px;">
              <div style="display: flex; gap: 8px;">
                <input type="text" class="form-input" id="new-category-name" placeholder="Nome da categoria">
                <button class="submit-btn" onclick="addCategory()" style="white-space: nowrap; padding: 10px 16px;">Adicionar</button>
              </div>
            </div>
            <div id="categories-list" style="display: flex; flex-direction: column; gap: 6px;">
              <!-- Lista de categorias ser√° preenchida dinamicamente -->
            </div>
          </div>
        </div>

          <!-- Se√ß√£o Exporta√ß√£o e Backup -->
          <div style="background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color);">
            <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 600;">Exporta√ß√£o e Backup</h3>
            <div class="form-group" style="margin-bottom: 12px;">
              <button class="submit-btn" onclick="exportToCSV()" style="width: 100%; padding: 10px;">Exportar CSV</button>
            </div>
            <div class="form-group" style="margin-bottom: 12px;">
              <button class="submit-btn" onclick="exportToPDF()" style="width: 100%; padding: 10px;">Exportar PDF</button>
            </div>
            <div class="form-group" style="margin-bottom: 12px;">
              <button class="submit-btn" onclick="backupData()" style="width: 100%; padding: 10px;">Fazer Backup</button>
            </div>
            <div class="form-group">
              <label class="form-label">Restaurar Backup</label>
              <input type="file" class="form-input" id="restore-file" accept=".json" style="margin-bottom: 8px;">
              <button class="submit-btn btn-danger" onclick="restoreData()" style="width: 100%; padding: 10px;">Restaurar</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Modal de A√ß√£o -->
    <div class="modal" id="action-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="modal-title">Adicionar</h3>
          <button class="close-btn" onclick="closeModal('action-modal')">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div id="current-quantity-info" style="display: none; background: var(--bg-secondary); padding: 16px; border-radius: 12px; margin-bottom: 16px; text-align: center;">
          <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px;">Quantidade Atual</div>
          <div id="current-quantity-display" style="font-size: 32px; font-weight: 700; color: var(--gov-blue);"></div>
          <div id="new-quantity-preview" style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;"></div>
        </div>
        <div id="remove-dates" style="display: none;">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Data de Sa√≠da</label>
              <input type="date" class="form-input" id="withdrawal-date" required>
            </div>
            <div class="form-group">
              <label class="form-label">Data de Retorno</label>
              <input type="date" class="form-input" id="return-date" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Curso / Projeto <span style="color: var(--gov-red);">*</span></label>
            <input type="text" class="form-input" id="withdrawal-course" placeholder="Ex: Curso de Inform√°tica B√°sica" required>
          </div>
          <div class="form-group">
            <label class="form-label">Motivo da Retirada <span style="color: var(--gov-red);">*</span></label>
            <textarea class="form-input" id="withdrawal-reason" rows="3" placeholder="Informe o motivo da retirada do material..." required></textarea>
          </div>
        </div>
        <div class="quantity-selector">
          <input type="number" class="quantity-input" id="quantity-input" value="1" min="1" oninput="updateQuantityPreview()">
          <div class="quick-buttons">
            <button type="button" class="quick-btn" onclick="setQuantity(1)">1</button>
            <button type="button" class="quick-btn" onclick="setQuantity(5)">5</button>
            <button type="button" class="quick-btn" onclick="setQuantity(10)">10</button>
            <button type="button" class="quick-btn" onclick="setQuantity(20)">20</button>
          </div>
        </div>
        <button class="submit-btn" onclick="confirmAction()">Confirmar</button>
      </div>
    </div>

    <!-- Modal de Alterar Senha -->
    <div class="modal" id="change-password-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Alterar Senha</h3>
          <button class="close-btn" onclick="closeModal('change-password-modal')">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="form-group">
          <label class="form-label">Senha Atual</label>
          <input type="password" class="form-input" id="current-password" required>
        </div>
        <div class="form-group">
          <label class="form-label">Nova Senha</label>
          <input type="password" class="form-input" id="new-password" required minlength="6">
          <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">M√≠nimo de 6 caracteres</p>
        </div>
        <div class="form-group">
          <label class="form-label">Confirmar Nova Senha</label>
          <input type="password" class="form-input" id="confirm-password" required minlength="6">
        </div>
        <button class="submit-btn" onclick="changePassword()">Alterar Senha</button>
      </div>
    </div>

    <!-- Modal de Alterar Nome -->
    <div class="modal" id="change-name-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Alterar Nome</h3>
          <button class="close-btn" onclick="closeModal('change-name-modal')">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="form-group">
          <label class="form-label">Novo Nome</label>
          <input type="text" class="form-input" id="new-name-input" required>
        </div>
        <button type="button" class="submit-btn" id="save-name-btn">Salvar Nome</button>
      </div>
    </div>

    <!-- Modal de Mapeamento de Colunas -->
    <div class="modal" id="column-mapping-modal">
      <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
          <h3 class="modal-title">Mapear Colunas da Planilha</h3>
          <button class="close-btn" onclick="closeModal('column-mapping-modal')">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="form-group">
          <p style="margin-bottom: 16px; color: var(--text-secondary);">
            Selecione qual coluna da planilha corresponde a cada campo do sistema:
          </p>
          <div id="column-mapping-form"></div>
        </div>
        <button class="submit-btn" onclick="processColumnMapping()">Processar Importa√ß√£o</button>
      </div>
    </div>

    <!-- Modal de Erros da Importa√ß√£o -->
    <div class="modal" id="import-errors-modal">
      <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
        <div class="modal-header">
          <h3 class="modal-title">Erros Encontrados na Planilha</h3>
          <button class="close-btn" onclick="closeModal('import-errors-modal')">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="form-group">
          <p style="margin-bottom: 16px; color: var(--text-secondary);">
            Foram encontrados <strong id="errors-count">0</strong> erros. Corrija-os abaixo ou pule para importar apenas os itens v√°lidos.
          </p>
          <div id="import-errors-list" style="margin-bottom: 16px;"></div>
          <div style="display: flex; gap: 8px;">
            <button type="button" class="submit-btn" onclick="applyErrorCorrections()">Aplicar Corre√ß√µes</button>
            <button type="button" class="submit-btn btn-secondary" onclick="skipErrorsAndImport()">Ignorar Erros e Importar V√°lidos</button>
            <button type="button" class="submit-btn btn-danger" onclick="closeModal('import-errors-modal')">Cancelar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Criar Item -->
    <div class="modal" id="create-item-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Criar Novo Item</h3>
          <button class="close-btn" onclick="closeModal('create-item-modal')">
            <span class="material-icons">close</span>
          </button>
        </div>
        <form id="create-item-form" onsubmit="createItem(event)">
          <div class="form-group">
            <label class="form-label">C√≥digo √önico</label>
            <div style="position: relative;">
              <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-weight: 500; pointer-events: none;">#</span>
              <input type="text" class="form-input" id="item-code" required placeholder="123" style="padding-left: 24px;">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Nome do Item</label>
            <input type="text" class="form-input" id="item-name" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Categoria</label>
              <select class="form-input" id="item-category" required>
                <option value="">Selecione...</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Unidade</label>
              <select class="form-input" id="item-unit" required>
                <option value="UN">UN</option>
                <option value="KG">KG</option>
                <option value="L">L</option>
                <option value="CX">CX</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Quantidade Inicial</label>
              <input type="number" class="form-input" id="item-quantity" value="0" min="0" required>
            </div>
            <div class="form-group">
              <label class="form-label">Quantidade M√≠nima</label>
              <input type="number" class="form-input" id="item-min-quantity" value="10" min="0" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Localiza√ß√£o</label>
              <select class="form-input" id="item-location" required>
                <option value="ADM">ADM</option>
                <option value="IAC-SOCIAL">IAC-SOCIAL</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Projeto <span style="color: var(--gov-red);">*</span></label>
              <select class="form-input" id="item-project" required>
                <option value="">Selecione o projeto...</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Data de Validade (opcional)</label>
            <input type="date" class="form-input" id="item-expiry">
          </div>
          <button type="submit" class="submit-btn">Criar Item</button>
        </form>
      </div>
    </div>

    <!-- Modal de Edi√ß√£o de Item -->
    <div class="modal" id="edit-item-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Editar Item</h3>
          <button class="close-btn" onclick="closeModal('edit-item-modal')">
            <span class="material-icons">close</span>
          </button>
        </div>
        <form id="edit-item-form" onsubmit="saveItemEdit(event)">
          <div class="form-group">
            <label class="form-label">C√≥digo √önico</label>
            <input type="text" class="form-input" id="edit-item-code" required readonly>
          </div>
          <div class="form-group">
            <label class="form-label">Nome do Item</label>
            <input type="text" class="form-input" id="edit-item-name" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Categoria</label>
              <select class="form-input" id="edit-item-category" required>
                <option value="">Selecione...</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Unidade</label>
              <select class="form-input" id="edit-item-unit" required>
                <option value="UN">UN</option>
                <option value="KG">KG</option>
                <option value="L">L</option>
                <option value="CX">CX</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Quantidade</label>
              <input type="number" class="form-input" id="edit-item-quantity" min="0" required>
            </div>
            <div class="form-group">
              <label class="form-label">Quantidade M√≠nima</label>
              <input type="number" class="form-input" id="edit-item-min-quantity" min="0" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Localiza√ß√£o</label>
              <select class="form-input" id="edit-item-location" required>
                <option value="ADM">ADM</option>
                <option value="IAC-SOCIAL">IAC-SOCIAL</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Projeto <span style="color: var(--gov-red);">*</span></label>
              <select class="form-input" id="edit-item-project" required>
                <option value="">Selecione o projeto...</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Data de Validade (opcional)</label>
            <input type="date" class="form-input" id="edit-item-expiry">
          </div>
          <div style="display: flex; gap: 8px;">
            <button type="submit" class="submit-btn" style="flex: 1;">Salvar Altera√ß√µes</button>
            <button type="button" class="submit-btn btn-danger" onclick="deleteItem()" style="flex: 1;">Excluir Item</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal de Gr√°ficos -->
    <div class="modal" id="charts-modal">
      <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
          <h3 class="modal-title">Gr√°ficos do Estoque</h3>
          <button class="close-btn" onclick="closeModal('charts-modal')">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div style="display: flex; flex-direction: column; gap: 24px;">
          <div class="chart-container">
            <div class="chart-title">Distribui√ß√£o por Localiza√ß√£o</div>
            <div class="chart-wrapper">
              <canvas id="modal-location-chart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <div class="chart-title">Status do Estoque</div>
            <div class="chart-wrapper">
              <canvas id="modal-status-chart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <div class="chart-title">Distribui√ß√£o por Projeto</div>
            <div class="chart-wrapper">
              <canvas id="modal-project-chart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Resultados da Importa√ß√£o -->
    <div class="modal" id="import-results-modal">
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
          <h3 class="modal-title">Resultado da Importa√ß√£o</h3>
          <button class="close-btn" onclick="closeModal('import-results-modal')">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="form-group" style="text-align: center;">
          <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
          <h3 id="import-success-count" style="color: var(--gov-green); font-size: 32px; margin-bottom: 8px;">0</h3>
          <p style="margin-bottom: 24px; color: var(--text-secondary);">Itens importados com sucesso</p>
          <div id="import-failed-count" style="display: none;">
            <h3 style="color: var(--gov-red); font-size: 24px; margin-bottom: 8px;">0</h3>
            <p style="margin-bottom: 24px; color: var(--text-secondary);">Itens n√£o importados</p>
          </div>
          <button class="submit-btn" onclick="closeModal('import-results-modal'); document.getElementById('import-file').value = '';">Fechar</button>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; justify-content: center; align-items: center; flex-direction: column; color: white;">
      <div style="width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px;"></div>
      <p id="loading-text" style="font-size: 18px; font-weight: 500;">Processando...</p>
    </div>

    <!-- Bot√£o Flutuante para Criar Item -->
    <button class="fab" id="fab-button" title="Criar Novo Item">
      <span class="material-icons" id="fab-icon">add</span>
    </button>

    <style>
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      #firestore-status-icon {
        transition: color 0.3s ease;
      }
    </style>

  </div>

  <script>
    // Estado da aplica√ß√£o
    let inventory = [];
    let history = [];
    let activityLogs = [];
    let users = [];
    let currentUser = null;
    let currentItem = null;
    let currentAction = null;
    let currentLocationFilter = 'all';
    let charts = {};
    let withdrawals = [];
    let withdrawalsUnsubscribe = null;
    let projects = [];
    let categories = [];
    
    // Expor para m√≥dulos ES6 do Firebase (ser√° atualizado depois das defini√ß√µes)
    window.inventory = inventory;

    // Sistema de Tema
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      const themeIcon = document.getElementById('theme-icon');
      const themeText = document.getElementById('theme-text');
      
      if (themeIcon) {
        themeIcon.textContent = newTheme === 'dark' ? 'light_mode' : 'dark_mode';
      }
      if (themeText) {
        themeText.textContent = newTheme === 'dark' ? 'Claro' : 'Escuro';
      }
    }

    function loadTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      
      const themeIcon = document.getElementById('theme-icon');
      const themeText = document.getElementById('theme-text');
      
      if (themeIcon) {
        themeIcon.textContent = savedTheme === 'dark' ? 'light_mode' : 'dark_mode';
      }
      if (themeText) {
        themeText.textContent = savedTheme === 'dark' ? 'Claro' : 'Escuro';
      }
    }

    // Expor fun√ß√µes para m√≥dulos ES6 do Firebase (ser√° atualizado depois das defini√ß√µes)

    function init() {
      loadTheme();
      loadSavedCredentials();
      loadProjects();
      loadCategories();
      // loadUsers(); // Removido - usando Firebase Auth
      // checkAuth(); // Removido - usando onAuthStateChanged
      initWithdrawalsSync();
    }

    // Sistema de Projetos
    function loadProjects() {
      try {
        const saved = localStorage.getItem('projects');
        if (saved) {
          projects = JSON.parse(saved);
        } else {
          // Projetos padr√£o
          projects = [
            { id: '1', name: 'PMQ - CSF' },
            { id: '2', name: 'IAC-SOCIAL' }
          ];
          saveProjects();
        }
        updateProjectSelects();
        renderProjectsList();
      } catch (error) {
        console.error('Erro ao carregar projetos:', error);
        projects = [{ id: '1', name: 'PMQ - CSF' }];
        saveProjects();
      }
    }

    function saveProjects() {
      localStorage.setItem('projects', JSON.stringify(projects));
      updateProjectSelects();
      renderProjectsList();
    }

    function updateProjectSelects() {
      const selects = [
        document.getElementById('item-project'),
        document.getElementById('edit-item-project')
      ];
      
      selects.forEach(select => {
        if (!select) return;
        const currentValue = select.value;
        select.innerHTML = '<option value="">Selecione o projeto...</option>';
        projects.forEach(project => {
          const option = document.createElement('option');
          option.value = project.name;
          option.textContent = project.name;
          select.appendChild(option);
        });
        if (currentValue) {
          select.value = currentValue;
        }
      });
    }

    function renderProjectsList() {
      const list = document.getElementById('projects-list');
      if (!list) return;
      
      if (projects.length === 0) {
        list.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center; color: var(--text-secondary);">Nenhum projeto cadastrado</div>';
        return;
      }
      
      list.innerHTML = projects.map(project => `
        <div class="project-item">
          <span class="project-item-name">${project.name}</span>
          <div class="project-item-actions">
            <button class="project-action-btn edit" onclick="openEditProjectModal('${project.id}')">Editar</button>
            <button class="project-action-btn delete" onclick="deleteProject('${project.id}')">Remover</button>
          </div>
        </div>
      `).join('');
    }

    function addProject() {
      const input = document.getElementById('new-project-name');
      const name = input?.value.trim();
      
      if (!name) {
        showToast('Digite o nome do projeto!', 'warning');
        return;
      }
      
      if (projects.find(p => p.name.toLowerCase() === name.toLowerCase())) {
        showToast('Este projeto j√° existe!', 'error');
        return;
      }
      
      const newProject = {
        id: Date.now().toString(),
        name: name
      };
      
      projects.push(newProject);
      saveProjects();
      input.value = '';
      showToast('Projeto adicionado com sucesso!', 'success');
    }

    function openEditProjectModal(projectId) {
      const project = projects.find(p => p.id === projectId);
      if (!project) {
        showToast('Projeto n√£o encontrado', 'error');
        return;
      }
      
      const newName = prompt('Digite o novo nome do projeto:', project.name);
      if (!newName || newName.trim() === '') {
        return;
      }
      
      const trimmedName = newName.trim();
      if (projects.find(p => p.id !== projectId && p.name.toLowerCase() === trimmedName.toLowerCase())) {
        showToast('Este nome j√° est√° em uso!', 'error');
        return;
      }
      
      project.name = trimmedName;
      saveProjects();
      showToast('Projeto editado com sucesso!', 'success');
    }

    function deleteProject(projectId) {
      const project = projects.find(p => p.id === projectId);
      if (!project) {
        showToast('Projeto n√£o encontrado', 'error');
        return;
      }
      
      // Verificar se h√° itens usando este projeto
      const itemsUsingProject = inventory.filter(i => i.project === project.name);
      if (itemsUsingProject.length > 0) {
        if (!confirm(`Este projeto est√° sendo usado por ${itemsUsingProject.length} item(ns). Deseja realmente remov√™-lo?\n\nOs itens n√£o perder√£o o projeto, mas voc√™ precisar√° atualiz√°-los manualmente.`)) {
          return;
        }
      }
      
      projects = projects.filter(p => p.id !== projectId);
      saveProjects();
      showToast('Projeto removido com sucesso!', 'success');
    }

    // Sistema de Categorias
    function loadCategories() {
      try {
        const saved = localStorage.getItem('categories');
        if (saved) {
          categories = JSON.parse(saved);
        } else {
          // Categorias padr√£o
          categories = [
            { id: '1', name: 'Permanente' },
            { id: '2', name: 'De Kit' },
            { id: '3', name: 'Insumo' },
            { id: '4', name: 'Outro' }
          ];
          saveCategories();
        }
        updateCategorySelects();
        renderCategoriesList();
      } catch (error) {
        console.error('Erro ao carregar categorias:', error);
        categories = [
          { id: '1', name: 'Permanente' },
          { id: '2', name: 'De Kit' },
          { id: '3', name: 'Insumo' },
          { id: '4', name: 'Outro' }
        ];
        saveCategories();
      }
    }

    function saveCategories() {
      localStorage.setItem('categories', JSON.stringify(categories));
      updateCategorySelects();
      renderCategoriesList();
    }

    function updateCategorySelects() {
      const selects = [
        document.getElementById('item-category'),
        document.getElementById('edit-item-category')
      ];
      
      selects.forEach(select => {
        if (!select) return;
        const currentValue = select.value;
        select.innerHTML = '<option value="">Selecione...</option>';
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category.name;
          option.textContent = category.name;
          select.appendChild(option);
        });
        if (currentValue) {
          select.value = currentValue;
        }
      });
    }

    function renderCategoriesList() {
      const list = document.getElementById('categories-list');
      if (!list) return;
      
      if (categories.length === 0) {
        list.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 14px;">Nenhuma categoria cadastrada</div>';
        return;
      }
      
      list.innerHTML = categories.map(category => `
        <div class="project-item">
          <span class="project-item-name">${category.name}</span>
          <div class="project-item-actions">
            <button class="project-action-btn edit" onclick="openEditCategoryModal('${category.id}')">Editar</button>
            <button class="project-action-btn delete" onclick="deleteCategory('${category.id}')">Remover</button>
          </div>
        </div>
      `).join('');
    }

    function addCategory() {
      const input = document.getElementById('new-category-name');
      const name = input?.value.trim();
      
      if (!name) {
        showToast('Digite o nome da categoria!', 'warning');
        return;
      }
      
      if (categories.find(c => c.name.toLowerCase() === name.toLowerCase())) {
        showToast('Esta categoria j√° existe!', 'error');
        return;
      }
      
      const newCategory = {
        id: Date.now().toString(),
        name: name
      };
      
      categories.push(newCategory);
      saveCategories();
      input.value = '';
      showToast('Categoria adicionada com sucesso!', 'success');
    }

    function openEditCategoryModal(categoryId) {
      const category = categories.find(c => c.id === categoryId);
      if (!category) {
        showToast('Categoria n√£o encontrada', 'error');
        return;
      }
      
      const newName = prompt('Digite o novo nome da categoria:', category.name);
      if (!newName || newName.trim() === '') {
        return;
      }
      
      const trimmedName = newName.trim();
      if (categories.find(c => c.id !== categoryId && c.name.toLowerCase() === trimmedName.toLowerCase())) {
        showToast('Este nome j√° est√° em uso!', 'error');
        return;
      }
      
      category.name = trimmedName;
      saveCategories();
      showToast('Categoria editada com sucesso!', 'success');
    }

    function deleteCategory(categoryId) {
      const category = categories.find(c => c.id === categoryId);
      if (!category) {
        showToast('Categoria n√£o encontrada', 'error');
        return;
      }
      
      // Verificar se h√° itens usando esta categoria
      const itemsUsingCategory = inventory.filter(i => i.category === category.name);
      if (itemsUsingCategory.length > 0) {
        if (!confirm(`Esta categoria est√° sendo usada por ${itemsUsingCategory.length} item(ns). Deseja realmente remov√™-la?\n\nOs itens n√£o perder√£o a categoria, mas voc√™ precisar√° atualiz√°-los manualmente.`)) {
          return;
        }
      }
      
      categories = categories.filter(c => c.id !== categoryId);
      saveCategories();
      showToast('Categoria removida com sucesso!', 'success');
    }

    // Sistema de Login/Usu√°rios
    function loadUsers() {
      const savedUsers = localStorage.getItem('users');
      if (savedUsers) {
        users = JSON.parse(savedUsers);
      } else {
        // Usu√°rio padr√£o
        users = [{
          id: 1,
          username: 'admin',
          password: 'admin',
          name: 'Administrador',
          role: 'admin'
        }];
        saveUsers();
      }
    }

    function saveUsers() {
      localStorage.setItem('users', JSON.stringify(users));
    }

    function checkAuth() {
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showMainContent();
      } else {
        showLogin();
      }
    }

    function showLogin() {
      document.getElementById('login-page').style.display = 'flex';
      document.getElementById('main-content').style.display = 'none';
    }

    function showMainContent() {
      document.getElementById('login-page').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
      updateUserInfo();
      renderInventory(); // loadData() removido - sincroniza√ß√£o em tempo real com Firebase
      updateFAB('inventory'); // Inicializar FAB na p√°gina de estoque
    }

    // Carregar credenciais salvas
    function loadSavedCredentials() {
      try {
        const savedEmail = localStorage.getItem('savedEmail');
        const rememberPassword = localStorage.getItem('rememberPassword') === 'true';
        
        if (savedEmail) {
          document.getElementById('login-username').value = savedEmail;
        }
        
        if (rememberPassword) {
          document.getElementById('remember-password').checked = true;
          const savedPassword = localStorage.getItem('savedPassword');
          if (savedPassword) {
            // Descriptografar (b√°sico - apenas para conveni√™ncia, n√£o seguro)
            try {
              document.getElementById('login-password').value = atob(savedPassword);
            } catch (e) {
              // Ignorar se n√£o conseguir descriptografar
            }
          }
        }
      } catch (error) {
        console.warn('Erro ao carregar credenciais salvas:', error);
      }
    }

    // Validar senha durante digita√ß√£o
    function validateLoginPassword() {
      const password = document.getElementById('login-password').value;
      const successEl = document.getElementById('login-success');
      
      if (successEl) {
        if (password.length >= 6) {
          successEl.classList.add('active');
        } else {
          successEl.classList.remove('active');
        }
      }
    }

    // Login com Firebase Auth
    document.getElementById('login-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const email = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      const rememberPassword = document.getElementById('remember-password').checked;
      
      if (!email || !password) {
        showToast('Por favor, preencha email e senha.', 'warning');
        return;
      }
      
      // Mostrar loading
      const loginLoading = document.getElementById('login-loading');
      const loginBtn = document.getElementById('login-submit-btn');
      const loginBtnText = document.getElementById('login-btn-text');
      const loginBtnLoading = document.getElementById('login-btn-loading');
      
      if (loginLoading) loginLoading.classList.add('active');
      if (loginBtn) loginBtn.disabled = true;
      if (loginBtnText) loginBtnText.textContent = 'Entrando...';
      if (loginBtnLoading) loginBtnLoading.style.display = 'inline-block';
      
      try {
        const { signInWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
        await signInWithEmailAndPassword(window.auth, email, password);
        
        // Salvar credenciais se solicitado
        if (rememberPassword) {
          localStorage.setItem('savedEmail', email);
          localStorage.setItem('savedPassword', btoa(password)); // Base64 (n√£o seguro, apenas conveni√™ncia)
          localStorage.setItem('rememberPassword', 'true');
        } else {
          localStorage.removeItem('savedEmail');
          localStorage.removeItem('savedPassword');
          localStorage.removeItem('rememberPassword');
        }
        
        showToast('Login realizado com sucesso!', 'success');
      } catch (error) {
        console.error('Erro no login:', error);
        let errorMessage = 'Erro no login. Verifique email e senha.';
        if (error.code === 'auth/invalid-email') {
          errorMessage = 'Email inv√°lido. Use um formato v√°lido (ex: usuario@email.com)';
        } else if (error.code === 'auth/user-not-found') {
          errorMessage = 'Usu√°rio n√£o encontrado. Verifique o email.';
        } else if (error.code === 'auth/wrong-password') {
          errorMessage = 'Senha incorreta.';
        } else if (error.code === 'auth/invalid-credential') {
          errorMessage = 'Credenciais inv√°lidas. Verifique email e senha.';
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = 'Erro de conex√£o. Verifique sua internet.';
        }
        showToast(errorMessage, 'error');
      } finally {
        if (loginLoading) loginLoading.classList.remove('active');
        if (loginBtn) loginBtn.disabled = false;
        if (loginBtnText) loginBtnText.textContent = 'Entrar';
        if (loginBtnLoading) loginBtnLoading.style.display = 'none';
      }
    });

    // Carregar credenciais ao iniciar
    loadSavedCredentials();

    async function logout() {
      if (confirm('Deseja sair do sistema?')) {
        try {
          const { signOut } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
          await signOut(window.auth);
          currentUser = null;
          showLogin();
        } catch (error) {
          console.error('Erro ao fazer logout:', error);
          currentUser = null;
          showLogin();
        }
      }
    }

    function updateUserInfo() {
      if (currentUser) {
        const usernameEl = document.getElementById('sidebar-username');
        const userroleEl = document.getElementById('sidebar-userrole');
        const headerUsernameEl = document.getElementById('header-username');
        const userNameInput = document.getElementById('user-name-input');
        const userEmailDisplay = document.getElementById('user-email-display');
        
        if (usernameEl) usernameEl.textContent = currentUser.name || currentUser.email || 'Usu√°rio';
        if (userroleEl) userroleEl.textContent = (currentUser.role === 'admin' ? 'Administrador' : 'Operador');
        if (headerUsernameEl) headerUsernameEl.textContent = currentUser.name || currentUser.email || 'Usu√°rio';
        if (userNameInput) userNameInput.value = currentUser.name || '';
        if (userEmailDisplay) userEmailDisplay.value = currentUser.email || '';
      }
    }

    // Fun√ß√µes de Alterar Senha e Nome
    function openChangePasswordModal() {
      document.getElementById('change-password-modal').classList.add('active');
      document.getElementById('current-password').value = '';
      document.getElementById('new-password').value = '';
      document.getElementById('confirm-password').value = '';
    }

    async function changePassword() {
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;

      if (!currentPassword || !newPassword || !confirmPassword) {
        showToast('Preencha todos os campos!', 'warning');
        return;
      }

      if (newPassword.length < 6) {
        showToast('A senha deve ter no m√≠nimo 6 caracteres!', 'warning');
        return;
      }

      if (newPassword !== confirmPassword) {
        showToast('As senhas n√£o coincidem!', 'error');
        return;
      }

      try {
        const { signInWithEmailAndPassword, updatePassword, reauthenticateWithCredential, EmailAuthProvider } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
        
        // Reautenticar para alterar senha
        const user = window.auth.currentUser;
        if (!user || !user.email) {
          showToast('Usu√°rio n√£o autenticado!', 'error');
          return;
        }

        const credential = EmailAuthProvider.credential(user.email, currentPassword);
        await reauthenticateWithCredential(user, credential);
        await updatePassword(user, newPassword);
        
        showToast('Senha alterada com sucesso!', 'success');
        closeModal('change-password-modal');
      } catch (error) {
        console.error('Erro ao alterar senha:', error);
        let errorMessage = 'Erro ao alterar senha.';
        if (error.code === 'auth/wrong-password') {
          errorMessage = 'Senha atual incorreta!';
        } else if (error.code === 'auth/weak-password') {
          errorMessage = 'A senha √© muito fraca!';
        }
        showToast(errorMessage, 'error');
      }
    }

    function openChangeNameModal() {
      const nameInput = document.getElementById('user-name-input');
      const newNameInput = document.getElementById('new-name-input');
      const modal = document.getElementById('change-name-modal');
      
      if (nameInput && newNameInput) {
        newNameInput.value = nameInput.value || '';
      }
      
      if (modal) {
        modal.classList.add('active');
      }
    }

    async function changeUserName() {
      // Prevenir m√∫ltiplas chamadas
      if (changeUserName.processing) {
        console.log('changeUserName j√° est√° processando, ignorando...');
        return;
      }
      changeUserName.processing = true;
      
      try {
        const newNameInput = document.getElementById('new-name-input');
        if (!newNameInput) {
          console.error('Campo new-name-input n√£o encontrado');
          showToast('Erro: campo n√£o encontrado', 'error');
          return;
        }

        const newName = newNameInput.value.trim();

        if (!newName) {
          showToast('Digite um nome!', 'warning');
          return;
        }

        const user = window.auth?.currentUser;
        if (!user || !user.uid) {
          showToast('Usu√°rio n√£o autenticado!', 'error');
          return;
        }

        // Tentar salvar no Firestore, mas se n√£o estiver dispon√≠vel, salvar localmente
        try {
          if (window.db) {
            const { doc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const userRef = doc(window.db, 'users', user.uid);
            await setDoc(userRef, { 
              name: newName,
              email: user.email,
              uid: user.uid,
              updatedAt: new Date().toISOString()
            }, { merge: true });
            console.log('Nome salvo no Firestore');
          } else {
            throw new Error('Firestore n√£o dispon√≠vel');
          }
        } catch (firestoreError) {
          console.warn('Erro ao salvar no Firestore, salvando localmente:', firestoreError);
          // Salvar localmente como fallback
          const userData = {
            name: newName,
            email: user.email,
            uid: user.uid,
            updatedAt: new Date().toISOString()
          };
          localStorage.setItem(`user_${user.uid}`, JSON.stringify(userData));
          showToast('Nome salvo localmente (Firestore n√£o dispon√≠vel). Crie o Firestore para sincroniza√ß√£o.', 'warning');
        }

        // Atualizar localmente
        if (currentUser) {
          currentUser.name = newName;
          updateUserInfo();
        }

        showToast('Nome alterado com sucesso!', 'success');
        closeModal('change-name-modal');
      } catch (error) {
        console.error('Erro ao alterar nome:', error);
        showToast(`Erro ao alterar nome: ${error.message || 'Erro desconhecido'}`, 'error');
      } finally {
        changeUserName.processing = false;
      }
    }
    
    // Expor fun√ß√µes para m√≥dulos ES6 do Firebase (ap√≥s defini√ß√µes)
    window.renderInventory = renderInventory;
    window.toggleCardExpand = function(card) {
      // S√≥ funciona no mobile
      if (window.innerWidth > 480) return;
      
      // Remover expanded de outros cards
      document.querySelectorAll('.item-card.expanded').forEach(c => {
        if (c !== card) c.classList.remove('expanded');
      });
      
      // Toggle do card clicado
      card.classList.toggle('expanded');
    };
    window.toggleFilters = toggleFilters;
    window.showMainContent = showMainContent;
    window.showLogin = showLogin;
    window.updateUserInfo = updateUserInfo;
    window.setCurrentUser = (user) => { currentUser = user; };
    window.setInventory = (items) => { inventory.length = 0; inventory.push(...items); };
    window.changeUserName = changeUserName;
    window.openChangeNameModal = openChangeNameModal;
    window.changePassword = changePassword;
    window.openChangePasswordModal = openChangePasswordModal;
    
    // Inicializar
    init();

    // Sistema de Toasts
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: 'check_circle',
        error: 'error',
        warning: 'warning',
        info: 'info'
      };
      
      toast.innerHTML = `
        <span class="material-icons toast-icon">${icons[type]}</span>
        <span class="toast-message">${message}</span>
        <button class="toast-close" onclick="this.parentElement.remove()">
          <span class="material-icons">close</span>
        </button>
      `;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 5000);
    }

    // Sidebar
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    document.getElementById('sidebar-overlay').addEventListener('click', toggleSidebar);

    // Event listener para bot√£o de salvar nome (ap√≥s DOM estar pronto)
    function setupSaveNameButton() {
      const saveNameBtn = document.getElementById('save-name-btn');
      if (saveNameBtn && !saveNameBtn.hasAttribute('data-listener-added')) {
        saveNameBtn.setAttribute('data-listener-added', 'true');
        saveNameBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          if (typeof changeUserName === 'function') {
            changeUserName();
          }
        });
      }
    }

    // Tentar configurar o bot√£o ap√≥s o DOM carregar
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupSaveNameButton);
    } else {
      setupSaveNameButton();
    }

    // Tamb√©m tentar quando o modal abrir
    const originalOpenChangeNameModal = openChangeNameModal;
    openChangeNameModal = function() {
      originalOpenChangeNameModal();
      setTimeout(setupSaveNameButton, 100);
    };

    // Sistema de Log
    function logActivity(action, description, type) {
      const log = {
        id: Date.now(),
        timestamp: new Date().toLocaleString('pt-BR'),
        user: currentUser ? currentUser.name : 'Sistema',
        userId: currentUser ? currentUser.id : null,
        action: action,
        description: description,
        type: type
      };
      
      activityLogs.unshift(log);
      if (activityLogs.length > 1000) activityLogs.pop();
      localStorage.setItem('activityLogs', JSON.stringify(activityLogs));
    }

    // Carregar dados
    function loadData() {
      const savedInventory = localStorage.getItem('inventory');
      const savedHistory = localStorage.getItem('history');
      const savedLogs = localStorage.getItem('activityLogs');
      
      if (savedInventory) inventory = JSON.parse(savedInventory);
      if (savedHistory) history = JSON.parse(savedHistory);
      if (savedLogs) activityLogs = JSON.parse(savedLogs);
    }

    function saveData() {
      // inventory removido - sincroniza√ß√£o em tempo real com Firestore
      localStorage.setItem('history', JSON.stringify(history));
      localStorage.setItem('activityLogs', JSON.stringify(activityLogs));
    }

    // Renderizar invent√°rio
    function renderInventory(filter = '') {
      const grid = document.getElementById('inventory-grid');
      let filtered = inventory.filter(item => {
        const matchFilter = !filter || item.name.toLowerCase().includes(filter.toLowerCase()) || 
                           (item.code && item.code.toLowerCase().includes(filter.toLowerCase()));
        const matchLocation = currentLocationFilter === 'all' || item.location === currentLocationFilter;
        return matchFilter && matchLocation;
      });

      // Atualizar contador de filtros
      updateFilterCounter(filtered.length, inventory.length, filter, currentLocationFilter);

      if (filtered.length === 0) {
        grid.innerHTML = '<div class="empty-state">Nenhum item encontrado</div>';
        return;
      }

      grid.innerHTML = filtered.map(item => {
        const status = getItemStatus(item);
        const statusClass = status === 'ok' ? 'ok' : status === 'warning' ? 'warning' : 'critical';
        const statusColors = {
          ok: '#7CB342',
          warning: '#FDD835',
          critical: '#E53935'
        };
        const statusLabels = {
          ok: 'OK',
          warning: 'Aten√ß√£o',
          critical: 'Cr√≠tico'
        };
        
        return `
          <div class="item-card" onclick="toggleCardExpand(this)" style="cursor: pointer;">
            <div style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 12px;">
              <div class="item-code" style="font-size: 11px; color: var(--text-secondary); background: var(--bg-secondary); padding: 4px 10px; border-radius: 8px; font-weight: 500;">${item.code || 'N/A'}</div>
              <div style="display: flex; align-items: center; gap: 6px;">
                <div class="item-status ${statusClass}" style="background: ${statusColors[status]};"></div>
                <span style="font-size: 11px; color: var(--text-secondary); font-weight: 500;">${statusLabels[status]}</span>
              </div>
            </div>
            
            <div class="item-name">${item.name}</div>
            
            <div class="item-quantity ${statusClass}" style="color: ${statusColors[status]};">
              ${item.quantity} <span style="font-size: 20px; font-weight: 500; color: var(--text-secondary);">${item.unit || 'UN'}</span>
            </div>
            
            <div class="item-meta">
              ${item.category ? `<div class="item-info"><span style="font-weight: 500;">Categoria:</span> ${item.category}</div>` : ''}
              <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
                <span class="badge location">üìç ${item.location}</span>
                ${item.project ? `<span class="badge project">üéØ ${item.project}</span>` : ''}
              </div>
              ${item.expiryDate ? `<div class="item-info" style="color: ${isExpiringSoon(item.expiryDate) ? '#E53935' : 'var(--text-secondary)'}; margin-top: 8px;">
                <span style="font-weight: 500;">Validade:</span> ${formatDate(item.expiryDate)}
              </div>` : ''}
            </div>
            
            <div class="item-actions" onclick="event.stopPropagation()">
              <button class="action-btn btn-add" onclick="openActionModal('${String(item.id || item.code)}', 'add')" title="Adicionar">
                <span class="material-icons">add</span>
              </button>
              <button class="action-btn btn-remove ${status === 'critical' ? 'dangerous' : ''}" onclick="openActionModal('${String(item.id || item.code)}', 'remove')" 
                      ${item.quantity === 0 ? 'disabled' : ''} title="Retirar">
                <span class="material-icons">remove</span>
              </button>
            </div>
            <div class="item-card-actions" onclick="event.stopPropagation()">
              <button class="item-edit-btn" onclick="openEditItemModal('${String(item.id || item.code)}')" title="Editar">
                <span class="material-icons">edit</span>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function updateFilterCounter(filteredCount, totalCount, searchFilter, locationFilter) {
      const filterInfo = document.getElementById('filter-info');
      const filteredCountEl = document.getElementById('filtered-count');
      const totalCountEl = document.getElementById('total-count');
      
      if (filteredCountEl) filteredCountEl.textContent = filteredCount;
      if (totalCountEl) totalCountEl.textContent = totalCount;
      
      if (filterInfo) {
        if (searchFilter || locationFilter !== 'all') {
          filterInfo.style.display = 'flex';
        } else {
          filterInfo.style.display = 'none';
        }
      }
    }

    function getItemStatus(item) {
      const minQty = item.minQuantity || 10;
      if (item.quantity === 0) return 'critical';
      if (item.quantity < minQty) return 'critical';
      if (item.quantity < minQty * 1.5) return 'warning';
      return 'ok';
    }

    function isExpiringSoon(date) {
      const expiry = new Date(date);
      const today = new Date();
      const daysUntilExpiry = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
      return daysUntilExpiry <= 7 && daysUntilExpiry >= 0;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr + 'T00:00:00');
      return date.toLocaleDateString('pt-BR');
    }


    function setLocationFilter(location, button) {
      currentLocationFilter = location;
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      if (button) button.classList.add('active');
      const searchValue = document.getElementById('search-input')?.value || '';
      renderInventory(searchValue);
    }

    function filterItems(query) {
      renderInventory(query);
    }

    function openActionModal(itemId, action) {
      // Converter para string para compara√ß√£o correta (IDs podem ser string ou number)
      const itemIdStr = String(itemId);
      const item = inventory.find(i => String(i.id) === itemIdStr || String(i.code) === itemIdStr);
      
      if (!item) {
        console.error('Item n√£o encontrado:', itemId, inventory);
        showToast('Erro: Item n√£o encontrado', 'error');
        return;
      }
      
      currentItem = item;
      currentAction = action;
      
      document.getElementById('modal-title').textContent = action === 'add' ? 'Adicionar' : 'Retirar';
      document.getElementById('quantity-input').value = 1;
      document.getElementById('quantity-input').max = action === 'remove' ? item.quantity : '';
      
      // Mostrar quantidade atual
      const currentQuantityEl = document.getElementById('current-quantity-display');
      const currentQuantityInfo = document.getElementById('current-quantity-info');
      const newQuantityPreview = document.getElementById('new-quantity-preview');
      
      if (currentQuantityEl) {
        currentQuantityEl.textContent = `${item.quantity} ${item.unit || 'UN'}`;
        currentQuantityInfo.style.display = 'block';
        updateQuantityPreview();
      }
      
      // Mostrar campos de data apenas para retirada
      if (action === 'remove') {
        document.getElementById('remove-dates').style.display = 'block';
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('withdrawal-date').value = today;
        document.getElementById('withdrawal-date').min = today;
        const returnDate = new Date();
        returnDate.setDate(returnDate.getDate() + 7);
        document.getElementById('return-date').value = returnDate.toISOString().split('T')[0];
        document.getElementById('return-date').min = today;
        document.getElementById('withdrawal-reason').value = '';
        document.getElementById('withdrawal-course').value = '';
      } else {
        document.getElementById('remove-dates').style.display = 'none';
      }
      
      document.getElementById('action-modal').classList.add('active');
    }

    function updateQuantityPreview() {
      if (!currentItem || !currentAction) return;
      
      const quantityInput = document.getElementById('quantity-input');
      const newQuantityPreview = document.getElementById('new-quantity-preview');
      
      if (!quantityInput || !newQuantityPreview) return;
      
      const quantity = parseInt(quantityInput.value) || 0;
      let newQuantity = currentItem.quantity;
      
      if (currentAction === 'add') {
        newQuantity = currentItem.quantity + quantity;
        newQuantityPreview.textContent = `Nova quantidade: ${newQuantity} ${currentItem.unit || 'UN'}`;
        newQuantityPreview.style.color = 'var(--gov-green)';
      } else if (currentAction === 'remove') {
        newQuantity = Math.max(0, currentItem.quantity - quantity);
        newQuantityPreview.textContent = `Nova quantidade: ${newQuantity} ${currentItem.unit || 'UN'}`;
        if (newQuantity < (currentItem.minQuantity || 10)) {
          newQuantityPreview.style.color = 'var(--gov-red)';
        } else if (newQuantity < (currentItem.minQuantity || 10) * 1.5) {
          newQuantityPreview.style.color = 'var(--gov-yellow)';
        } else {
          newQuantityPreview.style.color = 'var(--gov-green)';
        }
      }
    }

    function setQuantity(value) {
      document.getElementById('quantity-input').value = value;
      updateQuantityPreview();
    }

    async function confirmAction() {
      const quantity = parseInt(document.getElementById('quantity-input').value);
      
      if (currentAction === 'remove' && quantity > currentItem.quantity) {
        showToast('Quantidade solicitada maior que o estoque dispon√≠vel!', 'error');
        return;
      }
      
      const withdrawalDate = currentAction === 'remove' ? document.getElementById('withdrawal-date').value : null;
      const returnDate = currentAction === 'remove' ? document.getElementById('return-date').value : null;
      const withdrawalReason = currentAction === 'remove' ? document.getElementById('withdrawal-reason').value.trim() : null;
      const withdrawalCourse = currentAction === 'remove' ? document.getElementById('withdrawal-course').value.trim() : null;
      
      if (currentAction === 'remove' && (!withdrawalDate || !returnDate)) {
        showToast('Por favor, preencha as datas de sa√≠da e retorno!', 'warning');
        return;
      }
      
      if (currentAction === 'remove' && (!withdrawalCourse || withdrawalCourse === '')) {
        showToast('Por favor, informe o curso/projeto!', 'warning');
        return;
      }
      
      if (currentAction === 'remove' && (!withdrawalReason || withdrawalReason === '')) {
        showToast('Por favor, informe o motivo da retirada!', 'warning');
        return;
      }
      
      // Confirma√ß√£o extra para retiradas perigosas
      if (currentAction === 'remove') {
        const newQuantity = currentItem.quantity - quantity;
        const minQty = currentItem.minQuantity || 10;
        
        // Se a retirada deixar o estoque abaixo do m√≠nimo, pedir confirma√ß√£o extra
        if (newQuantity < minQty) {
          const confirmMessage = `‚ö†Ô∏è ATEN√á√ÉO: Esta retirada deixar√° o estoque em ${newQuantity} unidades, abaixo do m√≠nimo de ${minQty}.\n\nO estoque ficar√° CR√çTICO. Deseja continuar?`;
          
          if (!confirm(confirmMessage)) {
            return;
          }
        }
        
        // Se a retirada deixar o estoque zerado, confirma√ß√£o ainda mais expl√≠cita
        if (newQuantity === 0) {
          const criticalConfirm = `üö® ALERTA CR√çTICO: Esta retirada esgotar√° completamente o estoque de "${currentItem.name}".\n\nO estoque ficar√° ZERADO. Tem certeza absoluta?`;
          
          if (!confirm(criticalConfirm)) {
            return;
          }
        }
      }
      
      // Aplicar mudan√ßa diretamente ao invent√°rio no Firestore
      const timestamp = new Date().toLocaleString('pt-BR');
      const newQuantity = currentAction === 'add' 
        ? currentItem.quantity + quantity 
        : Math.max(0, currentItem.quantity - quantity);
      
      try {
        const { updateDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        // Usar ID ou c√≥digo como fallback
        const itemDocId = String(currentItem.id || currentItem.code);
        await updateDoc(doc(window.db, 'inventory', itemDocId), {
          quantity: newQuantity
        });
        
        if (currentAction === 'add') {
          logActivity('Adi√ß√£o', `Adicionou ${quantity} ${currentItem.unit || 'unidades'} de ${currentItem.name} (${currentItem.location})`, 'add');
          showToast(`Adicionado ${quantity} ${currentItem.unit || 'unidades'} de ${currentItem.name}`, 'success');
        } else {
          // Registrar withdrawal no Firestore
          try {
            const withdrawalData = {
              itemId: String(currentItem.id || currentItem.code),
              itemName: currentItem.name,
              quantity: quantity,
              unit: currentItem.unit || 'UN',
              course: withdrawalCourse,
              location: currentItem.location,
              withdrawalDate: withdrawalDate,
              expectedReturnDate: returnDate,
              returnedDate: null,
              status: 'in_use',
              userId: currentUser ? currentUser.uid : null,
              userName: currentUser ? (currentUser.name || currentUser.email) : 'Sistema',
              withdrawalReason: withdrawalReason
            };
            
            if (window.db) {
              const { collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
              await addDoc(collection(window.db, 'withdrawals'), {
                ...withdrawalData,
                createdAt: serverTimestamp()
              });
              console.log('Withdrawal registrado no Firestore');
            } else {
              // Fallback local
              withdrawalData.id = Date.now().toString();
              withdrawalData.createdAt = new Date();
              withdrawals.unshift(withdrawalData);
              localStorage.setItem('withdrawals', JSON.stringify(withdrawals));
              if (window.renderWithdrawals) {
                renderWithdrawals();
              }
              console.log('Withdrawal salvo localmente');
            }
          } catch (error) {
            console.error('Erro ao registrar withdrawal:', error);
            // Tentar salvar localmente como fallback
            try {
              const withdrawalData = {
                id: Date.now().toString(),
                itemId: String(currentItem.id || currentItem.code),
                itemName: currentItem.name,
                quantity: quantity,
                unit: currentItem.unit || 'UN',
                course: withdrawalCourse,
                location: currentItem.location,
                withdrawalDate: withdrawalDate,
                expectedReturnDate: returnDate,
                returnedDate: null,
                status: 'in_use',
                userId: currentUser ? currentUser.uid : null,
                userName: currentUser ? (currentUser.name || currentUser.email) : 'Sistema',
                withdrawalReason: withdrawalReason,
                createdAt: new Date()
              };
              withdrawals.unshift(withdrawalData);
              localStorage.setItem('withdrawals', JSON.stringify(withdrawals));
              if (window.renderWithdrawals) {
                renderWithdrawals();
              }
              showToast('Movimenta√ß√£o salva localmente (Firestore n√£o dispon√≠vel)', 'warning');
            } catch (localError) {
              console.error('Erro ao salvar withdrawal localmente:', localError);
            }
          }
          
          logActivity('Retirada', `Retirou ${quantity} ${currentItem.unit || 'unidades'} de ${currentItem.name} (${currentItem.location}) - Curso: ${withdrawalCourse} - Retorno: ${formatDate(returnDate)}`, 'remove');
          showToast(`Retirado ${quantity} ${currentItem.unit || 'unidades'} de ${currentItem.name} - Retorno: ${formatDate(returnDate)}`, 'info');
          
          // Verificar estoque cr√≠tico
          const updatedItem = { ...currentItem, quantity: newQuantity };
          if (getItemStatus(updatedItem) === 'critical') {
            showToast(`‚ö†Ô∏è Estoque cr√≠tico: ${currentItem.name}`, 'warning');
          }
        }
        
        // Adicionar ao hist√≥rico
        history.unshift({
          id: Date.now(),
          timestamp: timestamp,
          user: currentUser ? currentUser.name : 'Sistema',
          actions: [{
            itemId: currentItem.id,
            itemName: currentItem.name,
            action: currentAction,
            quantity: quantity,
            withdrawalDate: withdrawalDate,
            returnDate: returnDate,
            withdrawalReason: withdrawalReason
          }],
          notes: ''
        });
        
        saveData(); // Apenas para history e activityLogs
        closeModal('action-modal');
        // renderInventory() n√£o √© necess√°rio - sincroniza√ß√£o em tempo real atualiza automaticamente
      } catch (error) {
        console.error('Erro ao atualizar item:', error);
        showToast('Erro ao atualizar item. Tente novamente.', 'error');
      }
    }


    function openCreateItemModal() {
      // Limpar formul√°rio
      const form = document.getElementById('create-item-form');
      if (form) {
        form.reset();
        document.getElementById('item-quantity').value = '0';
        document.getElementById('item-min-quantity').value = '10';
      }
      updateProjectSelects();
      updateCategorySelects();
      document.getElementById('create-item-modal').classList.add('active');
    }

    async function createItem(e) {
      e.preventDefault();
      
      let code = document.getElementById('item-code').value.trim();
      // Garantir que o c√≥digo comece com #
      if (!code.startsWith('#')) {
        code = '#' + code;
      }
      const name = document.getElementById('item-name').value;
      const category = document.getElementById('item-category').value;
      const unit = document.getElementById('item-unit').value;
      const quantity = parseInt(document.getElementById('item-quantity').value);
      const minQuantity = parseInt(document.getElementById('item-min-quantity').value);
      const location = document.getElementById('item-location').value;
      const project = document.getElementById('item-project').value;
      const expiryDate = document.getElementById('item-expiry').value;

      if (!project) {
        showToast('Selecione um projeto!', 'warning');
        return;
      }

      // Verificar c√≥digo √∫nico
      if (inventory.find(i => i.code === code)) {
        showToast('C√≥digo j√° existe! Use outro c√≥digo.', 'error');
        return;
      }

      const newItem = {
        id: Date.now().toString(),
        code: code,
        name: name,
        category: category,
        unit: unit,
        quantity: quantity,
        minQuantity: minQuantity,
        location: location,
        project: project,
        expiryDate: expiryDate || null
      };

      try {
        if (window.db) {
          const { setDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
          await setDoc(doc(window.db, 'inventory', newItem.id.toString()), newItem);
        } else {
          // Fallback local
          inventory.push(newItem);
          localStorage.setItem('inventory', JSON.stringify(inventory));
        }
        
        logActivity('Cria√ß√£o', `Criou o item ${name} (${code})`, 'create');
        e.target.reset();
        document.getElementById('item-quantity').value = '0';
        document.getElementById('item-min-quantity').value = '10';
        showToast('Item criado com sucesso!', 'success');
        closeModal('create-item-modal');
      } catch (error) {
        console.error('Erro ao criar item:', error);
        showToast('Erro ao criar item. Tente novamente.', 'error');
      }
    }

    function renderDashboard() {
      const admItems = inventory.filter(i => i.location === 'ADM');
      const iacItems = inventory.filter(i => i.location === 'IAC-SOCIAL');
      
      const admTotal = admItems.reduce((sum, i) => sum + i.quantity, 0);
      const iacTotal = iacItems.reduce((sum, i) => sum + i.quantity, 0);
      
      const criticalItems = inventory.filter(i => getItemStatus(i) === 'critical').length;
      const warningItems = inventory.filter(i => getItemStatus(i) === 'warning').length;
      const okItems = inventory.filter(i => getItemStatus(i) === 'ok').length;
      
      // Itens em uso (withdrawals n√£o devolvidos)
      const itemsInUse = withdrawals.filter(w => 
        !w.returnedDate && !w.returned_date && w.status !== 'returned'
      );
      const totalInUse = itemsInUse.reduce((sum, w) => sum + (w.quantity || 0), 0);
      
      // Agrupar por projeto
      const itemsByProject = {};
      inventory.forEach(item => {
        const project = item.project || 'Sem Projeto';
        if (!itemsByProject[project]) {
          itemsByProject[project] = {
            count: 0,
            quantity: 0,
            items: []
          };
        }
        itemsByProject[project].count++;
        itemsByProject[project].quantity += item.quantity || 0;
        itemsByProject[project].items.push(item);
      });
      
      // Criar HTML dos projetos
      const projectsHTML = Object.keys(itemsByProject).map(project => {
        const projectData = itemsByProject[project];
        return `
          <div class="stat-card" style="grid-column: span 1;">
            <div class="stat-title">${project}</div>
            <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
              <div style="font-size: 14px; color: var(--text-secondary);">
                Itens: <strong style="color: var(--text-primary);">${projectData.count}</strong>
              </div>
              <div style="font-size: 14px; color: var(--text-secondary);">
                Quantidade: <strong style="color: var(--text-primary);">${projectData.quantity}</strong>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('dashboard-content').innerHTML = `
        <div class="stat-card" style="grid-column: span 2;">
          <div class="stat-title">Total de Itens no Estoque</div>
          <div class="stat-value">${inventory.length}</div>
          <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">
            Quantidade Total: <strong style="color: var(--text-primary);">${admTotal + iacTotal}</strong> unidades
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Itens em ADM</div>
          <div class="stat-value">${admTotal}</div>
          <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
            ${admItems.length} tipos diferentes
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Itens em IAC-SOCIAL</div>
          <div class="stat-value">${iacTotal}</div>
          <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
            ${iacItems.length} tipos diferentes
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Itens em Uso</div>
          <div class="stat-value" style="color: var(--gov-blue);">${totalInUse}</div>
          <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
            ${itemsInUse.length} movimenta√ß√µes ativas
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Estoque OK</div>
          <div class="stat-value" style="color: var(--gov-green);">${okItems}</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Estoque em Aten√ß√£o</div>
          <div class="stat-value" style="color: var(--gov-yellow);">${warningItems}</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Estoque Cr√≠tico</div>
          <div class="stat-value" style="color: var(--gov-red);">${criticalItems}</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Total de Movimenta√ß√µes</div>
          <div class="stat-value">${history.length}</div>
        </div>
        ${projectsHTML}
      `;
    }

    function openChartsModal() {
      document.getElementById('charts-modal').classList.add('active');
      
      // Aguardar um pouco para garantir que o modal est√° vis√≠vel
      setTimeout(() => {
        renderCharts();
      }, 100);
    }

    function renderCharts() {
      const admItems = inventory.filter(i => i.location === 'ADM');
      const iacItems = inventory.filter(i => i.location === 'IAC-SOCIAL');
      
      const admTotal = admItems.reduce((sum, i) => sum + i.quantity, 0);
      const iacTotal = iacItems.reduce((sum, i) => sum + i.quantity, 0);
      
      const criticalItems = inventory.filter(i => getItemStatus(i) === 'critical').length;
      const warningItems = inventory.filter(i => getItemStatus(i) === 'warning').length;
      const okItems = inventory.filter(i => getItemStatus(i) === 'ok').length;
      
      // Agrupar por projeto
      const itemsByProject = {};
      inventory.forEach(item => {
        const project = item.project || 'Sem Projeto';
        if (!itemsByProject[project]) {
          itemsByProject[project] = 0;
        }
        itemsByProject[project] += item.quantity || 0;
      });
      
      const projectLabels = Object.keys(itemsByProject);
      const projectData = Object.values(itemsByProject);
      
      // Gr√°fico de localiza√ß√£o
      const locationCtx = document.getElementById('modal-location-chart');
      if (locationCtx) {
        if (charts.location) charts.location.destroy();
        charts.location = new Chart(locationCtx, {
          type: 'pie',
          data: {
            labels: ['ADM', 'IAC-SOCIAL'],
            datasets: [{
              data: [admTotal, iacTotal],
              backgroundColor: ['#4A90E2', '#7CB342']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }
      
      // Gr√°fico de status
      const statusCtx = document.getElementById('modal-status-chart');
      if (statusCtx) {
        if (charts.status) charts.status.destroy();
        charts.status = new Chart(statusCtx, {
          type: 'bar',
          data: {
            labels: ['OK', 'Aten√ß√£o', 'Cr√≠tico'],
            datasets: [{
              label: 'Itens',
              data: [okItems, warningItems, criticalItems],
              backgroundColor: ['#7CB342', '#FDD835', '#E53935']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            scales: {
              y: {
                beginAtZero: true
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
      }
      
      // Gr√°fico por projeto
      const projectCtx = document.getElementById('modal-project-chart');
      if (projectCtx && projectLabels.length > 0) {
        if (charts.project) charts.project.destroy();
        
        // Gerar cores para os projetos
        const projectColors = projectLabels.map((_, index) => {
          const hue = (index * 360 / projectLabels.length) % 360;
          return `hsl(${hue}, 70%, 60%)`;
        });
        
        charts.project = new Chart(projectCtx, {
          type: 'doughnut',
          data: {
            labels: projectLabels,
            datasets: [{
              data: projectData,
              backgroundColor: projectColors
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }
    }

    function renderHistory() {
      const list = document.getElementById('history-list');
      if (!list) return;
      
      const filterType = document.getElementById('history-filter-type')?.value || 'all';
      const searchTerm = (document.getElementById('history-search')?.value || '').toLowerCase();
      
      // Combinar hist√≥rico e withdrawals devolvidos
      let allHistoryItems = [];
      
      // Adicionar hist√≥rico existente
      history.forEach(h => {
        if (h.actions && h.actions.length > 0) {
          h.actions.forEach(action => {
            allHistoryItems.push({
              id: `history_${h.id}_${action.itemId || ''}`,
              type: action.action === 'add' ? 'add' : 'remove',
              timestamp: h.timestamp,
              user: h.user || 'Sistema',
              itemId: action.itemId,
              itemName: action.itemName,
              quantity: action.quantity,
              location: action.location || '',
              withdrawalDate: action.withdrawalDate,
              returnDate: action.returnDate,
              withdrawalReason: action.withdrawalReason,
              notes: h.notes
            });
          });
        } else {
          // Hist√≥rico sem a√ß√µes (cria√ß√£o, edi√ß√£o, exclus√£o)
          const activityLog = activityLogs.find(log => 
            log.description && log.description.includes(h.user || '') && 
            log.timestamp === h.timestamp
          );
          
          let historyType = 'create';
          if (activityLog) {
            if (activityLog.action === 'Cria√ß√£o') historyType = 'create';
            else if (activityLog.action === 'Edi√ß√£o') historyType = 'edit';
            else if (activityLog.action === 'Exclus√£o') historyType = 'delete';
          }
          
          allHistoryItems.push({
            id: `history_${h.id}`,
            type: historyType,
            timestamp: h.timestamp,
            user: h.user || 'Sistema',
            description: activityLog?.description || h.notes || '',
            notes: h.notes
          });
        }
      });
      
      // Adicionar atividades do log (apenas as que n√£o s√£o a√ß√µes de hist√≥rico j√° inclu√≠das)
      if (activityLogs && Array.isArray(activityLogs)) {
        activityLogs.forEach(log => {
          // Verificar se j√° foi adicionado como a√ß√£o de hist√≥rico
          const alreadyAdded = allHistoryItems.some(item => {
            // Verificar se √© a mesma a√ß√£o baseado em timestamp e descri√ß√£o
            if (item.timestamp === log.timestamp && item.description === log.description) {
              return true;
            }
            // Verificar se a descri√ß√£o est√° relacionada a uma a√ß√£o j√° inclu√≠da
            if (log.description) {
              const descriptionLower = log.description.toLowerCase();
              return allHistoryItems.some(h => {
                if (h.itemName && descriptionLower.includes(h.itemName.toLowerCase())) {
                  return true;
                }
                return false;
              });
            }
            return false;
          });
          
          if (!alreadyAdded) {
            let logType = 'create';
            if (log.action === 'Cria√ß√£o') logType = 'create';
            else if (log.action === 'Edi√ß√£o') logType = 'edit';
            else if (log.action === 'Exclus√£o') logType = 'delete';
            else if (log.action === 'Adi√ß√£o') logType = 'add';
            else if (log.action === 'Retirada') logType = 'remove';
            else if (log.action === 'Devolu√ß√£o') logType = 'returned';
            
            // Tentar extrair informa√ß√µes do item da descri√ß√£o
            const description = log.description || '';
            const itemNameMatch = description.match(/(?:de|do|da)\s+([^(\n]+)/);
            const quantityMatch = description.match(/(\d+)\s+(unidades|unidade|UN|KG|L|CX)/i);
            
            allHistoryItems.push({
              id: `activity_${log.id}`,
              type: logType,
              timestamp: log.timestamp,
              user: log.user || 'Sistema',
              description: description,
              itemName: itemNameMatch ? itemNameMatch[1].trim() : null,
              quantity: quantityMatch ? parseInt(quantityMatch[1]) : null
            });
          }
        });
      }
      
      // Adicionar withdrawals devolvidos
      withdrawals.forEach(w => {
        if (w.returnedDate || w.returned_date || w.status === 'returned') {
          allHistoryItems.push({
            id: `returned_${w.id}`,
            type: 'returned',
            timestamp: w.returnedDate ? new Date(w.returnedDate + 'T12:00:00').toLocaleString('pt-BR') : 
                      (w.returned_date ? new Date(w.returned_date + 'T12:00:00').toLocaleString('pt-BR') : 
                      new Date().toLocaleString('pt-BR')),
            user: w.userName || w.user_name || 'Sistema',
            itemId: w.itemId,
            itemName: w.itemName || w.item_name || 'Item',
            quantity: w.quantity || 0,
            course: w.course || w.courseName || '',
            withdrawalDate: w.withdrawalDate || w.withdrawal_date,
            expectedReturnDate: w.expectedReturnDate || w.expected_return_date,
            returnedDate: w.returnedDate || w.returned_date,
            withdrawalReason: w.withdrawalReason || w.reason || ''
          });
        }
      });
      
      // Filtrar por tipo
      if (filterType !== 'all') {
        allHistoryItems = allHistoryItems.filter(item => item.type === filterType);
      }
      
      // Filtrar por busca
      if (searchTerm) {
        allHistoryItems = allHistoryItems.filter(item => 
          (item.itemName && item.itemName.toLowerCase().includes(searchTerm)) ||
          (item.user && item.user.toLowerCase().includes(searchTerm)) ||
          (item.description && item.description.toLowerCase().includes(searchTerm)) ||
          (item.course && item.course.toLowerCase().includes(searchTerm))
        );
      }
      
      // Ordenar por timestamp (mais recente primeiro)
      allHistoryItems.sort((a, b) => {
        const dateA = new Date(a.timestamp);
        const dateB = new Date(b.timestamp);
        return dateB - dateA;
      });
      
      if (allHistoryItems.length === 0) {
        list.innerHTML = '<div class="empty-state">Nenhuma altera√ß√£o encontrada com os filtros aplicados</div>';
        return;
      }
      
      list.innerHTML = allHistoryItems.map(item => {
        const typeIcons = {
          create: { icon: 'üìù', label: 'Cria√ß√£o', color: '#4A90E2' },
          edit: { icon: '‚úèÔ∏è', label: 'Edi√ß√£o', color: '#7CB342' },
          delete: { icon: 'üóëÔ∏è', label: 'Exclus√£o', color: '#E53935' },
          add: { icon: '‚ûï', label: 'Adi√ß√£o', color: '#4A90E2' },
          remove: { icon: '‚ûñ', label: 'Retirada', color: '#FDD835' },
          returned: { icon: '‚úÖ', label: 'Devolu√ß√£o', color: '#7CB342' }
        };
        
        const typeInfo = typeIcons[item.type] || { icon: 'üìã', label: 'Altera√ß√£o', color: '#86868B' };
        
        return `
          <div class="history-item">
            <div class="history-header">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="font-size: 24px;">${typeInfo.icon}</div>
                <div>
                  <strong style="color: ${typeInfo.color};">${typeInfo.label}</strong>
                  <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                    Por: ${item.user || 'Sistema'}
                  </div>
                </div>
              </div>
              <span class="history-time">${item.timestamp}</span>
            </div>
            
            ${item.itemName ? `
              <div style="margin-top: 12px;">
                <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                  ${item.itemName}
                </div>
                ${item.quantity !== undefined ? `
                  <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px;">
                    Quantidade: <strong style="color: var(--text-primary);">${item.type === 'add' ? '+' : item.type === 'remove' || item.type === 'returned' ? '-' : ''}${item.quantity}</strong>
                    ${item.unit ? item.unit : ''}
                  </div>
                ` : ''}
                ${item.location ? `
                  <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px;">
                    Localiza√ß√£o: <strong>${item.location}</strong>
                  </div>
                ` : ''}
              </div>
            ` : ''}
            
            ${item.description ? `
              <div style="color: var(--text-secondary); font-size: 14px; margin-top: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 8px;">
                ${item.description}
              </div>
            ` : ''}
            
            ${item.withdrawalDate || item.withdrawal_date ? `
              <div style="margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid ${typeInfo.color};">
                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                  <strong style="color: var(--text-primary);">Informa√ß√µes da Retirada:</strong>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; font-size: 13px;">
                  <div>
                    <span style="color: var(--text-secondary);">Data de Sa√≠da:</span>
                    <strong style="color: var(--text-primary); margin-left: 4px;">${formatDate(item.withdrawalDate || item.withdrawal_date)}</strong>
                  </div>
                  ${item.expectedReturnDate || item.expected_return_date ? `
                    <div>
                      <span style="color: var(--text-secondary);">Retorno Previsto:</span>
                      <strong style="color: var(--text-primary); margin-left: 4px;">${formatDate(item.expectedReturnDate || item.expected_return_date)}</strong>
                    </div>
                  ` : ''}
                  ${item.returnedDate ? `
                    <div style="color: var(--gov-green);">
                      <span>‚úÖ Devolvido em:</span>
                      <strong style="margin-left: 4px;">${formatDate(item.returnedDate)}</strong>
                    </div>
                  ` : ''}
                  ${item.course ? `
                    <div>
                      <span style="color: var(--text-secondary);">Curso/Projeto:</span>
                      <strong style="color: var(--text-primary); margin-left: 4px;">${item.course}</strong>
                    </div>
                  ` : ''}
                </div>
                ${item.withdrawalReason ? `
                  <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-color);">
                    <span style="color: var(--text-secondary); font-size: 12px;">Motivo:</span>
                    <div style="color: var(--text-primary); font-size: 13px; margin-top: 4px; font-style: italic;">
                      ${item.withdrawalReason}
                    </div>
                  </div>
                ` : ''}
              </div>
            ` : ''}
            
            ${item.notes ? `
              <div style="color: var(--text-secondary); font-size: 13px; margin-top: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 8px;">
                <strong>Observa√ß√£o:</strong> ${item.notes}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    function navigateTo(page, element) {
      document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
      const pageElement = document.getElementById(page + '-page');
      if (pageElement) {
        pageElement.classList.add('active');
      }
      
      document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
      if (element) {
        element.classList.add('active');
      }
      
      if (page === 'dashboard') {
        renderDashboard();
      }
      if (page === 'history') {
        renderHistory();
      }
      if (page === 'withdrawals') {
        setTimeout(() => {
          if (withdrawals.length === 0 && window.startWithdrawalsSync) {
            // Tentar inicializar se ainda n√£o foi inicializado
            window.startWithdrawalsSync();
          }
          renderWithdrawals();
        }, 100);
      }
      if (page === 'settings') {
        renderProjectsList();
        renderCategoriesList();
      }
      
      // Fechar sidebar no mobile ao navegar
      if (window.innerWidth <= 768) {
        toggleSidebar();
      }
    }

    function toggleFilters() {
      const filterButtons = document.getElementById('filter-buttons');
      if (filterButtons) {
        filterButtons.classList.toggle('active');
      }
    }

    function updateFAB(page) {
      const fabButton = document.getElementById('fab-button');
      const fabIcon = document.getElementById('fab-icon');
      
      if (!fabButton || !fabIcon) return;
      
      if (page === 'inventory') {
        fabButton.onclick = () => openCreateItemModal();
        fabButton.title = 'Criar Novo Item';
        fabIcon.textContent = 'add';
        fabButton.style.display = 'flex';
      } else if (page === 'withdrawals') {
        fabButton.onclick = () => {
          // Redirecionar para estoque para fazer retirada
          navigateTo('inventory', document.querySelector('.sidebar-item[onclick*="inventory"]'));
          showToast('Selecione um item do estoque para fazer uma retirada', 'info');
        };
        fabButton.title = 'Nova Retirada';
        fabIcon.textContent = 'arrow_upward';
        fabButton.style.display = 'flex';
      } else {
        // Para outras p√°ginas, esconder o FAB
        fabButton.style.display = 'none';
      }
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // Fechar modal ao clicar fora
    function setupModalCloseOnClick() {
      document.querySelectorAll('.modal').forEach(modal => {
        // Remover listeners anteriores para evitar duplica√ß√£o
        const newModal = modal.cloneNode(true);
        modal.parentNode.replaceChild(newModal, modal);
        
        newModal.addEventListener('click', function(e) {
          // Se o clique foi diretamente no modal (overlay), fechar
          if (e.target === newModal) {
            const modalId = newModal.id;
            closeModal(modalId);
          }
        });
      });
    }

    // Configurar ao carregar
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupModalCloseOnClick);
    } else {
      setupModalCloseOnClick();
    }

    // Exporta√ß√£o
    function exportToCSV() {
      const headers = ['C√≥digo', 'Nome', 'Categoria', 'Unidade', 'Quantidade', 'M√≠nimo', 'Localiza√ß√£o', 'Validade'];
      const rows = inventory.map(item => [
        item.code || '',
        item.name || '',
        item.category || '',
        item.unit || '',
        item.quantity || 0,
        item.minQuantity || 0,
        item.location || '',
        item.expiryDate ? formatDate(item.expiryDate) : ''
      ]);
      
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `estoque_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      
      showToast('Exporta√ß√£o CSV realizada com sucesso!', 'success');
    }

    function exportToPDF() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Configura√ß√µes
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 15;
        let yPos = margin;
        
        // Cabe√ßalho
        doc.setFontSize(20);
        doc.setFont(undefined, 'bold');
        doc.text('Controle de Estoque - Cear√° Sem Fome', pageWidth / 2, yPos, { align: 'center' });
        
        yPos += 10;
        doc.setFontSize(12);
        doc.setFont(undefined, 'normal');
        doc.text(`Relat√≥rio gerado em: ${new Date().toLocaleString('pt-BR')}`, pageWidth / 2, yPos, { align: 'center' });
        
        yPos += 15;
        
        // Estat√≠sticas
        const totalItems = inventory.length;
        const totalQuantity = inventory.reduce((sum, item) => sum + (item.quantity || 0), 0);
        const criticalItems = inventory.filter(i => getItemStatus(i) === 'critical').length;
        const warningItems = inventory.filter(i => getItemStatus(i) === 'warning').length;
        const okItems = inventory.filter(i => getItemStatus(i) === 'ok').length;
        
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('Resumo do Estoque', margin, yPos);
        
        yPos += 8;
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`Total de Itens: ${totalItems}`, margin, yPos);
        yPos += 6;
        doc.text(`Quantidade Total: ${totalQuantity} unidades`, margin, yPos);
        yPos += 6;
        doc.setTextColor(76, 175, 80); // Verde
        doc.text(`‚úì Itens OK: ${okItems}`, margin, yPos);
        yPos += 6;
        doc.setTextColor(255, 152, 0); // Laranja
        doc.text(`‚ö† Itens em Aten√ß√£o: ${warningItems}`, margin, yPos);
        yPos += 6;
        doc.setTextColor(244, 67, 54); // Vermelho
        doc.text(`‚úó Itens Cr√≠ticos: ${criticalItems}`, margin, yPos);
        doc.setTextColor(0, 0, 0); // Preto
        yPos += 12;
        
        // Verificar se precisa de nova p√°gina
        if (yPos > pageHeight - 40) {
          doc.addPage();
          yPos = margin;
        }
        
        // Tabela de itens
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('Lista de Itens', margin, yPos);
        yPos += 8;
        
        // Cabe√ßalho da tabela
        doc.setFontSize(8);
        doc.setFont(undefined, 'bold');
        const colWidths = [25, 50, 25, 20, 20, 20, 30]; // Ajuste das larguras
        const headers = ['C√≥digo', 'Nome', 'Categoria', 'Qtd', 'M√≠n', 'Local', 'Status'];
        let xPos = margin;
        
        doc.setFillColor(74, 144, 226); // Azul
        doc.rect(xPos, yPos - 5, pageWidth - 2 * margin, 7, 'F');
        doc.setTextColor(255, 255, 255);
        
        headers.forEach((header, index) => {
          doc.text(header, xPos + 2, yPos, { align: 'left' });
          xPos += colWidths[index];
        });
        
        yPos += 8;
        doc.setTextColor(0, 0, 0);
        doc.setFont(undefined, 'normal');
        
        // Itens agrupados por localiza√ß√£o
        const locations = ['ADM', 'IAC-SOCIAL'];
        
        locations.forEach(location => {
          const locationItems = inventory.filter(i => i.location === location);
          
          if (locationItems.length > 0) {
            // Verificar se precisa de nova p√°gina
            if (yPos > pageHeight - 30) {
              doc.addPage();
              yPos = margin;
            }
            
            // T√≠tulo da localiza√ß√£o
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text(`Localiza√ß√£o: ${location}`, margin, yPos);
            yPos += 6;
            
            locationItems.forEach((item, index) => {
              // Verificar se precisa de nova p√°gina
              if (yPos > pageHeight - 15) {
                doc.addPage();
                yPos = margin;
              }
              
              const status = getItemStatus(item);
              const statusColors = {
                ok: [76, 175, 80],
                warning: [255, 152, 0],
                critical: [244, 67, 54]
              };
              const statusText = {
                ok: 'OK',
                warning: 'ATEN',
                critical: 'CRIT'
              };
              
              // Linha alternada
              if (index % 2 === 0) {
                doc.setFillColor(245, 245, 245);
                doc.rect(margin, yPos - 4, pageWidth - 2 * margin, 5, 'F');
              }
              
              xPos = margin;
              doc.setFontSize(7);
              doc.setFont(undefined, 'normal');
              
              // C√≥digo (truncado se muito longo)
              doc.text((item.code || 'N/A').substring(0, 8), xPos + 1, yPos);
              xPos += colWidths[0];
              
              // Nome (truncado se muito longo)
              doc.text((item.name || 'N/A').substring(0, 20), xPos + 1, yPos);
              xPos += colWidths[1];
              
              // Categoria (truncado)
              doc.text((item.category || 'N/A').substring(0, 10), xPos + 1, yPos);
              xPos += colWidths[2];
              
              // Quantidade
              doc.text(String(item.quantity || 0), xPos + 1, yPos);
              xPos += colWidths[3];
              
              // M√≠nimo
              doc.text(String(item.minQuantity || 0), xPos + 1, yPos);
              xPos += colWidths[4];
              
              // Local (j√° sabemos que √© ADM ou IAC-SOCIAL, mas mostramos mesmo assim)
              doc.text(item.location || 'N/A', xPos + 1, yPos);
              xPos += colWidths[5];
              
              // Status com cor
              doc.setFillColor(...statusColors[status]);
              doc.setTextColor(255, 255, 255);
              doc.setFont(undefined, 'bold');
              doc.roundedRect(xPos, yPos - 3.5, colWidths[6] - 2, 4, 1, 1, 'F');
              doc.text(statusText[status], xPos + (colWidths[6] - 2) / 2, yPos, { align: 'center' });
              doc.setTextColor(0, 0, 0);
              
              yPos += 6;
            });
            
            yPos += 4; // Espa√ßo entre localiza√ß√µes
          }
        });
        
        // Adicionar p√°gina com itens agrupados por projeto (se houver)
        const itemsWithProject = inventory.filter(i => i.project);
        if (itemsWithProject.length > 0) {
          if (yPos > pageHeight - 40) {
            doc.addPage();
            yPos = margin;
          } else {
            yPos += 10;
          }
          
          doc.setFontSize(14);
          doc.setFont(undefined, 'bold');
          doc.text('Itens por Projeto', margin, yPos);
          yPos += 8;
          
          const projects = [...new Set(itemsWithProject.map(i => i.project))];
          
          projects.forEach(project => {
            if (yPos > pageHeight - 30) {
              doc.addPage();
              yPos = margin;
            }
            
            const projectItems = itemsWithProject.filter(i => i.project === project);
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text(`Projeto: ${project}`, margin, yPos);
            yPos += 6;
            
            doc.setFontSize(7);
            doc.setFont(undefined, 'normal');
            
            projectItems.forEach(item => {
              if (yPos > pageHeight - 15) {
                doc.addPage();
                yPos = margin;
              }
              
              doc.text(`‚Ä¢ ${item.name} (${item.quantity || 0} ${item.unit || 'UN'}) - ${item.location}`, margin + 5, yPos);
              yPos += 5;
            });
            
            yPos += 4;
          });
        }
        
        // Rodap√© em todas as p√°ginas
        const totalPages = doc.internal.pages.length - 1;
        for (let i = 1; i <= totalPages; i++) {
          doc.setPage(i);
          doc.setFontSize(8);
          doc.setTextColor(128, 128, 128);
          doc.text(
            `P√°gina ${i} de ${totalPages}`,
            pageWidth / 2,
            pageHeight - 10,
            { align: 'center' }
          );
        }
        
        // Gerar nome do arquivo
        const fileName = `estoque_${new Date().toISOString().split('T')[0]}.pdf`;
        
        // Salvar PDF
        doc.save(fileName);
        
        showToast('PDF gerado com sucesso!', 'success');
      } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        showToast('Erro ao gerar PDF. Verifique o console para mais detalhes.', 'error');
      }
    }

    function backupData() {
      const backup = {
        inventory: inventory,
        history: history,
        activityLogs: activityLogs,
        users: users,
        timestamp: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `backup_estoque_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      showToast('Backup realizado com sucesso!', 'success');
    }

    function restoreData() {
      const fileInput = document.getElementById('restore-file');
      const file = fileInput.files[0];
      
      if (!file) {
        showToast('Selecione um arquivo de backup!', 'warning');
        return;
      }
      
      if (!confirm('Restaurar backup ir√° substituir todos os dados atuais. Deseja continuar?')) {
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const backup = JSON.parse(e.target.result);
          inventory = backup.inventory || [];
          history = backup.history || [];
          activityLogs = backup.activityLogs || [];
          users = backup.users || [];
          
          saveData();
          saveUsers();
          renderInventory();
          
          showToast('Backup restaurado com sucesso!', 'success');
          fileInput.value = '';
        } catch (error) {
          showToast('Erro ao restaurar backup! Arquivo inv√°lido.', 'error');
        }
      };
      reader.readAsText(file);
    }

    // Vari√°veis globais para importa√ß√£o
    let importedData = null;
    let columnMapping = {};
    let importErrors = [];

    // Fun√ß√£o para lidar com sele√ß√£o de arquivo
    async function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      showLoading('Lendo planilha...');

      try {
        const workbook = XLSX.read(await file.arrayBuffer(), { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });

        if (data.length === 0) {
          hideLoading();
          showToast('Planilha vazia!', 'error');
          return;
        }

        importedData = data;
        hideLoading();
        
        // Detectar colunas automaticamente
        detectColumns(data);
      } catch (error) {
        hideLoading();
        console.error('Erro ao ler planilha:', error);
        showToast('Erro ao ler planilha. Verifique o formato do arquivo.', 'error');
      }
    }

    // Fun√ß√£o para detectar colunas automaticamente
    function detectColumns(data) {
      if (!data || data.length === 0) return;

      const headers = data[0].map(h => String(h || '').toLowerCase().trim());
      const mappingForm = document.getElementById('column-mapping-form');
      
      // Mapeamento inteligente baseado em palavras-chave
      const fieldMap = {
        'code': ['c√≥digo', 'codigo', 'id', 'identifica√ß√£o', 'identificacao'],
        'name': ['nome', 'item', 'item nome', 'descri√ß√£o', 'descricao', 'produto'],
        'quantity': ['quantidade', 'qtd', 'qty', 'estoque', 'saldo'],
        'category': ['categoria', 'categoria do item'],
        'unit': ['unidade', 'un', 'medida'],
        'minQuantity': ['m√≠nimo', 'minimo', 'quantidade m√≠nima', 'estoque m√≠nimo'],
        'location': ['local', 'localiza√ß√£o', 'localizacao', 'dep√≥sito', 'deposito'],
        'expiryDate': ['validade', 'data de validade', 'vencimento', 'expira']
      };

      columnMapping = {};

      // Detectar automaticamente
      Object.keys(fieldMap).forEach(field => {
        const keywords = fieldMap[field];
        for (let i = 0; i < headers.length; i++) {
          const header = headers[i];
          if (keywords.some(keyword => header.includes(keyword))) {
            columnMapping[field] = i;
            break;
          }
        }
      });

      // Criar formul√°rio de mapeamento
      const fields = [
        { key: 'code', label: 'C√≥digo', required: true },
        { key: 'name', label: 'Nome do Item', required: true },
        { key: 'quantity', label: 'Quantidade', required: true },
        { key: 'category', label: 'Categoria', required: false },
        { key: 'unit', label: 'Unidade', required: false },
        { key: 'minQuantity', label: 'Quantidade M√≠nima', required: false },
        { key: 'location', label: 'Localiza√ß√£o', required: false },
        { key: 'expiryDate', label: 'Data de Validade', required: false }
      ];

      mappingForm.innerHTML = fields.map(field => `
        <div class="form-group" style="margin-bottom: 16px;">
          <label class="form-label">
            ${field.label} ${field.required ? '<span style="color: var(--gov-red);">*</span>' : ''}
          </label>
          <select class="form-input" id="map-${field.key}" ${field.required ? 'required' : ''}>
            <option value="">-- Selecione --</option>
            ${headers.map((h, i) => `
              <option value="${i}" ${columnMapping[field.key] === i ? 'selected' : ''}>${h || `Coluna ${i + 1}`}</option>
            `).join('')}
          </select>
        </div>
      `).join('');

      document.getElementById('column-mapping-modal').classList.add('active');
    }

    // Processar mapeamento e validar dados
    async function processColumnMapping() {
      const fields = ['code', 'name', 'quantity', 'category', 'unit', 'minQuantity', 'location', 'expiryDate'];
      
      // Atualizar mapeamento
      fields.forEach(field => {
        const select = document.getElementById(`map-${field}`);
        if (select && select.value !== '') {
          columnMapping[field] = parseInt(select.value);
        } else {
          delete columnMapping[field];
        }
      });

      // Validar campos obrigat√≥rios
      if (columnMapping.code === undefined || columnMapping.name === undefined || columnMapping.quantity === undefined) {
        showToast('Mapeie pelo menos: C√≥digo, Nome e Quantidade!', 'warning');
        return;
      }

      closeModal('column-mapping-modal');
      showLoading('Validando dados...');

      // Processar dados
      const validItems = [];
      importErrors = [];

      for (let i = 1; i < importedData.length; i++) {
        const row = importedData[i];
        if (!row || row.length === 0) continue;

        const item = {};
        const errors = [];

        // Mapear campos
        if (columnMapping.code !== undefined) {
          item.code = String(row[columnMapping.code] || '').trim();
          if (!item.code) errors.push({ field: 'code', message: 'C√≥digo √© obrigat√≥rio' });
        }

        if (columnMapping.name !== undefined) {
          item.name = String(row[columnMapping.name] || '').trim();
          if (!item.name) errors.push({ field: 'name', message: 'Nome √© obrigat√≥rio' });
        }

        if (columnMapping.quantity !== undefined) {
          const qty = parseFloat(row[columnMapping.quantity]);
          if (isNaN(qty) || qty < 0) {
            errors.push({ field: 'quantity', message: `Quantidade inv√°lida: "${row[columnMapping.quantity]}"` });
          } else {
            item.quantity = Math.floor(qty);
          }
        }

        if (columnMapping.category !== undefined) {
          item.category = String(row[columnMapping.category] || '').trim() || 'Outros';
        } else {
          item.category = 'Outros';
        }

        if (columnMapping.unit !== undefined) {
          item.unit = String(row[columnMapping.unit] || '').trim().toUpperCase() || 'UN';
        } else {
          item.unit = 'UN';
        }

        if (columnMapping.minQuantity !== undefined) {
          const minQty = parseFloat(row[columnMapping.minQuantity]);
          item.minQuantity = isNaN(minQty) ? 10 : Math.floor(minQty);
        } else {
          item.minQuantity = 10;
        }

        if (columnMapping.location !== undefined) {
          item.location = String(row[columnMapping.location] || '').trim() || 'ADM';
        } else {
          item.location = 'ADM';
        }

        if (columnMapping.expiryDate !== undefined) {
          const dateStr = String(row[columnMapping.expiryDate] || '').trim();
          if (dateStr) {
            // Tentar parsear data em v√°rios formatos
            const date = parseDate(dateStr);
            item.expiryDate = date ? date.toISOString().split('T')[0] : null;
            if (!date && dateStr) {
              errors.push({ field: 'expiryDate', message: `Data inv√°lida: "${dateStr}"` });
            }
          }
        }

        // Verificar duplicatas
        const existingItem = inventory.find(it => it.code === item.code);
        if (existingItem) {
          errors.push({ field: 'code', message: `C√≥digo j√° existe: ${item.code}` });
        }

        if (errors.length > 0) {
          importErrors.push({ row: i + 1, item, errors, rawRow: row });
        } else {
          validItems.push(item);
        }
      }

      hideLoading();

      // Se houver erros, mostrar modal de corre√ß√£o
      if (importErrors.length > 0) {
        showImportErrorsModal();
      } else {
        // Importar direto se n√£o houver erros
        await importItems(validItems);
      }
    }

    // Fun√ß√£o para parsear data em v√°rios formatos
    function parseDate(dateStr) {
      if (!dateStr) return null;
      
      // Tentar formato ISO (YYYY-MM-DD)
      let date = new Date(dateStr);
      if (!isNaN(date.getTime())) return date;

      // Tentar formato brasileiro (DD/MM/YYYY)
      const brMatch = dateStr.match(/(\d{2})\/(\d{2})\/(\d{4})/);
      if (brMatch) {
        date = new Date(`${brMatch[3]}-${brMatch[2]}-${brMatch[1]}`);
        if (!isNaN(date.getTime())) return date;
      }

      // Tentar formato com Excel (n√∫mero serial)
      const excelNum = parseFloat(dateStr);
      if (!isNaN(excelNum) && excelNum > 25569) {
        // Excel epoch starts at 1900-01-01 (25569 days before Unix epoch)
        date = new Date((excelNum - 25569) * 86400 * 1000);
        if (!isNaN(date.getTime())) return date;
      }

      return null;
    }

    // Mostrar modal de erros
    function showImportErrorsModal() {
      const errorsList = document.getElementById('import-errors-list');
      const errorsCount = document.getElementById('errors-count');
      
      errorsCount.textContent = importErrors.length;
      
      errorsList.innerHTML = importErrors.map((error, idx) => `
        <div style="background: var(--input-bg); padding: 16px; border-radius: 8px; margin-bottom: 12px; border: 1px solid var(--border-color);">
          <div style="font-weight: 600; margin-bottom: 8px; color: var(--gov-red);">
            Linha ${error.row}: ${error.item.name || error.item.code || 'Sem nome'}
          </div>
          ${error.errors.map(e => `
            <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 4px;">
              ‚Ä¢ ${e.field}: ${e.message}
            </div>
          `).join('')}
          <div style="margin-top: 8px; display: flex; gap: 8px;">
            ${error.item.code ? `<input type="text" class="form-input" id="error-code-${idx}" value="${error.item.code}" placeholder="C√≥digo" style="flex: 1;">` : ''}
            ${error.item.name ? `<input type="text" class="form-input" id="error-name-${idx}" value="${error.item.name}" placeholder="Nome" style="flex: 2;">` : ''}
            ${error.item.quantity !== undefined ? `<input type="number" class="form-input" id="error-qty-${idx}" value="${error.item.quantity}" placeholder="Quantidade" style="flex: 1;">` : ''}
          </div>
        </div>
      `).join('');

      document.getElementById('import-errors-modal').classList.add('active');
    }

    // Aplicar corre√ß√µes
    async function applyErrorCorrections() {
      try {
        showLoading('Processando corre√ß√µes...');
        
        const correctedItems = [];

        importErrors.forEach((error, idx) => {
          const codeInput = document.getElementById(`error-code-${idx}`);
          const nameInput = document.getElementById(`error-name-${idx}`);
          const qtyInput = document.getElementById(`error-qty-${idx}`);

          const correctedItem = { ...error.item };
          if (codeInput) correctedItem.code = codeInput.value.trim();
          if (nameInput) correctedItem.name = nameInput.value.trim();
          if (qtyInput) {
            const qty = parseInt(qtyInput.value);
            correctedItem.quantity = isNaN(qty) ? 0 : qty;
          }

          // Garantir campos obrigat√≥rios
          if (!correctedItem.code) return;
          if (!correctedItem.name) return;
          if (correctedItem.quantity === undefined || correctedItem.quantity < 0) {
            correctedItem.quantity = 0;
          }

          // Garantir campos opcionais
          if (!correctedItem.category) correctedItem.category = 'Outros';
          if (!correctedItem.unit) correctedItem.unit = 'UN';
          if (!correctedItem.minQuantity) correctedItem.minQuantity = 10;
          if (!correctedItem.location) correctedItem.location = 'ADM';

          correctedItems.push(correctedItem);
        });

        // Adicionar itens v√°lidos originais
        const validItems = [];
        for (let i = 1; i < importedData.length; i++) {
          const row = importedData[i];
          if (!row) continue;

          const item = {};
          if (columnMapping.code !== undefined) item.code = String(row[columnMapping.code] || '').trim();
          if (columnMapping.name !== undefined) item.name = String(row[columnMapping.name] || '').trim();
          if (columnMapping.quantity !== undefined) {
            const qty = parseFloat(row[columnMapping.quantity]);
            item.quantity = isNaN(qty) ? 0 : Math.floor(qty);
          }

          // Verificar se n√£o est√° na lista de erros
          const hasError = importErrors.some(e => e.row === i + 1);
          if (!hasError && item.code && item.name) {
            // Mapear outros campos
            if (columnMapping.category !== undefined) item.category = String(row[columnMapping.category] || '').trim() || 'Outros';
            else item.category = 'Outros';
            if (columnMapping.unit !== undefined) item.unit = String(row[columnMapping.unit] || '').trim().toUpperCase() || 'UN';
            else item.unit = 'UN';
            if (columnMapping.minQuantity !== undefined) {
              const minQty = parseFloat(row[columnMapping.minQuantity]);
              item.minQuantity = isNaN(minQty) ? 10 : Math.floor(minQty);
            } else item.minQuantity = 10;
            if (columnMapping.location !== undefined) item.location = String(row[columnMapping.location] || '').trim() || 'ADM';
            else item.location = 'ADM';
            if (columnMapping.expiryDate !== undefined) {
              const dateStr = String(row[columnMapping.expiryDate] || '').trim();
              if (dateStr) {
                const date = parseDate(dateStr);
                item.expiryDate = date ? date.toISOString().split('T')[0] : null;
              }
            }
            validItems.push(item);
          }
        }

        closeModal('import-errors-modal');
        await importItems([...validItems, ...correctedItems]);
      } catch (error) {
        hideLoading();
        console.error('Erro ao aplicar corre√ß√µes:', error);
        showToast(`Erro ao aplicar corre√ß√µes: ${error.message || 'Erro desconhecido'}`, 'error');
      }
    }

    // Ignorar erros e importar apenas v√°lidos
    async function skipErrorsAndImport() {
      try {
        showLoading('Processando importa√ß√£o...');
        
        const validItems = [];
        const errorRows = importErrors.map(e => e.row);

        for (let i = 1; i < importedData.length; i++) {
          if (errorRows.includes(i + 1)) continue;

          const row = importedData[i];
          if (!row) continue;

          const item = {};
          if (columnMapping.code !== undefined) item.code = String(row[columnMapping.code] || '').trim();
          if (columnMapping.name !== undefined) item.name = String(row[columnMapping.name] || '').trim();
          if (columnMapping.quantity !== undefined) {
            const qty = parseFloat(row[columnMapping.quantity]);
            item.quantity = isNaN(qty) ? 0 : Math.floor(qty);
          }

          if (!item.code || !item.name) continue;

          if (columnMapping.category !== undefined) item.category = String(row[columnMapping.category] || '').trim() || 'Outros';
          else item.category = 'Outros';
          if (columnMapping.unit !== undefined) item.unit = String(row[columnMapping.unit] || '').trim().toUpperCase() || 'UN';
          else item.unit = 'UN';
          if (columnMapping.minQuantity !== undefined) {
            const minQty = parseFloat(row[columnMapping.minQuantity]);
            item.minQuantity = isNaN(minQty) ? 10 : Math.floor(minQty);
          } else item.minQuantity = 10;
          if (columnMapping.location !== undefined) item.location = String(row[columnMapping.location] || '').trim() || 'ADM';
          else item.location = 'ADM';
          if (columnMapping.expiryDate !== undefined) {
            const dateStr = String(row[columnMapping.expiryDate] || '').trim();
            if (dateStr) {
              const date = parseDate(dateStr);
              item.expiryDate = date ? date.toISOString().split('T')[0] : null;
            }
          }

          validItems.push(item);
        }

        closeModal('import-errors-modal');
        await importItems(validItems);
      } catch (error) {
        hideLoading();
        console.error('Erro ao ignorar erros e importar:', error);
        showToast(`Erro ao importar: ${error.message || 'Erro desconhecido'}`, 'error');
      }
    }

    // Importar itens para Firestore (com fallback para localStorage)
    async function importItems(items) {
      if (!items || items.length === 0) {
        hideLoading();
        showToast('Nenhum item v√°lido para importar!', 'warning');
        return;
      }

      try {
        let successCount = 0;
        let failedCount = 0;
        const itemsToSave = [];

        // Preparar itens
        for (const item of items) {
          // Validar item
          if (!item.code || !item.name) {
            failedCount++;
            continue;
          }

          // Gerar ID √∫nico se n√£o existir c√≥digo
          const itemId = item.code || `ITEM_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          
          // Verificar se j√° existe
          const existingItem = inventory.find(it => it.code === item.code);
          if (existingItem) {
            failedCount++;
            continue;
          }

          // Criar item completo - garantir que ID seja string
          const newItem = {
            id: String(itemId), // Garantir que ID seja sempre string
            code: item.code || String(itemId),
            name: item.name,
            quantity: item.quantity || 0,
            category: item.category || 'Outros',
            unit: item.unit || 'UN',
            minQuantity: item.minQuantity || 10,
            location: item.location || 'ADM',
            expiryDate: item.expiryDate || null
          };

          itemsToSave.push(newItem);
        }

        // Tentar salvar no Firestore
        if (window.db) {
          try {
            const { setDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            // Processar em lotes para n√£o sobrecarregar
            const batchSize = 10;
            for (let i = 0; i < itemsToSave.length; i += batchSize) {
              const batch = itemsToSave.slice(i, i + batchSize);
              
              for (const newItem of batch) {
                try {
                  await setDoc(doc(window.db, 'inventory', newItem.id.toString()), newItem);
                  successCount++;
                  showLoading(`Importando ${Math.min(i + batch.length, itemsToSave.length)} de ${itemsToSave.length} itens...`);
                } catch (error) {
                  console.error('Erro ao importar item no Firestore:', newItem, error);
                  failedCount++;
                }
              }
            }
          } catch (firestoreError) {
            console.warn('Erro ao acessar Firestore, salvando localmente:', firestoreError);
            // Fallback: salvar localmente
            for (const newItem of itemsToSave) {
              try {
                // Garantir que o ID seja string
                newItem.id = String(newItem.id || newItem.code);
                inventory.push(newItem);
                successCount++;
              } catch (error) {
                console.error('Erro ao salvar item localmente:', newItem, error);
                failedCount++;
              }
            }
            // Salvar no localStorage
            localStorage.setItem('inventory', JSON.stringify(inventory));
            showToast(`${successCount} itens importados localmente (Firestore n√£o dispon√≠vel). Crie o Firestore para sincroniza√ß√£o.`, 'warning');
          }
        } else {
          // Firestore n√£o dispon√≠vel, salvar localmente
          for (const newItem of itemsToSave) {
            try {
              // Garantir que o ID seja string
              newItem.id = String(newItem.id || newItem.code);
              inventory.push(newItem);
              successCount++;
            } catch (error) {
              console.error('Erro ao salvar item localmente:', newItem, error);
              failedCount++;
            }
          }
          // Salvar no localStorage
          localStorage.setItem('inventory', JSON.stringify(inventory));
          showToast(`${successCount} itens importados localmente (Firestore n√£o dispon√≠vel). Crie o Firestore para sincroniza√ß√£o.`, 'warning');
        }

        hideLoading();

        // Mostrar resultados
        showImportResults(successCount, failedCount);
        
        if (successCount > 0) {
          // Atualizar interface
          if (typeof renderInventory === 'function') {
            renderInventory();
          }
        } else if (failedCount > 0) {
          showToast(`Nenhum item foi importado. ${failedCount} itens falharam.`, 'error');
        }
      } catch (error) {
        hideLoading();
        console.error('Erro ao importar itens:', error);
        showToast(`Erro ao importar itens: ${error.message || 'Erro desconhecido'}`, 'error');
      }
    }

    // Mostrar resultados da importa√ß√£o
    function showImportResults(successCount, failedCount) {
      const successEl = document.getElementById('import-success-count');
      const failedEl = document.getElementById('import-failed-count');
      
      successEl.textContent = successCount;
      
      if (failedCount > 0) {
        failedEl.style.display = 'block';
        failedEl.querySelector('h3').textContent = failedCount;
      } else {
        failedEl.style.display = 'none';
      }

      document.getElementById('import-results-modal').classList.add('active');
    }

    // Fun√ß√µes de loading
    function showLoading(text = 'Processando...') {
      document.getElementById('loading-text').textContent = text;
      document.getElementById('loading-overlay').style.display = 'flex';
    }

    function hideLoading() {
      document.getElementById('loading-overlay').style.display = 'none';
    }

    // Fun√ß√µes de verifica√ß√£o do Firestore
    function updateFirestoreStatus(connected, error = null) {
      const statusEl = document.getElementById('firestore-status');
      const iconEl = document.getElementById('firestore-status-icon');
      const textEl = document.getElementById('firestore-status-text');
      const detailEl = document.getElementById('firestore-status-detail');
      
      if (!statusEl || !iconEl || !textEl || !detailEl) return;
      
      if (connected) {
        statusEl.style.background = 'rgba(124, 179, 66, 0.1)';
        statusEl.style.border = '1px solid rgba(124, 179, 66, 0.3)';
        iconEl.textContent = 'check_circle';
        iconEl.style.color = 'var(--gov-green)';
        textEl.textContent = '‚úÖ Firestore Conectado';
        detailEl.textContent = 'Sincroniza√ß√£o em tempo real ativa. Dados sendo salvos na nuvem.';
      } else {
        statusEl.style.background = 'rgba(229, 57, 53, 0.1)';
        statusEl.style.border = '1px solid rgba(229, 57, 53, 0.3)';
        iconEl.textContent = 'error';
        iconEl.style.color = 'var(--gov-red)';
        textEl.textContent = '‚ùå Firestore N√£o Conectado';
        
        if (error) {
          if (error.includes('does not exist') || error.includes('not-found')) {
            detailEl.textContent = 'Firestore n√£o foi criado ainda. Os dados est√£o sendo salvos localmente.';
          } else {
            detailEl.textContent = `Erro: ${error}`;
          }
        } else {
          detailEl.textContent = 'Os dados est√£o sendo salvos localmente. Crie o Firestore para sincroniza√ß√£o.';
        }
      }
    }

    async function testFirestoreConnection() {
      const statusEl = document.getElementById('firestore-status');
      const iconEl = document.getElementById('firestore-status-icon');
      const textEl = document.getElementById('firestore-status-text');
      const detailEl = document.getElementById('firestore-status-detail');
      
      if (statusEl) {
        statusEl.style.background = 'rgba(74, 144, 226, 0.1)';
        statusEl.style.border = '1px solid rgba(74, 144, 226, 0.3)';
      }
      if (iconEl) {
        iconEl.textContent = 'sync';
        iconEl.style.color = 'var(--gov-blue)';
        iconEl.style.animation = 'spin 1s linear infinite';
      }
      if (textEl) textEl.textContent = 'üîÑ Testando conex√£o...';
      if (detailEl) detailEl.textContent = 'Aguarde...';
      
      try {
        if (window.checkFirestoreStatus) {
          const isConnected = await window.checkFirestoreStatus();
          updateFirestoreStatus(isConnected, window.firestoreStatus?.error || null);
          
          if (isConnected) {
            showToast('‚úÖ Firestore est√° conectado e funcionando!', 'success');
          } else {
            const errorMsg = window.firestoreStatus?.error || 'Firestore n√£o dispon√≠vel';
            showToast(`‚ö†Ô∏è Firestore n√£o est√° conectado: ${errorMsg}`, 'warning');
          }
        } else {
          // Fallback: tentar escrever um documento de teste
          if (window.db) {
            const { doc, setDoc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const testRef = doc(window.db, '_test', 'connection');
            await setDoc(testRef, { timestamp: new Date().toISOString() });
            await deleteDoc(testRef);
            updateFirestoreStatus(true);
            showToast('‚úÖ Firestore est√° conectado e funcionando!', 'success');
          } else {
            updateFirestoreStatus(false, 'Firestore n√£o inicializado');
            showToast('‚ùå Firestore n√£o foi inicializado', 'error');
          }
        }
      } catch (error) {
        console.error('Erro ao testar Firestore:', error);
        const errorMsg = error.message || error.code || 'Erro desconhecido';
        updateFirestoreStatus(false, errorMsg);
        showToast(`‚ùå Erro ao testar Firestore: ${errorMsg}`, 'error');
      } finally {
        if (iconEl) {
          iconEl.style.animation = '';
        }
      }
    }


    // Expor fun√ß√µes de importa√ß√£o globalmente (ap√≥s todas as defini√ß√µes)
    window.applyErrorCorrections = applyErrorCorrections;
    window.skipErrorsAndImport = skipErrorsAndImport;
    window.importItems = importItems;
    window.handleFileSelect = handleFileSelect;
    window.processColumnMapping = processColumnMapping;
    window.showImportResults = showImportResults;
    window.showImportErrorsModal = showImportErrorsModal;
    window.showLoading = showLoading;
    window.hideLoading = hideLoading;
    window.updateFirestoreStatus = updateFirestoreStatus;
    window.testFirestoreConnection = testFirestoreConnection;
    window.updateQuantityPreview = updateQuantityPreview;
    window.validateLoginPassword = validateLoginPassword;

    // Fun√ß√µes de editar/excluir itens
    function openEditItemModal(itemId) {
      const itemIdStr = String(itemId);
      const item = inventory.find(i => String(i.id) === itemIdStr || String(i.code) === itemIdStr);
      
      if (!item) {
        showToast('Item n√£o encontrado', 'error');
        return;
      }
      
      currentItem = item;
      
      document.getElementById('edit-item-code').value = item.code || '';
      document.getElementById('edit-item-name').value = item.name || '';
      document.getElementById('edit-item-category').value = item.category || 'Outros';
      document.getElementById('edit-item-unit').value = item.unit || 'UN';
      document.getElementById('edit-item-quantity').value = item.quantity || 0;
      document.getElementById('edit-item-min-quantity').value = item.minQuantity || 10;
      document.getElementById('edit-item-location').value = item.location || 'ADM';
      document.getElementById('edit-item-project').value = item.project || '';
      document.getElementById('edit-item-expiry').value = item.expiryDate || '';
      
      updateProjectSelects();
      // Aguardar um pouco para garantir que o select foi atualizado
      setTimeout(() => {
        document.getElementById('edit-item-project').value = item.project || '';
      }, 50);
      
      document.getElementById('edit-item-modal').classList.add('active');
    }

    async function saveItemEdit(e) {
      e.preventDefault();
      
      if (!currentItem) {
        showToast('Erro: Item n√£o selecionado', 'error');
        return;
      }
      
      const project = document.getElementById('edit-item-project').value;
      if (!project) {
        showToast('Selecione um projeto!', 'warning');
        return;
      }

      const updatedItem = {
        ...currentItem,
        name: document.getElementById('edit-item-name').value.trim(),
        category: document.getElementById('edit-item-category').value,
        unit: document.getElementById('edit-item-unit').value,
        quantity: parseInt(document.getElementById('edit-item-quantity').value) || 0,
        minQuantity: parseInt(document.getElementById('edit-item-min-quantity').value) || 10,
        location: document.getElementById('edit-item-location').value,
        project: project,
        expiryDate: document.getElementById('edit-item-expiry').value || null
      };
      
      try {
        if (window.db) {
          const { updateDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
          const itemDocId = String(currentItem.id || currentItem.code);
          await updateDoc(doc(window.db, 'inventory', itemDocId), updatedItem);
        } else {
          // Fallback local
          const index = inventory.findIndex(i => String(i.id) === String(currentItem.id) || String(i.code) === String(currentItem.code));
          if (index !== -1) {
            inventory[index] = { ...inventory[index], ...updatedItem };
            localStorage.setItem('inventory', JSON.stringify(inventory));
          }
        }
        
        logActivity('Edi√ß√£o', `Editou o item ${updatedItem.name} (${updatedItem.code})`, 'edit');
        showToast('Item editado com sucesso!', 'success');
        closeModal('edit-item-modal');
        renderInventory();
      } catch (error) {
        console.error('Erro ao editar item:', error);
        showToast('Erro ao editar item. Tente novamente.', 'error');
      }
    }

    function confirmDeleteItem(itemId) {
      const itemIdStr = String(itemId);
      const item = inventory.find(i => String(i.id) === itemIdStr || String(i.code) === itemIdStr);
      
      if (!item) {
        showToast('Item n√£o encontrado', 'error');
        return;
      }
      
      if (!confirm(`Tem certeza que deseja excluir o item "${item.name}"?\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
        return;
      }
      
      deleteItem(itemId);
    }

    async function deleteItem() {
      // Buscar o item atual do modal
      const itemCode = document.getElementById('edit-item-code')?.value;
      if (!itemCode) {
        showToast('Item n√£o encontrado', 'error');
        return;
      }
      
      const item = inventory.find(i => String(i.code) === itemCode || String(i.id) === itemCode);
      
      if (!item) {
        showToast('Item n√£o encontrado', 'error');
        return;
      }
      
      if (!confirm(`Tem certeza que deseja excluir o item "${item.name}"? Esta a√ß√£o n√£o pode ser desfeita.`)) {
        return;
      }
      
      try {
        if (window.db) {
          const { deleteDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
          const itemDocId = String(item.id || item.code);
          await deleteDoc(doc(window.db, 'inventory', itemDocId));
        } else {
          // Fallback local
          inventory = inventory.filter(i => String(i.id) !== String(item.id) && String(i.code) !== itemCode);
          localStorage.setItem('inventory', JSON.stringify(inventory));
        }
        
        logActivity('Exclus√£o', `Excluiu o item ${item.name} (${item.code})`, 'delete');
        showToast('Item exclu√≠do com sucesso!', 'success');
        closeModal('edit-item-modal');
        renderInventory();
      } catch (error) {
        console.error('Erro ao excluir item:', error);
        showToast('Erro ao excluir item. Tente novamente.', 'error');
      }
    }

    // Sistema de withdrawals/movimenta√ß√µes
    function initWithdrawalsSync() {
      // Ser√° iniciado ap√≥s autentica√ß√£o
    }

    window.startWithdrawalsSync = function() {
      if (withdrawalsUnsubscribe) {
        return;
      }
      
      try {
        if (window.db) {
          // Importar dinamicamente
          import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js').then(async ({ collection, onSnapshot, query, orderBy }) => {
            try {
              const withdrawalsRef = collection(window.db, 'withdrawals');
              
              // Tentar com orderBy primeiro, se falhar tenta sem
              let q;
              try {
                q = query(withdrawalsRef, orderBy('createdAt', 'desc'));
              } catch (e) {
                // Se n√£o tiver √≠ndice para orderBy, usar sem ordena√ß√£o
                console.warn('Usando query sem orderBy:', e);
                q = withdrawalsRef;
              }
              
              withdrawalsUnsubscribe = onSnapshot(q, 
                (snapshot) => {
                  withdrawals = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const withdrawalData = {
                      id: doc.id,
                      ...data,
                      // Garantir que campos essenciais existam
                      withdrawalDate: data.withdrawalDate || data.withdrawal_date || '',
                      expectedReturnDate: data.expectedReturnDate || data.expected_return_date || data.returnDate || '',
                      course: data.course || data.courseName || 'Sem curso/projeto',
                      itemName: data.itemName || data.item_name || 'Item sem nome',
                      quantity: data.quantity || 0,
                      unit: data.unit || 'UN',
                      location: data.location || 'N/A',
                      userName: data.userName || data.user_name || 'Sistema',
                      withdrawalReason: data.withdrawalReason || data.reason || '',
                      returnedDate: data.returnedDate || data.returned_date || null
                    };
                    withdrawalData.status = getWithdrawalStatus(withdrawalData);
                    return withdrawalData;
                  });
                  
                  // Ordenar por data de cria√ß√£o (mais recente primeiro)
                  withdrawals.sort((a, b) => {
                    const dateA = a.createdAt?.toDate?.() || new Date(a.withdrawalDate || 0);
                    const dateB = b.createdAt?.toDate?.() || new Date(b.withdrawalDate || 0);
                    return dateB - dateA;
                  });
                  
                  console.log('Withdrawals atualizados:', withdrawals.length);
                  
                  if (window.renderWithdrawals) {
                    renderWithdrawals();
                  }
                },
                (error) => {
                  console.error('Erro ao sincronizar withdrawals:', error);
                  // Tentar carregar localmente se Firestore falhar
                  loadWithdrawalsLocal();
                }
              );
              
              console.log('‚úÖ Sincroniza√ß√£o de withdrawals iniciada');
            } catch (error) {
              console.error('Erro ao configurar query de withdrawals:', error);
              loadWithdrawalsLocal();
            }
          }).catch(error => {
            console.error('Erro ao importar Firestore:', error);
            loadWithdrawalsLocal();
          });
        } else {
          loadWithdrawalsLocal();
        }
      } catch (error) {
        console.error('Erro ao configurar sincroniza√ß√£o de withdrawals:', error);
        loadWithdrawalsLocal();
      }
    };

    // Carregar withdrawals localmente como fallback
    function loadWithdrawalsLocal() {
      try {
        const saved = localStorage.getItem('withdrawals');
        if (saved) {
          withdrawals = JSON.parse(saved);
          withdrawals.forEach(w => {
            w.status = getWithdrawalStatus(w);
          });
          if (window.renderWithdrawals) {
            renderWithdrawals();
          }
        }
      } catch (error) {
        console.error('Erro ao carregar withdrawals localmente:', error);
      }
    }

    function getWithdrawalStatus(withdrawal) {
      if (!withdrawal) return 'in_use';
      
      // Verificar se j√° foi devolvido
      if (withdrawal.returnedDate || withdrawal.returned_date) {
        return 'returned';
      }
      
      // Verificar se est√° atrasado
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const returnDateStr = withdrawal.expectedReturnDate || withdrawal.expected_return_date || withdrawal.returnDate;
      if (returnDateStr) {
        const returnDate = new Date(returnDateStr);
        returnDate.setHours(0, 0, 0, 0);
        
        if (today > returnDate) {
          return 'overdue';
        }
      }
      
      return 'in_use';
    }

    function renderWithdrawals() {
      const content = document.getElementById('withdrawals-content');
      if (!content) {
        console.warn('Elemento withdrawals-content n√£o encontrado');
        return;
      }
      
      console.log('Renderizando withdrawals. Total:', withdrawals.length);
      
      if (!withdrawals || withdrawals.length === 0) {
        content.innerHTML = '<div class="empty-state">Nenhum item em uso encontrado. Quando voc√™ retirar um item do estoque, ele aparecer√° aqui.</div>';
        return;
      }
      
      const courseFilter = document.getElementById('filter-course')?.value.toLowerCase() || '';
      const statusFilter = document.getElementById('filter-status')?.value || 'all';
      const locationFilter = document.getElementById('filter-location')?.value || 'all';
      
      let filtered = withdrawals.filter(w => {
        if (!w) return false;
        
        // Filtrar apenas itens que n√£o foram devolvidos (ou mostrar todos se filtro incluir devolvidos)
        if (statusFilter === 'all' || statusFilter === 'returned') {
          // Mostrar todos incluindo devolvidos se o filtro permitir
        } else {
          // Se filtro n√£o incluir devolvidos, filtrar apenas ativos
          if (w.status === 'returned' || w.returnedDate || w.returned_date) {
            return false;
          }
        }
        
        const course = (w.course || w.courseName || 'Sem curso/projeto').toLowerCase();
        const matchCourse = !courseFilter || course.includes(courseFilter);
        const matchStatus = statusFilter === 'all' || w.status === statusFilter;
        
        return matchCourse && matchStatus;
      });
      
      console.log('Withdrawals filtrados:', filtered.length);
      
      // Agrupar por curso
      const grouped = {};
      filtered.forEach(w => {
        const course = w.course || w.courseName || 'Sem curso/projeto';
        if (!grouped[course]) {
          grouped[course] = [];
        }
        grouped[course].push(w);
      });
      
      if (Object.keys(grouped).length === 0) {
        content.innerHTML = '<div class="empty-state">Nenhum item encontrado com os filtros aplicados. Tente ajustar os filtros.</div>';
        return;
      }
      
      content.innerHTML = Object.keys(grouped).map(course => {
        const courseItems = grouped[course];
        const activeItems = courseItems.filter(w => {
          const s = getWithdrawalStatus(w);
          return s === 'in_use' || s === 'overdue';
        });
        const overdueItems = courseItems.filter(w => getWithdrawalStatus(w) === 'overdue');
        const totalQuantity = activeItems.reduce((sum, w) => sum + (w.quantity || 0), 0);
        
        // Encontrar data de retorno mais pr√≥xima
        let nearestReturnDate = null;
        activeItems.forEach(w => {
          const returnDate = w.expectedReturnDate || w.expected_return_date || w.returnDate;
          if (returnDate) {
            if (!nearestReturnDate || new Date(returnDate) < new Date(nearestReturnDate)) {
              nearestReturnDate = returnDate;
            }
          }
        });
        
        return `
        <div class="withdrawals-group">
          <div class="withdrawals-group-header">
            <div class="withdrawals-group-title">${course}</div>
            <div class="withdrawals-group-summary">
              <span class="badge">üì¶ ${totalQuantity} itens</span>
              ${overdueItems.length > 0 ? `<span class="badge" style="background: rgba(229, 57, 53, 0.1); color: var(--gov-red);">‚ö†Ô∏è ${overdueItems.length} atrasado${overdueItems.length > 1 ? 's' : ''}</span>` : ''}
              ${nearestReturnDate ? `<span class="badge" style="background: rgba(255, 193, 7, 0.1); color: var(--gov-yellow);">üìÖ Retorno: ${formatDate(nearestReturnDate)}</span>` : ''}
            </div>
          </div>
          <div class="withdrawals-shelf-grid">
            ${grouped[course].map(w => {
              const status = getWithdrawalStatus(w);
              const statusLabels = {
                in_use: 'Em Uso',
                overdue: 'Atrasado',
                returned: 'Devolvido'
              };
              const statusClass = status;
              
              return `
                <div class="withdrawal-shelf-item">
                  <div class="withdrawal-shelf-item-header">
                    <span class="withdrawal-status ${statusClass}">${statusLabels[status]}</span>
                  </div>
                  <div class="withdrawal-shelf-item-name">${w.itemName || w.item_name || 'Item sem nome'}</div>
                  <div class="withdrawal-shelf-item-details">
                    <strong>Quantidade:</strong> ${w.quantity || 0} ${w.unit || 'UN'}
                  </div>
                  <div class="withdrawal-shelf-item-details">
                    <strong>Sa√≠da:</strong> ${formatDate(w.withdrawalDate || w.withdrawal_date || '')}
                  </div>
                  <div class="withdrawal-shelf-item-details" style="color: ${status === 'overdue' ? 'var(--gov-red)' : status === 'returned' ? 'var(--gov-green)' : 'var(--text-secondary)'};">
                    <strong>Retorno:</strong> ${formatDate(w.expectedReturnDate || w.expected_return_date || w.returnDate || '')}
                  </div>
                  ${(w.returnedDate || w.returned_date) ? `
                    <div class="withdrawal-shelf-item-details" style="color: var(--gov-green);">
                      <strong>Devolvido:</strong> ${formatDate(w.returnedDate || w.returned_date)}
                    </div>
                  ` : ''}
                  ${(w.withdrawalReason || w.reason) ? `
                    <div class="withdrawal-shelf-item-details" style="margin-top: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 6px; font-size: 12px;">
                      ${w.withdrawalReason || w.reason}
                    </div>
                  ` : ''}
                  ${status !== 'returned' ? `
                    <button class="submit-btn btn-success" style="margin-top: 12px; padding: 8px; font-size: 14px;" onclick="markAsReturned('${w.id}')">
                      Marcar como Devolvido
                    </button>
                  ` : ''}
                </div>
              `;
            }).join('')}
          </div>
        </div>
        `;
      }).join('');
    }

    function filterWithdrawals() {
      renderWithdrawals();
    }

    async function markAsReturned(withdrawalId) {
      try {
        // Encontrar o withdrawal
        const withdrawal = withdrawals.find(w => w.id === withdrawalId);
        if (!withdrawal) {
          showToast('Movimenta√ß√£o n√£o encontrada!', 'error');
          return;
        }

        // Verificar se j√° foi devolvido
        if (withdrawal.returnedDate || withdrawal.returned_date || withdrawal.status === 'returned') {
          showToast('Este item j√° foi marcado como devolvido!', 'warning');
          return;
        }

        const returnedDate = new Date().toISOString().split('T')[0];
        
        // Atualizar no Firestore se dispon√≠vel
        if (window.db) {
          try {
            const { updateDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            await updateDoc(doc(window.db, 'withdrawals', withdrawalId), {
              returnedDate: returnedDate,
              returned_date: returnedDate, // Compatibilidade
              status: 'returned'
            });
            console.log('Withdrawal atualizado no Firestore');
          } catch (firestoreError) {
            console.error('Erro ao atualizar no Firestore:', firestoreError);
            // Continuar com fallback local
          }
        }
        
        // Atualizar localmente
        const withdrawalIndex = withdrawals.findIndex(w => w.id === withdrawalId);
        if (withdrawalIndex !== -1) {
          withdrawals[withdrawalIndex].returnedDate = returnedDate;
          withdrawals[withdrawalIndex].returned_date = returnedDate;
          withdrawals[withdrawalIndex].status = 'returned';
          
          // Salvar localmente
          try {
            localStorage.setItem('withdrawals', JSON.stringify(withdrawals));
          } catch (localError) {
            console.warn('Erro ao salvar localmente:', localError);
          }
        }
        
        // Adicionar quantidade de volta ao estoque
        if (withdrawal.itemId) {
          const item = inventory.find(i => 
            String(i.id) === String(withdrawal.itemId) || 
            String(i.code) === String(withdrawal.itemId)
          );
          
          if (item) {
            const quantityToAdd = withdrawal.quantity || 0;
            const newQuantity = (item.quantity || 0) + quantityToAdd;
            
            // Atualizar no Firestore se dispon√≠vel
            if (window.db) {
              try {
                const { updateDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const itemDocId = String(item.id || item.code);
                await updateDoc(doc(window.db, 'inventory', itemDocId), {
                  quantity: newQuantity
                });
                console.log('Estoque atualizado no Firestore');
              } catch (firestoreError) {
                console.error('Erro ao atualizar estoque no Firestore:', firestoreError);
                // Continuar com fallback local
              }
            }
            
            // Atualizar localmente
            const itemIndex = inventory.findIndex(i => 
              String(i.id) === String(item.id) || 
              String(i.code) === String(item.code)
            );
            if (itemIndex !== -1) {
              inventory[itemIndex].quantity = newQuantity;
              try {
                localStorage.setItem('inventory', JSON.stringify(inventory));
              } catch (localError) {
                console.warn('Erro ao salvar estoque localmente:', localError);
              }
            }
          } else {
            console.warn('Item n√£o encontrado no estoque para devolu√ß√£o:', withdrawal.itemId);
          }
        }
        
        // Registrar devolu√ß√£o no hist√≥rico
        logActivity('Devolu√ß√£o', `Devolveu ${withdrawal.quantity || 0} ${withdrawal.unit || 'unidades'} de ${withdrawal.itemName || 'item'} - Devolvido em: ${returnedDate}`, 'returned');
        
        // Adicionar ao hist√≥rico
        history.unshift({
          id: Date.now(),
          timestamp: new Date().toLocaleString('pt-BR'),
          user: currentUser ? currentUser.name : (withdrawal.userName || 'Sistema'),
          actions: [{
            itemId: withdrawal.itemId,
            itemName: withdrawal.itemName || 'Item',
            action: 'returned',
            quantity: withdrawal.quantity || 0,
            withdrawalDate: withdrawal.withdrawalDate || withdrawal.withdrawal_date,
            returnDate: withdrawal.expectedReturnDate || withdrawal.expected_return_date,
            returnedDate: returnedDate,
            withdrawalReason: withdrawal.withdrawalReason || withdrawal.reason || ''
          }],
          notes: `Item devolvido em ${returnedDate}`
        });
        
        saveData();
        
        // Registrar devolu√ß√£o no hist√≥rico e log de atividades
        const returnedTimestamp = new Date().toLocaleString('pt-BR');
        
        logActivity('Devolu√ß√£o', `Devolveu ${withdrawal.quantity || 0} ${withdrawal.unit || 'unidades'} de ${withdrawal.itemName || withdrawal.item_name || 'item'} - Devolvido em: ${returnedDate}`, 'returned');
        
        // Adicionar ao hist√≥rico
        history.unshift({
          id: Date.now(),
          timestamp: returnedTimestamp,
          user: currentUser ? (currentUser.name || currentUser.email) : (withdrawal.userName || withdrawal.user_name || 'Sistema'),
          actions: [{
            itemId: withdrawal.itemId,
            itemName: withdrawal.itemName || withdrawal.item_name || 'Item',
            action: 'returned',
            quantity: withdrawal.quantity || 0,
            unit: withdrawal.unit || 'UN',
            location: withdrawal.location || '',
            withdrawalDate: withdrawal.withdrawalDate || withdrawal.withdrawal_date,
            returnDate: withdrawal.expectedReturnDate || withdrawal.expected_return_date,
            returnedDate: returnedDate,
            course: withdrawal.course || withdrawal.courseName || '',
            withdrawalReason: withdrawal.withdrawalReason || withdrawal.reason || ''
          }],
          notes: `Item devolvido em ${returnedDate}. Quantidade adicionada de volta ao estoque.`
        });
        
        saveData();
        
        // Atualizar renderiza√ß√£o
        if (window.renderWithdrawals) {
          renderWithdrawals();
        }
        if (window.renderInventory) {
          renderInventory();
        }
        
        showToast('Item marcado como devolvido e quantidade adicionada ao estoque!', 'success');
      } catch (error) {
        console.error('Erro ao marcar como devolvido:', error);
        showToast(`Erro ao marcar como devolvido: ${error.message || 'Erro desconhecido'}`, 'error');
      }
    }

    window.openEditItemModal = openEditItemModal;
    window.confirmDeleteItem = confirmDeleteItem;
    window.deleteItem = deleteItem;
    window.saveItemEdit = saveItemEdit;
    window.openCreateItemModal = openCreateItemModal;
    window.createItem = createItem;
    window.renderWithdrawals = renderWithdrawals;
    window.filterWithdrawals = filterWithdrawals;
    window.markAsReturned = markAsReturned;
    window.getWithdrawalStatus = getWithdrawalStatus;
    window.navigateTo = navigateTo;
    window.updateFAB = updateFAB;
    window.addProject = addProject;
    window.openEditProjectModal = openEditProjectModal;
    window.deleteProject = deleteProject;
    window.loadProjects = loadProjects;
    window.renderProjectsList = renderProjectsList;
    window.addCategory = addCategory;
    window.openEditCategoryModal = openEditCategoryModal;
    window.deleteCategory = deleteCategory;
    window.loadCategories = loadCategories;
    window.renderCategoriesList = renderCategoriesList;
    window.openChartsModal = openChartsModal;
    window.renderCharts = renderCharts;
  </script>
</body>
</html>

